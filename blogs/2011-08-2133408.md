# SQL Server 2008中的CDC(Change Data Capture)功能使用及释疑 
> 原文发表于 2011-08-10, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/08/10/2133408.html 


<p>CDC（Change Data Capture:<a href="http://technet.microsoft.com/zh-cn/library/bb522489.aspx">变更数据捕获</a>）这个功能是SQL Server 2008企业版的功能，它提供了一种新的机制，对表格数据的更新进行跟踪，在数据仓库的建设过程中，通过这种技术，可以简化从业务数据库导入数据的复杂度。</p> <p>&nbsp;</p> <p>之前我有过两篇文章介绍，最近因为又在和有关客户介绍这方面的应用。发现之前的例子不是那么完整和清楚，特此再整理一篇出来，给大家参考</p> <p>&nbsp;</p> <ul> <li> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2009/04/28/1445297.html">SQL Server 2008 的CDC功能</a></p></li> <li> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2009/05/16/1458388.html">关于CDC功能的答疑</a></p></li></ul> <p>&nbsp;</p> <h1>1. 准备一个数据库，里面准备一个表，Orders</h1> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058187912.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058181259.png" width="268" height="209"></a></p> <h1>2. 启用数据库级别的CDC选项</h1><pre class="csharpcode">--在数据库级别启用CDC功能
<span class="kwrd">EXEC</span> sys.sp_cdc_enable_db <style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style></pre>
<p>这个命令执行完之后，会在系统表里面添加6个表格</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058188195.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058189274.png" width="276" height="229"></a></p>

<p>&nbsp;</p>
<h1>3.在需要做数据捕获的表上面启用CDC选项</h1><pre class="csharpcode"><span class="kwrd">EXEC</span> sys.sp_cdc_enable_table @source_schema=<span class="str">'dbo'</span>,@source_name=<span class="str">'Orders'</span>,@capture_instance=<span class="str">'Orders'</span>,@supports_net_changes=0,@role_name=null</pre>
<p>&nbsp;</p>
<p>【备注】关于这个存储过程的具体用法和有关参数的含义，请参考
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p><a href="http://msdn.microsoft.com/en-us/library/bb522475.aspx">http://msdn.microsoft.com/en-us/library/bb522475.aspx</a></p>
<p>&nbsp;</p>
<p>执行之后，会有如下的输出消息</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058198718.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058195653.png" width="650" height="133"></a></p>
<p>这个提示的意思是说，要启动SQL Server Agent。因为CDC功能是要通过一个两个作业来自动化完成的</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058196733.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058194225.png" width="310" height="105"></a></p>
<p>&nbsp;</p>
<p>与此同时，执行上面的命令还将在系统表中添加一个表格</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058191717.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058192796.png" width="266" height="230"></a></p>
<p>&nbsp;</p>
<p>还会添加一个函数</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058199732.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058195587.png" width="430" height="454"></a></p>
<p>&nbsp;</p>
<h1>4.插入或者更新数据测试CDC功能</h1><pre class="csharpcode">--插入或者更新数据测试CDC功能
INSERT Orders(CustomerID) <span class="kwrd">VALUES</span>(<span class="str">'Microsoft'</span>);
INSERT Orders(CustomerID) <span class="kwrd">VALUES</span>(<span class="str">'Google'</span>);

<span class="kwrd">UPDATE</span> Orders <span class="kwrd">SET</span> CustomerID=<span class="str">'Yahoo'</span> <span class="kwrd">WHERE</span> OrderID=1
<span class="kwrd">DELETE</span> <span class="kwrd">FROM</span> Orders <span class="kwrd">WHERE</span> OrderID=2</pre>
<p>这个范例插入两行数据，紧接着又对第一行更新，然后还删除了第二行，所以最终只有一行数据</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058196667.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058204159.png" width="459" height="124"></a>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>那么，我们来看看CDC做了什么事情呢？</p><pre class="csharpcode"><span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.Orders_CT</pre>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058203602.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058206078.png" width="908" height="197"></a></p>
<p>我们可以来解释一下上面结果的含义</p>
<p>__$operation=2的情况，表示新增</p>
<p>__$operation=3或者4，表示更新，3表示旧值，4表示新值</p>
<p>__$operation=1的情况，表示删除</p>
<p>&nbsp;</p>
<p>很好理解，不是吗？</p>
<p>但是，我们一般都是需要按照时间范围进行检索，对吧，所以，需要使用下面的语法进行查询</p><pre class="csharpcode">--按照时间范围查询CDC结果
<span class="kwrd">DECLARE</span> @from_lsn <span class="kwrd">BINARY</span>(10),@end_lsn <span class="kwrd">BINARY</span>(10)
<span class="kwrd">DECLARE</span> @start_time DATETIME = <span class="str">'2011-8-10 00:00:00'</span>
<span class="kwrd">DECLARE</span> @end_time DATETIME =<span class="str">'2011-8-11 00:00:00'</span>
<span class="kwrd">SELECT</span> @from_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">'smallest greater than or equal'</span>,@start_time)
<span class="kwrd">SELECT</span> @end_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">' largest less than or equal'</span>,@end_time)
<span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.fn_cdc_get_all_changes_Orders(@from_lsn,@end_lsn,<span class="str">'all'</span>)</pre>
<p>&nbsp;</p>
<p>关于sys.fn_cdc_map_time_to_lsn这个函数，请参考</p>
<p><a href="http://msdn.microsoft.com/en-us/library/bb500137.aspx">http://msdn.microsoft.com/en-us/library/bb500137.aspx</a>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>查询的结果如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058205521.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058206601.png" width="904" height="183"></a>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>






<p>&nbsp;</p>
<p>如果需要包含更新操作的旧值，则可以以下的语法</p><pre class="csharpcode"><span class="kwrd">DECLARE</span> @from_lsn <span class="kwrd">BINARY</span>(10),@end_lsn <span class="kwrd">BINARY</span>(10)
<span class="kwrd">DECLARE</span> @start_time DATETIME = <span class="str">'2011-8-10 00:00:00'</span>
<span class="kwrd">DECLARE</span> @end_time DATETIME =<span class="str">'2011-8-11 00:00:00'</span>
<span class="kwrd">SELECT</span> @from_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">'smallest greater than or equal'</span>,@start_time)
<span class="kwrd">SELECT</span> @end_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">' largest less than or equal'</span>,@end_time)
<span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.fn_cdc_get_all_changes_Orders(@from_lsn,@end_lsn,<span class="str">'all update old'</span>)</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058206045.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058219600.png" width="887" height="167"></a></p>
<p>&nbsp;</p>
<p>通常，为了方便起见，我们会将这个查询定义为一个存储过程，如下</p><pre class="csharpcode">--定义存储过程来进行查询
<span class="kwrd">CREATE</span> <span class="kwrd">PROC</span> GetOrdersCDCResult(@start_time DATETIME,@end_time DATETIME)
<span class="kwrd">AS</span>
<span class="kwrd">BEGIN</span>
    <span class="kwrd">DECLARE</span> @from_lsn <span class="kwrd">BINARY</span>(10),@end_lsn <span class="kwrd">BINARY</span>(10)
    <span class="kwrd">SELECT</span> @from_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">'smallest greater than or equal'</span>,@start_time)
    <span class="kwrd">SELECT</span> @end_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">' largest less than or equal'</span>,@end_time)
    <span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.fn_cdc_get_all_changes_Orders(@from_lsn,@end_lsn,<span class="str">'all'</span>)
END</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>然后，每次需要用的时候，就直接调用即可</p><pre class="csharpcode">--执行存储过程
EXEC GetOrdersCDCResult <span class="str">'2011-8-10'</span>,<span class="str">'2011-8-11'</span></pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<h1>5.结合SSIS实现事实表的增量更新</h1>
<p>下面展示了一个SSIS 包的设计，这里面读取CDC的数据，先进行一些查找，然后按照__$operation的值拆分成为三个操作，分别进行插入，更新和删除，这样就可以实现对事实表的增量更新</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058212631.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108101058218487.png" width="762" height="700"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>本文所有的代码如下</p><pre class="csharpcode"><span class="kwrd">USE</span> SampleDatabase
<span class="kwrd">GO</span>

--在数据库级别启用CDC功能
<span class="kwrd">EXEC</span> sys.sp_cdc_enable_db 

--在需要做数据捕获的表格上面启用CDC功能
<span class="kwrd">EXEC</span> sys.sp_cdc_enable_table @source_schema=<span class="str">'dbo'</span>,@source_name=<span class="str">'Orders'</span>,@capture_instance=<span class="str">'Orders'</span>,@supports_net_changes=0,@role_name=<span class="kwrd">null</span>

--插入或者更新数据测试CDC功能
INSERT Orders(CustomerID) <span class="kwrd">VALUES</span>(<span class="str">'Microsoft'</span>);
INSERT Orders(CustomerID) <span class="kwrd">VALUES</span>(<span class="str">'Google'</span>);

<span class="kwrd">UPDATE</span> Orders <span class="kwrd">SET</span> CustomerID=<span class="str">'Yahoo'</span> <span class="kwrd">WHERE</span> OrderID=1
<span class="kwrd">DELETE</span> <span class="kwrd">FROM</span> Orders <span class="kwrd">WHERE</span> OrderID=2

--查询CDC的结果
<span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.Orders_CT


--按照时间范围查询CDC结果
<span class="kwrd">DECLARE</span> @from_lsn <span class="kwrd">BINARY</span>(10),@end_lsn <span class="kwrd">BINARY</span>(10)
<span class="kwrd">DECLARE</span> @start_time DATETIME = <span class="str">'2011-8-10 00:00:00'</span>
<span class="kwrd">DECLARE</span> @end_time DATETIME =<span class="str">'2011-8-11 00:00:00'</span>
<span class="kwrd">SELECT</span> @from_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">'smallest greater than or equal'</span>,@start_time)
<span class="kwrd">SELECT</span> @end_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">' largest less than or equal'</span>,@end_time)
<span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.fn_cdc_get_all_changes_Orders(@from_lsn,@end_lsn,<span class="str">'all'</span>)

--定义存储过程来进行查询
<span class="kwrd">CREATE</span> <span class="kwrd">PROC</span> GetOrdersCDCResult(@start_time DATETIME,@end_time DATETIME)
<span class="kwrd">AS</span>
<span class="kwrd">BEGIN</span>
    <span class="kwrd">DECLARE</span> @from_lsn <span class="kwrd">BINARY</span>(10),@end_lsn <span class="kwrd">BINARY</span>(10)
    <span class="kwrd">SELECT</span> @from_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">'smallest greater than or equal'</span>,@start_time)
    <span class="kwrd">SELECT</span> @end_lsn=sys.fn_cdc_map_time_to_lsn(<span class="str">' largest less than or equal'</span>,@end_time)
    <span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> cdc.fn_cdc_get_all_changes_Orders(@from_lsn,@end_lsn,<span class="str">'all'</span>)
<span class="kwrd">END</span>

--执行存储过程
<span class="kwrd">EXEC</span> GetOrdersCDCResult <span class="str">'2011-8-10'</span>,<span class="str">'2011-8-11'</span>
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>