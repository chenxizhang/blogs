# 在ubuntu上面配置nginx实现反向代理和负载均衡 
> 原文发表于 2015-07-29, 地址: http://www.cnblogs.com/chenxizhang/p/4687290.html 


<p><a href="http://www.cnblogs.com/chenxizhang/p/4684260.html">上一篇</a>文章（<a title="http://www.cnblogs.com/chenxizhang/p/4684260.html" href="http://www.cnblogs.com/chenxizhang/p/4684260.html">http://www.cnblogs.com/chenxizhang/p/4684260.html</a>），我做了一个实验，就是利用Visual Studio，基于Nancy框架，开发了一个自托管（Self-hosting）的应用程序，然后将其部署到了一台Ubuntu的虚拟机上面，通过mono将其顺利地运行了起来，这样也就实现了.NET应用程序在Liunx系统上面的移植。</p> <p>这一篇要讲解的是进一步的实验，我们都知道Nginx这款服务器，它可以用来做反向代理服务器，也可以做负载均衡。</p> <p>关于nginx(要读成 engine x)，有兴趣的朋友可以多看一下官方网站：<a title="http://nginx.org/" href="http://nginx.org/">http://nginx.org/</a>&nbsp;</p> <h1>通过Nginx做反向代理</h1> <p>首先，需要安装nginx</p><pre><code>sudo apt-get install nginx</code></pre><pre><code>然后，需要对Nginx进行配置</code></pre><pre><code></code><code>cd /etc/nginx/sites-available/</code></pre><pre><code>这个目录下面默认会有一个default的配置文件，内容如下</code></pre><pre><a href="http://images0.cnblogs.com/blog/9072/201507/292049111571189.png"><img title="image" border="0" alt="image" src="http://images0.cnblogs.com/blog/9072/201507/292049118291817.png" width="244" height="132"></a></pre><pre>它是在80端口进行监听。你可以直接修改这个文件，例如我上图中其实已经设置了将所有请求转发（proxy_pass）到之前我们启动的那个网站（8888端口）。</pre><pre>我们也可以自己创建一个独立的配置文件，另外指定一个端口</pre>
<p>cat &gt; nancydemo</p>
<p>然后输入如下的内容</p>
<p>&nbsp;</p>
<p>server {<br>&nbsp;&nbsp;&nbsp; listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#ff0000">81;</font><br>&nbsp;&nbsp;&nbsp; server_name&nbsp; yourdomainname.com;<br>&nbsp;&nbsp;&nbsp; root /var/www/nancydemo;</p>
<p>&nbsp;&nbsp;&nbsp; location /Content/ {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alias /var/www/nancydemo/Content/;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; location ~*&nbsp; \.(jpg|jpeg|png|gif|ico|css|js|ttf)$ {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; expires 365d;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; location / {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_pass http://127.0.0.1:8888<a href="http://;">;</a><br>&nbsp;&nbsp;&nbsp; }<br>}<br></p>
<p>按下CTRL +D保存这个文件，然后重新加载一下配置信息，就可以在81端口访问到原先8888端口的内容了</p>
<p>sudo /etc/init.d/nginx reload</p>
<p>&nbsp;</p>
<p>有童鞋可能会问了，为什么要这么麻烦呢？用户直接访问8888端口不就好了吗？通过访问81然后再访问8888端口，这样会不会有性能下降呢？</p>
<p>其实呢，这个问题的关键在于你要理解什么叫反向代理。反向代理一方面隐藏了真正的服务器信息（例如地址），另外，还可能带来更加快的访问速度。</p>
<p><br>&nbsp;</p>

<h1>直接访问（端口8888）以及通过代理（端口81）访问的压力测试结果</h1>
<p><a href="http://images0.cnblogs.com/blog/9072/201507/292049127983888.png"><img title="image" border="0" alt="image" src="http://images0.cnblogs.com/blog/9072/201507/292049135016272.png" width="244" height="153"></a></p>
<p>&nbsp;</p>
<h1>启用两台Web服务器，通过nginx做负载均衡</h1>
<p>nginx不仅仅可以作为反向代理服务器，而且也是一款很出色的负载均衡服务器。为了做这个实验，我在服务器端分别用之前写好的程序，启动了两个网站，端口分别为8888和9999。</p>
<p>接下来介绍一下，如何配置nginx使其可以实现负载均衡。方法很简单，我们需要编辑nancydemo这个配置文件（请注意红色标出的部分）</p>
<p><br><strong><font color="#ff0000">upstream xizhang{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server 127.0.0.1:8888;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server 127.0.0.1:9999;</font></strong></p>
<p><strong><font color="#ff0000">}</font></strong><br>server {<br>&nbsp;&nbsp;&nbsp; listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 81;<br>&nbsp;&nbsp;&nbsp; server_name&nbsp; yourdomainname.com;<br>&nbsp;&nbsp;&nbsp; root /var/www/nancydemo;</p>
<p>&nbsp;&nbsp;&nbsp; location /Content/ {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alias /var/www/nancydemo/Content/;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; location ~*&nbsp; \.(jpg|jpeg|png|gif|ico|css|js|ttf)$ {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; expires 365d;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; location / {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong><font color="#ff0000">proxy_pass </font></strong><a href="http://xizhang;"><strong><font color="#ff0000">http://xizhang;</font></strong></a><br>&nbsp;&nbsp;&nbsp; }<br>}<br><br></p>
<p><a href="http://images0.cnblogs.com/blog/9072/201507/292049140954457.png"><img title="image" border="0" alt="image" src="http://images0.cnblogs.com/blog/9072/201507/292049147353328.png" width="244" height="163"></a></p>
<p>配置完成之后，我们需要重新加载一下配置信息</p>
<p><strong><font color="#ff0000">sudo /etc/init.d/nginx reload</font></strong></p>
<p>&nbsp;</p>
<p>测试结果表明每秒请求数明显上升</p>
<p><a href="http://images0.cnblogs.com/blog/9072/201507/292049160328598.png"><img title="image" border="0" alt="image" src="http://images0.cnblogs.com/blog/9072/201507/292049175958853.png" width="244" height="147"></a></p>
<p>我们可以在服务器中看到有两个nginx进程，以及mono的进程。</p>
<p><a href="http://images0.cnblogs.com/blog/9072/201507/292049215178422.png"><img title="image" border="0" alt="image" src="http://images0.cnblogs.com/blog/9072/201507/292049223296009.png" width="244" height="132"></a></p>



<p>关于使用nginx实现负载均衡，还有一些细节，有兴趣可以参考 <a title="http://nginx.org/en/docs/http/load_balancing.html" href="http://nginx.org/en/docs/http/load_balancing.html">http://nginx.org/en/docs/http/load_balancing.html</a></p>
<p>&nbsp;</p>
<p>nginx还可以作为静态资源服务器，实现动静分离（并且可以缓存起来），进一步提高Web服务器的性能和吞吐量。这个话题就不过多展开了，有兴趣的朋友们可以参考官方的文档</p>
<p><a href="http://images0.cnblogs.com/blog/9072/201507/292049240323222.png"><img title="image" border="0" alt="image" src="http://images0.cnblogs.com/blog/9072/201507/292049253601249.png" width="244" height="135"></a></p>