# MOSS 2010:Visual Studio 2010开发体验（20）&mdash;&mdash;使用ADO.NET Data Service快速访问SharePoint列表数据 
> 原文发表于 2010-04-28, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/04/28/1723251.html 


<p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/04/28/1723196.html">上一篇</a> 讨论ECMAScript Object Model的时候，我们在结尾说到了，其实客户端的Javascript是通过一个client.svc文件去查询的。请注意看下图选中的部分</p> <p>地址是： <a title="http://nymoss2010:45223/Sites/dev/_vti_bin/client.svc/ProcessQuery" href="http://nymoss2010:45223/Sites/dev/_vti_bin/client.svc/ProcessQuery">http://nymoss2010:45223/Sites/dev/_vti_bin/client.svc/ProcessQuery</a></p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb.png" width="1044" height="810"></a> </p> <p>有些朋友看到这个可能会感到新奇，实际上在我看来没有什么可奇怪的。我之前也提到过，原先MOSS 2007的时候，为了让客户端可以访问到SharePoint的数据，实际上也有公开一些Web Service的。那时候的做法是基于asmx的方式去做的。</p> <p>时代不同了，这个方面当然也要考虑升级了。就像WCF是对asmx的升级一样，原先那套服务都升级成了这种svc的服务。实际上，就是WCF服务啦。</p> <p>当然，认真说起来呢，它不是简单的WCF服务，而是所谓的ADO.NET Data Service。关于什么是ADO.NET Data Service，有兴趣的朋友可以参考我下面的文章</p> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2009/05/18/1459533.html">http://www.cnblogs.com/chenxizhang/archive/2009/05/18/1459533.html</a></p> <p>也可以通过下面的地址查看更多</p> <p><a href="http://www.google.com.hk/custom?hl=zh-CN&amp;newwindow=1&amp;safe=strict&amp;client=pub-4210569241504288&amp;cof=FORID:1;GL:1;S:http://www.cnblogs.com/;L:http://www.cnblogs.com/images/logo_small.gif;LH:50;LW:129;LBGC:FFFFFF;LC:%230000ff;VLC:%23663399;GFNT:%230000ff;GIMP:%230000ff;DIV:%23336699;&amp;domains=cnblogs.com&amp;sitesearch=cnblogs.com&amp;channel=5875741252&amp;q=site:www.cnblogs.com/chenxizhang/+ado.net+data+service&amp;start=0&amp;sa=N">http://www.google.com.hk/custom?hl=zh-CN&amp;newwindow=1&amp;safe=strict&amp;client=pub-4210569241504288&amp;cof=FORID:1;GL:1;S:http://www.cnblogs.com/;L:http://www.cnblogs.com/images/logo_small.gif;LH:50;LW:129;LBGC:FFFFFF;LC:%230000ff;VLC:%23663399;GFNT:%230000ff;GIMP:%230000ff;DIV:%23336699;&amp;domains=cnblogs.com&amp;sitesearch=cnblogs.com&amp;channel=5875741252&amp;q=site:www.cnblogs.com/chenxizhang/+ado.net+data+service&amp;start=0&amp;sa=N</a></p> <p>&nbsp;</p> <p>我们需要展开一些讨论，这个地址（<a title="http://nymoss2010:45223/Sites/dev/_vti_bin/client.svc/ProcessQuery" href="http://nymoss2010:45223/Sites/dev/_vti_bin/client.svc/ProcessQuery">http://nymoss2010:45223/Sites/dev/_vti_bin/client.svc/ProcessQuery</a>）到底代表请求了什么地方的什么文件呢？</p> <p>我们都知道_vti_bin是一个SharePoint中的一个特殊目录，SharePoint有很多类似的特殊目录。大家简单地记住，所有下划线开头的一般都是特殊目录。例如_layouts,_images等等</p> <p>_vti_bin其实代表了下面这个位置，在里面我们确实可以找到Client.svc文件</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_22.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_10.png" width="1044" height="810"></a> </p> <p>我记得在很多次给一些朋友讲解SharePoint的内部架构时，讲到这里，很多朋友就会好奇地问，为什么是叫_vti，而不叫别的呢？</p> <p>Good question! 其实，保留vti 很大意义上是为了纪念一家公司吧，这家公司就叫vti （Vermeer Technologies Inc ）,你可能会说，这有什么大不了的呀。我要是说出一个产品，你就会知道为什么要纪念他们。FrontPage。是的，这家公司发明的FrontPage,后来被微软收购了，后来才慢慢有了STS,然后才有了WSS,然后今天才有MOSS。</p> <p>【注意】FrontPage不光是网页设计工具，它还有服务器组件（FrontPage Extension)，正是这个组件，构成了SharePoint最早的形状。</p> <p>【注意】我强烈建议大家学一个新技术，或者一种新的架构时，要花些时间看看它背后到底做了什么样的设计</p> <p>呵呵，下面这个 链接介绍了VTI这个公司，以及FrontPage的历史</p> <p><a href="http://www.seoconsultants.com/frontpage/history/">http://www.seoconsultants.com/frontpage/history/</a></p> <p>我现在都还记得当年用FrontPage 97做出第一个网站（其实就几个很简单的asp页面，链接到Access数据库），发布到Windows 98的一个所谓的PWS(Personal Web Server)上面的激动心情啊 <a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/%E4%BF%BA%E6%98%AF%E5%A4%A7%E7%88%B7_2.gif" class="thickbox"><img title="俺是大爷" border="0" alt="俺是大爷" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/%E4%BF%BA%E6%98%AF%E5%A4%A7%E7%88%B7_thumb.gif" width="42" height="42"></a> </p> <p>&nbsp;</p> <p>咳，低调低调。继续咱们的正题吧。我们现在找到了这个文件，接下来看看它里面到底是什么呢？我们用记事本将其打开</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_24.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_11.png" width="1044" height="810"></a> </p> <p>通过反编译工具，我们可以很清楚看到，它就是一个WCF服务</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_26.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_12.png" width="1044" height="810"></a> </p> <p>事实上，除了client.svc，还有其他几个svc，如下图所示</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_28.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_13.png" width="1044" height="810"></a> </p> <p>&nbsp;</p> <p>&nbsp;</p> <p>接下去我们将介绍使用ListData.svc这个服务来进行列表的读写操作，据我所知，这是很多朋友非常感兴趣的</p> <p>&nbsp;</p> <h2>1. 创建一个新的项目</h2> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_4.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_1.png" width="1044" height="810"></a> </p> <h2>2. 添加服务引用</h2> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_30.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_14.png" width="339" height="530"></a> </p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_32.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_15.png" width="1044" height="810"></a> </p> <p>这个引用添加完之后，确实和一般的WCF服务是不一样的。下图所示，就是典型的ADO.NET Data Service的效果</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_34.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_16.png" width="1044" height="810"></a> </p> <p>&nbsp;</p> <h2>3. 使用服务</h2> <p>首先将整个解决方案生成一下，然后我们可以显示一下数据源</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_50.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_24.png" width="1044" height="810"></a> </p> <p>然后，我们可以选中左侧的“Employees”，将它拖拽到窗体上面</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_52.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_25.png" width="1044" height="810"></a> </p> <p>看起来很神奇吧，呵呵。它自动地做好了所有的控件。</p> <p>然后，我们添加几句简单的代码，在窗体加载的时候读取数据</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.ComponentModel;
<span class="kwrd">using</span> System.Data;
<span class="kwrd">using</span> System.Drawing;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;
<span class="kwrd">using</span> System.Windows.Forms;

<span class="kwrd">namespace</span> WindowsFormsApplication1
{
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Form1 : Form
    {
        <span class="kwrd">public</span> Form1()
        {
            InitializeComponent();
            Load += <span class="kwrd">new</span> EventHandler(Form1_Load);
        }

        <span class="kwrd">void</span> Form1_Load(<span class="kwrd">object</span> sender, EventArgs e)
        {
            dev.开发DataContext ctx = <span class="kwrd">new</span> dev.开发DataContext(<span class="kwrd">new</span> Uri(<span class="str">"http://localhost:45223/sites/dev/_vti_bin/listdata.svc"</span>));

            ctx.Credentials = System.Net.CredentialCache.DefaultNetworkCredentials;

            employeesBindingSource.DataSource = ctx.Employees.ToArray();

        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>按下F5键，我们就可以读取到这些员工数据了</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_54.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_26.png" width="1044" height="810"></a> </p>
<p>&nbsp;</p>
<p>假如我们只要显示年龄小于60岁的员工，应该如何做呢？只要修改下面这句代码即可</p><pre class="csharpcode">employeesBindingSource.DataSource = ctx.Employees.Where(emp =&gt; emp.Age &lt; 60).ToArray();</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>这样显示出来的列表就只有两项了</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_56.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualS.NETDataServiceSharePoint_11F05/image_thumb_27.png" width="1044" height="810"></a> </p>
<p>太方便了吧。还没有完了，我们甚至可以在窗体上修改数据，然后保存和提交到SharePoint。</p>
<p>只要调用下面这句代码就可以了</p>
<p>ctx.SaveChanges(); 
<p>&nbsp;</p>
<h1>总结一下：</h1>
<p>MOSS 2010提供了一系列基于ADO.NET Data Service和WCF技术实现的服务，利用这些服务，可以在客户端开发的时候大大地提高生产力。到这一篇，本系列的客户端访问技术部分就结束了。下一篇开始讨论工作流</p>