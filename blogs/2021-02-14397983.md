# .NET Core项目自动化测试和代码覆盖率审查 
> 原文发表于 2021-02-11, 地址: http://www.cnblogs.com/chenxizhang/p/14397983.html 


<p>这篇文章给大家分享一下，如何配置.NET Core项目自动化测试和代码覆盖率审查。
</p><p>基本知识，请参考这里： <a href="https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-with-dotnet-test">https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-with-dotnet-test</a>
	</p><h2>环境准备：
</h2><p>演示项目基于Visual Studio Code，并且安装如下插件
</p><ol><li>Coverage Gutters
</li><li>Coverlet
</li></ol><p>我有如下的项目结构
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180428234-1714744034.png" alt=""/>
	</p><h2>本地开发环境运行测试并查看代码覆盖率
</h2><p>运行 dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=lcov /p:CoverletOutput=./lcov.info
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180429269-886145710.png" alt=""/>
	</p><p>点击状态栏中的Watch 按钮
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180429638-1006797314.png" alt=""/>
	</p><p>这样就能快速进入源代码中查看哪些代码覆盖，哪些代码没有覆盖。
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180432449-389690191.png" alt=""/>
	</p><p>下图红色标出的代码是没有覆盖到的。
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180434204-1286395821.png" alt=""/>
	</p><p>
 </p><h2>配置CI 系统自动测试和计算覆盖率
</h2><p>我这里用 的是Azure DevOps，希望每次pipeline运行时能了解测试成功率和代码覆盖率。
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180434989-1957488221.png" alt=""/>
	</p><p>你可以像下面这样定义Pipeline
</p><p>
 </p><p># ASP.NET
</p><p># Build and test ASP.NET projects.
</p><p># Add steps that publish symbols, save build artifacts, deploy, and more:
</p><p># https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4
</p><p>
 </p><p>trigger:
</p><p>- main
</p><p>
 </p><p>pool:
</p><p>  vmImage: 'windows-latest'
</p><p>
 </p><p>variables:
</p><p>  solution: '**/*.sln'
</p><p>  buildPlatform: 'Any CPU'
</p><p>  buildConfiguration: 'Release'
</p><p>
 </p><p>steps:
</p><p>- task: NuGetToolInstaller@1
</p><p>
 </p><p>- task: NuGetCommand@2
</p><p>  inputs:
</p><p>    restoreSolution: '$(solution)'
</p><p>
 </p><p>- task: VSBuild@1
</p><p>  inputs:
</p><p>    solution: '$(solution)'
</p><p>    msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
</p><p>    platform: '$(buildPlatform)'
</p><p>    configuration: '$(buildConfiguration)'
</p><p>
 </p><p>- task: DotNetCoreCLI@2
</p><p>  inputs:
</p><p>    command: 'test'
</p><p>    arguments: '--collect "XPlat Code Coverage"'
</p><p>
 </p><p>- task: PublishCodeCoverageResults@1
</p><p>  inputs:
</p><p>    codeCoverageTool: 'Cobertura'
</p><p>summaryFileLocation: '$(Agent.TempDirectory)\*\coverage.cobertura.xml'
</p><p>
 </p><p>成功运行后，会看到下面这样的详细测试报告
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180435837-1945651470.png" alt=""/>
	</p><p>
 </p><p>还有代码覆盖率审查报告
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180436730-831138055.png" alt=""/>
	</p><p>
 </p><p>通过在Azure DevOps安装一个插件（"Build Quality Checks"），可以根据代码覆盖率的数值进行代码质量审查。例如下图所示，就是我们规定必须代码覆盖率到达60%以上才能编译通过。
</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180438013-2015801405.png" alt=""/>
	</p><p><img src="https://img2020.cnblogs.com/blog/9072/202102/9072-20210211180439024-2502567.png" alt=""/>
	</p><p>
 </p>