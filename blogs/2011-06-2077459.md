# RIA Service中对于递归实体类型处理的问题及解决方案 
> 原文发表于 2011-06-10, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/06/10/2077459.html 


<p>故事是这样开始的：</p> <p>&nbsp;</p> <p>我们在开发一个Silverlight应用程序的时候使用到了RIA Service，我们需要通过该服务公开一个对文件夹的查询操作。</p> <p>为此，我们建立了如下的一个实体类型</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Web;

<span class="kwrd">using</span> System.Runtime.Serialization;
<span class="kwrd">using</span> System.ComponentModel.DataAnnotations;

<span class="kwrd">using</span> System.ServiceModel.DomainServices.Server;

<span class="kwrd">namespace</span> DomainServiceSample.Web
{
    [DataContract]<span class="rem">//必须声明类别为DataContract</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> Folder
    {
        [DataMember]<span class="rem">//必须声明属性为DataMember</span>
        [Key]<span class="rem">//一个用于DomainService的Entity必须有一个Key</span>
        <span class="kwrd">public</span> Guid ID { get; set; }

        [DataMember]
        <span class="kwrd">public</span> <span class="kwrd">string</span> Name { get; set; }

        [DataMember]         </pre><pre class="csharpcode"><span class="kwrd">        public</span> Folder[] SubFolder { get; set; }
        
    }
}</pre>
<p>【注意】上面其实是有一个递归的类型，也就是Folder里面又包含Folder</p>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>然后，我们创建了一个DomainService</p><pre class="csharpcode">
<span class="kwrd">namespace</span> DomainServiceSample.Web
{
    <span class="kwrd">using</span> System;
    <span class="kwrd">using</span> System.Collections.Generic;
    <span class="kwrd">using</span> System.ComponentModel;
    <span class="kwrd">using</span> System.ComponentModel.DataAnnotations;
    <span class="kwrd">using</span> System.Linq;
    <span class="kwrd">using</span> System.ServiceModel.DomainServices.Hosting;
    <span class="kwrd">using</span> System.ServiceModel.DomainServices.Server;


    <span class="rem">// TODO: Create methods containing your application logic.</span>
    [EnableClientAccess()]
    <span class="kwrd">public</span> <span class="kwrd">class</span> SampleDomainService : DomainService
    {
        [Query]
        <span class="kwrd">public</span> IQueryable&lt;Folder&gt; GetFolder()
        {
            var folder = <span class="kwrd">new</span> Folder() { ID = Guid.NewGuid(), Name = <span class="str">"Level 1 Folder"</span> };
            var subFolders = <span class="kwrd">new</span>[]{
                <span class="kwrd">new</span> Folder(){ID=Guid.NewGuid(),Name=<span class="str">"Level 2 Folder"</span>},
                <span class="kwrd">new</span> Folder(){ID=Guid.NewGuid(),Name=<span class="str">"Level 2 Folder 2"</span>}
            };
            folder.SubFolder = subFolders;
            <span class="kwrd">return</span> <span class="kwrd">new</span>[] { folder }.AsQueryable();
        }
    }
}


</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
这个代码没有什么特别的,我们计划向客户端发送的结果是一个Folder,但同时它包含了两个子Folder。</p>
<p>编写上面两个类型很顺利，然后我们生成项目，因为使用了Domain Service，所以在Silverlight应用程序中会得到一个自动生成的类型</p>
<p>我们打开那个文件，确实里面是有一个Folder的类型</p><pre class="csharpcode">    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// The 'Folder' entity class.</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    [DataContract(Namespace=<span class="str">"http://schemas.datacontract.org/2004/07/DomainServiceSample.Web"</span>)]
    <span class="kwrd">public</span> <span class="kwrd">sealed</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Folder : Entity
    {
        
        <span class="kwrd">private</span> Guid _id;
        
        <span class="kwrd">private</span> <span class="kwrd">string</span> _name;
        
        <span class="preproc">#region</span> Extensibility Method Definitions

        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// This method is invoked from the constructor once initialization is complete and</span>
        <span class="rem">/// can be used for further object setup.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnCreated();
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnIDChanging(Guid <span class="kwrd">value</span>);
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnIDChanged();
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnNameChanging(<span class="kwrd">string</span> <span class="kwrd">value</span>);
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnNameChanged();

        <span class="preproc">#endregion</span>
        
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Initializes a new instance of the &lt;see cref="Folder"/&gt; class.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">public</span> Folder()
        {
            <span class="kwrd">this</span>.OnCreated();
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Gets or sets the 'ID' value.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [DataMember()]
        [Editable(<span class="kwrd">false</span>, AllowInitialValue=<span class="kwrd">true</span>)]
        [Key()]
        [RoundtripOriginal()]
        <span class="kwrd">public</span> Guid ID
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">this</span>._id;
            }
            set
            {
                <span class="kwrd">if</span> ((<span class="kwrd">this</span>._id != <span class="kwrd">value</span>))
                {
                    <span class="kwrd">this</span>.OnIDChanging(<span class="kwrd">value</span>);
                    <span class="kwrd">this</span>.ValidateProperty(<span class="str">"ID"</span>, <span class="kwrd">value</span>);
                    <span class="kwrd">this</span>._id = <span class="kwrd">value</span>;
                    <span class="kwrd">this</span>.RaisePropertyChanged(<span class="str">"ID"</span>);
                    <span class="kwrd">this</span>.OnIDChanged();
                }
            }
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Gets or sets the 'Name' value.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [DataMember()]
        <span class="kwrd">public</span> <span class="kwrd">string</span> Name
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">this</span>._name;
            }
            set
            {
                <span class="kwrd">if</span> ((<span class="kwrd">this</span>._name != <span class="kwrd">value</span>))
                {
                    <span class="kwrd">this</span>.OnNameChanging(<span class="kwrd">value</span>);
                    <span class="kwrd">this</span>.RaiseDataMemberChanging(<span class="str">"Name"</span>);
                    <span class="kwrd">this</span>.ValidateProperty(<span class="str">"Name"</span>, <span class="kwrd">value</span>);
                    <span class="kwrd">this</span>._name = <span class="kwrd">value</span>;
                    <span class="kwrd">this</span>.RaiseDataMemberChanged(<span class="str">"Name"</span>);
                    <span class="kwrd">this</span>.OnNameChanged();
                }
            }
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Computes a value from the key fields that uniquely identifies this entity instance.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;An object instance that uniquely identifies this entity instance.&lt;/returns&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">object</span> GetIdentity()
        {
            <span class="kwrd">return</span> <span class="kwrd">this</span>._id;
        }
    }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
但是，让人疑惑的是，<strong><font color="#ff0000">这个类型里面并没有包含SubFolder这个属性</font></strong></p>
<p>这是什么情况呢？难道RIA Service不允许传递这种包含递归类型引用的实体？确实如此。</p>
<p>&nbsp;</p>
<p>我目前的解决方法是：</p>
<p>1. 为Folder类型添加一个ParentID属性</p>
<p>2. 为SubFolder设置关联，即子Folder的ParentID设置到父Folder的ID。并且定义他们的关联</p>
<p>3. 使用Include属性标记SubFolder是要包含进来的</p>
<p>&nbsp;</p>
<p>所以，这个类型修改为下面这样</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Web;

<span class="kwrd">using</span> System.Runtime.Serialization;
<span class="kwrd">using</span> System.ComponentModel.DataAnnotations;

<span class="kwrd">using</span> System.ServiceModel.DomainServices.Server;

<span class="kwrd">namespace</span> DomainServiceSample.Web
{
    [DataContract]<span class="rem">//必须声明类别为DataContract</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> Folder
    {
        [DataMember]<span class="rem">//必须声明属性为DataMember</span>
        [Key]<span class="rem">//一个用于DomainService的Entity必须有一个Key</span>
        <span class="kwrd">public</span> Guid ID { get; set; }

        [DataMember]
        <span class="kwrd">public</span> <span class="kwrd">string</span> Name { get; set; }


        [DataMember]
<font color="#ff0000">        [Association(<span class="str">"Test"</span>,<span class="str">"ID"</span>,<span class="str">"ParentID"</span>)]
        [Include]</font>
        <span class="kwrd">public</span> Folder[] SubFolder { get; set; }


  <font color="#ff0000">      [DataMember]
        <span class="kwrd">public</span> Guid ParentID { get; set; }</font>
        
    }
}</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106101132137223.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106101132135096.png" width="919" height="727"></a></p>
<p>然后，我们再来看在Silverlight中生成的那个类型</p><pre class="csharpcode">   <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// The 'Folder' entity class.</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    [DataContract(Namespace=<span class="str">"http://schemas.datacontract.org/2004/07/DomainServiceSample.Web"</span>)]
    <span class="kwrd">public</span> <span class="kwrd">sealed</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Folder : Entity
    {
        
        <span class="kwrd">private</span> Guid _id;
        
        <span class="kwrd">private</span> <span class="kwrd">string</span> _name;
        
        <span class="kwrd">private</span> Guid _parentID;
        
        <span class="kwrd">private</span> EntityCollection&lt;Folder&gt; _subFolder;
        
        <span class="preproc">#region</span> Extensibility Method Definitions

        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// This method is invoked from the constructor once initialization is complete and</span>
        <span class="rem">/// can be used for further object setup.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnCreated();
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnIDChanging(Guid <span class="kwrd">value</span>);
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnIDChanged();
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnNameChanging(<span class="kwrd">string</span> <span class="kwrd">value</span>);
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnNameChanged();
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnParentIDChanging(Guid <span class="kwrd">value</span>);
        <span class="kwrd">partial</span> <span class="kwrd">void</span> OnParentIDChanged();

        <span class="preproc">#endregion</span>
        
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Initializes a new instance of the &lt;see cref="Folder"/&gt; class.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">public</span> Folder()
        {
            <span class="kwrd">this</span>.OnCreated();
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Gets or sets the 'ID' value.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [DataMember()]
        [Editable(<span class="kwrd">false</span>, AllowInitialValue=<span class="kwrd">true</span>)]
        [Key()]
        [RoundtripOriginal()]
        <span class="kwrd">public</span> Guid ID
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">this</span>._id;
            }
            set
            {
                <span class="kwrd">if</span> ((<span class="kwrd">this</span>._id != <span class="kwrd">value</span>))
                {
                    <span class="kwrd">this</span>.OnIDChanging(<span class="kwrd">value</span>);
                    <span class="kwrd">this</span>.ValidateProperty(<span class="str">"ID"</span>, <span class="kwrd">value</span>);
                    <span class="kwrd">this</span>._id = <span class="kwrd">value</span>;
                    <span class="kwrd">this</span>.RaisePropertyChanged(<span class="str">"ID"</span>);
                    <span class="kwrd">this</span>.OnIDChanged();
                }
            }
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Gets or sets the 'Name' value.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [DataMember()]
        <span class="kwrd">public</span> <span class="kwrd">string</span> Name
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">this</span>._name;
            }
            set
            {
                <span class="kwrd">if</span> ((<span class="kwrd">this</span>._name != <span class="kwrd">value</span>))
                {
                    <span class="kwrd">this</span>.OnNameChanging(<span class="kwrd">value</span>);
                    <span class="kwrd">this</span>.RaiseDataMemberChanging(<span class="str">"Name"</span>);
                    <span class="kwrd">this</span>.ValidateProperty(<span class="str">"Name"</span>, <span class="kwrd">value</span>);
                    <span class="kwrd">this</span>._name = <span class="kwrd">value</span>;
                    <span class="kwrd">this</span>.RaiseDataMemberChanged(<span class="str">"Name"</span>);
                    <span class="kwrd">this</span>.OnNameChanged();
                }
            }
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Gets or sets the 'ParentID' value.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [DataMember()]
        <span class="kwrd">public</span> Guid ParentID
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">this</span>._parentID;
            }
            set
            {
                <span class="kwrd">if</span> ((<span class="kwrd">this</span>._parentID != <span class="kwrd">value</span>))
                {
                    <span class="kwrd">this</span>.OnParentIDChanging(<span class="kwrd">value</span>);
                    <span class="kwrd">this</span>.RaiseDataMemberChanging(<span class="str">"ParentID"</span>);
                    <span class="kwrd">this</span>.ValidateProperty(<span class="str">"ParentID"</span>, <span class="kwrd">value</span>);
                    <span class="kwrd">this</span>._parentID = <span class="kwrd">value</span>;
                    <span class="kwrd">this</span>.RaiseDataMemberChanged(<span class="str">"ParentID"</span>);
                    <span class="kwrd">this</span>.OnParentIDChanged();
                }
            }
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Gets the collection of associated &lt;see cref="Folder"/&gt; entity instances.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [Association(<span class="str">"Test"</span>, <span class="str">"ID"</span>, <span class="str">"ParentID"</span>)]
        <span class="kwrd">public</span> EntityCollection&lt;Folder&gt; SubFolder
        {
            get
            {
                <span class="kwrd">if</span> ((<span class="kwrd">this</span>._subFolder == <span class="kwrd">null</span>))
                {
                    <span class="kwrd">this</span>._subFolder = <span class="kwrd">new</span> EntityCollection&lt;Folder&gt;(<span class="kwrd">this</span>, <span class="str">"SubFolder"</span>, <span class="kwrd">this</span>.FilterSubFolder);
                }
                <span class="kwrd">return</span> <span class="kwrd">this</span>._subFolder;
            }
        }
        
        <span class="kwrd">private</span> <span class="kwrd">bool</span> FilterSubFolder(Folder entity)
        {
            <span class="kwrd">return</span> (entity.ParentID == <span class="kwrd">this</span>.ID);
        }
        
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// Computes a value from the key fields that uniquely identifies this entity instance.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;An object instance that uniquely identifies this entity instance.&lt;/returns&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">object</span> GetIdentity()
        {
            <span class="kwrd">return</span> <span class="kwrd">this</span>._id;
        }
    }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>这时就看到SubFolder了，而且还包含了很多其他的属性。</p>
<p>&nbsp;</p>
<p>最后，我做了一个界面来显示给大家看看效果</p>
<p>MainPage.xaml的内容如下</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">UserControl</span> <span class="attr">x:Class</span><span class="kwrd">="DomainServiceSample.MainPage"</span>
    <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
    <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span>
    <span class="attr">xmlns:d</span><span class="kwrd">="http://schemas.microsoft.com/expression/blend/2008"</span>
    <span class="attr">xmlns:mc</span><span class="kwrd">="http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
    <span class="attr">mc:Ignorable</span><span class="kwrd">="d"</span>
    <span class="attr">d:DesignHeight</span><span class="kwrd">="300"</span> <span class="attr">d:DesignWidth</span><span class="kwrd">="400"</span> <span class="attr">xmlns:sdk</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk"</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">Grid</span> <span class="attr">x:Name</span><span class="kwrd">="LayoutRoot"</span> <span class="attr">Background</span><span class="kwrd">="White"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">sdk:DataGrid</span> <span class="attr">AutoGenerateColumns</span><span class="kwrd">="True"</span> <span class="attr">Margin</span><span class="kwrd">="16,13,12,12"</span> <span class="attr">Name</span><span class="kwrd">="dataGrid1"</span> <span class="attr">ItemsSource</span><span class="kwrd">="{Binding}"</span> <span class="attr">RowDetailsVisibilityMode</span><span class="kwrd">="Visible"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">sdk:DataGrid.RowDetailsTemplate</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">DataTemplate</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">sdk:DataGrid</span> <span class="attr">AutoGenerateColumns</span><span class="kwrd">="True"</span> <span class="attr">Margin</span><span class="kwrd">="20,20,20,20"</span> <span class="attr">Height</span><span class="kwrd">="300"</span> <span class="attr">ItemsSource</span><span class="kwrd">="{Binding SubFolder}"</span> <span class="kwrd">/&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">DataTemplate</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">sdk:DataGrid.RowDetailsTemplate</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">sdk:DataGrid</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Grid</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">UserControl</span><span class="kwrd">&gt;</span>
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>MainPage.xaml.cs的内容如下</p>
<p>&nbsp;</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Net;
<span class="kwrd">using</span> System.Windows;
<span class="kwrd">using</span> System.Windows.Controls;
<span class="kwrd">using</span> System.Windows.Documents;
<span class="kwrd">using</span> System.Windows.Input;
<span class="kwrd">using</span> System.Windows.Media;
<span class="kwrd">using</span> System.Windows.Media.Animation;
<span class="kwrd">using</span> System.Windows.Shapes;

<span class="kwrd">using</span> DomainServiceSample.Web;

<span class="kwrd">namespace</span> DomainServiceSample
{
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> MainPage : UserControl
    {
        <span class="kwrd">public</span> MainPage()
        {
            InitializeComponent();

            Loaded += <span class="kwrd">new</span> RoutedEventHandler(MainPage_Loaded);
        }

        <span class="kwrd">void</span> MainPage_Loaded(<span class="kwrd">object</span> sender, RoutedEventArgs e)
        {
            var ctx = <span class="kwrd">new</span> SampleDomainContext();
            var op = ctx.Load&lt;Folder&gt;(ctx.GetFolderQuery());
            dataGrid1.DataContext = op.Entities;
        }
    }
}
</pre>
<p>&nbsp;</p>
<p>同时，服务端的代码我也稍作了修改</p><pre class="csharpcode">
<span class="kwrd">namespace</span> DomainServiceSample.Web
{
    <span class="kwrd">using</span> System;
    <span class="kwrd">using</span> System.Collections.Generic;
    <span class="kwrd">using</span> System.ComponentModel;
    <span class="kwrd">using</span> System.ComponentModel.DataAnnotations;
    <span class="kwrd">using</span> System.Linq;
    <span class="kwrd">using</span> System.ServiceModel.DomainServices.Hosting;
    <span class="kwrd">using</span> System.ServiceModel.DomainServices.Server;


    <span class="rem">// TODO: Create methods containing your application logic.</span>
    [EnableClientAccess()]
    <span class="kwrd">public</span> <span class="kwrd">class</span> SampleDomainService : DomainService
    {
        [Query]
        <span class="kwrd">public</span> IQueryable&lt;Folder&gt; GetFolder()
        {
            var folder = <span class="kwrd">new</span> Folder() { ID = Guid.NewGuid(), Name = <span class="str">"Level 1 Folder"</span> };
            var subFolders = <span class="kwrd">new</span>[]{
                <span class="kwrd">new</span> Folder(){ID=Guid.NewGuid(),Name=<span class="str">"Level 2 Folder"</span><font color="#ff0000">,ParentID=folder.ID</font>},
                <span class="kwrd">new</span> Folder(){ID=Guid.NewGuid(),Name=<span class="str">"Level 2 Folder 2"</span><font color="#ff0000">,ParentID=folder.ID</font>}
            };
            folder.SubFolder = subFolders;
            <span class="kwrd">return</span> <span class="kwrd">new</span>[] { folder }.AsQueryable();
        }
    }
}


</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>调试起来看到的效果如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106101132149830.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/20110610113214179.png" width="737" height="474"></a></p>
<p>&nbsp;</p>
<p>虽然解决了问题，但个人感觉Domain Service这个设计值得商榷。如果各位有更好的见解和解决方案，请不吝赐教</p>