# Silverlight有限支持WCF的binding问题 
> 原文发表于 2011-06-19, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/06/19/2084524.html 


<p>这是最近遇到的一个小问题。情况是这样的：</p> <p>1.我们有一个网站，是用<font color="#ff0000" size="5"><strong>.NET Framework 3.5</strong></font>编写的，里面有一些WCF的服务。作为演示，我下面有一个范例服务</p> <p>&nbsp;</p> <h2>合约</h2><pre class="csharpcode"><span class="kwrd">using</span> System.ServiceModel;

<span class="kwrd">namespace</span> WebApplication1
{
    <span class="rem">// NOTE: You can use the "Rename" command on the "Refactor" menu to change the interface name "IService1" in both code and config file together.</span>
    [ServiceContract]
    <span class="kwrd">public</span> <span class="kwrd">interface</span> IService1
    {
        [OperationContract]
        <span class="kwrd">void</span> DoWork();

        [OperationContract]
        <span class="kwrd">string</span> Helloworld();
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<h2>服务</h2><pre class="csharpcode">
<span class="kwrd">namespace</span> WebApplication1
{
    <span class="rem">// NOTE: You can use the "Rename" command on the "Refactor" menu to change the class name "Service1" in code, svc and config file together.</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> Service1 : IService1
    {
        <span class="kwrd">public</span> <span class="kwrd">void</span> DoWork()
        {
        }


        <span class="kwrd">public</span> <span class="kwrd">string</span> Helloworld()
        {
            <span class="kwrd">return</span> <span class="str">"hello,world"</span>;
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>2.我们需要在一个新的Silverlight应用程序中访问这些WCF服务，但是无论我们选择Silverlight的版本是3.0，还是4.0（注意，这不是.NET Framework的版本），都无法完成服务引用。</p>
<p>具体的症状就是，添加引用之后，Silverlight无法正确生成那个配置文件</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190905108870.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190905111511.png" width="635" height="514"></a></p>
<p>会有两个警告</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906059175.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906079373.png" width="898" height="279"></a></p>
<p>具体的信息是</p>
<p>Warning&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp; Custom tool warning: No endpoints compatible with Silverlight 3 were found. The generated client class will not be usable unless endpoint information is provided via the constructor.&nbsp;&nbsp;&nbsp; d:\temp\WebApplication1\SilverlightApplication1\Service References\DataModel\Reference.svcmap&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp; SilverlightApplication1<br></p>
<p>&nbsp;</p>
<p>然后，我们去看那个生成的配置文件的话，会看到一片空白</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906076374.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906082296.png" width="731" height="112"></a></p>
<p>&nbsp;</p>
<p>这样的问题要怎么解决呢？我们首先要把问题找到，从上面的错误消息，它的意思应该是说，不支持目前提供的EndPoint。</p>
<p>那么，服务端到底使用了什么样的EndPoint呢</p>
<p>我们转到web应用程序中的web.config文件，可以看到如下的设置</p><pre class="csharpcode">    <span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">behaviors</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">serviceBehaviors</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">behavior</span> <span class="attr">name</span><span class="kwrd">="WebApplication1.Service1Behavior"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">serviceMetadata</span> <span class="attr">httpGetEnabled</span><span class="kwrd">="true"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">serviceDebug</span> <span class="attr">includeExceptionDetailInFaults</span><span class="kwrd">="false"</span> <span class="kwrd">/&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">behavior</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">serviceBehaviors</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">behaviors</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">services</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">service</span> <span class="attr">behaviorConfiguration</span><span class="kwrd">="WebApplication1.Service1Behavior"</span>
                <span class="attr">name</span><span class="kwrd">="WebApplication1.Service1"</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">=""</span> <span class="attr">binding</span><span class="kwrd">="wsHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="WebApplication1.IService1"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">identity</span><span class="kwrd">&gt;</span>
                        <span class="kwrd">&lt;</span><span class="html">dns</span> <span class="attr">value</span><span class="kwrd">="localhost"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;/</span><span class="html">identity</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">endpoint</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">="mex"</span> <span class="attr">binding</span><span class="kwrd">="mexHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="IMetadataExchange"</span> <span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">service</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">services</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>也就是说，默认情况下，.NET Framework 3.5提供的WCF，是使用wsHttpBinding的。难道是Silverlight不支持这种EndPoint吗？</p>
<p>为了做测验，我们可以将其修改为相对简单的basicHttpBinding</p><pre class="csharpcode">
    <span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">behaviors</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">serviceBehaviors</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">behavior</span> <span class="attr">name</span><span class="kwrd">="WebApplication1.Service1Behavior"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">serviceMetadata</span> <span class="attr">httpGetEnabled</span><span class="kwrd">="true"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">serviceDebug</span> <span class="attr">includeExceptionDetailInFaults</span><span class="kwrd">="false"</span> <span class="kwrd">/&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">behavior</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">serviceBehaviors</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">behaviors</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">services</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">service</span> <span class="attr">behaviorConfiguration</span><span class="kwrd">="WebApplication1.Service1Behavior"</span>
                <span class="attr">name</span><span class="kwrd">="WebApplication1.Service1"</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">=""</span> <span class="attr">binding</span><span class="kwrd">="basicHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="WebApplication1.IService1"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">identity</span><span class="kwrd">&gt;</span>
                        <span class="kwrd">&lt;</span><span class="html">dns</span> <span class="attr">value</span><span class="kwrd">="localhost"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;/</span><span class="html">identity</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">endpoint</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">="mex"</span> <span class="attr">binding</span><span class="kwrd">="mexHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="IMetadataExchange"</span> <span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">service</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">services</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span></pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
<br></p>
<p>然后，我们再去Silverlight中添加引用看看是否能解决问题</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906096540.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906107261.png" width="916" height="373"></a></p>
<p>我们发现，这次成功了，ClientConfig中也正确生成了WCF的配置,并且通过如下的代码可以完成服务的调用</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Windows;
<span class="kwrd">using</span> System.Windows.Controls;
<span class="kwrd">using</span> System.ServiceModel;

<span class="kwrd">namespace</span> SilverlightApplication1
{
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> MainPage : UserControl
    {
        <span class="kwrd">public</span> MainPage()
        {
            InitializeComponent();
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> Button_Click(<span class="kwrd">object</span> sender, RoutedEventArgs e)
        {
            var proxy = <span class="kwrd">new</span> DataModel.Service1Client();
            proxy.Endpoint.Address = <span class="kwrd">new</span> EndpointAddress(<span class="kwrd">new</span> Uri(Application.Current.Host.Source, <span class="str">"../Service1.svc"</span>));


            proxy.HelloworldCompleted += (o, a) =&gt;
            {
                MessageBox.Show(a.Result);
            };


            proxy.HelloworldAsync();
            
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>&nbsp;</p>
<p>好的，看起来问题是解决了，也就是说Silverlight只支持使用basicHttpBinding?如果我们非要改成wsHttpBinding ，行不行呢？</p>
<p>我尝试将clientconfig文件修改为</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">configuration</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">client</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">="http://localhost:2514/Service1.svc"</span> <span class="attr">binding</span><span class="kwrd">="wsHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="DataModel.IService1"</span>
                <span class="attr">name</span><span class="kwrd">="BasicHttpBinding_IService1"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">client</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">configuration</span><span class="kwrd">&gt;</span>
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>并且将服务端的web.config，也修改为</p><pre class="csharpcode">    <span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">behaviors</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">serviceBehaviors</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">behavior</span> <span class="attr">name</span><span class="kwrd">="WebApplication1.Service1Behavior"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">serviceMetadata</span> <span class="attr">httpGetEnabled</span><span class="kwrd">="true"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">serviceDebug</span> <span class="attr">includeExceptionDetailInFaults</span><span class="kwrd">="false"</span> <span class="kwrd">/&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">behavior</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">serviceBehaviors</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">behaviors</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">services</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">service</span> <span class="attr">behaviorConfiguration</span><span class="kwrd">="WebApplication1.Service1Behavior"</span>
                <span class="attr">name</span><span class="kwrd">="WebApplication1.Service1"</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">=""</span> <span class="attr">binding</span><span class="kwrd">="wsHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="WebApplication1.IService1"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">identity</span><span class="kwrd">&gt;</span>
                        <span class="kwrd">&lt;</span><span class="html">dns</span> <span class="attr">value</span><span class="kwrd">="localhost"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;/</span><span class="html">identity</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">endpoint</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">="mex"</span> <span class="attr">binding</span><span class="kwrd">="mexHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="IMetadataExchange"</span> <span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">service</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">services</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span></pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>运行程序的结果是，会报告如下的错误</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906114295.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106190906127426.png" width="456" height="260"></a></p>
<p>也就是说，确实不支持wsHttpBinding</p>
<p><strike></strike>&nbsp;</p>
<p>关于这一点，有兴趣的朋友，也可以参考一下微软官方的文档说明</p>
<p><a href="http://msdn.microsoft.com/en-us/library/cc896571(v=VS.95).aspx">http://msdn.microsoft.com/en-us/library/cc896571(v=VS.95).aspx</a></p>
<p>&nbsp;</p>
<p>【又及】</p>
<p>在Silverlight中，最简单易用的服务是RIA Service，关于这一点，我已经写过很多文章介绍。</p>
<p>那么，RIA Service是使用什么binding呢？</p>
<p>请参考下面这篇文章</p>
<p><a href="http://weblogs.asp.net/fredriknormen/archive/2009/11/27/wcf-ria-services-binding-deep-dive.aspx">http://weblogs.asp.net/fredriknormen/archive/2009/11/27/wcf-ria-services-binding-deep-dive.aspx</a></p>