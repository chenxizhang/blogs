# Workflow Foundation 4.0中的事件驱动流程设计和应用（三） 
> 原文发表于 2010-10-07, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/10/07/1845164.html 


<p>前面两篇已经实现了最简单的基于事件的工作流程，用户可以在客户端（任意类型的客户端）发出流程操作的指令，通过WCF的通讯，驱动后台的工作流工作。</p> <p><a title="Workflow Foundation 4.0中的事件驱动流程设计和应用（一）" href="http://www.cnblogs.com/chenxizhang/archive/2010/10/07/1845104.html">Workflow Foundation 4.0中的事件驱动流程设计和应用（一）</a></p> <p>&nbsp;</p> <p>但之前的例子只有一个事件，就是“创建流程”的事件，显然这是不够的。这一篇就来把这个例子完善一下，通过这个练习之后，大家应该可以大致了解在WF4中如何设计基于事件的流程了</p> <p>我们将为这个流程添加一个“审批流程”的事件。</p> <p>本文代码，请通过 <a href="http://files.cnblogs.com/chenxizhang/WFEventDriven(3).rar" target="_blank">这里</a> 下载</p> <h1>1. 修改工作流设计</h1> <p>很显然地，我们会在下面添加另外一个Pick Activity，然后里面也添加一个Receive来实现事件监听</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_2.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb.png" width="476" height="425"></a></p> <p>&nbsp;</p> <p>同时，我们定义了三个变量用来接收用户传递过来的数据</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_8.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_3.png" width="758" height="221"></a></p> <p>&nbsp;</p> <p>我们在Receive上面设置了参数与这些变量之间的映射</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_10.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_4.png" width="704" height="504"></a></p> <p>一切看起来都还是挺自然的。请注意，这个Receive，因为是第二个事件，所以无需创建新的工作流实例（如果每个事件都创建新的实例，那就乱套了），也就是说CanCreateInstance不需要设置为true</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_12.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_5.png" width="390" height="408"></a></p> <p>&nbsp;</p> <p>这个工作流的xaml文件代码如下</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">Activity</span> <span class="attr">mc:Ignorable</span><span class="kwrd">="sap"</span> <span class="attr">x:Class</span><span class="kwrd">="DocumentReviewLib.DocumentReviewWorkflow"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="483,1245"</span> <span class="attr">mva:VisualBasic</span>.<span class="attr">Settings</span><span class="kwrd">="Assembly references and imported namespaces for internal implementation"</span> <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities"</span> <span class="attr">xmlns:mc</span><span class="kwrd">="http://schemas.openxmlformats.org/markup-compatibility/2006"</span> <span class="attr">xmlns:mv</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic;assembly=System"</span> <span class="attr">xmlns:mva</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"</span> <span class="attr">xmlns:p</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/servicemodel"</span> <span class="attr">xmlns:s</span><span class="kwrd">="clr-namespace:System;assembly=mscorlib"</span> <span class="attr">xmlns:s1</span><span class="kwrd">="clr-namespace:System;assembly=System"</span> <span class="attr">xmlns:s2</span><span class="kwrd">="clr-namespace:System;assembly=System.Xml"</span> <span class="attr">xmlns:s3</span><span class="kwrd">="clr-namespace:System;assembly=System.Core"</span> <span class="attr">xmlns:s4</span><span class="kwrd">="clr-namespace:System;assembly=System.ServiceModel"</span> <span class="attr">xmlns:sa</span><span class="kwrd">="clr-namespace:System.Activities;assembly=System.Activities"</span> <span class="attr">xmlns:sad</span><span class="kwrd">="clr-namespace:System.Activities.Debugger;assembly=System.Activities"</span> <span class="attr">xmlns:sap</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"</span> <span class="attr">xmlns:scg</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System"</span> <span class="attr">xmlns:scg1</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.ServiceModel"</span> <span class="attr">xmlns:scg2</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.Core"</span> <span class="attr">xmlns:scg3</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=mscorlib"</span> <span class="attr">xmlns:sd</span><span class="kwrd">="clr-namespace:System.Data;assembly=System.Data"</span> <span class="attr">xmlns:sl</span><span class="kwrd">="clr-namespace:System.Linq;assembly=System.Core"</span> <span class="attr">xmlns:ssa</span><span class="kwrd">="clr-namespace:System.ServiceModel.Activities;assembly=System.ServiceModel.Activities"</span> <span class="attr">xmlns:st</span><span class="kwrd">="clr-namespace:System.Text;assembly=mscorlib"</span> <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">Sequence</span> <span class="attr">DisplayName</span><span class="kwrd">="文档审批流程"</span> <span class="attr">sad:XamlDebuggerXmlReader</span>.<span class="attr">FileName</span><span class="kwrd">="d:\temp\WF4EventDrivenSolution\DocumentReviewLib\DocumentReviewWorkflow.xaml"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="443,1205"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">Sequence.Variables</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span> <span class="attr">Default</span><span class="kwrd">="-1"</span> <span class="attr">Name</span><span class="kwrd">="TicketId"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="p:CorrelationHandle"</span> <span class="attr">Name</span><span class="kwrd">="__handle1"</span> <span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Sequence.Variables</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">scg3:Dictionary</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String, x:Object"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">x:Boolean</span> <span class="attr">x:Key</span><span class="kwrd">="IsExpanded"</span><span class="kwrd">&gt;</span>True<span class="kwrd">&lt;/</span><span class="html">x:Boolean</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">scg3:Dictionary</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">Pick</span> <span class="attr">DisplayName</span><span class="kwrd">="文档创建"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="421,677"</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">PickBranch</span> <span class="attr">DisplayName</span><span class="kwrd">="用户提交了一个新的流程"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="307,631"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:Receive</span> <span class="attr">x:Name</span><span class="kwrd">="__ReferenceID0"</span> <span class="attr">CanCreateInstance</span><span class="kwrd">="True"</span> <span class="attr">DisplayName</span><span class="kwrd">="收到用户的消息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="277,100"</span> <span class="attr">OperationName</span><span class="kwrd">="CreateTicket"</span> <span class="attr">ServiceContractName</span><span class="kwrd">="IDocumentReview"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:Receive.CorrelationInitializers</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">p:RequestReplyCorrelationInitializer</span> <span class="attr">CorrelationHandle</span><span class="kwrd">="[__handle1]"</span> <span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:Receive.CorrelationInitializers</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:Receive</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">Sequence</span> <span class="attr">DisplayName</span><span class="kwrd">="事件响应"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="277,413"</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">scg3:Dictionary</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String, x:Object"</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">x:Boolean</span> <span class="attr">x:Key</span><span class="kwrd">="IsExpanded"</span><span class="kwrd">&gt;</span>True<span class="kwrd">&lt;/</span><span class="html">x:Boolean</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">scg3:Dictionary</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Assign</span> <span class="attr">DisplayName</span><span class="kwrd">="随机产生一个流程编号"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,58"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Assign.To</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>[TicketId]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">Assign.To</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Assign.Value</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">InArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>[New Random().Next()]<span class="kwrd">&lt;/</span><span class="html">InArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">Assign.Value</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">Assign</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:SendReply</span> <span class="attr">Request</span><span class="kwrd">="{x:Reference __ReferenceID0}"</span> <span class="attr">DisplayName</span><span class="kwrd">="SendReplyTo收到用户的消息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,90"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:SendMessageContent</span> <span class="attr">DeclaredMessageType</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">InArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>[TicketId]<span class="kwrd">&lt;/</span><span class="html">InArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:SendMessageContent</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:SendReply</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">WriteLine</span> <span class="attr">DisplayName</span><span class="kwrd">="输出信息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,61"</span> <span class="attr">Text</span><span class="kwrd">="[&amp;quot;流程被创建，编号为:&amp;quot; &amp;amp; TicketId]"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">Sequence</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">PickBranch</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Pick</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">Pick</span> <span class="attr">DisplayName</span><span class="kwrd">="文档审批"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="421,364"</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">PickBranch</span> <span class="attr">DisplayName</span><span class="kwrd">="经理审批"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="285,318"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">PickBranch.Variables</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">Name</span><span class="kwrd">="action"</span> <span class="kwrd">/&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">Name</span><span class="kwrd">="comment"</span> <span class="kwrd">/&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span> <span class="attr">Name</span><span class="kwrd">="reviewId"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">PickBranch.Variables</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:Receive</span> <span class="attr">DisplayName</span><span class="kwrd">="经理审批"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,100"</span> <span class="attr">OperationName</span><span class="kwrd">="UpdateTicket"</span> <span class="attr">ServiceContractName</span><span class="kwrd">="IDocumentReview"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:ReceiveParametersContent</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">x:Key</span><span class="kwrd">="action"</span><span class="kwrd">&gt;</span>[action]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">x:Key</span><span class="kwrd">="comment"</span><span class="kwrd">&gt;</span>[comment]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span> <span class="attr">x:Key</span><span class="kwrd">="id"</span><span class="kwrd">&gt;</span>[reviewId]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:ReceiveParametersContent</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:Receive</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">WriteLine</span> <span class="attr">DisplayName</span><span class="kwrd">="打印消息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,100"</span> <span class="attr">Text</span><span class="kwrd">="[String.Format(&amp;quot;Ticket update --- action : {0}, comment :{1} &amp;quot;, action, comment)]"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">PickBranch</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Pick</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">Sequence</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">Activity</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<h1>2. 更新客户端代码和设计</h1>
<p>工作流已经进行了修改，相应地，客户端代码也需要有一些更新</p>
<p>启动宿主程序，然后通过下面的方式再次得到客户端代码文件。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_14.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_6.png" width="681" height="446"></a></p>
<p>同样，我们只需要添加那个DocumentReviewWorkflow.cs到项目中来</p>
<p>&nbsp;</p>
<p>我们修改窗口如下，添加审批的工具按钮</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_16.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_7.png" width="567" height="366"></a></p>
<p>有关代码如下</p><pre class="csharpcode">        <span class="kwrd">private</span> <span class="kwrd">void</span> btApproval_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            <span class="rem">//同意某个流程</span>
            var action = <span class="str">"approval"</span>;
            UpdateTicket(action);

        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> UpdateTicket(<span class="kwrd">string</span> action)
        {
            <span class="kwrd">if</span> (lstTickets.SelectedIndex &gt; -1)
            {
                var id = <span class="kwrd">int</span>.Parse(lstTickets.SelectedItem.ToString());
                var comment = txtComment.Text;

                var proxy = <span class="kwrd">new</span> DocumentReviewClient();
                proxy.UpdateTicket(action, comment, id);

            }
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> btReject_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            var action = <span class="str">"Reject"</span>;
            UpdateTicket(action);
        }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>代码也是很好理解的，几乎无需特别的解释。</p>
<p>&nbsp;</p>
<h1>3. 调试程序</h1>
<p>&nbsp;</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_20.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_2.png" width="681" height="446"></a><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_18.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_1.png" width="519" height="336"></a></p>
<p>我几乎迫不及待地想要看一下效果了。选择某个Ticket之后，点击“同意”按钮，激动人心的时刻到了。晕，又是什么也没有发生。<img class="wlEmoticon wlEmoticon-angrysmile" alt="Angry smile" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/wlEmoticon-angrysmile_2.png"></p>
<p>你猜对了，这又是我预先埋下的一个“陷阱”。放心吧，如果那么容易做出来，我是不会专门写一篇来介绍的。</p>
<p>&nbsp;</p>
<h1>4.修改流程设计</h1>
<p>有点沮丧吗？其实大可不必。淡定，淡定</p>
<p>静下心来想一下，为什么它不能工作呢？很显然，客户端的请求是发送到了服务端的，那么就是说服务端不知道该怎么处理？这样解释是合理的吧。</p>
<p>那么服务端为什么不知道该怎么处理呢？你可能会说，我都告诉他TicketId了，为什么它不会找到那个Instance，然后触发里面的事件呢？</p>
<p>症结点就在于这里，你光是传递TicketId过来是不够的，还需要在工作流中将这个Id标识为一个上下文事件关联的依据。</p>
<p>还记得第二篇提到的CorrelationHandler吗？既然事件需要被定位到，那么它就需要有一定的机制可以区分。不同实例之间就是通过不同的CorrelationHandler来区别的。</p>
<p>&nbsp;</p>
<p>那么，我们既然想让UpdateTicket事件与相应的CreateTicket事件所创建的那个实例关联起来，就需要定义一个特殊的Handler。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_22.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_8.png" width="736" height="121"></a></p>
<p>注意，这个__handler是我们定义的，而上面的那个__handler1是之前第二个练习时自动创建的</p>
<p>&nbsp;</p>
<p>接下来，我们需要对这个handler进行初始化。这个可以通过一个InitializeCorrelation的Activity来完成</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_28.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_11.png" width="357" height="356"></a></p>
<p>我们让这个初始化好的handler具有一个属性，Id，保存当前这个TicketId</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_26.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_10.png" width="454" height="254"></a></p>
<p>&nbsp;</p>
<p>然后，我们修改”UpdateTicket”这个事件</p>
<p>&nbsp;</p>
<p>设置CorrelatesWith属性</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_30.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_12.png" width="354" height="189"></a></p>
<p>设置CorrelatesOn属性</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_32.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_13.png" width="454" height="254"></a></p>
<p>这个设置，也就是说，让UpdateTicket方法传入的id参数，自动作为查找CorrelationHandler的依据</p>
<p><font color="#ff0000" size="4"><strong>【注意】这一步至关重要</strong></font></p>
<p>&nbsp;</p>
<p>保存流程，编译即可。因为这种更改，不涉及到与客户端的合约更改，所以无需重新生成客户端代码。这也是用WF来做流程设计的好处之一。</p>
<p>最终版xaml如下</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">Activity</span> <span class="attr">mc:Ignorable</span><span class="kwrd">="sap"</span> <span class="attr">x:Class</span><span class="kwrd">="DocumentReviewLib.DocumentReviewWorkflow"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="483,1378"</span> <span class="attr">mva:VisualBasic</span>.<span class="attr">Settings</span><span class="kwrd">="Assembly references and imported namespaces for internal implementation"</span> <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities"</span> <span class="attr">xmlns:mc</span><span class="kwrd">="http://schemas.openxmlformats.org/markup-compatibility/2006"</span> <span class="attr">xmlns:mv</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic;assembly=System"</span> <span class="attr">xmlns:mva</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"</span> <span class="attr">xmlns:p</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/servicemodel"</span> <span class="attr">xmlns:s</span><span class="kwrd">="clr-namespace:System;assembly=mscorlib"</span> <span class="attr">xmlns:s1</span><span class="kwrd">="clr-namespace:System;assembly=System"</span> <span class="attr">xmlns:s2</span><span class="kwrd">="clr-namespace:System;assembly=System.Xml"</span> <span class="attr">xmlns:s3</span><span class="kwrd">="clr-namespace:System;assembly=System.Core"</span> <span class="attr">xmlns:s4</span><span class="kwrd">="clr-namespace:System;assembly=System.ServiceModel"</span> <span class="attr">xmlns:sa</span><span class="kwrd">="clr-namespace:System.Activities;assembly=System.Activities"</span> <span class="attr">xmlns:sad</span><span class="kwrd">="clr-namespace:System.Activities.Debugger;assembly=System.Activities"</span> <span class="attr">xmlns:sap</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"</span> <span class="attr">xmlns:scg</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System"</span> <span class="attr">xmlns:scg1</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.ServiceModel"</span> <span class="attr">xmlns:scg2</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.Core"</span> <span class="attr">xmlns:scg3</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=mscorlib"</span> <span class="attr">xmlns:sd</span><span class="kwrd">="clr-namespace:System.Data;assembly=System.Data"</span> <span class="attr">xmlns:sl</span><span class="kwrd">="clr-namespace:System.Linq;assembly=System.Core"</span> <span class="attr">xmlns:ssa</span><span class="kwrd">="clr-namespace:System.ServiceModel.Activities;assembly=System.ServiceModel.Activities"</span> <span class="attr">xmlns:ssx</span><span class="kwrd">="clr-namespace:System.ServiceModel.XamlIntegration;assembly=System.ServiceModel"</span> <span class="attr">xmlns:st</span><span class="kwrd">="clr-namespace:System.Text;assembly=mscorlib"</span> <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">Sequence</span> <span class="attr">DisplayName</span><span class="kwrd">="文档审批流程"</span> <span class="attr">sad:XamlDebuggerXmlReader</span>.<span class="attr">FileName</span><span class="kwrd">="d:\temp\WF4EventDrivenSolution\DocumentReviewLib\DocumentReviewWorkflow.xaml"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="443,1338"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">Sequence.Variables</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span> <span class="attr">Default</span><span class="kwrd">="-1"</span> <span class="attr">Name</span><span class="kwrd">="TicketId"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="p:CorrelationHandle"</span> <span class="attr">Name</span><span class="kwrd">="__handle1"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="p:CorrelationHandle"</span> <span class="attr">Name</span><span class="kwrd">="__handler"</span> <span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Sequence.Variables</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">scg3:Dictionary</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String, x:Object"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">x:Boolean</span> <span class="attr">x:Key</span><span class="kwrd">="IsExpanded"</span><span class="kwrd">&gt;</span>True<span class="kwrd">&lt;/</span><span class="html">x:Boolean</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">scg3:Dictionary</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">Pick</span> <span class="attr">DisplayName</span><span class="kwrd">="文档创建"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="421,810"</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">PickBranch</span> <span class="attr">DisplayName</span><span class="kwrd">="用户提交了一个新的流程"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="307,764"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:Receive</span> <span class="attr">x:Name</span><span class="kwrd">="__ReferenceID0"</span> <span class="attr">CanCreateInstance</span><span class="kwrd">="True"</span> <span class="attr">DisplayName</span><span class="kwrd">="收到用户的消息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="277,100"</span> <span class="attr">OperationName</span><span class="kwrd">="CreateTicket"</span> <span class="attr">ServiceContractName</span><span class="kwrd">="IDocumentReview"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:Receive.CorrelationInitializers</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">p:RequestReplyCorrelationInitializer</span> <span class="attr">CorrelationHandle</span><span class="kwrd">="[__handle1]"</span> <span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:Receive.CorrelationInitializers</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:Receive</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">Sequence</span> <span class="attr">DisplayName</span><span class="kwrd">="事件响应"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="277,546"</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">scg3:Dictionary</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String, x:Object"</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">x:Boolean</span> <span class="attr">x:Key</span><span class="kwrd">="IsExpanded"</span><span class="kwrd">&gt;</span>True<span class="kwrd">&lt;/</span><span class="html">x:Boolean</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">scg3:Dictionary</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">sap:WorkflowViewStateService.ViewState</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Assign</span> <span class="attr">DisplayName</span><span class="kwrd">="随机产生一个流程编号"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,58"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Assign.To</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>[TicketId]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">Assign.To</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Assign.Value</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">InArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>[New Random().Next()]<span class="kwrd">&lt;/</span><span class="html">InArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">Assign.Value</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">Assign</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:InitializeCorrelation</span> <span class="attr">Correlation</span><span class="kwrd">="[__handler]"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,93"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">InArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">x:Key</span><span class="kwrd">="Id"</span><span class="kwrd">&gt;</span>[TicketId.ToString()]<span class="kwrd">&lt;/</span><span class="html">InArgument</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:InitializeCorrelation</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:SendReply</span> <span class="attr">Request</span><span class="kwrd">="{x:Reference __ReferenceID0}"</span> <span class="attr">DisplayName</span><span class="kwrd">="SendReplyTo收到用户的消息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,90"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:SendMessageContent</span> <span class="attr">DeclaredMessageType</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">InArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span><span class="kwrd">&gt;</span>[TicketId]<span class="kwrd">&lt;/</span><span class="html">InArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:SendMessageContent</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:SendReply</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">WriteLine</span> <span class="attr">DisplayName</span><span class="kwrd">="输出信息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,61"</span> <span class="attr">Text</span><span class="kwrd">="[&amp;quot;流程被创建，编号为:&amp;quot; &amp;amp; TicketId]"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">Sequence</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">PickBranch</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Pick</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">Pick</span> <span class="attr">DisplayName</span><span class="kwrd">="文档审批"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="421,364"</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">PickBranch</span> <span class="attr">DisplayName</span><span class="kwrd">="经理审批"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="285,318"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">PickBranch.Variables</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">Name</span><span class="kwrd">="action"</span> <span class="kwrd">/&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">Name</span><span class="kwrd">="comment"</span> <span class="kwrd">/&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">Variable</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span> <span class="attr">Name</span><span class="kwrd">="reviewId"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">PickBranch.Variables</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">p:Receive</span> <span class="attr">CorrelatesWith</span><span class="kwrd">="[__handler]"</span> <span class="attr">DisplayName</span><span class="kwrd">="经理审批"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,100"</span> <span class="attr">OperationName</span><span class="kwrd">="UpdateTicket"</span> <span class="attr">ServiceContractName</span><span class="kwrd">="IDocumentReview"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:Receive.CorrelatesOn</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">p:XPathMessageQuery</span> <span class="attr">x:Key</span><span class="kwrd">="Id"</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">p:XPathMessageQuery.Namespaces</span><span class="kwrd">&gt;</span>
                  <span class="kwrd">&lt;</span><span class="html">ssx:XPathMessageContextMarkup</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">x:String</span> <span class="attr">x:Key</span><span class="kwrd">="xgSc"</span><span class="kwrd">&gt;</span>http://tempuri.org/<span class="kwrd">&lt;/</span><span class="html">x:String</span><span class="kwrd">&gt;</span>
                  <span class="kwrd">&lt;/</span><span class="html">ssx:XPathMessageContextMarkup</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">p:XPathMessageQuery.Namespaces</span><span class="kwrd">&gt;</span>sm:body()/xgSc:UpdateTicket/xgSc:id<span class="kwrd">&lt;/</span><span class="html">p:XPathMessageQuery</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:Receive.CorrelatesOn</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">p:ReceiveParametersContent</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">x:Key</span><span class="kwrd">="action"</span><span class="kwrd">&gt;</span>[action]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:String"</span> <span class="attr">x:Key</span><span class="kwrd">="comment"</span><span class="kwrd">&gt;</span>[comment]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
              <span class="kwrd">&lt;</span><span class="html">OutArgument</span> <span class="attr">x:TypeArguments</span><span class="kwrd">="x:Int32"</span> <span class="attr">x:Key</span><span class="kwrd">="id"</span><span class="kwrd">&gt;</span>[reviewId]<span class="kwrd">&lt;/</span><span class="html">OutArgument</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">p:ReceiveParametersContent</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">p:Receive</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">PickBranch.Trigger</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">WriteLine</span> <span class="attr">DisplayName</span><span class="kwrd">="打印消息"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="255,100"</span> <span class="attr">Text</span><span class="kwrd">="[String.Format(&amp;quot;Ticket update --- Ticketid :{0} , action : {1}, comment :{2} &amp;quot;, reviewId, action, comment)]"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">PickBranch</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Pick</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">Sequence</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">Activity</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<h1>5.测试程序</h1>
<p>发起流程后，分别选择不同的编号，进行审批。结果如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_34.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/Workflow-Foundation-4.0_D5A0/image_thumb_14.png" width="681" height="446"></a></p>
<p>大功告成，收工</p>
<p>&nbsp;</p>
<p>总结：</p>
<p>&nbsp;</p>
<p>利用WF 4的全新框架，可以快速设计基于事件驱动的工作流。它提高了开发效率，简化了开发流程，而更重要的是，这对于广大开发人员的身心健康有着很有益地帮助</p>
<p>&nbsp;</p>
<p>本文代码，请通过 <a href="http://files.cnblogs.com/chenxizhang/WFEventDriven(3).rar" target="_blank">这里</a> 下载</p>