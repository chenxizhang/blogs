# MVC 2中HandleErrorFilter的问题及其解决方法 
> 原文发表于 2010-10-23, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/10/23/1858848.html 


<p>近日在使用MVC2的异常处理的时候，遇到一些问题</p> <p>1. 我们的Error.aspx是没有使用MasterPage</p> <p>2.通过如下代码测试</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Web;
<span class="kwrd">using</span> System.Web.Mvc;

<span class="kwrd">namespace</span> MvcApplication1.Controllers
{
    [HandleError]
    <span class="kwrd">public</span> <span class="kwrd">class</span> HomeController : Controller
    {
        <span class="kwrd">public</span> ActionResult Index()
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> ApplicationException();

        }

        <span class="kwrd">public</span> ActionResult About()
        {
            <span class="kwrd">return</span> View();
        }

        <span class="kwrd">public</span> ActionResult Test()
        {
            <span class="kwrd">return</span> View(<span class="str">"Error"</span>);
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>我们发现会遇到500错误</p>
<p><a href="http://www.xizhang.com/blogimages/4d5a81d0aa6f_6CC9/image.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/4d5a81d0aa6f_6CC9/image_thumb.png" width="1028" height="724"></a></p>
<p>通过工具，我看到下面代码</p>
<p><a href="http://www.xizhang.com/blogimages/4d5a81d0aa6f_6CC9/image_3.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/4d5a81d0aa6f_6CC9/image_thumb_3.png" width="839" height="580"></a></p>
<p>其实要讲起来，应该后面三句代码是多余的</p>
<p>【备注】如果Error.aspx是有MasterPage的时候，又不会出错，这倒是很奇怪的。</p>
<p>&nbsp;</p>
<p>这样的话，其实我们可以定义一个自己的Handler，下面这个例子，我只是把Master的属性和后面三行删除掉了。这样问题就解决了，不管有没有MasterPage，也不管是什么异常都能被Handle了</p>
<p>&nbsp;</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Web;
<span class="kwrd">using</span> System.Web.Mvc;

<span class="kwrd">namespace</span> MvcApplication1
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> MyErrorHandler:ActionFilterAttribute,IExceptionFilter
    {
        <span class="kwrd">public</span> MyErrorHandler()
        {
            View = <span class="str">"Error"</span>;
        }
        <span class="kwrd">public</span> <span class="kwrd">void</span> OnException(ExceptionContext filterContext)
        {
            <span class="kwrd">string</span> controllerName = (<span class="kwrd">string</span>)filterContext.RouteData.Values[<span class="str">"controller"</span>];
            <span class="kwrd">string</span> actionName = (<span class="kwrd">string</span>)filterContext.RouteData.Values[<span class="str">"action"</span>];
            HandleErrorInfo model = <span class="kwrd">new</span> HandleErrorInfo(filterContext.Exception, controllerName, actionName);
            ViewResult result = <span class="kwrd">new</span> ViewResult();
            result.ViewName = <span class="kwrd">this</span>.View;
            result.ViewData = <span class="kwrd">new</span> ViewDataDictionary&lt;HandleErrorInfo&gt;(model);
            result.TempData = filterContext.Controller.TempData;
            filterContext.Result = result;
            filterContext.ExceptionHandled = <span class="kwrd">true</span>;

        }

        <span class="kwrd">public</span> <span class="kwrd">string</span> View { get; set; }
    }
}</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>