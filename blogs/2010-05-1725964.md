# MOSS 2010:Visual Studio 2010开发体验（25）&mdash;&mdash;编写自定义的BCS连接器（续） 
> 原文发表于 2010-05-02, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/05/02/1725964.html 


<p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/05/01/1725711.html">上一篇</a>我讲解到了如何在Visual Studio 2010中编写自定义的BCS连接器来实现更加灵活的应用程序集成。在那篇文章，我主要讲解了有关的概念，并且做了一个最简单的模型，发布之后能够使用它。</p> <p>这一篇，我们继续来实现一个更加有现实意义的 BCS 连接器。我们需要读取的数据仍然是有关员工信息的。</p> <p>我们希望员工实体拥有如下的信息</p> <ul> <li>ID  <li>FirstName  <li>LastName  <li>Age</li></ul> <p>&nbsp;</p> <p>【提示】通过跟随本文做练习，你将学会如何设计一个自己的业务实体模型。</p> <p>【注意】不要小看这个步骤，我之前就提到过，自定义BCS模型这个小工具其实还有值得改进的地方。目前的情况是一不小心就会出错。所以，最好按照我的步骤来做练习。这个步骤是我总结出来的最佳实践，你可以先做完练习，然后对某些步骤的细节做一些进一步的学习</p> <p>&nbsp;</p> <h2>1. 创建一个空白SharePoint项目</h2> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_41.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_3.png" width="1044" height="810"></a> </p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_61.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_8.png" width="1044" height="810"></a> </p> <h2>2. 添加一个BDC模型</h2> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_63.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_20.png" width="1044" height="810"></a> </p> <h2>3. 修改业务实体（Entity）</h2> <p>所谓实体就是在BDC服务中交换的数据格式。例如我们要处理员工数据，这就是一个实体。项目模板默认生成的实体类型如下（Entity1.cs)</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_65.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_30.png" width="1044" height="810"></a> </p> <p>将代码修改为下面这样</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">namespace</span> BDC.Northwind.EmployeeModel
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// This class contains the properties for Entity1. The properties keep the data for Entity1.</span>
    <span class="rem">/// If you want to rename the class, don't forget to rename the entity in the model xml as well.</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Employee
    {
        <span class="rem">//TODO: Implement additional properties here. The property Message is just a sample how a property could look like.</span>
        <span class="kwrd">public</span> <span class="kwrd">int</span> EmployeeID { get; set; }
        <span class="kwrd">public</span> <span class="kwrd">string</span> FirstName { get; set; }
        <span class="kwrd">public</span> <span class="kwrd">string</span> LastName { get; set; }
        <span class="kwrd">public</span> <span class="kwrd">int</span> Age { get; set; }
    }
}
<a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_67.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_31.png" width="1044" height="810"></a> </pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<h2>4. 修改服务类型(Service)</h2>
<p>实体只是数据,但谁来接受请求并且处理,然后返回数据呢?这就是服务的概念. 默认生成的那个 Entity1Service.cs就是服务所在的文件。它现在看起来是下面这样的</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_69.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_32.png" width="1044" height="810"></a> </p>
<p>将代码修改如下</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">namespace</span> BDC.Northwind.EmployeeModel
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// All the methods for retrieving, updating and deleting data are implemented in this class file.</span>
    <span class="rem">/// The samples below show the finder and specific finder method for Entity1.</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> EmployeeService
    {

        <span class="kwrd">static</span> List&lt;Employee&gt; GetEmployees()
        {
            <span class="kwrd">return</span> <span class="kwrd">new</span> List&lt;Employee&gt;(){
                <span class="kwrd">new</span> Employee(){
                    EmployeeID=1,
                    FirstName=<span class="str">"ares"</span>,
                    LastName=<span class="str">"chen"</span>,
                    Age=20
                },
                <span class="kwrd">new</span> Employee(){
                    EmployeeID=2,
                    FirstName=<span class="str">"bill"</span>,
                    LastName=<span class="str">"gates"</span>,
                    Age=20
                },
                <span class="kwrd">new</span> Employee(){
                    EmployeeID=3,
                    FirstName=<span class="str">"steve"</span>,
                    LastName=<span class="str">"ballmer"</span>,
                    Age=20
                }
            };
        }

        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// This is a sample specific finder method for Entity1.</span>
        <span class="rem">/// If you want to delete or rename the method think about changing the xml in the BDC model file as well.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="id"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;returns&gt;Entity1&lt;/returns&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">static</span> Employee ReadItem(<span class="kwrd">int</span> id)
        {
            <span class="kwrd">return</span> GetEmployees().FirstOrDefault(e =&gt; e.EmployeeID == id);
        }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// This is a sample finder method for Entity1.</span>
        <span class="rem">/// If you want to delete or rename the method think about changing the xml in the BDC model file as well.</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;IEnumerable of Entities&lt;/returns&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">static</span> IEnumerable&lt;Employee&gt; ReadList()
        {
            <span class="kwrd">return</span> GetEmployees();
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
上述代码中，我们先用一个静态的函数模拟了一个读取所有员工的操作，它是返回了三个员工的数据。很明显，这三位都是赫赫有名的大人物<a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/%E6%9C%AA%E5%91%BD%E5%90%8D_2.gif" class="thickbox"><img title="未命名" border="0" alt="未命名" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/%E6%9C%AA%E5%91%BD%E5%90%8D_thumb.gif" width="100" height="100"></a> </p>
<p>然后，我们让ReadItem和ReadList方法有了更加好的实现。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_71.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_33.png" width="1044" height="810"></a> </p>
<p>&nbsp;</p>
<h2>5. 修改模型定义（EmployeeModel.bdcm)</h2>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_73.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_34.png" width="1044" height="810"></a> </p>
<p>首先将Entity1重命名为Employee</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_75.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_35.png" width="1044" height="810"></a> </p>
<p>【注意】如果你注意观察的话，原先的那个Entity1Service.cs文件也被重命名为了EmployeeService.cs</p>
<p>接下来，我们需要将它的Identifier1修改为EmployeeID</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_77.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_36.png" width="1044" height="810"></a> </p>
<p>接下来，我们需要切换到BDC Explorer来完成进一步的修改。如果你没有看到BDC Explorer，那么可以通过View==&gt;Other Window==&gt;BDC Explorer打开它</p>
<p>为了方便修改，请将IDE调整为下面这样</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_79.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_37.png" width="1044" height="810"></a> </p>
<p>我们要将它修改成下面这样。（这里的步骤很繁琐，我就不全部截图了。基本上都是在属性窗口中做设置，要特别注意的是TypeName的设置）</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_81.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_38.png" width="1044" height="810"></a> </p>
<p>【注意】原先的Message直接修改Name为FirstName</p>
<p>而LastName和Age是我们通过下面的方式添加的</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_83.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_39.png" width="704" height="530"></a> </p>
<p>&nbsp;</p>
<h2>6. 编译项目并且部署（确保没有任何错误）</h2>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_85.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_40.png" width="704" height="530"></a> </p>
<h2>7. 验证和使用该模型</h2>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_87.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_41.png" width="1044" height="810"></a> </p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_89.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_42.png" width="1044" height="810"></a> </p>
<p>点击“Create Lists &amp; Form”按钮</p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_91.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_43.png" width="1044" height="810"></a> </p>
<p>最后，我们就可以在网站中看到下面这个列表了</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_93.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_44.png" width="1044" height="810"></a> </p>
<p></p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_95.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201025BCS_AE75/image_thumb_45.png" width="1044" height="810"></a> </p>
<p>&nbsp;</p>
<p>总结：这一篇文章我讲解了如何实现自定义BDC模型。其实这个工作并不难，但却是比较繁琐的，而且容易出错。</p>
<p>我不确信每个人都能通过看一遍就学会如何做，所以如果你实在遇到了问题，也可以通过下面地址下载范例代码</p>
<p><a title="http://files.cnblogs.com/chenxizhang/BDC_Northwind.rar" href="http://files.cnblogs.com/chenxizhang/BDC_Northwind.rar">http://files.cnblogs.com/chenxizhang/BDC_Northwind.rar</a></p>