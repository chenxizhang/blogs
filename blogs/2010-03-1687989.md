# 如何实现多文件下载（实例） 
> 原文发表于 2010-03-17, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/03/17/1687989.html 


<p>有网友看了我之前喜写的多文件下载的文章，想自己实现一个类似的。但遇到困难。我这里准备了一个可以参考的完整的例子。其实不难，我希望这位朋友还是要把基础功夫学好。</p> <p>&nbsp;</p> <p>1. 页面</p><pre class="csharpcode"><span class="asp">&lt;%@ Page Language="C#" AutoEventWireup="true" CodeBehind="Default.aspx.cs" Inherits="MultipleFileDownLoadSample._Default" %&gt;</span>

<span class="kwrd">&lt;!</span><span class="html">DOCTYPE</span> <span class="attr">html</span> <span class="attr">PUBLIC</span> <span class="kwrd">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span> <span class="kwrd">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">html</span> <span class="attr">xmlns</span><span class="kwrd">="http://www.w3.org/1999/xhtml"</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">head</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">title</span><span class="kwrd">&gt;&lt;/</span><span class="html">title</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">head</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">body</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">form</span> <span class="attr">id</span><span class="kwrd">="form1"</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">div</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">asp:Button</span> <span class="attr">ID</span><span class="kwrd">="btDownload"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">Text</span><span class="kwrd">="下载"</span> <span class="attr">onclick</span><span class="kwrd">="btDownload_Click"</span> 
            <span class="attr">style</span><span class="kwrd">="height: 26px"</span> <span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">hr</span> <span class="kwrd">/&gt;</span>
    
        <span class="kwrd">&lt;</span><span class="html">asp:GridView</span> <span class="attr">ID</span><span class="kwrd">="gv"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">AutoGenerateColumns</span><span class="kwrd">="false"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Columns</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">asp:TemplateField</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">ItemTemplate</span><span class="kwrd">&gt;</span>
                        <span class="kwrd">&lt;</span><span class="html">asp:CheckBox</span> <span class="attr">ID</span><span class="kwrd">="chk"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="kwrd">/&gt;</span>
                    <span class="kwrd">&lt;/</span><span class="html">ItemTemplate</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">asp:TemplateField</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">asp:TemplateField</span> <span class="attr">HeaderText</span><span class="kwrd">="文件名"</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;</span><span class="html">ItemTemplate</span><span class="kwrd">&gt;</span>
                        <span class="kwrd">&lt;</span><span class="html">asp:Label</span> <span class="attr">ID</span><span class="kwrd">="file"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">Text</span><span class="kwrd">='&lt;%# Eval("FileName") %&gt;'</span><span class="kwrd">&gt;&lt;/</span><span class="html">asp:Label</span><span class="kwrd">&gt;</span>
                    <span class="kwrd">&lt;/</span><span class="html">ItemTemplate</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;/</span><span class="html">asp:TemplateField</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">Columns</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">asp:GridView</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">div</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">form</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">body</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">html</span><span class="kwrd">&gt;</span>
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>2. 代码</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Web;
<span class="kwrd">using</span> System.Web.UI;
<span class="kwrd">using</span> System.Web.UI.WebControls;

<span class="kwrd">using</span> System.IO;
<span class="kwrd">using</span> ICSharpCode.SharpZipLib.Zip;

<span class="kwrd">namespace</span> MultipleFileDownLoadSample
{
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> _Default : System.Web.UI.Page
    {
        <span class="kwrd">protected</span> <span class="kwrd">void</span> Page_Load(<span class="kwrd">object</span> sender, EventArgs e)
        {
            <span class="kwrd">if</span> (!IsPostBack) {
                DataBind();
            }
        }
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> DataBind()
        {
            <span class="rem">//读取images目录下面的文件列表，绑定到GridView上面</span>
            var query = from item <span class="kwrd">in</span> Directory.GetFiles(Server.MapPath(<span class="str">"~/images"</span>))
                        select <span class="kwrd">new</span>
                        {
                            FileName = Path.GetFileName(item)
                        };

            gv.DataSource = query;
            gv.DataBind();
        }


        <span class="kwrd">private</span> <span class="kwrd">void</span> Download(IEnumerable&lt;<span class="kwrd">string</span>&gt; files,<span class="kwrd">string</span> zipFileName ){
            <span class="rem">//根据所选文件打包下载</span>
            MemoryStream ms = <span class="kwrd">new</span> MemoryStream();
            <span class="kwrd">byte</span>[] buffer = <span class="kwrd">null</span>;

            <span class="kwrd">using</span> (ZipFile file = ZipFile.Create(ms))
            {
                file.BeginUpdate();
                file.NameTransform = <span class="kwrd">new</span> MyNameTransfom();<span class="rem">//通过这个名称格式化器，可以将里面的文件名进行一些处理。默认情况下，会自动根据文件的路径在zip中创建有关的文件夹。</span>

                <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> files)
                {
                    file.Add(Server.MapPath(<span class="kwrd">string</span>.Format(<span class="str">"~/images/{0}"</span>,item)));
                }


                file.CommitUpdate();

                buffer = <span class="kwrd">new</span> <span class="kwrd">byte</span>[ms.Length];
                ms.Position = 0;
                ms.Read(buffer, 0, buffer.Length);
            }


            Response.AddHeader(<span class="str">"content-disposition"</span>, <span class="str">"attachment;filename="</span>+zipFileName);
            Response.BinaryWrite(buffer);
            Response.Flush();
            Response.End();
        }

        <span class="kwrd">protected</span> <span class="kwrd">void</span> btDownload_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            <span class="rem">//根据复选框的选中状态，将多个文件打包下载</span>
            List&lt;<span class="kwrd">string</span>&gt; files = <span class="kwrd">new</span> List&lt;<span class="kwrd">string</span>&gt;();
            <span class="kwrd">foreach</span> (GridViewRow item <span class="kwrd">in</span> gv.Rows)
            {
                var chk = item.FindControl(<span class="str">"chk"</span>) <span class="kwrd">as</span> CheckBox;
                <span class="kwrd">if</span> (chk.Checked)
                {
                    var label = item.FindControl(<span class="str">"file"</span>) <span class="kwrd">as</span> Label;
                    files.Add(label.Text);
                }
            }

            Download(files, <span class="str">"Test.zip"</span>);
        }
    }

    <span class="kwrd">public</span> <span class="kwrd">class</span> MyNameTransfom : ICSharpCode.SharpZipLib.Core.INameTransform
    {

        <span class="preproc">#region</span> INameTransform 成员

        <span class="kwrd">public</span> <span class="kwrd">string</span> TransformDirectory(<span class="kwrd">string</span> name)
        {
            <span class="kwrd">return</span> <span class="kwrd">null</span>;
        }

        <span class="kwrd">public</span> <span class="kwrd">string</span> TransformFile(<span class="kwrd">string</span> name)
        {
            <span class="kwrd">return</span> Path.GetFileName(name);
        }

        <span class="preproc">#endregion</span>
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>3. 效果</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/89feafbd55cf_A737/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/89feafbd55cf_A737/image_thumb.png" width="871" height="610"></a> </p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/89feafbd55cf_A737/image_4.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/89feafbd55cf_A737/image_thumb_1.png" width="811" height="571"></a> </p>
<p>&nbsp;</p>
<p>4. 源文件</p>
<p></p>
<p><a title="MultipleFileDownLoadSample.rar" href="http://files.cnblogs.com/chenxizhang/MultipleFileDownLoadSample.rar">MultipleFileDownLoadSample.rar</a></p>