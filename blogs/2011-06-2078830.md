# 再谈谈ADO.NET Data Service 数据格式(xml和json） 
> 原文发表于 2011-06-12, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/06/12/2078830.html 


<p>去年的时候，我写过一篇文章，介绍如何让ADO.NET Data Service返回json数据格式。如果有兴趣，可以参考下面这个链接</p> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/10/27/1862898.html">http://www.cnblogs.com/chenxizhang/archive/2010/10/27/1862898.html</a></p> <p>&nbsp;</p> <p>近日被网友问起，为什么这个成熟的框架（ADO.NET Data Service, 现在新版本里面叫WCF Data Service)，居然还需要用自定义的Behavior来改变这种输出格式。</p> <p>事实上，我认为这个问题问得很好，有些事情多问几个为什么，真相将会显现。</p> <p>&nbsp;</p> <p>那么，我们来多问几个问题</p> <h2>1. 什么是json</h2> <p>json的全称是指Javascript object notation, 这种数据格式顾名思义，是用于Javascript的一种原生的数据格式，它一方面较之xml或者html，有体积小的优点，同时它最适合javascript对其进行解析和处理</p> <p>&nbsp;</p> <h2>2. 为什么ADO.NET Data Service需要支持json</h2> <p>ADO.NET Data Service作为一种服务，它可能被广泛用于各种业务场景，我们可能通过客户端程序来访问它，也可能通过javascript来访问它。既然希望在javascript中访问该服务，那么最好是能支持json格式。</p> <h2>3. ADO.NET Data Service如何支持json</h2> <p>其实这是内置支持的。去年写的那个文章是一个做法，本文在此基础上再一步地澄清一些技术点，给大家参考</p> <p>&nbsp;</p> <p>为了做演示，我准备了一个简单的项目</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309376086.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309373087.png" width="919" height="727"></a></p> <p>本例中，我采用LINQ to SQL作为数据模型，访问了Northwind数据库的Customers表</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309372564.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309382597.png" width="919" height="727"></a></p> <p>同时，我添加了一个最简单的Data Service</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309382630.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309388759.png" width="919" height="727"></a></p> <p>【备注】以上步骤如果你不清楚，请通过<a href="http://msdn.microsoft.com/en-us/library/cc907912.aspx">http://msdn.microsoft.com/en-us/library/cc907912.aspx</a> 进行一些基础的学习</p> <p>&nbsp;</p> <p>该服务运行起来之后的效果如下</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309381824.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309398792.png" width="926" height="367"></a></p> <p>如果我们访问Customers这个实体集合，则会有下面的结果</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309394681.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309393285.png" width="1028" height="732"></a></p> <p>我们看到，它默认是用XML（准确地说，是用Atom）格式返回数据的。</p> <p>&nbsp;</p> <p>好吧，我们回到原始的问题，那么如何返回json格式的数据呢？<a href="http://www.cnblogs.com/chenxizhang/archive/2010/10/27/1862898.html">http://www.cnblogs.com/chenxizhang/archive/2010/10/27/1862898.html</a> 这篇文章确实提供了一个做法，但事实上真的需要这么做吗？</p> <p>&nbsp;</p> <p>既然我们是要在javascript中访问服务，才需要json格式的数据，那么我们就用javascript来访问一下该服务，看看到底会怎么样？</p> <p>下面的例子，我用了最喜欢的jquery来编写脚本</p><pre class="csharpcode"><span class="asp">&lt;%@ Page Title="Home Page" Language="C#" MasterPageFile="~/Site.master" AutoEventWireup="true"
    CodeBehind="Default.aspx.cs" Inherits="WebApplication1._Default" %&gt;</span>

<span class="kwrd">&lt;</span><span class="html">asp:Content</span> <span class="attr">ID</span><span class="kwrd">="HeaderContent"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">ContentPlaceHolderID</span><span class="kwrd">="HeadContent"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">script</span> <span class="attr">src</span><span class="kwrd">="Scripts/jquery-1.4.1.min.js"</span> <span class="attr">type</span><span class="kwrd">="text/javascript"</span><span class="kwrd">&gt;&lt;/</span><span class="html">script</span><span class="kwrd">&gt;</span>
    &lt;script language=<span class="str">"javascript"</span> type=<span class="str">"text/javascript"</span>&gt;
        $(<span class="kwrd">function</span> () {

            <span class="kwrd">var</span> url = <span class="str">"NorthwindService.svc/Customers"</span>;
            $.getJSON(url, <span class="kwrd">null</span>, <span class="kwrd">function</span> (data) {
                <span class="kwrd">var</span> table = $(<span class="str">"&lt;table /&gt;"</span>);

                $(data.d).each(<span class="kwrd">function</span> () {
                    <span class="kwrd">var</span> tr = $(<span class="str">"&lt;tr /&gt;"</span>);
                    $(<span class="str">"&lt;td /&gt;"</span>).text(<span class="kwrd">this</span>.CompanyName).appendTo(tr);
                    tr.appendTo(table);
                });

                table.appendTo($(<span class="str">"#jsonHolder"</span>));

            });

        });

    <span class="kwrd">&lt;/</span><span class="html">script</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">asp:Content</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">asp:Content</span> <span class="attr">ID</span><span class="kwrd">="BodyContent"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">ContentPlaceHolderID</span><span class="kwrd">="MainContent"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">div</span> <span class="attr">id</span><span class="kwrd">="jsonHolder"</span><span class="kwrd">&gt;</span>
        <span class="rem">&lt;!--这里通过json请求的方式读取Data Service，并且进行布局--&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">div</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">asp:Content</span><span class="kwrd">&gt;</span>
</pre>
<p>也就是说，我们只要在jquery中通过getJSON方法发起请求就可以了。通过Fiddler工具监控，我们看到Request里面其实有一个格式设置：application/json</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309395794.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309394714.png" width="589" height="203"></a></p>
<p>监控到的回复如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309398858.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309399415.png" width="941" height="689"></a></p>
<p>展现在页面上面的效果如下</p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309407321.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/20110612130940942.png" width="1028" height="732"></a></p>
<p>如此看来，<strong><font color="#ff0000">ADO.NET Data Service内置就是支持json格式的，重点就在于客户端发起请求的时候，指定需要返回json格式</font></strong>即可。</p>
<p>&nbsp;</p>
<p>那么，我们可以将话题再延伸一下，如果在一个普通的客户端程序中，也想返回json格式的数据的话，该怎么办呢？</p>
<p>其实也很简单，我们可以在发起请求的时候，指定要使用json格式返回数据，如下是一个简单的例子</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> System.Net;


<span class="kwrd">namespace</span> ConsoleApplication
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var url = <span class="str">"http://localhost:9458/NorthwindService.svc/Customers"</span>;

            var client = <span class="kwrd">new</span> WebClient();
     <strong>       client.Headers.Add(<span class="str">"Accept:application/json"</span>);</strong>
            client.DownloadStringCompleted += (s, a) =&gt;
            {
                Console.WriteLine(a.Result);
            };

            client.DownloadStringAsync(<span class="kwrd">new</span> Uri(url));

            Console.Read();
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>


<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/20110612130942551.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106121309436713.png" width="673" height="998"></a></p>
<p>至于如何将这个json的字符串转换为对象进行处理，不是本文讨论的范围。有兴趣可以了解&nbsp; DataContractJsonSerializer 这个类型。</p>
<p>我可以预见 的是，你真正了解这些之后，会和我一样的感慨</p>
<p>1.在托管代码中，尽量用XML，使用LINQ to XML这样的技术解析数据较为方便</p>
<p>2.在javascript代码中，尽量用JSON,直接就可以用对象的方式访问。</p>