# 如何在ViewModel中正确地使用Timer（定时器） 
> 原文发表于 2012-05-05, 地址: http://www.cnblogs.com/chenxizhang/archive/2012/05/05/2484637.html 


<h2>内容摘要：</h2> <p>这是我在某个客户那边讲课的时候遇到一个小问题，在ViewModel中创建的一个Timer，并不会被自动停止，即便使用该ViewModel的View已经被关闭了。这个问题的原因在于Timer的特殊工作机制，它是运行在一个独立的工作线程的，除非明确地停止他，或者整个程序关闭了，它才会停止。这一讲中，我通过实例重现了这个问题，然后提供了一个可行的解决方法。</p> <p>&nbsp;</p> <h2>视频地址：</h2> <p><a href="http://www.tudou.com/programs/view/uO4b2j0N4L8/">http://www.tudou.com/programs/view/uO4b2j0N4L8/</a></p> <p><embed src="http://www.tudou.com/v/uO4b2j0N4L8/&amp;rpid=101037296&amp;resourceId=101037296_05_05_99/v.swf" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" wmode="opaque" width="480" height="400"></embed></p> <h2>示例代码：</h2> <p>备注：该范例使用了MvvmLight作为MVVM框架，请自行安装</p> <p><font color="#ff0000">Model：</font></p> <p>&nbsp;</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Diagnostics;
<span class="kwrd">using</span> System.Linq;

<span class="kwrd">namespace</span> SilverlightApplicationSample
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> DataService
    {
        <span class="kwrd">public</span> <span class="kwrd">static</span> Customer[] GetCustomers()
        {

            Debug.WriteLine(<span class="kwrd">string</span>.Format(<span class="str">"[{0}]正在调用数据服务"</span>,DateTime.Now));

            var rnd = <span class="kwrd">new</span> Random();
            <span class="kwrd">return</span> Enumerable.Range(1, rnd.Next(100)).Select(x =&gt; <span class="kwrd">new</span> Customer()
            {
                CompanyName = <span class="str">"Company "</span> + x.ToString()
            }).ToArray();

        }
    }

    <span class="kwrd">public</span> <span class="kwrd">class</span> Customer
    {
        <span class="kwrd">public</span> <span class="kwrd">string</span> CompanyName { get; set; }
    }
}
</pre><pre class="csharpcode">&nbsp;</pre><pre class="csharpcode"><font color="#ff0000">ViewModel：</font></pre><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Windows.Threading;
<span class="kwrd">using</span> GalaSoft.MvvmLight;

<span class="kwrd">namespace</span> SilverlightApplicationSample
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 使用MVVMLight实现的MVVM ViewModel</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> CustomerWindowViewModel : ViewModelBase
    {
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这个方法也不会自动调用</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Cleanup()
        {
            <span class="kwrd">base</span>.Cleanup();

            timer.Stop();
        }

 

        DispatcherTimer timer = <span class="kwrd">null</span>;

        <span class="kwrd">public</span> CustomerWindowViewModel()
        {
            <span class="rem">//正常情况下的绑定</span>
            <span class="rem">//Customers = DataService.GetCustomers();</span>


            <span class="rem">//使用定时器调用服务</span>
            timer = <span class="kwrd">new</span> DispatcherTimer();

            timer.Interval = TimeSpan.FromSeconds(1);
            timer.Tick += (o, a) =&gt;
            {
                Customers = DataService.GetCustomers();
            };

            timer.Start();
        }

        <span class="kwrd">private</span> Customer[] _Customers;
        <span class="kwrd">public</span> Customer[] Customers
        {
            get { <span class="kwrd">return</span> _Customers; }
            set
            {
                <span class="kwrd">if</span> (_Customers != <span class="kwrd">value</span>)
                {
                    _Customers = <span class="kwrd">value</span>;
                    RaisePropertyChanged(<span class="str">"Customers"</span>);
                }
            }
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>&nbsp;</p>
<p><font color="#ff0000">View：</font></p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">controls:ChildWindow</span> <span class="attr">x:Class</span><span class="kwrd">="SilverlightApplicationSample.CustomerWindow"</span>
                      <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
                      <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span>
                      <span class="attr">xmlns:controls</span><span class="kwrd">="clr-namespace:System.Windows.Controls;assembly=System.Windows.Controls"</span>
                      <span class="attr">Width</span><span class="kwrd">="400"</span>
                      <span class="attr">Height</span><span class="kwrd">="300"</span>
                      <span class="attr">Title</span><span class="kwrd">="CustomerWindow"</span>
                      <span class="attr">xmlns:local</span><span class="kwrd">="clr-namespace:SilverlightApplicationSample"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">controls:ChildWindow.DataContext</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">local:CustomerWindowViewModel</span><span class="kwrd">&gt;&lt;/</span><span class="html">local:CustomerWindowViewModel</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">controls:ChildWindow.DataContext</span><span class="kwrd">&gt;</span>
    
    <span class="kwrd">&lt;</span><span class="html">Grid</span> <span class="attr">x:Name</span><span class="kwrd">="LayoutRoot"</span>
          <span class="attr">Margin</span><span class="kwrd">="2"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">Grid.RowDefinitions</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">RowDefinition</span> <span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">RowDefinition</span> <span class="attr">Height</span><span class="kwrd">="Auto"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">Grid.RowDefinitions</span><span class="kwrd">&gt;</span>



        <span class="kwrd">&lt;</span><span class="html">ListBox</span> <span class="attr">ItemsSource</span><span class="kwrd">="{Binding Customers}"</span>
                 <span class="attr">DisplayMemberPath</span><span class="kwrd">="CompanyName"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">ListBox</span><span class="kwrd">&gt;</span>

        <span class="kwrd">&lt;</span><span class="html">Button</span> <span class="attr">x:Name</span><span class="kwrd">="CancelButton"</span>
                <span class="attr">Content</span><span class="kwrd">="Cancel"</span>
                <span class="attr">Click</span><span class="kwrd">="CancelButton_Click"</span>
                <span class="attr">Width</span><span class="kwrd">="75"</span>
                <span class="attr">Height</span><span class="kwrd">="23"</span>
                <span class="attr">HorizontalAlignment</span><span class="kwrd">="Right"</span>
                <span class="attr">Margin</span><span class="kwrd">="0,12,0,0"</span>
                <span class="attr">Grid</span>.<span class="attr">Row</span><span class="kwrd">="1"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">Button</span> <span class="attr">x:Name</span><span class="kwrd">="OKButton"</span>
                <span class="attr">Content</span><span class="kwrd">="OK"</span>
                <span class="attr">Click</span><span class="kwrd">="OKButton_Click"</span>
                <span class="attr">Width</span><span class="kwrd">="75"</span>
                <span class="attr">Height</span><span class="kwrd">="23"</span>
                <span class="attr">HorizontalAlignment</span><span class="kwrd">="Right"</span>
                <span class="attr">Margin</span><span class="kwrd">="0,12,79,0"</span>
                <span class="attr">Grid</span>.<span class="attr">Row</span><span class="kwrd">="1"</span> <span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Grid</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">controls:ChildWindow</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
<pre class="csharpcode">&nbsp;</pre><pre class="csharpcode">&nbsp;</pre><pre class="csharpcode">Page：</pre><pre class="csharpcode"><span class="kwrd">using</span> System.Windows;
<span class="kwrd">using</span> System.Windows.Controls;

<span class="kwrd">namespace</span> SilverlightApplicationSample
{
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> MainPage : UserControl
    {
        <span class="kwrd">public</span> MainPage()
        {
            InitializeComponent();
        }

        

        <span class="kwrd">private</span> <span class="kwrd">void</span> Button_Click(<span class="kwrd">object</span> sender, RoutedEventArgs e)
        {
            var window = <span class="kwrd">new</span> CustomerWindow();
            window.Closed += (o, a) =&gt;
            {
                var vm = window.DataContext <span class="kwrd">as</span> CustomerWindowViewModel;
                vm.Cleanup();
            };

            window.Show();
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>