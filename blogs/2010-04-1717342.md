# 如何在不安装Word的情况下生成Word文档 
> 原文发表于 2010-04-21, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/04/21/1717342.html 


<p>我们的需求是这样的</p> <p>1. 有如下这样一份Word文档的模板</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_16.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_7.png" width="914" height="722"></a> </p> <p>2. 我们需要在服务器端动态生成这样的文件，每次需要换的内容是标题、描述、时间。而且应该把员工列表读出来，填充在下面的表格中</p> <p>&nbsp;</p> <p>&nbsp;</p> <p>我们的解决方案是：</p> <p>1. 在服务端安装Word，然后通过使用word的com模型，诸如word.application, word.document等对象去操作和生成文档。</p> <p>这种方式的问题就是服务器必须安装Word，这可能在很多客户那边是没有办法去做到的。</p> <p>&nbsp;</p> <p>2. 通过xml的方式生成word文档。这就是本篇日志主要讲的东西。</p> <p>&nbsp;</p> <p>首先，我们将word文档全部做好，包括格式设置。如上图所示。</p> <p>接下来，我们将该文档保存为XML格式</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_6.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_2.png" width="975" height="772"></a> </p> <p>这个文档是怎么样的呢？</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_8.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_3.png" width="1117" height="710"></a> </p> <p>看起来有点乱，对吧？没关系，我们将有关的架构稍微理一下就明白了</p> <p>将该文件在IE中打开。注意首先将下面这句话删除掉</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_10.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_4.png" width="1117" height="710"></a> </p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_12.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_5.png" width="1028" height="732"></a> </p> <p>为了后面能够快速地对该文档进行修改和扩展，我们给之前写好文字的XML元素处添加几个tag。</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_14.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_6.png" width="1117" height="710"></a> </p> <p>我们添加了几个tag</p> <p>tag=”Title” 表示标题</p> <p>tag=”Description” 表示描述</p> <p>tag=”Time” 表示时间</p> <p>tag=”Table”表示表格的行</p> <blockquote> <p>tag=”FirstName” 表示姓</p> <p>tag=”LastName” 表示名</p> <p>tag=”Country” 表示国家</p> <p>tag=”Region” 表示地区</p> <p>tag=”City” 表示城市</p></blockquote> <p>然后，我们还需要记下来一个命名空间</p> <p>xmlns:w="<b>http://schemas.microsoft.com/office/word/2003/wordml</b>"</p> <p>&nbsp;</p> <p>好了，有了这些素材，我们就可以在网站中修改该文件了</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_18.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_8.png" width="963" height="784"></a> </p> <p>&nbsp;</p> <p>我们用一个单独的ashx来负责生成该文件</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Web;
<span class="kwrd">using</span> System.Web.Services;

<span class="kwrd">using</span> System.Xml.Linq;
<span class="kwrd">using</span> System.IO;

<span class="kwrd">namespace</span> WordDocumentWeb
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// $codebehindclassname$ 的摘要说明</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    [WebService(Namespace = <span class="str">"http://tempuri.org/"</span>)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    <span class="kwrd">public</span> <span class="kwrd">class</span> DocumentHandler : IHttpHandler
    {

        <span class="kwrd">public</span> <span class="kwrd">void</span> ProcessRequest(HttpContext context)
        {
            context.Response.Clear();
            context.Response.AddHeader(<span class="str">"content-disposition"</span>, <span class="str">"attachment;filename=EmployeeReport.doc"</span>);
            context.Response.ContentEncoding = System.Text.Encoding.GetEncoding(<span class="str">"UTF-8"</span>);
            context.Response.ContentType = <span class="str">"application/vnd.ms-word"</span>;
            XDocument doc = XDocument.Load(context.Server.MapPath(<span class="str">"员工模板.xml"</span>));
            <span class="rem">//开始修改文档</span>

            XNamespace w = <span class="str">"http://schemas.microsoft.com/office/word/2003/wordml"</span>;
            XNamespace wx = <span class="str">"http://schemas.microsoft.com/office/word/2003/auxHint"</span>;
            var nodes = doc.Root.Element(w + <span class="str">"body"</span>).Descendants(w + <span class="str">"t"</span>);
            FindAndReplaceNode(nodes, <span class="str">"Title"</span>, <span class="str">"文档标题（代码修改）"</span>);
            FindAndReplaceNode(nodes, <span class="str">"Description"</span>, <span class="str">"文档描述（代码修改）"</span>);
            FindAndReplaceNode(nodes, <span class="str">"Time"</span>, DateTime.Now.ToString());


            <span class="rem">//填充表格</span>
            var table = doc.Root.Element(w + <span class="str">"body"</span>).Element(wx+<span class="str">"sub-section"</span>).Element(w + <span class="str">"tbl"</span>);<span class="rem">//这是表格</span>

            var templateRow = doc.Root.Element(w + <span class="str">"body"</span>).Descendants(w + <span class="str">"tr"</span>).FirstOrDefault(
                e =&gt; e.Attribute(<span class="str">"tag"</span>) != <span class="kwrd">null</span> &amp;&amp; e.Attribute(<span class="str">"tag"</span>).Value == <span class="str">"Table"</span>);

            <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; 10; i++)
            {
                var newRow = templateRow.Clone();
                var datas = newRow.Descendants(w + <span class="str">"t"</span>);
                FindAndReplaceNode(datas, <span class="str">"FirstName"</span>, <span class="str">"陈"</span>);
                FindAndReplaceNode(datas, <span class="str">"LastName"</span>, <span class="str">"希章"</span>);
                FindAndReplaceNode(datas, <span class="str">"Country"</span>, <span class="str">"中国"</span>);
                FindAndReplaceNode(datas, <span class="str">"Region"</span>, <span class="str">"上海"</span>);
                FindAndReplaceNode(datas, <span class="str">"City"</span>, <span class="str">"上海"</span>);
                table.Add(newRow);
            }

            templateRow.Remove();

            

            StreamWriter sw = <span class="kwrd">new</span> StreamWriter(context.Response.OutputStream);
            doc.Save(sw);
            sw.Flush();
            sw.Close();
            context.Response.End();

        }


        <span class="kwrd">private</span> <span class="kwrd">void</span> FindAndReplaceNode(IEnumerable&lt;XElement&gt; elements,<span class="kwrd">string</span> tag,<span class="kwrd">string</span> <span class="kwrd">value</span>){
            var found = elements.FirstOrDefault(n =&gt; n.Attribute(<span class="str">"tag"</span>) != <span class="kwrd">null</span> &amp;&amp; n.Attribute(<span class="str">"tag"</span>).Value ==tag);
            <span class="kwrd">if</span> (found != <span class="kwrd">null</span>)
                found.Value = <span class="kwrd">value</span>;
        }

        <span class="kwrd">public</span> <span class="kwrd">bool</span> IsReusable
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">false</span>;
            }
        }
    }


    <span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">class</span> Extensions {
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 克隆一个节点</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="element"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">static</span> XElement Clone(<span class="kwrd">this</span> XElement element)
        {
            <span class="kwrd">return</span> <span class="kwrd">new</span> XElement(element.Name,
                       element.Attributes(),
                       element.Nodes().Select(n =&gt;
                       {
                           XElement e = n <span class="kwrd">as</span> XElement;
                           <span class="kwrd">if</span> (e != <span class="kwrd">null</span>)
                           {
                               <span class="kwrd">return</span> e.Clone();
                           }

                           <span class="kwrd">return</span> n;
                       }
                       ),
                       (!element.IsEmpty &amp;&amp; !element.Nodes().OfType&lt;XText&gt;().Any()) ? <span class="kwrd">string</span>.Empty : <span class="kwrd">null</span>
                   );
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>接下来在页面中，我们的代码就是</p><pre class="csharpcode">        <span class="kwrd">protected</span> <span class="kwrd">void</span> btGenerate_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            <span class="rem">//根据模板生成一份Word文档，替换的部分包括了标题文字，描述文字和表格</span>

            Response.Redirect(<span class="str">"DocumentHandler.ashx"</span>);
        }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>&nbsp;</p>
<p>最后运行的效果如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_19.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb.png" width="418" height="266"></a> </p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_21.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WordWord_C30D/image_thumb_1.png" width="914" height="722"></a></p>