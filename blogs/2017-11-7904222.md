# 掀起Azure AD的盖头来&mdash;&mdash;深入理解Microsoft Graph应用程序和服务权限声明 
> 原文发表于 2017-11-27, 地址: http://www.cnblogs.com/chenxizhang/p/7904222.html 


<p><br></p><blockquote><p>作者：陈希章 发表于 2017年7月12日</p></blockquote><h1>引子</h1><p>这是一篇计划外的文章。我们都知道要进行Microsoft Graph的开发的话，需要进行应用程序注册。这个在此前我已经有专门的文章写过了。但这里存在一个小的问题：国内版的Office 365在申请好之后，并没有像国际版那样，有一个对应的可以注册和管理应用程序的Azure的界面。说起来有点绕，国际版的Office 365管理员可以直接登陆到portal.azure.com进行应用程序注册和管理，但国内版却不行。这个问题目前来说还是一个know issue。不过，在帮助一些客户解决这个问题的过程中，我们也有一些变通的做法，例如我下面的这篇文章就是摘自于世纪互联技术支持的标准做法。<p><a href="http://www.cnblogs.com/chenxizhang/p/6010139.html">国内版Office 365和Azure AAD绑定的问题及解决方案</a><p>上述方案中建议客户要另外在购买一个Azure AD的订阅，然后可以跟Office 365那个Tenant绑定起来。这个从一定程度上解决了问题，但不是那么完美。本文给大家分享的是我们另外研究出来的一些经验做法。<h1>理解Office 365与Azure AD的关系</h1><p>从逻辑上说，Azure是微软的智能云平台，在这个平台上，不光是运行了全球不计其数的客户的应用程序，也承载着包括Office 365在内的规模庞大的一些SaaS平台。而Office 365的用户管理和应用管理，本质上就是用Azure AD来实现的。当然，国外的版本，Azure AD还可以做到更多，包括组织配置文件、设备管理、按条件的访问控制等等。限于篇幅，本文不对这些高级功能进行展开，我们仅仅针对用户管理和应用管理，尤其是应用管理这块来一探究竟。<blockquote><p>本文的例子，因为主要是要演示如何解决国内版的问题，所以截图全部采用国内版Office 365或者Azure 请注意，登陆国内版本的Azure，有两种方式，一种是传统门户(manage.windowsazure.cn)，一种是新门户（portal.azure.cn)。新门户毫无疑问带来了一些新的功能，例如支持使用最新的Resource Management的方式创建和管理资源。但是，要进行Azure AD的操作的话，目前还只能在传统门户中进行</p></blockquote><p><img alt="" src="https://chenxizhang.gitbooks.io/office365devguide/docs/images/azureadportal.png"><p>这就是我们喜闻乐见的Azure AD管理界面，用户管理不用多说了，这里可以增加和删除用户，修改用户的一些基本信息。我们重点关注的是应用管理的这个部分。<p><img alt="" src="https://chenxizhang.gitbooks.io/office365devguide/docs/images/azureadapplicationportal.png"><p>稍微简单地回顾一下相关的概念，注册应用程序（application）有两种不同类型（本机或者Web），除了提供一些基本信息（对于Web应用程序而言，关键一点在于提供ReplyUrl）之外，最重要的就是定义该应用程序需要访问的资源，以及申请的权限了。资源，在Azure AD内部的技术范畴来说，是较为ServicePrinciple的一个对象，而所谓的权限，又分为两种，一种是delegated permission，一种是application permission。前者也称为oauth权限，这是需要用户授权，并且模拟用户的身份去进行操作，适合于一些有用户交互的应用程序，而后者（也称为role权限）则适合于一些在后台运行的服务或者自动运行的脚本。<p><img alt="" src="https://chenxizhang.gitbooks.io/office365devguide/docs/images/azureadapppermission.png"><p>必须承认，就算是有图形化界面，要完全理解上面这些东西也多少需要一定的时间。与此同时，如果我们连图形化界面都没有的话，怎么来创建应用程序并且为其申请相关资源的权限呢，这有点挑战，但是谢天谢地，我们还是找到了一些方法。<h1>通过PowerShell来创建应用程序并且定义服务和权限声明</h1><p>我旗帜鲜明地喜欢PowerShell，尤其是用来管理Azure AD以及Office 365的时候，它总是能让我们事半功倍。为了演示下面的功能，我需要提醒你准备如下的软件环境。<p>请在Windows 10的机器上面，安装如下的几个组件<ol><li>下载安装官方提供的Microsoft Online Service Sign-in Assistant for IT Professionals <a href="https://go.microsoft.com/fwlink/p/?LinkId=286152">https://go.microsoft.com/fwlink/p/?LinkId=286152</a><li>下载安装官方提供的Azure Active Directory Connection <a href="http://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185">http://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185</a><li>请在本地用管理员身份打开PowerShell，并运行命令 Install-Module -Name AzureAD</li></ol><blockquote><p>当然，你还得需要有一个Office 365 的管理员账号信息</p></blockquote><p>为了验证你是否安装成功如上的组件，请重新打开一个PowerShell窗口，运行下面的命令<pre><code>$credential = Get-Credential
# 此时会弹出一个登陆框，请输入Office 365管理员和密码信息，如果没有错误请继续

Connect-AzureAD -Credential $credential -AzureEnvironmentName AzureChinaCloud
# 如果没有错误请继续
Get-AzureADApplication
</code></pre><h4>查询所有的服务定义信息</h4><p>我们需要通过脚本获取到当前这个Azure AD中已经定义好的服务信息<pre><code>Get-AzureADServicePrincipal
</code></pre><p>正常情况下将返回下面的结果<p>ObjectId<br>AppId<br>DisplayName<p>06d6e7e4-dcb4-4783-a617-78d89bb584f3<br>0000000f-0000-0000-c000-000000000000<br>Microsoft.Azure.GraphExplorer<p>0a80ca08-a6b5-42d9-91a3-1a93c6c25b05<br>43e38210-29b3-411d-b9f7-4a75b5fd2786<br>工作流<p>0f6b73aa-9a6d-4c25-b518-5aef795042d6<br>00000002-0000-0ff1-ce00-000000000000<br>Office 365 Exchange Online<p>13fc1a89-6a58-406a-9cb2-42e92c458fd3<br>aa9ecb1e-fd53-4aaa-a8fe-7a54de2c1334<br>Office 365 Configure<p>1a17c404-11db-442b-93ae-e0751e1563b7<br>00000007-0000-0ff1-ce00-000000000000<br>Microsoft.ExchangeOnlineProtection<p>224fdbf8-fbe8-4d54-b98e-f8b9ad15cac8<br>00000005-0000-0000-c000-000000000000<br>Microsoft.Azure.Workflow<p>26df55ee-6a90-4a17-879c-1a982094512c<br>00000009-0000-0000-c000-000000000000<br>Power BI Service<p>2ab85e47-1ba1-4948-9a95-f16eef6215aa<br>00000003-0000-0ff1-ce00-000000000000<br>Office 365 SharePoint Online<p>30236da4-3a49-4615-bb09-d665e5938602<br>181dc382-d034-45ad-b7d7-4f440986737b<br>sample<p>30ee19e0-47bd-4a3d-8e2b-3752f02d4ffc<br>2d4d3d8e-2be3-4bef-9f87-7875a61c29de<br>OneNote<p>3319d71d-8dfc-42ff-8fa0-0aa64f553350<br>00000003-0000-0000-c000-000000000000<br>Microsoft Graph<p>348ecf66-4f9c-4ec5-8db4-c86171859ea5<br>c5393580-f805-4401-95e8-94b7a6ef2fc2<br>Office 365 Management APIs<p>465b5392-ee37-4d69-be91-dad28b5fb77a<br>00000004-0000-0ff1-ce00-000000000000<br>Office 365 Lync Online<p>465eec3f-9bcd-4c27-b071-780b86f01083<br>0000000c-0000-0000-c000-000000000000<br>Microsoft.Azure.ActiveDirectoryUX<p>4ba6a93c-053e-4575-83aa-419fcc7cadb5<br>c84c5f13-394f-4807-9a35-317cffa11143<br>工作流<p>4fa14876-02c2-4089-a450-2b8b45d17ae0<br>00000002-0000-0000-c000-000000000000<br>Windows Azure Active Directory<p>524c2aaa-6ca4-4db5-9876-b758bbd4d6c7<br>8d3a7d3c-c034-4f19-a2ef-8412952a9671<br>MicrosoftOffice<p>6226889d-694d-4ee0-8717-0997c544b94e<br>ab27a73e-a3ba-4e43-8360-8bcc717114d8<br>Microsoft.OfficeModernCalendar<p>63246e22-5673-4665-9744-e33f18aceaf3<br>aa2cd2a1-5a04-4e64-b76a-0a0f21e9d1d9<br>webappsample123<p>67749e7c-7d67-4338-abdd-82f13ff22010<br>00000006-0000-0ff1-ce00-000000000000<br>Microsoft.Office365Portal<p>6de0d20c-2b7f-4aed-803c-f3157018b59b<br>00000013-0000-0000-c000-000000000000<br>Windows Azure Management Portal<p>72f64ca3-d200-423b-92da-4f3dd6621ef9<br>1142d051-c271-4044-b1ac-522c8029e3b7<br>websampletest<p>76c56681-2887-4cd4-a375-971669f0d471<br>8fca0a66-c008-4564-a876-ab3ae0fd5cff<br>Microsoft.SMIT<p>778437c2-766d-4853-8738-2f397efeae06<br>0f698dd4-f011-4d23-a33e-b36416dcb1e6<br>OfficeClientService<p>793601bf-1a81-400d-bb7d-68db352702c5<br>ae675dd6-076c-4036-9d0b-f5a4e9c10c71<br>nativeapplication<p>79a7fbfe-a0d5-4416-8c8f-6a523d45cd4c<br>803ee9ca-3f7f-4824-bd6e-0b99d720c35c<br>Azure Media Service<p>7f07985a-6657-41cb-b5f6-14c3554b027d<br>326128ad-f5f4-474c-bb19-c5e9b7780ba0<br>微软 Office 365 移动办公套件<p>866d1fbf-bf6d-4e30-a8ad-570317df9642<br>797f4846-ba00-4fd7-ba43-dac1f8f63013<br>Windows Azure Service Management API<p>8ac0becf-4180-43fd-883f-18bda7f45827<br>0f6edad5-48f2-4585-a609-d252b1c52770<br>AIGraphClient<p>8f5f81a0-7690-4bad-b097-bb22a9940041<br>168f7c69-e70d-4a14-ae22-c069b5d296bc<br>webapp<p>93a3c4d5-6451-4648-8195-b00eafe51b0e<br>f05ff7c9-f75a-4acd-a3b5-f4b6a870245d<br>SharePoint Android<p>94decd41-c70a-4255-b73a-0d52ead4dde9<br>2ab3d641-6164-4930-8f58-68d56787ab47<br>testapplication<p>9c4b5e57-6ec2-4218-be29-70d197664262<br>595d87a1-277b-4c0a-aa7f-44f8a068eafc<br>Microsoft.SupportTicketSubmission<p>a4c307c2-d229-4cea-a51c-c498b146fc3f<br>601d4e27-7bb3-4dee-8199-90d47d527e1c<br>Microsoft.Office365.ChangeManagement<p>a534ad32-c4a0-491e-810f-7499a8b9016a<br>c44b4083-3bb0-49c1-b47d-974e53cbdf3c<br>Ibiza Portal<p>a913c56c-7a86-479e-894e-9649f99f7841<br>8fad9a3d-ce06-4d85-8f9a-873164f0cafc<br>native<p>c259baa5-c050-420d-a4a9-3130dbeed2f9<br>6f82282e-0070-4e78-bc23-e6320c5fa7de<br>Microsoft.DiscoveryService<p>ce72c49b-a6df-45c6-9055-76d7eb684a9d<br>3f56a5d5-7882-4290-9fd8-3908d734b3fe<br>deamon<p>dc4e9fbc-9e1d-4900-9ea1-dfc9b8d414c5<br>0000000b-0000-0000-c000-000000000000<br>Microsoft.SellerDashboard<p>e1d2b488-d085-4af5-bd97-d2436f72fd7d<br>e3583ad2-c781-4224-9b91-ad15a8179ba0<br>Microsoft.ExtensibleRealUserMonitoring<p>ebf95d4c-7ccf-4ecf-ac48-793d2782f98d<br>67e3df25-268a-4324-a550-0de1c7f97287<br>Microsoft.OfficeWebAppsService<p>f0df0bc2-1c0a-446b-9eb6-7a4cf9749079<br>61a7b0d6-2bc9-48b6-8653-ef6b496815cb<br>GraphExplorer<p><br><p>虽然列了这么多，但其实我们一般最关注就是下面这个服务 ObjectId | AppId | DisplayName -------- | ----- | ----------- 3319d71d-8dfc-42ff-8fa0-0aa64f553350 | 00000003-0000-0000-c000-000000000000 | Microsoft Graph<h4>查询服务的权限信息</h4><p>有了服务的基本信息，我们就可以查询它的详细信息，尤其是我们关注的权限定义这部分信息了<pre><code>$graph = Get-AzureADServicePrincipal -ObjectId 3319d71d-8dfc-42ff-8fa0-0aa64f553350
# 这个命令将Microsoft Graph这个服务定义保存为一个变量

$graph | fl * 
# 这个命令将显示详细信息
</code></pre><p><img alt="" src="https://chenxizhang.gitbooks.io/office365devguide/docs/images/azureappgraphdetails.png"><p>下面我将演示一下如何将它的两类权限分别列举出来<pre><code>$graph.Oauth2Permissions 
# 这个会列举出来所有的用户模拟权限
</code></pre><p>Id<br>IsEnabled<br>Type<br>UserConsentDescription<br>UserConsentDisplayName<br>Value<p>58e15261-dfce-4dbd-b1a9-6a513ccf39cd<br>True<br>User<br>Allows the app to read, update, create, and delete contacts you have permissions to access, including your own and shared contacts.<br>Read and write to your and shared contacts<br>Contacts.ReadWrite.Shared<p>c8ee694a-ac5f-44eb-9487-f4fea3a6538d<br>True<br>User<br>Allows the app to read contacts you have permissions to access, including your own and shared contacts.<br>Read your and shared contacts<br>Contacts.Read.Shared<p>9e044dd2-b119-478e-8b0c-3143ff864625<br>True<br>User<br>Allows the app to read, update, create and delete events in all calendars in your organization you have permissions to access. This includes delegate and shared calendars.<br>Read and write to your and shared calendars<br>Calendars.ReadWrite.Shared<p>f1731364-f498-453c-a95f-c57fdbeff4f1<br>True<br>User<br>Allows the app to read events in all calendars that you can access, including delegate and shared calendars.<br>Read calendars?you can access<br>Calendars.Read.Shared<p>2bf44396-38c4-4826-813f-75074b46a125<br>True<br>User<br>Allows the app to send mail as you or on-behalf of someone else.<br>Send mail on behalf of others or yourself<br>Mail.Send.Shared<p>0772b0b8-18f9-4412-a1dc-cdbb000727fa<br>True<br>User<br>Allows the app to read, update, create, and delete mail you have permission to access, including your own and shared mail. Does not allow the app to send mail on your behalf.<br>Read and write mail?you can access<br>Mail.ReadWrite.Shared<p>07382180-f05b-4f94-8e51-02736bd78f14<br>True<br>User<br>Allows the app to read mail you can access, including shared mail.<br>Read mail you can access<br>Mail.Read.Shared<p>e1fe6dd8-ba31-4d61-89e7-88639da4683d<br>True<br>User<br>Allows you to sign in to the app with your organizational account and let the app read your profile. It also allows the app to read basic company information.<br>Sign you in and read your profile<br>User.Read<p>b4e74841-8e56-480b-be8b-910348b18b4c<br>True<br>User<br>Allows the app to read your profile, and discover your group membership, reports and manager. It also allows the app to update your profile information on your behalf.<br>Read and update your profile<br>User.ReadWrite<p>b340eb25-3456-403f-be2f-af7a0d370277<br>True<br>User<br>Allows the app to read a basic set of profile properties of other users in your organization on your behalf. Includes display name, first and last name, email address and photo.<br>Read all users' basic profiles<br>User.ReadBasic.All<p>a154be20-db9c-4678-8ab7-66f6cc099a59<br>True<br>Admin<br>Allows the app to read the full set of profile properties, reports, and managers of other users in your organization, on your behalf.<br>Read all users' full profiles<br>User.Read.All<p>204e0828-b5ca-4ad8-b9f3-f32a958e7cc4<br>True<br>Admin<br>Allows the app to read and write the full set of profile properties, reports, and managers of other users in your organization, on your behalf.<br>Read and write all users' full profiles<br>User.ReadWrite.All<p>5f8c59db-677d-491f-a6b8-5f174b11ec1d<br>True<br>Admin<br>Allows the app to list groups, and to read their properties and all group memberships on your behalf. Also allows the app to read calendar, conversations, files, and other group content for all groups you can access.<br>Read all groups<br>Group.Read.All<p>4e46008b-f24c-477d-8fff-7bb4ec7aafe0<br>True<br>Admin<br>Allows the app to create groups and read all group properties and memberships on your behalf. Additionally allows the app to manage your groups and to update group content for groups you are a member of.<br>Read and write all groups<br>Group.ReadWrite.All<p>06da0dbc-49e2-44d2-8312-53f166ab848a<br>True<br>Admin<br>Allows the app to read data in your organization's directory.<br>Read directory data<br>Directory.Read.All<p>c5366453-9fb0-48a5-a156-24f0c49a4b84<br>True<br>Admin<br>Allows the app to read and write data in your organization's directory, such as other users, groups. It does not allow the app to delete users or groups, or reset user passwords.<br>Read and write directory data<br>Directory.ReadWrite.All<p>0e263e50-5827-48a4-b97c-d940288653c7<br>True<br>Admin<br>Allows the app to have the same access to information in your work or school directory as you do.<br>Access the directory as you<br>Directory.AccessAsUser.All<p>570282fd-fa5c-430d-a7fd-fc8dc98a9dca<br>True<br>User<br>Allows the app to read email in your mailbox.<br>Read your mail<br>Mail.Read<p>024d486e-b451-40bb-833d-3e66d98c5c73<br>True<br>User<br>Allows the app to read, update, create and delete email in your mailbox. Does not include permission to send mail.<br>Read and write access to your mail<br>Mail.ReadWrite<p>e383f46e-2787-4529-855e-0e479a3ffac0<br>True<br>User<br>Allows the app to send mail as you.<br>Send mail as you<br>Mail.Send<p>465a38f9-76ea-45b9-9f34-9e8b0d4b0b42<br>True<br>User<br>Allows the app to read events in your calendars.<br>Read your calendars<br>Calendars.Read<p>1ec239c2-d7c9-4623-a91a-a9775856bb36<br>True<br>User<br>Allows the app to read, update, create and delete events in your calendars.<br>Have full access to your calendars<br>Calendars.ReadWrite<p>ff74d97f-43af-4b68-9f2a-b77ee6968c5d<br>True<br>User<br>Allows the app to read contacts in your contact folders.<br>Read your contacts<br>Contacts.Read<p>d56682ec-c09e-4743-aaf4-1a3aac4caa21<br>True<br>User<br>Allows the app to read, update, create and delete contacts in your contact folders.<br>Have full access of your contacts<br>Contacts.ReadWrite<p>10465720-29dd-4523-a11a-6a75c743c9d9<br>True<br>User<br>Allows the app to read your files and files shared with you.<br>Read your files and files shared with you<br>Files.Read<p>5c28f0bf-8a70-41f1-8ab2-9032436ddb65<br>True<br>User<br>Allows the app to read, create, update, and delete your files and files shared with you.<br>Have full access to your files and files shared with you<br>Files.ReadWrite<p>8019c312-3263-48e6-825e-2b833497195b<br>True<br>User<br>Allows the app to read, create, update and delete files in the application's folder.<br>Have full access to the application's folder<br>Files.ReadWrite.AppFolder<p>17dde5bd-8c17-420f-a486-969730c1b827<br>True<br>User<br>Allows the app to read and write files that you select. After you select a file, the app has access to the file for several hours.<br>Read and write selected files<br>Files.ReadWrite.Selected<p>5447fe39-cb82-4c1a-b977-520e67e724eb<br>True<br>User<br>Allows the app to read files that you select. After you select a file, the app has access to the file for several hours.<br>Read selected files<br>Files.Read.Selected<p>205e70e5-aba6-4c52-a976-6d2d46c48043<br>True<br>User<br>Allow the application to read documents and list items in all site collections on your behalf<br>Read items in all site collections<br>Sites.Read.All<pre><code>$graph.AppRoles
# 这个会列举出来所有的应用权限
</code></pre><p>Description<br>DisplayName<br>Id<br>IsEnabled<br>Value<p>Allows the app to read mail in all mailboxes without a signed-in user.<br>Read mail in all mailboxes<br>810c84a8-4a9e-49e6-bf7d-12d183f40d01<br>True<br>Mail.Read<p>Allows the app to create, read, update, and delete mail in all mailboxes without a signed-in user. Does not include permission to send mail.<br>Read and write mail in all mailboxes<br>e2a3a72e-5f79-4c64-b1b1-878b674786c9<br>True<br>Mail.ReadWrite<p>Allows the app to send mail as any user without a signed-in user.<br>Send mail as any user<br>b633e1c5-b582-4048-a93e-9f11b44c7e96<br>True<br>Mail.Send<p>Allows the app to read events of all calendars without a signed-in user.<br>Read calendars in all mailboxes<br>798ee544-9d2d-430c-a058-570e29e34338<br>True<br>Calendars.Read<p>Allows the app to create, read, update, and delete events of all calendars without a signed-in user.<br>Read and write calendars in all mailboxes<br>ef54d2bf-783f-4e0f-bca1-3210c0444d99<br>True<br>Calendars.ReadWrite<p>Allows the app to read all contacts in all mailboxes without a signed-in user.<br>Read contacts in all mailboxes<br>089fe4d0-434a-44c5-8827-41ba8a0b17f5<br>True<br>Contacts.Read<p>Allows the app to create, read, update, and delete all contacts in all mailboxes without a signed-in user.<br>Read and write contacts in all mailboxes<br>6918b873-d17a-4dc1-b314-35f528134491<br>True<br>Contacts.ReadWrite<p>Allows the app to read group properties and memberships, and read the calendar and conversations for all groups, without a signed-in user.<br>Read all groups<br>5b567255-7703-4780-807c-7be8301ae99b<br>True<br>Group.Read.All<p>Allows the app to create groups, read all group properties and memberships, update group properties and memberships, and delete groups. Also allows the app to read and write group calendar and conversations. All of these operations can be performed by the app without a signed-in user.<br>Read and write all groups<br>62a82d76-70ea-41e2-9197-370581804d09<br>True<br>Group.ReadWrite.All<p>Allows the app to read data in your organization's directory, such as users, groups and apps, without a signed-in user.<br>Read directory data<br>7ab1d382-f21e-4acd-a863-ba3e13f7da61<br>True<br>Directory.Read.All<p>Allows the app to read and write data in your organization's directory, such as users, and groups, without a signed-in user. Does not allow user or group deletion.<br>Read and write directory data<br>19dbc75e-c2e2-444c-a770-ec69d8559fc7<br>True<br>Directory.ReadWrite.All<p>Allows the app to read and write all device properties without a signed in user. Does not allow device creation, device deletion or update of device alternative security identifiers.<br>Read and write devices<br>1138cb37-bd11-4084-a2b7-9f71582aeddb<br>True<br>Device.ReadWrite.All<p>Allows the app to read user profiles without a signed in user.<br>Read all users' full profiles<br>df021288-bdef-4463-88db-98f22de89214<br>True<br>User.Read.All<p>Allows the app to read and update user profiles without a signed in user.<br>Read and write all users' full profiles<br>741f803b-c850-494e-b5df-cde7c675a1ca<br>True<br>User.ReadWrite.All<h4>创建应用程序</h4><p>创建应用程序的PowerShell命令是New-AzureADApplication,它的详细用法请参考这里 <a href="https://docs.microsoft.com/en-us/powershell/module/azuread/new-azureadapplication?view=azureadps-2.0">https://docs.microsoft.com/en-us/powershell/module/azuread/new-azureadapplication?view=azureadps-2.0</a><pre><code>$app= New-AzureADApplication -DisplayName "yourapplicationname"  -ReplyUrls "https://websample.com/replyurl" -Homepage "https://websample.com" -IdentifierUris "https://websample.com"

# 这是用来创建Web应用程序的

$app= New-AzureADApplication -DisplayName "yourapplicationname"  -PublicClient $true

# 这是用来创建本地应用程序的，设置PublicClient属性为true即可

$app

#请保存app的具体信息，尤其是AppId
</code></pre><h1>创建密钥</h1><p>如果上面创建的是Web 应用程序，还需要为应用程序创建密钥。这里会用到的PowerShell命令是New-AzureADApplicationPasswordCredential，它的详细用法请参考这里 <a href="https://docs.microsoft.com/en-us/powershell/module/azuread/new-azureadapplicationpasswordcredential?view=azureadps-2.0">https://docs.microsoft.com/en-us/powershell/module/azuread/new-azureadapplicationpasswordcredential?view=azureadps-2.0</a><pre><code>New-AzureADApplicationPasswordCredential -ObjectId $app.ObjectId

# 正常情况下，将返回一个为期一年的密钥信息

CustomKeyIdentifier :
EndDate             : 7/12/2018 10:25:28 AM
KeyId               :
StartDate           : 7/12/2017 10:25:28 AM
Value               : /TD0rbE5gwm/a6TGqUhqVY46LA16rir6Zwm7pK69prI=


# 请保存这个Value信息
</code></pre><h1>绑定服务和设定权限</h1><p>我们已经创建了应用程序，也为他申请了一个密钥，下面就是最后也是最关键的环节————为应用程序绑定服务并且设定权限了。下面这个代码段是为上面创建好的应用程序，并且为其申请了四个delegated permission。（具体这四个权限对应的是什么，请参考上面的表格）<pre><code>$graphrequest = New-Object -TypeName "Microsoft.Open.AzureAD.Model.RequiredResourceAccess"

$graphrequest.ResourceAccess = New-Object -TypeName "System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]"

$ids =@("024d486e-b451-40bb-833d-3e66d98c5c73","e383f46e-2787-4529-855e-0e479a3ffac0","e1fe6dd8-ba31-4d61-89e7-88639da4683d","b340eb25-3456-403f-be2f-af7a0d370277")

foreach($id in $ids){
    $obj = New-Object -TypeName "Microsoft.Open.AzureAD.Model.ResourceAccess" -ArgumentList $id,"Scope"
    # 如果是AppRole权限，则第二个参数为Role

    $graphrequest.ResourceAccess.Add($obj)
}

$graphrequest.ResourceAppId = "00000003-0000-0000-c000-000000000000"

Set-AzureADApplication -ObjectId $app.ObjectId -RequiredResourceAccess ($graphrequest)
# 这句命令的RequiredResourceAccess 参数中可以有多个对象
</code></pre><h1>结语</h1><p>这篇文章的篇幅较长，我尽可能详细地展示了很多Azure AD中注册应用程序，绑定服务和设定权限的细节，尤其是对于国内的Office 365客户以及合作伙伴来说应该有较高的实用价值。 当我们没有图形化界面可以使用的时候，你就会由衷地感慨，脚本（例如PowerShell）确实是很强大的，而且通过脚本的探索过程，你可以更加清晰地理解其背后的逻辑。