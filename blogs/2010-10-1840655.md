# WF 4.0中如何实现xaml工作流的动态加载 
> 原文发表于 2010-10-01, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/10/01/1840655.html 


<p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/10/01/1840629.html" target="_blank">上一篇</a>，我用实例讲解了在.NET Framework 3.0(3.5)中如何动态加载xoml创建和运行流程的做法。这一篇谈一下在WF 4.0中的情况，首先介绍一下WF 4的一些重要变化</p> <ol> <li>WF 4中，默认就是用xaml（注意，不是xoml)，同时不允许包含c#代码</li> <li>WF 4中，不再区分顺序工作流和状态机工作流</li> <li>WF 4中，不再能直接使用Code Activity，如果希望写代码，则需要编写一个自定义的Activity，继承Code Activity</li></ol> <p>我接下来还是用一个例子讲解一下如何在WF 4中动态加载xaml工作流的做法吧</p> <p>&nbsp;</p> <p><font size="4"><strong>1. 创建自定义的Activity</strong></font></p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_2.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_thumb.png" width="959" height="664"></a></p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;
<span class="kwrd">using</span> System.Activities;

<span class="kwrd">namespace</span> WorkflowConsoleApplication1
{

    <span class="kwrd">public</span> <span class="kwrd">sealed</span> <span class="kwrd">class</span> MyActivity : CodeActivity
    {
        <span class="rem">// Define an activity input argument of type string</span>
        <span class="kwrd">public</span> InArgument&lt;<span class="kwrd">string</span>&gt; Text { get; set; }

        <span class="rem">// If your activity returns a value, derive from CodeActivity&lt;TResult&gt;</span>
        <span class="rem">// and return the value from the Execute method.</span>
        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Execute(CodeActivityContext context)
        {
            <span class="rem">// Obtain the runtime value of the Text input argument</span>
            <span class="kwrd">string</span> text = context.GetValue(<span class="kwrd">this</span>.Text);

            Console.WriteLine(text);
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p><font size="4"><strong>2.将这个自定义的Activity添加到流程中</strong></font></p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_4.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_thumb_1.png" width="1028" height="670"></a></p>
<p>设置它的Text属性</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_6.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_thumb_2.png" width="354" height="189"></a></p>
<p>&nbsp;</p>
<p><font size="4"><strong>3.将工作流的属性进行一些修改</strong></font></p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_8.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_thumb_3.png" width="1028" height="670"></a></p>
<p>注意，将BuildAction设置为Content，同时Copy to Output Directory 设置为Copy always， 并且将Custom Tool设置为空白</p>
<p>完成操作之后，得到的xaml文件如下</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">Activity</span> <span class="attr">mc:Ignorable</span><span class="kwrd">="sap"</span> <span class="attr">x:Class</span><span class="kwrd">="WorkflowConsoleApplication1.Workflow1"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="240,240"</span> <span class="attr">mva:VisualBasic</span>.<span class="attr">Settings</span><span class="kwrd">="Assembly references and imported namespaces for internal implementation"</span> <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities"</span> <span class="attr">xmlns:local</span><span class="kwrd">="clr-namespace:WorkflowConsoleApplication1"</span> <span class="attr">xmlns:mc</span><span class="kwrd">="http://schemas.openxmlformats.org/markup-compatibility/2006"</span> <span class="attr">xmlns:mv</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic;assembly=System"</span> <span class="attr">xmlns:mva</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"</span> <span class="attr">xmlns:s</span><span class="kwrd">="clr-namespace:System;assembly=mscorlib"</span> <span class="attr">xmlns:s1</span><span class="kwrd">="clr-namespace:System;assembly=System"</span> <span class="attr">xmlns:s2</span><span class="kwrd">="clr-namespace:System;assembly=System.Xml"</span> <span class="attr">xmlns:s3</span><span class="kwrd">="clr-namespace:System;assembly=System.Core"</span> <span class="attr">xmlns:sad</span><span class="kwrd">="clr-namespace:System.Activities.Debugger;assembly=System.Activities"</span> <span class="attr">xmlns:sap</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"</span> <span class="attr">xmlns:scg</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System"</span> <span class="attr">xmlns:scg1</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.ServiceModel"</span> <span class="attr">xmlns:scg2</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.Core"</span> <span class="attr">xmlns:scg3</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=mscorlib"</span> <span class="attr">xmlns:sd</span><span class="kwrd">="clr-namespace:System.Data;assembly=System.Data"</span> <span class="attr">xmlns:sl</span><span class="kwrd">="clr-namespace:System.Linq;assembly=System.Core"</span> <span class="attr">xmlns:st</span><span class="kwrd">="clr-namespace:System.Text;assembly=mscorlib"</span> <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">local:MyActivity</span> <span class="attr">sad:XamlDebuggerXmlReader</span>.<span class="attr">FileName</span><span class="kwrd">="D:\temp\WorkflowConsoleApplication1\WorkflowConsoleApplication1\Workflow1.xaml"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="200,200"</span> <span class="attr">Text</span><span class="kwrd">="Hello,World"</span> <span class="kwrd">/&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">Activity</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p><font size="4"><strong>4. 通过下面的代码创建并且运行流程</strong></font></p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Activities;
<span class="kwrd">using</span> System.Activities.Statements;

<span class="kwrd">using</span> System.Activities.XamlIntegration;

<span class="kwrd">namespace</span> WorkflowConsoleApplication1
{

    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {

            WorkflowInvoker.Invoke(ActivityXamlServices.Load(<span class="str">"workflow1.xaml"</span>));
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>运行上述代码，我们会遇到一个错误</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_10.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_thumb_4.png" width="456" height="256"></a></p>
<p>这是为什么呢？MyActivity找不到？</p>
<p>我们应该手工将xaml文件成下面这样。请注意粗体的部分，我添加了assembly的设置</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">Activity</span> <span class="attr">mc:Ignorable</span><span class="kwrd">="sap"</span> <span class="attr">x:Class</span><span class="kwrd">="WorkflowConsoleApplication1.Workflow1"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="240,240"</span> <span class="attr">mva:VisualBasic</span>.<span class="attr">Settings</span><span class="kwrd">="Assembly references and imported namespaces for internal implementation"</span> <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities"</span> <strong><font size="4"><span class="attr">xmlns:local</span><span class="kwrd">="clr-namespace:WorkflowConsoleApplication1;assembly=WorkflowConsoleApplication1"</span></font></strong> <span class="attr">xmlns:mc</span><span class="kwrd">="http://schemas.openxmlformats.org/markup-compatibility/2006"</span> <span class="attr">xmlns:mv</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic;assembly=System"</span> <span class="attr">xmlns:mva</span><span class="kwrd">="clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"</span> <span class="attr">xmlns:s</span><span class="kwrd">="clr-namespace:System;assembly=mscorlib"</span> <span class="attr">xmlns:s1</span><span class="kwrd">="clr-namespace:System;assembly=System"</span> <span class="attr">xmlns:s2</span><span class="kwrd">="clr-namespace:System;assembly=System.Xml"</span> <span class="attr">xmlns:s3</span><span class="kwrd">="clr-namespace:System;assembly=System.Core"</span> <span class="attr">xmlns:sad</span><span class="kwrd">="clr-namespace:System.Activities.Debugger;assembly=System.Activities"</span> <span class="attr">xmlns:sap</span><span class="kwrd">="http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"</span> <span class="attr">xmlns:scg</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System"</span> <span class="attr">xmlns:scg1</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.ServiceModel"</span> <span class="attr">xmlns:scg2</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=System.Core"</span> <span class="attr">xmlns:scg3</span><span class="kwrd">="clr-namespace:System.Collections.Generic;assembly=mscorlib"</span> <span class="attr">xmlns:sd</span><span class="kwrd">="clr-namespace:System.Data;assembly=System.Data"</span> <span class="attr">xmlns:sl</span><span class="kwrd">="clr-namespace:System.Linq;assembly=System.Core"</span> <span class="attr">xmlns:st</span><span class="kwrd">="clr-namespace:System.Text;assembly=mscorlib"</span> <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">local:MyActivity</span> <span class="attr">sad:XamlDebuggerXmlReader</span>.<span class="attr">FileName</span><span class="kwrd">="D:\temp\WorkflowConsoleApplication1\WorkflowConsoleApplication1\Workflow1.xaml"</span> <span class="attr">sap:VirtualizedContainerService</span>.<span class="attr">HintSize</span><span class="kwrd">="200,200"</span> <span class="attr">Text</span><span class="kwrd">="Hello,World"</span> <span class="kwrd">/&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">Activity</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>





<p>&nbsp;</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_12.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/Windows-Live-Writer/WF-4.0xaml_130A6/image_thumb_5.png" width="681" height="446"></a></p>
<p>&nbsp;</p>
<p>我个人认为这应该算是一个bug。但目前的情况就是这样，如果你的自定义Activity是在当前应用程序里面，则也是需要设置Assembly的信息的。</p>
<p>当然，如果自定义Activity是单独的Assembly,则应该默认就会写上Assembly信息，那种情况反而是没有问题的。</p>