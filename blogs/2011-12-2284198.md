# 在MVC项目中为用户登录失败次数实现提示 
> 原文发表于 2011-12-11, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/12/11/2284198.html 


<p>这两天在给一个客户讲解MVC 3的架构和在项目中的应用，有提到这样一个问题：</p> <blockquote> <p>MVC3 默认实现的Forms Authentication机制，可以结合SQL Server做成员管理，而且可以设置在一定时间内如果用户连续输入密码错误达到一定次数的话，就自动将用户锁定。</p> <p>但是，默认情况下，却没有提供一定的机制，给用户提示，例如你已经输入几次失败了，还最多可以输入几次等等。这在有的时候给用户造成了一些不便。</p></blockquote> <p>那么，是否有办法解决这个问题呢？</p> <p>本文源代码，可以通过这里下载 <a title="MvcApplicationSample.rar" href="http://files.cnblogs.com/chenxizhang/MvcApplicationSample.rar">MvcApplicationSample.rar</a></p> <p>&nbsp;</p> <p>首先，我们来看一下默认的一些设置和代码</p> <h1>MemberShip的配置</h1><pre class="csharpcode">   <span class="kwrd">&lt;</span><span class="html">membership</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">providers</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">clear</span><span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="AspNetSqlMembershipProvider"</span> <span class="attr">type</span><span class="kwrd">="System.Web.Security.SqlMembershipProvider"</span> <span class="attr">connectionStringName</span><span class="kwrd">="ApplicationServices"</span>
             <span class="attr">enablePasswordRetrieval</span><span class="kwrd">="false"</span> <span class="attr">enablePasswordReset</span><span class="kwrd">="true"</span> <span class="attr">requiresQuestionAndAnswer</span><span class="kwrd">="false"</span> <span class="attr">requiresUniqueEmail</span><span class="kwrd">="false"</span>
             <span class="attr">maxInvalidPasswordAttempts</span><span class="kwrd">="5"</span> <span class="attr">minRequiredPasswordLength</span><span class="kwrd">="6"</span> <span class="attr">minRequiredNonalphanumericCharacters</span><span class="kwrd">="0"</span> <span class="attr">passwordAttemptWindow</span><span class="kwrd">="10"</span>
             <span class="attr">applicationName</span><span class="kwrd">="/"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">providers</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">membership</span><span class="kwrd">&gt;</span>
</pre>
<p>上面的配置是默认的，意思是在10分钟内，如果连续输入密码5次错误的话，就锁住用户</p>
<p>&nbsp;</p>
<h1>AccountController中的代码</h1><pre class="csharpcode">        [HttpPost]
        <span class="kwrd">public</span> ActionResult LogOn(LogOnModel model, <span class="kwrd">string</span> returnUrl)
        {
            <span class="kwrd">if</span>(ModelState.IsValid)
            {
                <span class="kwrd">if</span>(Membership.ValidateUser(model.UserName, model.Password))
                {
                    FormsAuthentication.SetAuthCookie(model.UserName, model.RememberMe);
                    <span class="kwrd">if</span>(Url.IsLocalUrl(returnUrl) &amp;&amp; returnUrl.Length &gt; 1 &amp;&amp; returnUrl.StartsWith(<span class="str">"/"</span>)
                        &amp;&amp; !returnUrl.StartsWith(<span class="str">"//"</span>) &amp;&amp; !returnUrl.StartsWith(<span class="str">"/\\"))
                    {
                        return Redirect(returnUrl);
                    }
                    else
                    {
                        return RedirectToAction("</span>Index<span class="str">", "</span>Home<span class="str">");
                    }
                }
                else
                {

                    ModelState.AddModelError("</span><span class="str">", "</span>The user name or password provided <span class="kwrd">is</span> incorrect.");
                }
            }

            <span class="rem">// If we got this far, something failed, redisplay form</span>
            <span class="kwrd">return</span> View(model);
        }</pre>
<p>这里的代码很简单，只要不通过验证的话，就显示一个错误消息：The user name or password provided <span class="kwrd">is</span> incorrect.</p>
<p>但其实这个消息对用户来说并不是很直观，他不会知道到底是哪里出了错：是用户名不对呢？还是密码不对？甚至说，密码还可以最多输入几次？</p>
<p>&nbsp;</p>
<p>所以，默认情况下，如果登录不成功，就会看到如下的界面</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/20111211212712960.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127146981.png" width="931" height="627"></a></p>
<p>如果连续输入错误超过5次，就会导致用户再也无法登录，而他没有得到任何提示。我们通过数据库可以看到这个用户已经被锁定了。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127165750.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127179819.png" width="1047" height="129"></a></p>
<p>而且在这个表中确实有一个字段是记录了连续输入密码错误的次数</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127189951.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127203671.png" width="738" height="130"></a></p>
<p>&nbsp;</p>
<p>那么，接下来看看是否有什么办法解决？我想到的解决方案如下</p>
<p>&nbsp;</p>
<h1>添加一个自定义的MembershipProvider</h1>
<p>既然默认的Membership Provider提供不了这个功能，那么我们可以尝试自己做一个，想办法去读取这张表应该就能实现</p><pre class="csharpcode"><span class="kwrd">using</span> System.Configuration;
<span class="kwrd">using</span> System.Data.SqlClient;
<span class="kwrd">using</span> System.Web.Security;

<span class="kwrd">namespace</span> MvcApplicationSample.Extensions
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 这是一个自定义的MembershipProvider，添加了一个功能，可以获取用户连续输入密码失败的次数</span>
    <span class="rem">/// 作者：陈希章</span>
    <span class="rem">/// 反馈：ares@xizhang.com</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> MySQLMemberShipProvider:SqlMembershipProvider
    {

        <span class="kwrd">private</span> <span class="kwrd">string</span> connectionString = <span class="kwrd">string</span>.Empty;


        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Initialize(<span class="kwrd">string</span> name, System.Collections.Specialized.NameValueCollection config)
        {
            <span class="kwrd">base</span>.Initialize(name, config);

            <span class="rem">//这里获取到默认使用的数据库连接字符串</span>
            connectionString = ConfigurationManager.ConnectionStrings[<span class="str">"ApplicationServices"</span>].ConnectionString;
        }


        <span class="kwrd">public</span> <span class="kwrd">int</span> GetFailedPasswordAttemptCount(<span class="kwrd">string</span> userName)
        {
            <span class="kwrd">using</span>(var conn = <span class="kwrd">new</span> SqlConnection(connectionString))
            {
                <span class="kwrd">using</span>(var cmd = conn.CreateCommand())
                {
                    cmd.CommandText = <span class="str">"SELECT aspnet_Membership.FailedPasswordAttemptCount FROM aspnet_Membership INNER JOIN aspnet_Users ON aspnet_Membership.UserId = aspnet_Users.UserId INNER JOIN aspnet_Applications ON aspnet_Membership.ApplicationId =aspnet_Applications.ApplicationId AND aspnet_Users.ApplicationId = aspnet_Applications.ApplicationId WHERE (aspnet_Users.UserName = @userName) AND (aspnet_Applications.ApplicationName =@applicationName)"</span>;

                    cmd.Parameters.AddWithValue(<span class="str">"@userName"</span>, userName);
                    cmd.Parameters.AddWithValue(<span class="str">"@applicationName"</span>, <span class="kwrd">this</span>.ApplicationName);

                    conn.Open();
                    var result = cmd.ExecuteScalar();
                    conn.Close();

                    <span class="kwrd">if</span>(result != <span class="kwrd">null</span>)
                    {
                        <span class="kwrd">return</span> (<span class="kwrd">int</span>)result;
                    }
                }
            }
            <span class="rem">//如果用户不存在，则返回-1</span>
            <span class="kwrd">return</span> -1;
        }
    }
}</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<h1>修改web.config使用这个新的membership Provider</h1>
<p>修改部分为下面粗体的部分</p><pre class="csharpcode">    <span class="kwrd">&lt;</span><span class="html">membership</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">providers</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">clear</span><span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="AspNetSqlMembershipProvider"</span> <span class="attr">type</span><span class="kwrd">="<strong>MvcApplicationSample.Extensions.MySQLMemberShipProvider,MvcApplicationSample</strong>"</span> <span class="attr">connectionStringName</span><span class="kwrd">="ApplicationServices"</span>
             <span class="attr">enablePasswordRetrieval</span><span class="kwrd">="false"</span> <span class="attr">enablePasswordReset</span><span class="kwrd">="true"</span> <span class="attr">requiresQuestionAndAnswer</span><span class="kwrd">="false"</span> <span class="attr">requiresUniqueEmail</span><span class="kwrd">="false"</span>
             <span class="attr">maxInvalidPasswordAttempts</span><span class="kwrd">="5"</span> <span class="attr">minRequiredPasswordLength</span><span class="kwrd">="6"</span> <span class="attr">minRequiredNonalphanumericCharacters</span><span class="kwrd">="0"</span> <span class="attr">passwordAttemptWindow</span><span class="kwrd">="10"</span>
             <span class="attr">applicationName</span><span class="kwrd">="/"</span> <span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">providers</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">membership</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>



<p>&nbsp;</p>
<p>&nbsp;</p>
<h1>修改AccountController中的代码（请注意粗体部分）</h1><pre class="csharpcode">        [HttpPost]
        <span class="kwrd">public</span> ActionResult LogOn(LogOnModel model, <span class="kwrd">string</span> returnUrl)
        {
            <span class="kwrd">if</span>(ModelState.IsValid)
            {
                <span class="kwrd">if</span>(Membership.ValidateUser(model.UserName, model.Password))
                {
                    FormsAuthentication.SetAuthCookie(model.UserName, model.RememberMe);
                    <span class="kwrd">if</span>(Url.IsLocalUrl(returnUrl) &amp;&amp; returnUrl.Length &gt; 1 &amp;&amp; returnUrl.StartsWith(<span class="str">"/"</span>)
                        &amp;&amp; !returnUrl.StartsWith(<span class="str">"//"</span>) &amp;&amp; !returnUrl.StartsWith(<span class="str">"/\\"))
                    {
                        return Redirect(returnUrl);
                    }
                    else
                    {
                        return RedirectToAction("</span>Index<span class="str">", "</span>Home<span class="str">");
                    }
                }
                else
                {


     <strong>               var provider = (Extensions.MySQLMemberShipProvider)Membership.Provider;
                    var count = provider.GetFailedPasswordAttemptCount(model.UserName);
                    var max = provider.MaxInvalidPasswordAttempts;

                    


                    if(count != -1)
                    {



                        ModelState.AddModelError("</strong></span><strong><span class="str">", count==max?"</span>Your account <span class="kwrd">is</span> locked.<span class="str">":string.Format("</span>You have been continually input the wrong password {0} times, <span class="kwrd">if</span> then enter {1} mistakes, your account will be locked</strong><strong><span class="str">", count, max - count));
                    }
                    else
                        ModelState.AddModelError("</span><span class="str">", "</span>The user name or password provided <span class="kwrd">is</span> incorrect.");</strong>
                }
            }

            <span class="rem">// If we got this far, something failed, redisplay form</span>
            <span class="kwrd">return</span> View(model);
        }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>这样的话，我们来测试一下效果看看</p><pre class="csharpcode"><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127226378.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127238495.png" width="931" height="627"></a></pre><pre class="csharpcode">如果连续输错5次，则提示已经被锁定了</pre><pre class="csharpcode">&nbsp;</pre><pre class="csharpcode"><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/201112112127252248.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201112/20111211212726220.png" width="931" height="627"></a></pre><pre class="csharpcode">&nbsp;</pre>
<p>本文源代码，可以通过这里下载 <a title="MvcApplicationSample.rar" href="http://files.cnblogs.com/chenxizhang/MvcApplicationSample.rar">MvcApplicationSample.rar</a></p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>