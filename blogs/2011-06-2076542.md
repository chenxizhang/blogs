# 常见SQL Server导入导出数据的几个工具 
> 原文发表于 2011-06-09, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/06/09/2076542.html 


<p>在我们的日常工作中，与数据库打交道的机会越来越多。这一篇文章我整理一下常见的SQL Server导入导出数据的几个工具</p> <p>&nbsp;</p> <h1>1. 数据导入导出向导</h1> <p>这是一个可视化的工具，我放在首位，是由于它可以极大灵活地满足导入导出功能，而且是所见即所得的，易于使用。</p> <p>启动数据导入导出向导的方式有好多种，我自己习惯直接通过如下的命令启动(开始=》运行）</p> <p>dtswizard（顾名思义，它是一个wizard——向导，而且是与dts——data transfomation service有关的)</p> <p>从下图可以看出，这个工具支持多种不同类型的数据源（以及数据目标），它其实不仅仅限于SQL Server服务器。</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb.png" width="239" height="244"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_3.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_3.png" width="239" height="244"></a></p> <p>【注意】如果是64位，这里的提供程序中找不到Excel和Access（我知道很多朋友都想导出这两种格式）</p> <p>&nbsp;</p> <p>该向导还可以通过在SQL Server Management Studio(SSMS)中启动。如果数据源或者数据目标是SQL Server的话，这是更加方便一些的。</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_4.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_4.png" width="244" height="184"></a></p> <p>【注意】通过这样的方式启动的向导，却又可以看到Excel和Access（很神奇吧，<img class="wlEmoticon wlEmoticon-smilewithtongueout" alt="Smile with tongue out" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/wlEmoticon-smilewithtongueout.png">）</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_5.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_5.png" width="239" height="244"></a></p> <p>值得一提的是，这个导入导出向导还有一个好处，就是将我们经常需要导入导出的操作保存起来，如下图所示</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_6.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_6.png" width="239" height="244"></a></p> <p>这里有一个所谓的SSIS Package，是什么意思呢？SSIS指的是SQL Server Integration Service，它是微软SQL Server BI平台的一个重要组件，用来设计和管理ETL解决方案。</p> <p>这个SSIS Package是一个扩展名为dtsx的特殊文件包，它可以通过一个所谓的Business Intelligence Developement Studio(BI Studio）打开查看，并且还可以进一步地编辑</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_7.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_7.png" width="244" height="175"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_8.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_8.png" width="244" height="175"></a></p> <p>【备注】SSIS的讨论已经超出了本篇文章的范围。如有兴趣，请搜索我其他的文章。</p> <p>&nbsp;</p> <p>&nbsp;</p> <h1>2.BCP</h1> <p>如果你要实现简单的数据导入导出，并且希望用脚本命令的方式，而不是图形界面来实现。那么可以考虑SQL Server提供的BCP实用工具。</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_9.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_9.png" width="244" height="168"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_10.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_10.png" width="244" height="168"></a></p> <p>上图演示了如何将一个表导出为Excel文件，但如果想要根据一个查询导出的话，则可以按照下面这样的语法</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_11.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_11.png" width="244" height="168"></a></p> <p>使用BCP也可以进行数据，只要将out改成In即可。</p> <p>【注意】使用bcp导出数据最大一个问题就是没有标题行</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_12.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_12.png" width="244" height="145"></a></p> <p>&nbsp;</p> <h1>3. Bulk Insert和OpenRowSet</h1> <p>如果想在T-SQL中直接导入Excel文件的数据，或者TXT文件的数据，则可以了解一下如下两个特殊的T-SQL语法</p> <p>BulkInsert的语法大致如下</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_13.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_13.png" width="244" height="147"></a></p> <p>OpenRowSet的语法大致如下</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_14.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_14.png" width="244" height="83"></a></p> <p>&nbsp;</p> <p>【备注】关于这两个语句的详细用法，请参考SQL Server自带的联机丛书。</p> <p>&nbsp;</p> <h1>4.FORXML和OPENXML</h1> <p>如果想要导出导入XML格式的数据，则可以了解一下FORXML和OPENXML语法（它们是T-SQL语法，所以也可以很灵活地嵌入在我们的存储过程中）</p><pre class="csharpcode"><span class="kwrd">USE</span> Northwind
<span class="kwrd">GO</span>

<span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> Orders 
    <span class="kwrd">FOR</span> XML RAW(<span class="str">'OrderItem'</span>),
    ELEMENTS XSINIL,
    ROOT(<span class="str">'Orders'</span>) </pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>上面的语法，可以将查询用XML格式返回，如下图所示</p>
<p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_15.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_15.png" width="244" height="224"></a></p>
<p>【备注】FOR XML是SELECT的一个子句，有关更多用法，请参考SQL Server自带的联机丛书</p>
<p>【备注】导出为XML格式的目的是为了更好地在不同应用程序之间共享。</p>
<p>&nbsp;</p>
<p>反过来，如果我们得到了一段XML数据，想将其导入到SQL Server中某个表中。可以考虑用OPENXML的语法。它的作用就是将XML还原为行集数据，然后就可以插入到我们的目的表中去了。</p><pre class="csharpcode"><span class="kwrd">DECLARE</span> @x XML
<span class="kwrd">DECLARE</span> @docHandle <span class="kwrd">int</span>

<span class="kwrd">SET</span> @x=N<span class="str">'&lt;Orders xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
  &lt;OrderItem&gt;
    &lt;OrderID&gt;10248&lt;/OrderID&gt;
    &lt;CustomerID&gt;VINET&lt;/CustomerID&gt;
    &lt;EmployeeID&gt;3&lt;/EmployeeID&gt;
    &lt;OrderDate&gt;1996-07-04T00:00:00&lt;/OrderDate&gt;
    &lt;RequiredDate&gt;1996-08-01T00:00:00&lt;/RequiredDate&gt;
    &lt;ShippedDate&gt;1996-07-16T00:00:00&lt;/ShippedDate&gt;
    &lt;ShipVia&gt;3&lt;/ShipVia&gt;
    &lt;Freight&gt;32.3800&lt;/Freight&gt;
    &lt;ShipName&gt;Vins et alcools Chevalier&lt;/ShipName&gt;
    &lt;ShipAddress&gt;59 rue de lAbbaye&lt;/ShipAddress&gt;
    &lt;ShipCity&gt;Reims&lt;/ShipCity&gt;
    &lt;ShipRegion xsi:nil="true" /&gt;
    &lt;ShipPostalCode&gt;51100&lt;/ShipPostalCode&gt;
    &lt;ShipCountry&gt;France&lt;/ShipCountry&gt;
  &lt;/OrderItem&gt;
  &lt;OrderItem&gt;
    &lt;OrderID&gt;10249&lt;/OrderID&gt;
    &lt;CustomerID&gt;TOMSP&lt;/CustomerID&gt;
    &lt;EmployeeID&gt;6&lt;/EmployeeID&gt;
    &lt;OrderDate&gt;1996-07-05T00:00:00&lt;/OrderDate&gt;
    &lt;RequiredDate&gt;1996-08-16T00:00:00&lt;/RequiredDate&gt;
    &lt;ShippedDate&gt;1996-07-10T00:00:00&lt;/ShippedDate&gt;
    &lt;ShipVia&gt;1&lt;/ShipVia&gt;
    &lt;Freight&gt;11.6100&lt;/Freight&gt;
    &lt;ShipName&gt;Toms Spezialitäten&lt;/ShipName&gt;
    &lt;ShipAddress&gt;Luisenstr. 48&lt;/ShipAddress&gt;
    &lt;ShipCity&gt;Münster&lt;/ShipCity&gt;
    &lt;ShipRegion xsi:nil="true" /&gt;
    &lt;ShipPostalCode&gt;44087&lt;/ShipPostalCode&gt;
    &lt;ShipCountry&gt;Germany&lt;/ShipCountry&gt;
  &lt;/OrderItem&gt;&lt;/Orders&gt;'</span>
  
  

--第一步，做准备
<span class="kwrd">EXEC</span> SP_XML_PREPAREDOCUMENT @docHandle <span class="kwrd">OUTPUT</span>,@x
--第二步，<span class="kwrd">openxml</span>
INSERT Orders <span class="kwrd">SELECT</span> * <span class="kwrd">FROM</span> <span class="kwrd">OPENXML</span>(@docHandle,N<span class="str">'/Orders/OrderItem'</span>,2) <span class="kwrd">WITH</span> Orders
--第三步，销毁
<span class="kwrd">EXEC</span> sp_xml_removedocument @docHandle
  </pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>【备注】OPENXML还有其他更加复杂的用法，请参考SQL Server自带的联机丛书</p>
<p>&nbsp;</p>
<h1>5.使用Excel导出数据，或者建立查询</h1>
<p>最后介绍一种更加简单的方法，如果经常需要在Excel中进行数据库查询，并且据此做一些进一步的分析。最好的方法是在Excel中直接去导出数据，或者建立查询</p>
<p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_16.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_16.png" width="244" height="184"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_17.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_17.png" width="244" height="172"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_18.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_18.png" width="244" height="174"></a></p>
<p><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_19.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_19.png" width="244" height="205"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_20.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_20.png" width="244" height="206"></a><a href="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_21.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server_D62C/image_thumb_21.png" width="244" height="145"></a></p>
<p>这个做法的好处，是可以在现有Excel中，任何位置放置你需要的数据，而且需要注意的是，这些数据是链接到数据库的，也就是说，如果数据库的数据发生了更新，则只要刷新一下就可以了。</p>