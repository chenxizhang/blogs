# SQL Server 2008性能数据收集（Data Collector)的一些扩展话题 
> 原文发表于 2011-03-16, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/03/16/1986293.html 


<p>Data Collector是SQL Server 2008 新增的一个特性，位列管理员需知的top 10列表中。该功能在SQL Server 2008 R2中没有太大的变化</p> <h1>什么是Data Collector</h1> <p>关于这个主题，请直接参考微软官方的说明 <a title="http://msdn.microsoft.com/zh-CN/library/bb677248.aspx" href="http://msdn.microsoft.com/zh-CN/library/bb677248.aspx">http://msdn.microsoft.com/zh-CN/library/bb677248.aspx</a></p> <p>关于如何配置Data Collector的详细步骤，可以参考&nbsp; <a title="http://www.qudong.com/soft/program/Sql%20Server/jichujiaocheng/20090106/28656.html" href="http://www.qudong.com/soft/program/Sql%20Server/jichujiaocheng/20090106/28656.html">http://www.qudong.com/soft/program/Sql%20Server/jichujiaocheng/20090106/28656.html</a></p> <p>&nbsp;</p> <p>本文主要解释几个与该功能有关的扩展话题，也是我曾经被几次问到的</p> <p>&nbsp;</p> <h1>能不能收集多个实例的数据</h1> <p>很多管理员都关心这个话题，因为DBA需要管理多个实例，那么是不是需要在多个实例上面都去配置那个数据仓库呢？</p> <p>应该不是这样的。数据收集器功能的架构是下面这样</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/clip_image002.gif"><img title="clip_image002" border="0" alt="clip_image002" src="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/clip_image002_thumb.gif" width="483" height="364"></a></p> <p>&nbsp;</p> <p>也就是说，可以只有一个数据仓库（MDW:Management Data Warehouse)，然后在多个Target instance上面，配置收集，并且将其结果发送到这个中心的MDW中来。DBA们可以通过客户端机器，远程控制MDW，并且查看报表。</p> <p>&nbsp;</p> <h1></h1> <h1></h1> <h1>对性能的影响是怎么样的</h1> <p>既然数据收集是在每个需要收集的实例上面直接运行的，那么就有DBA问到，这样的话会不会对这个实例产生不利的影响呢？这个说法是这样，肯定是有影响的，因为性能收集说到底是一种查询，包括对DMV的查询，或者对性能计数器的查询。而它查询是定期运行的。例如Server Activity的话，默认都是60秒收集一次。据一般的估计，如果只是使用了默认的三个系统收集组，而且没有进行修改所有的默认收集或者上传的时间，那么配置了性能收集，对当前实例的影响主要体现在会加重CPU的一点点负担，具体大约是5%左右。数据的体积大约为300MB左右/天。</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_thumb.png" width="1075" height="751"></a></p> <h1>如何自定义数据集(Collection Set)</h1> <p>系统默认自带了3个（SQL SERVER 2008)或者4个（SQL Server 2008 R2)数据集</p> <p><a href="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_3.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_thumb_3.png" width="278" height="168"></a></p> <p>&nbsp;</p> <p>但是，如果我们需要自定义数据集，应该怎么做呢？下面有一个范例脚本</p> <p>请注意，这个脚本是在msdb中进行工作</p> <p>&nbsp;</p><pre class="csharpcode"><span class="kwrd">Use</span> msdb
<span class="kwrd">go</span>

<span class="kwrd">Declare</span> @collection_set_id_1 <span class="kwrd">int</span>
<span class="kwrd">Declare</span> @collection_set_uid_2 uniqueidentifier
<span class="kwrd">EXEC</span> [dbo].[sp_syscollector_create_collection_set] 
    @name=N<span class="str">'Disk Performance and SQL CPU'</span>, 
    @collection_mode=1, 
    @description=N<span class="str">'Collects logical disk performance counters and SQL Process CPU'</span>, 
    @target=N<span class="str">''</span>, 
    @logging_level=0, 
    @days_until_expiration=7, 
    @proxy_name=N<span class="str">''</span>, 
    @schedule_name=N<span class="str">'CollectorSchedule_Every_5min'</span>, 
    @collection_set_id=@collection_set_id_1 <span class="kwrd">OUTPUT</span>, 
    @collection_set_uid=@collection_set_uid_2 <span class="kwrd">OUTPUT</span>
<span class="kwrd">Select</span> collection_set_id_1=@collection_set_id_1, collection_set_uid_2=@collection_set_uid_2

<span class="kwrd">Declare</span> @collector_type_uid_3 uniqueidentifier
<span class="kwrd">Select</span> @collector_type_uid_3 = collector_type_uid <span class="kwrd">From</span> [dbo].[syscollector_collector_types] <span class="kwrd">Where</span> name = N<span class="str">'Performance Counters Collector Type'</span>;
<span class="kwrd">Declare</span> @collection_item_id_4 <span class="kwrd">int</span>
<span class="kwrd">EXEC</span> [dbo].[sp_syscollector_create_collection_item] 
@name=N<span class="str">'Logical Disk Collection and SQL Server CPU'</span>, 
@<span class="kwrd">parameters</span>=N<span class="str">'&lt;ns:PerformanceCountersCollector xmlns:ns="DataCollectorType"&gt;
    &lt;PerformanceCounters Objects="LogicalDisk" 
        Counters="Avg. Disk Bytes/Read" 
        Instances="*" /&gt;
    &lt;PerformanceCounters Objects="LogicalDisk" 
        Counters="Avg. Disk Bytes/Write" 
        Instances="*" /&gt;
    &lt;PerformanceCounters Objects="LogicalDisk" 
        Counters="Avg. Disk sec/Read" 
        Instances="*" /&gt;
    &lt;PerformanceCounters Objects="LogicalDisk" 
        Counters="Avg. Disk sec/Write" 
        Instances="*" /&gt;
    &lt;PerformanceCounters Objects="LogicalDisk" 
        Counters="Disk Read Bytes/sec" 
        Instances="*" /&gt;
    &lt;PerformanceCounters Objects="LogicalDisk" 
        Counters="Disk Write Bytes/sec" 
        Instances="*" /&gt;
    &lt;PerformanceCounters Objects="Process" 
        Counters="% Privileged Time" 
        Instances="sqlservr" /&gt;
    &lt;PerformanceCounters Objects="Process" 
        Counters="% Processor Time" 
        Instances="sqlservr" /&gt;
&lt;/ns:PerformanceCountersCollector&gt;'</span>, 
@collection_item_id=@collection_item_id_4 <span class="kwrd">OUTPUT</span>, 
@frequency=5, 
@collection_set_id=@collection_set_id_1, 
@collector_type_uid=@collector_type_uid_3
<span class="kwrd">Select</span> @collection_item_id_4
<span class="kwrd">go</span> 
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>执行完之后，就有下面这样一个新的Collection Set出来</p>
<p><a href="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_4.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_thumb_4.png" width="308" height="164"></a></p>
<p>&nbsp;</p>
<p>然后可以启用它，并且收集，上传</p><pre class="csharpcode"><span class="kwrd">EXEC</span> sp_syscollector_start_collection_set @collection_set_id = &lt;collection_set_id_1&gt;
<span class="rem">-- replace &lt;collection_set_id_1&gt; with value from above </span>
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>最后，运行下面的脚本可以获得结果（注意，这个脚本不是在msdb中运行，而是在数据仓库中）</p><pre class="csharpcode"><span class="kwrd">select</span> spci.<span class="kwrd">path</span> <span class="kwrd">as</span> <span class="str">'Counter Path'</span>, spci.object_name <span class="kwrd">as</span> <span class="str">'Object Name'</span>,
spci.counter_name <span class="kwrd">as</span> <span class="str">'counter Name'</span>, spci.instance_name,
spcv.formatted_value <span class="kwrd">as</span> <span class="str">'Formatted Value'</span>,
spcv.collection_time <span class="kwrd">as</span> <span class="str">'Collection Time'</span>,
csii.instance_name <span class="kwrd">as</span> <span class="str">'SQL Server Instance'</span> 
<span class="kwrd">from</span> snapshots.performance_counter_values spcv, 
snapshots.performance_counter_instances spci,
msdb.dbo.syscollector_collection_sets_internal scsi,
core.source_info_internal csii,
core.snapshots_internal csi
<span class="kwrd">where</span> spcv.performance_counter_instance_id = spci.performance_counter_id <span class="kwrd">and</span>
scsi.collection_set_uid=csii.collection_set_uid <span class="kwrd">and</span>
csii.source_id = csi.source_id <span class="kwrd">and</span> csi.snapshot_id=spcv.snapshot_id <span class="kwrd">and</span>
scsi.name = <span class="str">'Disk Performance and SQL CPU'</span>
<span class="kwrd">order</span> <span class="kwrd">by</span> spcv.collection_time <span class="kwrd">desc</span>
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>结果大致如下</p>
<p><a href="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_5.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/SQL-Server-2008_F0BA/image_thumb_5.png" width="1017" height="458"></a></p>
<p>&nbsp;</p>
<p>希望对于大家有所帮助</p>