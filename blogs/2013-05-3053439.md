# 优化网站设计（七）：避免在CSS中使用表达式 
> 原文发表于 2013-05-01, 地址: http://www.cnblogs.com/chenxizhang/archive/2013/05/01/3053439.html 


<h1>前言</h1>
<p>网站设计的优化是一个很大的话题,有一些通用的原则,也有针对不同开发平台的一些建议。这方面的研究一直没有停止过，我在不同的场合也分享过这样的话题。</p>
<p>作为通用的原则，雅虎的工程师团队曾经给出过35个最佳实践。这个列表请参考</p>
<p>Best Practices for Speeding Up Your Web Site&nbsp; <a href="http://developer.yahoo.com/performance/rules.html">http://developer.yahoo.com/performance/rules.html</a></p>
<p>同时，他们还发布了一个相应的测试工具Yslow <a href="http://developer.yahoo.com/yslow/">http://developer.yahoo.com/yslow/</a></p>
<p>我强烈推荐所有的网站开发人员都应该学习这些最佳实践，并结合自己的实际项目情况进行应用。</p>
<p>接下来的一段时间，我将结合ASP.NET这个开发平台，针对这些原则，通过一个系列文章的形式，做些讲解和演绎，以帮助大家更好地理解这些原则，并且更好地使用他们。</p>
<h1>准备工作</h1>
<p>为了跟随我进行后续的学习，你需要准备如下的开发环境和工具</p>
<ol>
<li>Google Chrome 或者firefox ，并且安装 Yslow这个扩展组件.请注意，这个组件是雅虎提供的，但目前没有针对IE的版本。<ol>
<li><a href="https://chrome.google.com/webstore/detail/yslow/ninejjcohidippngpapiilnmkgllmakh">https://chrome.google.com/webstore/detail/yslow/ninejjcohidippngpapiilnmkgllmakh</a>
<p>Technorati Tags: <a href="http://technorati.com/tags/Performance">Performance</a>,<a href="http://technorati.com/tags/Web+design">Web design</a>,<a href="http://technorati.com/tags/ASP.NET">ASP.NET</a></p>
</li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/yslow/">https://addons.mozilla.org/en-US/firefox/addon/yslow/</a></li>
<li>你应该对这些浏览器的开发人员工具有所了解，你可以通过按下F12键调出这个工具。</li>
</ol></li>
<li>Visaul Studio 2010 SP1 或更高版本，推荐使用Visual Studio 2012<ol>
<li><a href="http://www.microsoft.com/visualstudio/eng/downloads">http://www.microsoft.com/visualstudio/eng/downloads</a></li>
</ol></li>
<li>你需要对ASP.NET的开发基本流程和核心技术有相当的了解，本系列文章很难对基础知识做普及。</li>
</ol>
<h1>本文要讨论的话题</h1>
<p>这一篇我来和大家讨论个原则：<a href="http://developer.yahoo.com/performance/rules.html#css_expressions">Avoid CSS Expressions</a>&nbsp; （避免在CSS中使用表达式）</p>
<p>最早的CSS是不支持所谓的表达式的，微软的IE从5.0开始引入了这种概念，意思是希望我们拥有定义动态的CSS样式的能力，详细的文章请参考<a href="http://msdn.microsoft.com/en-us/library/ms537634(v=VS.85).aspx">http://msdn.microsoft.com/en-us/library/ms537634(v=VS.85).aspx</a>，下面有一个简单的例子：</p>
<p><strong><span>background-color: expression((new Date()).getHours()%2 ? "#B8D4FF" : "#F08A00" );</span></strong></p>
<p>这里可以使用一个特殊的expression函数，其实这是一个javascript的函数。它可以进行根据一个表达式进行计算，动态地决定background-color的值。</p>
<p>看起来是一个相当不错的功能，但我们可能不会想到这个表达式会运算很多次（这个具体的次数可能远远超过你的想象）</p>
<p>我随便定义了一个界面，并添加了如下的样式定义</p>
<pre class="csharpcode">    <span class="kwrd">&lt;</span><span class="html">style</span><span class="kwrd">&gt;</span>
        body {
            background-color: expression((new Date()).getHours()%2 ? "#B8D4FF" : "#F08A00" );
        }
    <span class="kwrd">&lt;/</span><span class="html">style</span><span class="kwrd">&gt;</span></pre>
<style><!--
.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
--></style>
<p>打开之后，只是鼠标动来动去，或者滚动条上下拖动几下，就会执行1865次。如下图所示</p>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01182253-b653c8cd5d454a0b829aee6603233eb9.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01182254-08d990f60a5040958301bde0782b5ca1.png" alt="image" width="244" height="170" border="0" /></a></p>
<p>很显然，这是很可观的一些成本。这还是比较简单的表达式，试想一下，如果有更加复杂的表达式呢？这些函数需要一次一次的执行，毫无疑问地会拖累页面执行的效率，乃至浏览器的性能。</p>
<p>正因为如此，不光是其他浏览器都不支持，同时w3c标准组织也不支持这种方式。鉴于此，微软方面也于2008年（彼时发布了IE 8）的时候，正式终止了对这种功能的支持。下面这篇文章是当时所发出的声明：</p>
<p><a href="http://blogs.msdn.com/b/ie/archive/2008/10/16/ending-expressions.aspx">http://blogs.msdn.com/b/ie/archive/2008/10/16/ending-expressions.aspx</a></p>
<p>文中提到的三点不再支持CSS表达式的原因，显然是很中肯的（<strong><span>更加符合标准，更加有利于性能提升，以及减少受攻击面</span></strong>）</p>
<p><strong>Why end support for expressions ?</strong></p>
<ul>
<li><strong>To comply with standards</strong>
<ul>
<li>Expressions are proprietary to Internet Explorer and as such not interoperable.</li>
<li>A common use-case for expressions was to fix IE bugs or to emulate those CSS 2.1 features not yet supported by the browser, for example, min-width and max-width. We have not only worked hard to fix these bugs in IE8 but our new layout engine supports the missing features natively.</li>
</ul>
</li>
<li><strong>To improve performance</strong>
<ul>
<li>Expressions evaluation has a high runtime cost; web performance experts like Steve Souders <a href="http://developer.yahoo.net/blog/archives/2007/07/high_performanc_6.html">recommend avoiding them to improve front-end performance</a></li>
</ul>
</li>
<li><strong>To reduce the browser attack surface</strong>
<ul>
<li>Because they expose a script execution context, CSS expressions constitute a possible script injection attack vector.</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>那么，情况已经很清楚了，如果你根本不了解CSS表达式，那么恭喜你，你不需要再了解它了。如果你以前用过CSS表达式，而且对它还比较喜欢，那么我也希望你能慎重地考虑一下这条建议，并且毅然地选择放弃这种功能，拥抱标准吧。</p>
<p>好吧，你可能已经同意了我的提议，但是仍然有一个疑问，那么如果我们真的希望实现动态的CSS，怎么办呢？例如上面这个例子，我们希望根据当前的时间，来决定显示什么背景颜色。（小时为单数时显示一种颜色，为复数时显示另外一种颜色）。</p>
<p>你在想这个问题是吗？那我们为什么不像下面这么做呢？</p>
<pre class="csharpcode">    &lt;script src=<span class="str">"Scripts/jquery-2.0.0.min.js"</span>&gt;&lt;/script&gt;
    &lt;script&gt;
        $(<span class="kwrd">function</span> () {
            $(<span class="str">"body"</span>).css(<span class="str">"background-color"</span>, (<span class="kwrd">new</span> Date()).getHours() % 2 ? <span class="str">"#B8D4FF"</span> : <span class="str">"#F08A00"</span>);
        });
    &lt;/script&gt;
</pre>
<style><!--
.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
--></style>
<p>我们不光发现调用次数少了，而且这种代码在所有主流浏览器都能实现一致的用户体验，何乐而不为呢？</p>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01182255-12b17870ddea4ee1ba922133c092d200.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01182256-af4938b422cb40668d6f47a51fe3bc5c.png" alt="image" width="244" height="170" border="0" /></a></p>
<p>【备注】因为使用了jquery,所以会有一些其他的方法调用。</p>