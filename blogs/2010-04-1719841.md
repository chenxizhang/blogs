# MOSS 2010:Visual Studio 2010开发体验（14）&mdash;&mdash;列表开发之事件接收器 
> 原文发表于 2010-04-25, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/04/25/1719841.html 


<p>通过前面几篇，我们已经完成了内容类型，列表定义，列表实例的开发。本篇继续讲解列表中的一个重要环节——事件接收器开发。</p> <p>我们的场景是：我希望之前做好的订单列表这个内容类型自动地具有某些事件特征，例如当用户在添加一个条目的时候，检查订购日期，如果小于今天的话，就不让添加。（这只是一个假设的场景，现实工作中可以依照业务逻辑而定）</p> <p>我们应该如何实现这个需求呢？Follow me </p> <p>1.添加一个事件接收器</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb.png" width="1044" height="810"></a> </p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_6.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_2.png" width="1044" height="810"></a> </p> <p></p> <p>下面是默认生成的两个文件</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_8.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_3.png" width="1044" height="810"></a> </p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_10.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_4.png" width="1044" height="810"></a> </p> <p>&lt;?xml version="1.0" encoding="utf-8"?&gt;<br>&lt;Elements xmlns="<a href="http://schemas.microsoft.com/sharepoint/&quot;">http://schemas.microsoft.com/sharepoint/"</a>&gt;<br>&nbsp; &lt;Receivers ListTemplateId="10000"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Receiver&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Name&gt;OrderItemEventReceiverItemAdding&lt;/Name&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Type&gt;ItemAdding&lt;/Type&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Assembly&gt;$SharePoint.Project.AssemblyFullName$&lt;/Assembly&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Class&gt;OrderListSolution.OrderItemEventReceiver.OrderItemEventReceiver&lt;/Class&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;SequenceNumber&gt;10000&lt;/SequenceNumber&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Receiver&gt;  <p>&nbsp; &lt;/Receivers&gt;<br>&lt;/Elements&gt; <p></p> <p>&nbsp;</p> <p>2. 修改有关代码实现业务逻辑</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Security.Permissions;
<span class="kwrd">using</span> Microsoft.SharePoint;
<span class="kwrd">using</span> Microsoft.SharePoint.Security;
<span class="kwrd">using</span> Microsoft.SharePoint.Utilities;
<span class="kwrd">using</span> Microsoft.SharePoint.Workflow; 

<span class="kwrd">namespace</span> OrderListSolution.OrderItemEventReceiver
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// List Item Events</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> OrderItemEventReceiver : SPItemEventReceiver
    {
       <span class="rem">/// &lt;summary&gt;</span>
       <span class="rem">/// An item is being added.</span>
       <span class="rem">/// &lt;/summary&gt;</span>
       <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> ItemAdding(SPItemEventProperties properties)
       { 

           SPItemEventDataCollection data = properties.AfterProperties;
           SPList list = properties.OpenWeb().Lists[properties.ListId];
           <span class="kwrd">string</span> fieldName= list.Fields.GetField(<span class="str">"订购日"</span>).InternalName; 

           var date = DateTime.Parse(data[fieldName].ToString());
           <span class="kwrd">if</span> (date &gt; DateTime.Now)
           {
               properties.ErrorMessage = <span class="str">"当前添加的日期不合法"</span>;
               properties.Cancel = <span class="kwrd">true</span>;
               <span class="kwrd">return</span>; 

           } 

       } 

    }
}
<a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_12.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_5.png" width="1044" height="810"></a> </pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>3.部署和调试，按下F5键</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_14.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_6.png" width="1044" height="810"></a> </p>
<p>【注意】我们这里故意将订购日设置于大于当前日期。根据事件中的逻辑，我们预期它会报告一个错误，而且取消当前的提交</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_16.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_7.png" width="1044" height="810"></a> </p>
<p>我们看到了这个错误页面，看起来有些吓人，不是吗？对于一般用户来说，他们可能要被吓坏了</p>
<p>接下来，我们可以定义一个专门的页面来显示错误消息，提高用户体验</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_18.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_8.png" width="1044" height="810"></a> </p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_20.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201014_BCB1/image_thumb_9.png" width="1044" height="810"></a> </p>
<p>然后修改一下代码</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Security.Permissions;
<span class="kwrd">using</span> Microsoft.SharePoint;
<span class="kwrd">using</span> Microsoft.SharePoint.Security;
<span class="kwrd">using</span> Microsoft.SharePoint.Utilities;
<span class="kwrd">using</span> Microsoft.SharePoint.Workflow;

<span class="kwrd">namespace</span> OrderListSolution.OrderItemEventReceiver
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// List Item Events</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> OrderItemEventReceiver : SPItemEventReceiver
    {
       <span class="rem">/// &lt;summary&gt;</span>
       <span class="rem">/// An item is being added.</span>
       <span class="rem">/// &lt;/summary&gt;</span>
       <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> ItemAdding(SPItemEventProperties properties)
       {


           SPItemEventDataCollection data = properties.AfterProperties;
           SPList list = properties.OpenWeb().Lists[properties.ListId];
           <span class="kwrd">string</span> fieldName= list.Fields.GetField(<span class="str">"订购日"</span>).InternalName;


           

           var date = DateTime.Parse(data[fieldName].ToString());
           <span class="kwrd">if</span> (date &gt; DateTime.Now)
           {
               <span class="rem">//properties.ErrorMessage = "当前添加的日期不合法";</span>
               properties.Status = SPEventReceiverStatus.CancelWithRedirectUrl;
               properties.RedirectUrl = <span class="str">"/_layouts/OrderListSolution/ErrorPage.aspx"</span>;
               properties.Cancel = <span class="kwrd">true</span>;

           }

       }


    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>