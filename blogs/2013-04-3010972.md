# 定制WPF中的DataGrid控件支持对不同的实体类实现中文标题显示 
> 原文发表于 2013-04-09, 地址: http://www.cnblogs.com/chenxizhang/archive/2013/04/09/3010972.html 


<h2>问题提出：</h2> <p>这是今天被问到的一个问题。情况是这样的：</p> <p>我们都知道WPF中有一个用来显示列表数据的DataGrid控件，而且该控件具有一个AutoGenerateColumns 属性（默认为true)，它可以根据给定的数据，自动地设置列的标题，也就是说，我们可以根据需要读取不同的实体数据，然后绑定到控件上去，它自己知道该如何创建列，以及显示数据。</p> <p>这里的问题在于，我们的实体类定义通常都是英文的，例如下面是一个最简单的例子</p><pre class="csharpcode">    <span class="kwrd">public</span> <span class="kwrd">class</span> Employee
    {
        <span class="kwrd">public</span> <span class="kwrd">string</span> FirstName { get; set; }
        <span class="kwrd">public</span> <span class="kwrd">string</span> LastName { get; set; }
    }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>DataGrid会自动为每个属性建立一个列，并且列标题设置为属性名称。例如下面这样：</p>
<p><a href="http://images.cnitblog.com/blog/9072/201304/09204159-d0e6bd3ee3ff4462a2a50ca32578aa9b.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201304/09204159-ee3ef1d00aab4769a7955c856704586a.png" width="660" height="214"></a></p>
<p>但是，美中不足的是，我们的用户更喜欢中文的标题。那么，我们是否能够以最小的代价，让这些标题能显示中文呢？</p>
<p>&nbsp;</p>
<h2>解决方案：</h2>
<p>首先，我联想到了MVC中的一个做法，就是需要给实体类添加属性描述，因为无论如何，我们需要有一个地方可以定义这些中文标题。幸运的是，我们可以直接使用内置的DataAnnotation的功能来实现，例如：</p><pre class="csharpcode">    <span class="kwrd">public</span> <span class="kwrd">class</span> Employee
    {
        [Display(Name=<span class="str">"姓氏"</span>)]
        <span class="kwrd">public</span> <span class="kwrd">string</span> FirstName { get; set; }
        [Display(Name=<span class="str">"名字"</span>)]
        <span class="kwrd">public</span> <span class="kwrd">string</span> LastName { get; set; }
    }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>备注：这里要先引用System.ComponentModel.DataAnnotations 这个程序集。</p>
<p>&nbsp;</p>
<p>接下来，我们的问题就是，如何将这里定义好的Display的属性，读取到DataGrid的列标题处。我首先想到的是，能否通过定制ColumnHeaderStyle来实现，但经过一些努力，没有成功。如果有朋友对这个方案有补充，请不吝赐教。</p>
<p>我最后采用的方法是这样的，DataGrid有一个事件叫：AutoGeneratingColumn&nbsp; ，顾名思义，这个事件就是在列被创建出来之前触发的。我通过下面的代码实现了我们想要的功能。</p><pre class="csharpcode">        <span class="kwrd">private</span> <span class="kwrd">void</span> DataGrid_AutoGeneratingColumn_1(<span class="kwrd">object</span> sender, DataGridAutoGeneratingColumnEventArgs e)
        {
            var result = e.PropertyName;
            var p = (e.PropertyDescriptor <span class="kwrd">as</span> PropertyDescriptor).ComponentType.GetProperties().FirstOrDefault(x =&gt; x.Name == e.PropertyName);

            <span class="kwrd">if</span> (p != <span class="kwrd">null</span>)
            {
                var found = p.GetCustomAttribute&lt;DisplayAttribute&gt;();
                <span class="kwrd">if</span> (found != <span class="kwrd">null</span>) result = found.Name;
            }

            e.Column.Header = result;
        }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>这样一来，我们看到的界面就是下面这样的啦</p>
<p><a href="http://images.cnitblog.com/blog/9072/201304/09204159-5cb304f6fd7746bba4385efef9e8c8aa.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201304/09204200-1083d460daf64fd1a38d96e1302f3566.png" width="660" height="223"></a></p>
<p>而且重要的，这个功能是完全通用的，不管日后想要换成什么样的实体类型，都可以通过定义Display这个Attributel来改变标题。</p>
<p>&nbsp;</p>
<p>最后，我还这个功能封装了一下，以便更加好的使用.我做了一个扩展控件，如下所示</p><pre class="csharpcode"><span class="kwrd">using</span> System.ComponentModel;
<span class="kwrd">using</span> System.ComponentModel.DataAnnotations;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Reflection;
<span class="kwrd">using</span> System.Windows.Controls;

<span class="kwrd">namespace</span> WpfApplication1
{
    <span class="kwrd">class</span> xGrid:DataGrid
    {
        <span class="kwrd">public</span> xGrid()
        {
            AutoGeneratingColumn += (o, e) =&gt;
            {
                var result = e.PropertyName;
                var p = (e.PropertyDescriptor <span class="kwrd">as</span> PropertyDescriptor).ComponentType.GetProperties().FirstOrDefault(x =&gt; x.Name == e.PropertyName);

                <span class="kwrd">if</span> (p != <span class="kwrd">null</span>)
                {
                    var found = p.GetCustomAttribute&lt;DisplayAttribute&gt;();
                    <span class="kwrd">if</span> (found != <span class="kwrd">null</span>) result = found.Name;
                }

                e.Column.Header = result;
            };
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>这样的话，在项目中任何页面上我都可以直接像下面这样使用这个控件了。</p><pre class="csharpcode">&lt;Window x:Class=<span class="str">"WpfApplication1.MainWindow"</span>
        xmlns=<span class="str">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        xmlns:x=<span class="str">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
        Title=<span class="str">"MainWindow"</span>
        xmlns:controls=<span class="str">"clr-namespace:WpfApplication1"</span>
        Height=<span class="str">"350"</span>
        Width=<span class="str">"525"</span>&gt;
    &lt;Grid&gt;
        <strong><font color="#ff0000">&lt;controls:xGrid ItemsSource=<span class="str">"{Binding}"</span>&gt;&lt;/controls:xGrid&gt;</font></strong>
    &lt;/Grid&gt;
&lt;/Window&gt;
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>