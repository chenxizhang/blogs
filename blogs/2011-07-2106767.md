# 如何在RIA应用中实现用户授权 
> 原文发表于 2011-07-14, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/07/14/2106767.html 


<p><a href="http://www.cnblogs.com/chenxizhang/archive/2011/07/13/2105204.html">上一篇</a>我讲到了在RIA应用中的身份验证，其实在做一个应用系统的时候，身份验证只是第一步，验证是确认谁可以访问我们的系统。然后授权就是第二步，授权是确认谁可以在系统中做什么事情。</p> <p>那么，接着上面这个例子，我们现在有一个方法如下</p><pre class="csharpcode">        [Query][RequiresAuthentication]
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这个方法返回一些客户名称</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="kwrd">public</span> IQueryable&lt;Customer&gt; GetCustomers()
        {

            <span class="kwrd">return</span> <span class="kwrd">new</span>[]{
                <span class="kwrd">new</span> Customer(){ID=1,Name=<span class="str">"Microsoft"</span>},
                <span class="kwrd">new</span> Customer(){ID=2,Name=<span class="str">"Google"</span>},
                <span class="kwrd">new</span> Customer(){ID=3,Name=<span class="str">"Apple"</span>},
                <span class="kwrd">new</span> Customer(){ID=4,Name=<span class="str">"Facebook"</span>},
                <span class="kwrd">new</span> Customer(){ID=5,Name=<span class="str">"Yahoo"</span>},
                <span class="kwrd">new</span> Customer(){ID=16,Name=<span class="str">"AOL"</span>}
            }.AsQueryable();
        }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>这个方法返回了一些客户名称。那么，假设我们希望这个方法的调用者必须在我们的系统里面具有某个角色，例如Sales角色。只有在这个角色里面的用户，我们才授权给他调用该方法。</p>
<p>接下来我就把这个例子继续做下去，添加这部分功能。</p>
<p>&nbsp;</p>
<h1>1. 启用授权</h1>
<p>其实要说起来，要给某个方法进行授权很简单，我们只需要在方面上面添加一个Attribute即可，请注意看下面红色的部分</p><pre class="csharpcode">        [Query][RequiresAuthentication]<strong><font color="#ff0000">[RequiresRole(<span class="str">"Sales"</span>)]</font></strong>
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这个方法返回一些客户名称</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="kwrd">public</span> IQueryable&lt;Customer&gt; GetCustomers()
        {

            <span class="kwrd">return</span> <span class="kwrd">new</span>[]{
                <span class="kwrd">new</span> Customer(){ID=1,Name=<span class="str">"Microsoft"</span>},
                <span class="kwrd">new</span> Customer(){ID=2,Name=<span class="str">"Google"</span>},
                <span class="kwrd">new</span> Customer(){ID=3,Name=<span class="str">"Apple"</span>},
                <span class="kwrd">new</span> Customer(){ID=4,Name=<span class="str">"Facebook"</span>},
                <span class="kwrd">new</span> Customer(){ID=5,Name=<span class="str">"Yahoo"</span>},
                <span class="kwrd">new</span> Customer(){ID=16,Name=<span class="str">"AOL"</span>}
            }.AsQueryable();
        }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>我们可以先测试一下，现在运行起来会发生什么样的情况？一点都不意外，肯定是要报告错误的，因为我们现在的用户身份没有关联到任何的角色。如下图所示</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201107/201107142046038781.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201107/201107142046047012.png" width="920" height="395"></a></p>
<p>&nbsp;</p>
<h1>2. 实现角色管理</h1>
<p>我们需要在服务器端实现角色管理，就是要能够根据用户身份判断他所拥有的角色信息。</p>
<p>为了简单起见，我添加了一个SimpleRoleProvider，而且只重写了其中的一个方法，请注意下面红色的部分</p>
<p>【备注】这里只是做例子，重点是给大家讲它的原理。所以直接用硬编码的方式。</p>
<p>&nbsp;</p><pre class="csharpcode">  <span class="kwrd">public</span> <span class="kwrd">class</span> SimpleRoleProvider : System.Web.Security.RoleProvider
    {

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> AddUsersToRoles(<span class="kwrd">string</span>[] usernames, <span class="kwrd">string</span>[] roleNames)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> ApplicationName
        {
            get
            {
                <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
            }
            set
            {
                <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
            }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> CreateRole(<span class="kwrd">string</span> roleName)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> DeleteRole(<span class="kwrd">string</span> roleName, <span class="kwrd">bool</span> throwOnPopulatedRole)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span>[] FindUsersInRole(<span class="kwrd">string</span> roleName, <span class="kwrd">string</span> usernameToMatch)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span>[] GetAllRoles()
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

<strong><font color="#ff0000">        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span>[] GetRolesForUser(<span class="kwrd">string</span> username)
        {
            <span class="kwrd">if</span>(username == <span class="str">"chenxizhang"</span>)
                <span class="kwrd">return</span> <span class="kwrd">new</span>[] { 
                    <span class="str">"Sales"</span>
                };
            <span class="kwrd">return</span> <span class="kwrd">null</span>;
        }</font></strong>

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span>[] GetUsersInRole(<span class="kwrd">string</span> roleName)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> IsUserInRole(<span class="kwrd">string</span> username, <span class="kwrd">string</span> roleName)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> RemoveUsersFromRoles(<span class="kwrd">string</span>[] usernames, <span class="kwrd">string</span>[] roleNames)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> RoleExists(<span class="kwrd">string</span> roleName)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }
    }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>如何注册使用这个Provider呢？我们需要修改web.config文件</p>
<p>在system.web里面添加了这么一段</p><pre class="csharpcode">    <span class="kwrd">&lt;</span><span class="html">roleManager</span> <span class="attr">enabled</span><span class="kwrd">="true"</span> <span class="attr">defaultProvider</span><span class="kwrd">="simple"</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">providers</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">clear</span><span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="simple"</span> <span class="attr">type</span><span class="kwrd">="SilverlightRIAAuthenticationSample.Web.SimpleRoleProvider"</span><span class="kwrd">/&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">providers</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">roleManager</span><span class="kwrd">&gt;</span></pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
再次运行程序，我们会发现已经能返回数据了，为什么呢，因为chenxizhang这个用户是Sales角色的，所以他就有权限查询。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201107/201107142046051025.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201107/201107142046078941.png" width="1003" height="656"></a></p>
<p>这就是在RIA Service中进行授权的简单例子。虽然简单，但已经能够说明问题了。</p>
<p>讲到这里，有很多朋友都理解了。但也许有人会对写这个SimpleRoleProvider感到疑惑，为什么要这么写呢？能不能用数据库里面的信息来授权呢？当然是可以的，在真正的系统中，我是推荐你用数据库来做身份验证和授权的。</p>
<p>&nbsp;</p>
<p>下面有些参考链接</p>
<p><a href="http://msdn.microsoft.com/en-us/library/6e9y4s5t.aspx">http://msdn.microsoft.com/en-us/library/6e9y4s5t.aspx</a></p>
<p><a href="http://msdn.microsoft.com/en-us/library/879kf95c.aspx">http://msdn.microsoft.com/en-us/library/879kf95c.aspx</a></p>
<p><a href="http://msdn.microsoft.com/en-us/library/2fx93s7w.aspx">http://msdn.microsoft.com/en-us/library/2fx93s7w.aspx</a></p>
<p>&nbsp;</p>
<p>简而言之，其实从ASP.NET 2.0开始就提供了一套标准的服务来完成身份验证，授权，个性化，配置等等功能，而且有一个非常标准的数据库——传说中的“aspnetdb”.</p>
<p>&nbsp;</p>
<h1>3.两个相关问题</h1>
<p>有网友之前问到，如何实现更加动态化的授权呢？我是这么理解的，有两个层面</p>
<ul>
<li>我们有些方法，可能需要根据当前用户的身份，对数据进行过滤。也就是说，其实方法都是可以被用户调用的，只不过每个人调用的结果不一样。这也是一种特殊的授权吧。</li></ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这个问题的关键在于，如何在方法里面获取得到当前用户的身份。请参考下面这个代码。既然能得到用户的信息，那么在查询的时候，就可以用这个作为参数传递到数据库进行过滤。这样就实现了刚才所说的需求。</p>
<blockquote><pre class="csharpcode">            var currentUser = <span class="kwrd">this</span>.ServiceContext.User.Identity.Name;</pre></blockquote>
<ul>
<li>有的朋友可能会觉得系统自带的这个RequiresRole属性不够灵活。我之前接触过一个客户，他们的情况是，他们不想将角色名称写死在代码里面。希望能够读取配置文件的方式。这当然也不是说做不到。我下面用一个小例子来演示</li></ul>
<p>首先，我可以定义一个特殊的类型，继承自AuthorizationAttribute </p>
<p>&nbsp;</p><pre class="csharpcode"><span class="kwrd">using</span> System.ComponentModel.DataAnnotations;
<span class="kwrd">using</span> System.Configuration;

<span class="kwrd">namespace</span> SilverlightRIAAuthenticationSample.Web
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> DynamicRequiresRole:AuthorizationAttribute
    {
        <span class="kwrd">protected</span> <span class="kwrd">override</span> AuthorizationResult IsAuthorized(System.Security.Principal.IPrincipal principal, AuthorizationContext authorizationContext)
        {
            Role = ConfigurationManager.AppSettings[RoleNameInConfig];

            <span class="kwrd">if</span>(principal.IsInRole(Role))
                <span class="kwrd">return</span> AuthorizationResult.Allowed;
            <span class="kwrd">return</span> <span class="kwrd">new</span> AuthorizationResult(<span class="str">"Access deny"</span>);
        }

        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这个属性指定在配置文件中设置角色的AppSettings的键名</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">public</span> <span class="kwrd">string</span> RoleNameInConfig { get; set; }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这是内部保存的角色信息</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">private</span> <span class="kwrd">string</span> Role { get; set; }



    }
}</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>


<p>&nbsp;</p>
<p>然后，我在配置文件中添加一个设置</p><pre class="csharpcode">  <span class="kwrd">&lt;</span><span class="html">appSettings</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">key</span><span class="kwrd">="SalesRoleName"</span> <span class="attr">value</span><span class="kwrd">="Sales"</span><span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">appSettings</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>接下来，我就可以在方法上面使用这个Attribute了</p><pre class="csharpcode">        [Query][RequiresAuthentication]
        [DynamicRequiresRole(RoleNameInConfig=<span class="str">"SalesRoleName"</span>)]
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这个方法返回一些客户名称</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="kwrd">public</span> IQueryable&lt;Customer&gt; GetCustomers()
        {
            var currentUser = <span class="kwrd">this</span>.ServiceContext.User.Identity.Name;

            <span class="kwrd">return</span> <span class="kwrd">new</span>[]{
                <span class="kwrd">new</span> Customer(){ID=1,Name=<span class="str">"Microsoft"</span>},
                <span class="kwrd">new</span> Customer(){ID=2,Name=<span class="str">"Google"</span>},
                <span class="kwrd">new</span> Customer(){ID=3,Name=<span class="str">"Apple"</span>},
                <span class="kwrd">new</span> Customer(){ID=4,Name=<span class="str">"Facebook"</span>},
                <span class="kwrd">new</span> Customer(){ID=5,Name=<span class="str">"Yahoo"</span>},
                <span class="kwrd">new</span> Customer(){ID=16,Name=<span class="str">"AOL"</span>}
            }.AsQueryable();
        }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>这样就可以完成特殊的授权了。当然我上面只是一个演示，你还可以写更多的逻辑在里面</p>
<p>&nbsp;</p>
<p>这个范例的完整代码，请通过下面的链接下载</p>
<p><a title="http://files.cnblogs.com/chenxizhang/SilverlightRIAAuthentication_AuthorizationSample.rar" href="http://files.cnblogs.com/chenxizhang/SilverlightRIAAuthentication_AuthorizationSample.rar">http://files.cnblogs.com/chenxizhang/SilverlightRIAAuthentication_AuthorizationSample.rar</a></p>
<p>【备注】这个代码还修正了关于OOB中不能正确进行身份验证的问题</p>