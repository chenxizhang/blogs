# MOSS 2010:Visual Studio 2010开发体验（15）&mdash;&mdash;LINQ to SharePoint 
> 原文发表于 2010-04-26, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/04/26/1721573.html 


<p>这一篇我们来讨论的是,如何通过LINQ的技术实现对SharePoint 2010列表的读取。我还记得当年.NET Framework 3.5发布，第一次接触到Linq的时候那种不可思议的感觉。现在，SharePoint的开发也支持Linq啦，这真是一件值得欢欣鼓舞的事情。</p> <p>&nbsp;</p> <p>这篇文章的所有练习都基于下面这样列表。这个列表显示了员工的信息。作为演示目的，我只是添加了三个范例数据</p> <p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_4.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb_1.png" width="1038" height="408"></a> </p> <p>目前针对MOSS 2010的开发，需要使用框架.NET Framework 3.5 而不是.NET Framework 4.0，而且编译的目标必须设置为Any CPU，或者X64。否则会出现一些莫名其妙的情况。这些是需要注意的，详细的介绍请参考我在下面这个博客文章</p> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/04/04/1704116.html">http://www.cnblogs.com/chenxizhang/archive/2010/04/04/1704116.html</a></p> <p>&nbsp;</p> <p>在讲LINQ to SharePoint之前，我们稍微回顾一下之前是怎么访问SharePoint 列表的。我们会用到SharePoint所提供的组件对象模型（Object Model）去做，具体来说，我们大致有下面两种常见的做法</p> <p>【注意】如果你对SharePoint的对象模型不清楚，下面这篇文章可以帮助你理解 <a href="http://www.cnblogs.com/chenxizhang/archive/2010/04/05/1704550.html">http://www.cnblogs.com/chenxizhang/archive/2010/04/05/1704550.html</a></p> <p>&nbsp;</p> <h2>1. 通过读取SPList.Items</h2><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> Microsoft.SharePoint;

<span class="kwrd">namespace</span> ConsoleApplication1
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var url = <span class="str">"http://localhost:45223/sites/dev"</span>;
            
            <span class="kwrd">using</span> (SPSite site = <span class="kwrd">new</span> SPSite(url))
            {
                <span class="kwrd">using</span> (SPWeb web = site.OpenWeb())
                {
                    SPList list = web.Lists[<span class="str">"Employees"</span>];
                    <span class="kwrd">foreach</span> (SPListItem item <span class="kwrd">in</span> list.Items)
                    {
                        Console.WriteLine(<span class="str">"FullName:{0},{1}  Age:{2}"</span>,
                            item[<span class="str">"FirstName"</span>],
                            item[<span class="str">"LastName"</span>],
                            item[<span class="str">"Age"</span>]);
                    }

                }
            }
        }
    }
}</pre>
<p>以上的代码是读取所有的员工的，假设我们要做筛选呢，例如我们只想看到那些年龄小于60岁的员工资料，我们会怎么做呢？</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> Microsoft.SharePoint;

<span class="kwrd">namespace</span> ConsoleApplication1
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var url = <span class="str">"http://localhost:45223/sites/dev"</span>;
            
            <span class="kwrd">using</span> (SPSite site = <span class="kwrd">new</span> SPSite(url))
            {
                <span class="kwrd">using</span> (SPWeb web = site.OpenWeb())
                {
                    SPList list = web.Lists[<span class="str">"Employees"</span>];
                    <span class="kwrd">foreach</span> (SPListItem item <span class="kwrd">in</span> list.Items)
                    {
<strong> <font color="#ff0000">                       <span class="kwrd">if</span>(<span class="kwrd">int</span>.Parse(item[<span class="str">"Age"</span>].ToString())&lt;60)
</font></strong>                        Console.WriteLine(<span class="str">"FullName:{0},{1}  Age:{2}"</span>,
                            item[<span class="str">"FirstName"</span>],
                            item[<span class="str">"LastName"</span>],
                            item[<span class="str">"Age"</span>]);
                    }

                }
            }
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>没错，这可以实现我们的目的。其实如何结合LINQ to Object的技术，我们还可以像下面这样写代码</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> Microsoft.SharePoint;

<span class="kwrd">namespace</span> ConsoleApplication1
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var url = <span class="str">"http://localhost:45223/sites/dev"</span>;
            
            <span class="kwrd">using</span> (SPSite site = <span class="kwrd">new</span> SPSite(url))
            {
                <span class="kwrd">using</span> (SPWeb web = site.OpenWeb())
                {
                    SPList list = web.Lists[<span class="str">"Employees"</span>];


<strong><font color="#ff0000">                    var query = from SPListItem item <span class="kwrd">in</span> list.Items
                                <span class="kwrd">where</span> <span class="kwrd">int</span>.Parse(item[<span class="str">"Age"</span>].ToString()) &lt; 60
                                select item;</font></strong>

                    <span class="kwrd">foreach</span> (SPListItem item <span class="kwrd">in</span> query)
                    {
                        
                        Console.WriteLine(<span class="str">"FullName:{0},{1}  Age:{2}"</span>,
                            item[<span class="str">"FirstName"</span>],
                            item[<span class="str">"LastName"</span>],
                            item[<span class="str">"Age"</span>]);
                    }

                }
            }
        }
    }
}</pre><pre class="csharpcode">
<a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_5.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb.png" width="524" height="143"></a> </pre>
<p>看起来不错，而且我们这里其实也用到了Linq的语法，不是吗？但大家要注意一下，上面三种写法，不管有没有进行筛选，也不管是否用到了LINQ语法，它们都有一个很大的问题，就是：他们都是把所有的SPListItem读取过来，然后再做处理的（例如做筛选），这意味着什么呢？</p>
<p>&nbsp;</p>
<p>假设列表的项目很多，例如有成千上万个员工记录，然而我们这个程序其实只要用到其中的一个员工，大家可以试想一下会是多大的一个资源浪费的操作。基于这样的理由，所以以前我们用得更多的可能是下面这种做法</p>
<p>&nbsp;</p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<h2>2. 通过CAML语法</h2>
<p>CAML是一个特殊的标记语言吧，它的全称是Collaborative Application Markup Language（协作应用程序标记语言）。这里有一个链接，如果有兴趣的朋友可以了解一下</p>
<p><a href="http://msdn.microsoft.com/zh-cn/library/ms426449.aspx">http://msdn.microsoft.com/zh-cn/library/ms426449.aspx</a></p>
<p>这篇文章中，我们的重点当然不是介绍CAML，只是演示一下如何使用它来定义查询语法，对列表进行筛选。</p>
<p>【注意】CAML的功能不仅仅限于列表查询，它甚至可以定义列表，和网站结构等等。</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> Microsoft.SharePoint;

<span class="kwrd">namespace</span> ConsoleApplication1
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var url = <span class="str">"http://localhost:45223/sites/dev"</span>;
            
            <span class="kwrd">using</span> (SPSite site = <span class="kwrd">new</span> SPSite(url))
            {
                <span class="kwrd">using</span> (SPWeb web = site.OpenWeb())
                {
                    SPList list = web.Lists[<span class="str">"Employees"</span>];


                    SPQuery query = <span class="kwrd">new</span> SPQuery();
<strong><font color="#ff0000">                    query.Query = <span class="str">"&lt;Where&gt;&lt;Lt&gt;&lt;FieldRef Name='Age' /&gt;&lt;Value Type='Number'&gt;60&lt;/Value&gt;&lt;/Lt&gt;&lt;/Where&gt;"</span>;</font></strong>
                    <span class="kwrd">foreach</span> (SPListItem item <span class="kwrd">in</span> list.GetItems(query))
                    {
                        Console.WriteLine(<span class="str">"FullName:{0},{1}  Age:{2}"</span>,
                            item[<span class="str">"FirstName"</span>],
                            item[<span class="str">"LastName"</span>],
                            item[<span class="str">"Age"</span>]);
                    }

                }


            }

            Console.Read();
        }
    }
}
</pre>
<p></p>
<p>这个例子中，我们使用了一个全新的类型，SPQuery。它可以定义一串查询的语句。而SPList的GetItems方法就可以使用这个Query对象进行过滤。注意，这是在服务器端就过滤掉了数据，而不会把所有的SPListItem读取到我们的程序中来了。</p>
<p>很显然的一个问题是，如果让你手工编写这个查询语句，恐怕是一件很困难的事情。所以以前我们一般都需要借助一些外部工具。其中最出名的一个工具就是U2U提供的CAML Query builder。</p>
<p>关于如何使用U2U这个工具，以及有关注意事项，我之前也有一篇文章介绍</p>
<p><a href="http://www.cnblogs.com/chenxizhang/archive/2009/10/23/1588415.html">http://www.cnblogs.com/chenxizhang/archive/2009/10/23/1588415.html</a></p>
<p>&nbsp;</p>
<p>CAML确实可以帮助我们实现灵活的查询，但无论如何，它的语法还是相对来说晦涩难懂的。所以，有一位叫bdesmet的开发人员实现了一套LINQ Provider，名称就是linqtoSharepoint,你可以通过下面的网站了解到有关信息</p>
<p><a href="http://linqtosharepoint.codeplex.com/">http://linqtosharepoint.codeplex.com/</a></p>
<p>【注意】这是一个开源项目，虽然名称很接近，但我们这篇博客文章并不是讨论它的使用。事实上，如果你还在使用MOSS 2007的话，它可能对你有些帮助。但我们现在如果使用MOSS 2010的话，就没有必要了。因为现在是内置了这个支持。</p>
<p>【注意】我曾经在MOSS 2007的使用用过这个插件，但效果不尽如人意，尤其是如果你的网站中的列表是用中文命名的话。所以，如果你遇到了一些问题，也不必感到特别的诧异。</p>
<p>&nbsp;</p>
<h2>3. 使用MOSS 2010全新的 LINQ 支持特性</h2>
<p>我们终于要切入正题了：如何使用MOSS 2010的LINQ特性来改善开发体验，以及它与之前的方法有何差别呢？</p>
<p>为了使用LINQ的功能，我们第一步需要用一个工具生成一个代码文件，这个文件包含了所有列表的一个实体类。</p>
<p>该工具叫SPMetal.exe，它的位置一般是在C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\BIN目录中。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_7.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb_2.png" width="1044" height="810"></a> </p>
<p>通过类似下面这样的方式执行该工具</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_9.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb_3.png" width="1044" height="810"></a> </p>
<p>该工具所生成的实体类文件大致如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_11.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb_4.png" width="1044" height="810"></a> </p>
<p></p>
<p></p>
<p></p>
<p></p>
<p>有了这个文件，接下来我们就可以将它添加到项目中，并且基于它编写代码来实现对列表的查询了。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_13.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb_5.png" width="1044" height="810"></a>&nbsp;</p>
<p>在该文件中，你发现有很多错误的提示。这是因为我们还没有添加一个程序集的引用。</p>
<p>添加Microsoft.SharePoint.Linq.dll的引用，该程序集一般在c:\Program Files\Common Files\Microsoft Shared\web server extensions\14\ISAPI目录中</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_15.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MOSS2010VisualStudio201015LINQtoSharePoi_D4C8/image_thumb_6.png" width="1044" height="810"></a> </p>
<p>添加完引用之后，编译该项目，确保没有任何错误。</p>
<p>&nbsp;</p>
<p>接下来，我们看看代码应该如何修改</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> Microsoft.SharePoint;

<span class="kwrd">namespace</span> ConsoleApplication1
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var url = <span class="str">"http://localhost:45223/sites/dev"</span>;

            EntitiesDataContext ctx = <span class="kwrd">new</span> EntitiesDataContext(url);
            var query = from item <span class="kwrd">in</span> ctx.Employees
                        <span class="kwrd">where</span> item.Age &lt; 60
                        select item;


            <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> query)
            {

                Console.WriteLine(<span class="str">"FullName:{0},{1} Age:{2}"</span>,
                    item.FirstName,
                    item.LastName,
                    item.Age);
            }

            Console.Read();
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p></p>
<p>&nbsp;</p>
<p>WOW, 我只能说，这样写代码的感觉是非常棒的：强类型、有智能感知支持、没有类型转换问题、更不需要记住那些晦涩难懂的CAML语句。。。。。。</p>
<p>这就是LINQ的魅力吧，你也赶紧试试吧</p>