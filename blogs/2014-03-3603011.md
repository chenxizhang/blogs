# WebAPI 2.x中如何扩展Identity Store 
> 原文发表于 2014-03-16, 地址: http://www.cnblogs.com/chenxizhang/p/3603011.html 


<p>ASP.NET WebAPI 中引入了新的一套身份验证和授权的机制，官方的叫法是ASP.NET Identity，有关这个概念的细节，感兴趣的同学可以参考 <a title="http://www.asp.net/identity" href="http://www.asp.net/identity">http://www.asp.net/identity</a></p> <p>这套新的机制，默认还是使用SQL Server来做身份保存的，但更多的是提供了灵活性，包括与外部验证系统（OAuth）的整合。但在一些较为简单的场合下，我们可能希望简化这个部分，例如我们不需要外部整合，而且我们的用户数也相对有限，不希望用数据库来实现。</p> <p>本文提供了一个实例，我是使用XML文件的方式来保存用户信息的，该文件的格式大致如下</p> <p><a href="http://images.cnitblog.com/blog/9072/201403/160900217938368.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201403/160900230741410.png" width="1427" height="310"></a></p> <p>&nbsp;</p> <p>然后，我编写了一个自定义的类型，实现了一些主要的方法</p><pre class="csharpcode">    <span class="kwrd">public</span> <span class="kwrd">class</span> XmlUserStore : IUserStore&lt;ApplicationUser&gt;,IUserPasswordStore&lt;ApplicationUser&gt;,IRoleStore&lt;IdentityRole&gt;
    {

        <span class="kwrd">private</span> <span class="kwrd">string</span> filePath = HttpContext.Current.Server.MapPath(<span class="str">"~/app_data/users.xml"</span>);


        <span class="kwrd">public</span> Task CreateAsync(ApplicationUser user)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        <span class="kwrd">public</span> Task DeleteAsync(ApplicationUser user)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        <span class="kwrd">public</span> Task&lt;ApplicationUser&gt; FindByIdAsync(<span class="kwrd">string</span> userId)
        {
            <span class="kwrd">return</span> FindByNameAsync(userId);
        }

        <span class="kwrd">public</span> Task&lt;ApplicationUser&gt; FindByNameAsync(<span class="kwrd">string</span> userName)
        {

            var doc = XDocument.Load(filePath);
            var found = doc.Root.Elements(<span class="str">"user"</span>).FirstOrDefault(x =&gt; x.Attribute(<span class="str">"name"</span>).Value == userName);
            ApplicationUser user = <span class="kwrd">null</span>;
            <span class="kwrd">if</span> (found != <span class="kwrd">null</span>)
            {
                user = <span class="kwrd">new</span> ApplicationUser()
                {
                    UserName = userName,
                    Id = userName,
                    PasswordHash = found.Attribute(<span class="str">"password"</span>).Value
                };
            }

            <span class="kwrd">return</span> Task&lt;ApplicationUser&gt;.FromResult(user);
        }

        <span class="kwrd">public</span> Task UpdateAsync(ApplicationUser user)
        {
            <span class="kwrd">return</span> Task.FromResult(0);
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> Dispose()
        {
        }

        <span class="kwrd">public</span> Task&lt;<span class="kwrd">string</span>&gt; GetPasswordHashAsync(ApplicationUser user)
        {
            var result = <span class="kwrd">string</span>.Empty;
            <span class="kwrd">if</span> (user != <span class="kwrd">null</span>)
                result = user.PasswordHash;

            <span class="kwrd">return</span> Task&lt;<span class="kwrd">string</span>&gt;.FromResult(result);
        }

        <span class="kwrd">public</span> Task&lt;<span class="kwrd">bool</span>&gt; HasPasswordAsync(ApplicationUser user)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        <span class="kwrd">public</span> Task SetPasswordHashAsync(ApplicationUser user, <span class="kwrd">string</span> passwordHash)
        {
            var doc = XDocument.Load(filePath);
            var found = doc.Root.Elements(<span class="str">"user"</span>).FirstOrDefault(x =&gt; x.Attribute(<span class="str">"name"</span>).Value ==user.UserName);

            <span class="kwrd">if</span>(found!=<span class="kwrd">null</span>)
            {
                found.Attribute(<span class="str">"password"</span>).Value = passwordHash;
                doc.Save(filePath);

                <span class="kwrd">return</span> Task.FromResult(1);
            }

            <span class="kwrd">return</span> Task.FromResult(0);
        }


        <span class="kwrd">public</span> Task CreateAsync(IdentityRole role)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        <span class="kwrd">public</span> Task DeleteAsync(IdentityRole role)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        Task&lt;IdentityRole&gt; IRoleStore&lt;IdentityRole&gt;.FindByIdAsync(<span class="kwrd">string</span> roleId)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        Task&lt;IdentityRole&gt; IRoleStore&lt;IdentityRole&gt;.FindByNameAsync(<span class="kwrd">string</span> roleName)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }

        <span class="kwrd">public</span> Task UpdateAsync(IdentityRole role)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> System.NotImplementedException();
        }
    }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>接下来，我们要在AccountController中使用这个新的UserStore的类型。</p>
<p><a href="http://images.cnitblog.com/blog/9072/201403/160900233405394.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201403/160900236218309.png" width="803" height="311"></a></p>