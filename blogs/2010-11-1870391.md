# ASP.NET自定义身份验证的实践 
> 原文发表于 2010-11-06, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/11/06/1870391.html 


<p>事情是这样的：有一套ASP.NET应用程序，用户一般会用工号登录，但是我们希望在应用程序中方便地访问到该用户相关的其他信息，例如用户名或者工厂名称。</p> <p>按照标准的ASP.NET Membership的做法，它不能提供这样的信息。Page.User.Identity.Name只是返回用户登录时使用的名称，在本例中是工号。</p> <p>我们的目标是，<strong><font color="#ff0000">能不能实现Page.User.Identity.Name显示用户的真实名称，而不是工号，甚至还可以显示其他的一些信息。</font></strong></p> <p>&nbsp;</p> <p>要实现这样的功能，我的思路是自定义身份验证。下面就是我的步骤，可以供大家参考</p> <p>&nbsp;</p> <h1>第一步：自定义Identity </h1> <p>Identity在安全设计中很重要，他一般代表了用户标识。本例中，我们添加了几个特殊的属性</p><pre class="csharpcode">    <span class="kwrd">public</span> <span class="kwrd">class</span> SECIdentity : IIdentity
    {


        <span class="kwrd">public</span> <span class="kwrd">string</span> DisplayName { get; set; }
        <span class="kwrd">public</span> <span class="kwrd">string</span> Factory { get; set; }
        <span class="kwrd">public</span> <span class="kwrd">string</span> Name { get; set; }




        <span class="kwrd">public</span> <span class="kwrd">string</span> AuthenticationType
        {
            get { <span class="kwrd">return</span> <span class="str">"Custom Authentication"</span>; }
        }

        <span class="kwrd">public</span> <span class="kwrd">bool</span> IsAuthenticated
        {
            get { <span class="kwrd">return</span> <span class="kwrd">true</span>; }
        }
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> ToString()
        {
            <span class="kwrd">return</span> <span class="kwrd">string</span>.Format(<span class="str">"{0},{1}"</span>, Factory, DisplayName);
        }
    }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<h1></h1>
<h1>第二步：自定义Principal</h1>
<p>一个用户不仅需要有名称等基本信息，它还应该具有另外一些信息，例如角色等等。这可以通过封装成一个Principal来解决</p><pre class="csharpcode">    <span class="kwrd">public</span> <span class="kwrd">class</span> SECPrincipal : IPrincipal
    {
        <span class="kwrd">public</span> SECPrincipal(<span class="kwrd">string</span> name, <span class="kwrd">string</span> displayName, <span class="kwrd">string</span> factory)
        {
            identity = <span class="kwrd">new</span> SECIdentity()
            {
                Name = name,
                DisplayName = displayName,
                Factory = factory
            };
        }
        <span class="kwrd">private</span> IIdentity identity;
        <span class="kwrd">public</span> IIdentity Identity
        {
            get
            {
                <span class="kwrd">return</span> identity;
            }
        }

        <span class="kwrd">public</span> <span class="kwrd">bool</span> IsInRole(<span class="kwrd">string</span> role)
        {
            <span class="kwrd">return</span> <span class="kwrd">true</span>;
        }
    }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<h1>第三步：自定义MembershipProvider</h1>
<p>我们需要有一个特殊的Provider，来读取自定义数据库，校验用户，并且把有关的数据都一起读出来</p>
<p>请注意，作为演示，我只是实现了这个Provider的一个方法：ValidateUser.其他的方法都没有实现</p><pre class="csharpcode">    <span class="kwrd">public</span> <span class="kwrd">class</span> SECMembershipProvider:MembershipProvider
    {

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> ApplicationName
        {
            get
            {
                <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
            }
            set
            {
                <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
            }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> ChangePassword(<span class="kwrd">string</span> username, <span class="kwrd">string</span> oldPassword, <span class="kwrd">string</span> newPassword)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> ChangePasswordQuestionAndAnswer(<span class="kwrd">string</span> username, <span class="kwrd">string</span> password, <span class="kwrd">string</span> newPasswordQuestion, <span class="kwrd">string</span> newPasswordAnswer)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipUser CreateUser(<span class="kwrd">string</span> username, <span class="kwrd">string</span> password, <span class="kwrd">string</span> email, <span class="kwrd">string</span> passwordQuestion, <span class="kwrd">string</span> passwordAnswer, <span class="kwrd">bool</span> isApproved, <span class="kwrd">object</span> providerUserKey, <span class="kwrd">out</span> MembershipCreateStatus status)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> DeleteUser(<span class="kwrd">string</span> username, <span class="kwrd">bool</span> deleteAllRelatedData)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> EnablePasswordReset
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> EnablePasswordRetrieval
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipUserCollection FindUsersByEmail(<span class="kwrd">string</span> emailToMatch, <span class="kwrd">int</span> pageIndex, <span class="kwrd">int</span> pageSize, <span class="kwrd">out</span> <span class="kwrd">int</span> totalRecords)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipUserCollection FindUsersByName(<span class="kwrd">string</span> usernameToMatch, <span class="kwrd">int</span> pageIndex, <span class="kwrd">int</span> pageSize, <span class="kwrd">out</span> <span class="kwrd">int</span> totalRecords)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipUserCollection GetAllUsers(<span class="kwrd">int</span> pageIndex, <span class="kwrd">int</span> pageSize, <span class="kwrd">out</span> <span class="kwrd">int</span> totalRecords)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">int</span> GetNumberOfUsersOnline()
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> GetPassword(<span class="kwrd">string</span> username, <span class="kwrd">string</span> answer)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipUser GetUser(<span class="kwrd">string</span> username, <span class="kwrd">bool</span> userIsOnline)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipUser GetUser(<span class="kwrd">object</span> providerUserKey, <span class="kwrd">bool</span> userIsOnline)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> GetUserNameByEmail(<span class="kwrd">string</span> email)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">int</span> MaxInvalidPasswordAttempts
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">int</span> MinRequiredNonAlphanumericCharacters
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">int</span> MinRequiredPasswordLength
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">int</span> PasswordAttemptWindow
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> MembershipPasswordFormat PasswordFormat
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> PasswordStrengthRegularExpression
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> RequiresQuestionAndAnswer
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> RequiresUniqueEmail
        {
            get { <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException(); }
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> ResetPassword(<span class="kwrd">string</span> username, <span class="kwrd">string</span> answer)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> UnlockUser(<span class="kwrd">string</span> userName)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> UpdateUser(MembershipUser user)
        {
            <span class="kwrd">throw</span> <span class="kwrd">new</span> NotImplementedException();
        }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> ValidateUser(<span class="kwrd">string</span> username, <span class="kwrd">string</span> password)
        {
            <span class="rem">//这里可以实际读取数据库，对用户名和密码进行校验</span>
            <span class="kwrd">if</span> (username == <span class="str">"007"</span> &amp;&amp; password == <span class="str">"password"</span>)
            {

                var cookie = <span class="kwrd">new</span> HttpCookie(username + <span class="str">"_data"</span>);

                cookie.Values.Add(<span class="str">"displayName"</span>, <span class="str">"ares"</span>);
                cookie.Values.Add(<span class="str">"factory"</span>, <span class="str">"shanghai"</span>);
                HttpContext.Current.Response.Cookies.Add(cookie);

                <span class="kwrd">return</span> <span class="kwrd">true</span>;

            }
            <span class="kwrd">return</span> <span class="kwrd">false</span>;
        }


    }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>大家注意这个ValidateUser方法，我们除了校验用户之外，还可以将用户的displayName和factory读取出来，放在cookie里面。这是为了下一步做准备。</p>
<h1>第四步：注册使用这个MembershipProvider</h1><pre class="csharpcode">        <span class="kwrd">&lt;</span><span class="html">membership</span> <span class="attr">defaultProvider</span><span class="kwrd">="SECMembershipProvider"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">providers</span><span class="kwrd">&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">clear</span><span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="SECMembershipProvider"</span> <span class="attr">type</span><span class="kwrd">="MvcApplicationSample.Extensions.SECMembershipProvider,MvcApplicationSample"</span><span class="kwrd">/&gt;</span>
                <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="AspNetSqlMembershipProvider"</span> <span class="attr">type</span><span class="kwrd">="System.Web.Security.SqlMembershipProvider"</span> <span class="attr">connectionStringName</span><span class="kwrd">="ApplicationServices"</span> <span class="attr">enablePasswordRetrieval</span><span class="kwrd">="false"</span> <span class="attr">enablePasswordReset</span><span class="kwrd">="true"</span> <span class="attr">requiresQuestionAndAnswer</span><span class="kwrd">="false"</span> <span class="attr">requiresUniqueEmail</span><span class="kwrd">="false"</span> <span class="attr">maxInvalidPasswordAttempts</span><span class="kwrd">="5"</span> <span class="attr">minRequiredPasswordLength</span><span class="kwrd">="6"</span> <span class="attr">minRequiredNonalphanumericCharacters</span><span class="kwrd">="0"</span> <span class="attr">passwordAttemptWindow</span><span class="kwrd">="10"</span> <span class="attr">applicationName</span><span class="kwrd">="/"</span><span class="kwrd">/&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">providers</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">membership</span><span class="kwrd">&gt;</span></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<h1>第五步：修改HttpContext.User属性</h1>
<p>这是我们至关重要的一步。我们希望替换掉默认那个HttpContext.User。</p>
<p>请注意，这个操作必须在一个特殊事件中来完成。请转到global.asax文件中，添加如下代码</p>
<p>&nbsp;</p><pre class="csharpcode">        <span class="kwrd">void</span> Application_PostAuthenticateRequest(<span class="kwrd">object</span> sender, EventArgs e)
        {
            var app = (HttpApplication)sender;
            <span class="kwrd">if</span> (app.User.Identity.IsAuthenticated)
            {
                var userName = app.User.Identity.Name;
                var cookie = app.Request.Cookies[userName + <span class="str">"_data"</span>];
                var displayName = cookie.Values[<span class="str">"displayName"</span>];
                var factory = cookie.Values[<span class="str">"factory"</span>];

                HttpContext.Current.User= <span class="kwrd">new</span> Extensions.SECPrincipal(userName, displayName, factory);
            }

        }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<h1>第六步：使用自定义的Principal</h1>
<p>我们在页面中，就可以很容易地使用自定义的这个Principal了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Welcome &lt;b&gt;&lt;%: Page.User.Identity.ToString() %&gt;</p>
<p>&nbsp;</p>
<p>下面是一个最后的结果。这个项目是最近做给客户做MVC理论和实践课程中的一个范例。仅供参考</p>
<p><a href="http://www.xizhang.com/blogimages/fe970ef26b75_5DBE/image.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/fe970ef26b75_5DBE/image_thumb.png" width="1028" height="732"></a></p>
<p><a href="http://www.xizhang.com/blogimages/fe970ef26b75_5DBE/image_3.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/fe970ef26b75_5DBE/image_thumb_3.png" width="1075" height="778"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>