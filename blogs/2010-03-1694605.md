# WPF：如何实现单实例的应用程序（Single Instance） 
> 原文发表于 2010-03-25, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/03/25/1694605.html 


<p>好吧，这是我将WPF与Windows Forms进行比较的系列文章的第四篇，讨论一下如何实现单实例(single instance)</p> <p>先来看第一种最简单粗暴的做法:</p> <p><strong><font color="#ff0000">检测进程名</font></strong>,如果名称一样,则表示程序已经启动了,就不再启动.</p><pre class="csharpcode">    <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> OnStartup(StartupEventArgs e)
    {
        <span class="rem">// Get Reference to the current Process</span>
        Process thisProc = Process.GetCurrentProcess();
        <span class="rem">// Check how many total processes have the same name as the current one</span>
        <span class="kwrd">if</span> (Process.GetProcessesByName(thisProc.ProcessName).Length &gt; 1)
        {
            <span class="rem">// If ther is more than one, than it is already running.</span>
            MessageBox.Show(<span class="str">"Application is already running."</span>);
            Application.Current.Shutdown();
            <span class="kwrd">return</span>;
        }

        <span class="kwrd">base</span>.OnStartup(e);
    }
很简单,不是吗?但简单有什么错呢? 它很实用.</pre><pre class="csharpcode">[注意]这个代码如果在visual studio中调试则无效，因为visual studio调试用的进程是加了一个vshost的后缀的。</pre><pre class="csharpcode">&nbsp;</pre><pre class="csharpcode">第二种方案我觉得应该还是可以用<strong><font color="#ff0000" size="4">mutex</font></strong>来实现嘛，看看下面的代码</pre><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Configuration;
<span class="kwrd">using</span> System.Data;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Windows;
<span class="kwrd">using</span> System.Diagnostics;
<span class="kwrd">using</span> System.Threading;

<span class="kwrd">namespace</span> WpfApplication1
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// App.xaml 的交互逻辑</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> App : Application
    {
        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> OnStartup(StartupEventArgs e)
        {
            <span class="kwrd">bool</span> createNew;
            Mutex mutex = <span class="kwrd">new</span> Mutex(<span class="kwrd">true</span>, <span class="str">"MyApplication"</span>, <span class="kwrd">out</span> createNew);
            <span class="kwrd">if</span> (createNew)
                <span class="kwrd">base</span>.OnStartup(e);
            <span class="kwrd">else</span>
            {
                MessageBox.Show(<span class="str">"程序已经启动了"</span>);
                Application.Current.Shutdown();
            } 
        }

    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
<font size="2" face="Consolas">这一种做法的结果与第一种很类似，或者说没有任何区别。</font></p>
<p><font size="2" face="Consolas"></font>&nbsp;</p>
<p><font size="2" face="Consolas">看起来解决问题了，但仍然不是很理想的。最好的情况是，当用户开启第二个实例的时候，如果第一个实例没有处于活动状态，则应该激活它。</font></p>
<p><font size="2" face="Consolas">我们很自然还是联想到了原先在Windows Forms时代的<strong><font color="#ff0000" size="4">WindowsFormsApplicationBase</font></strong>，那里面做这个事情太简单了。</font></p>
<p><font size="2" face="Consolas">首先，添加Microsoft.VisualBasic的引用</font></p>
<p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WPF_E576/image_2.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WPF_E576/image_thumb.png" width="716" height="595"></a> </p><pre class="csharpcode"><span class="kwrd">namespace</span> WpfApplication1
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> EntryPoint
    {
        [STAThread]
        <span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            SingleInstanceManager manager = <span class="kwrd">new</span> SingleInstanceManager();
            manager.Run(args);
        }
    }

    <span class="rem">// Using VB bits to detect single instances and process accordingly:</span>
    <span class="rem">//  * OnStartup is fired when the first instance loads</span>
    <span class="rem">//  * OnStartupNextInstance is fired when the application is re-run again</span>
    <span class="rem">//    NOTE: it is redirected to this instance thanks to IsSingleInstance</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> SingleInstanceManager : WindowsFormsApplicationBase
    {
        SingleInstanceApplication app;

        <span class="kwrd">public</span> SingleInstanceManager()
        {
            <span class="kwrd">this</span>.IsSingleInstance = <span class="kwrd">true</span>;
        }

        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">bool</span> OnStartup(Microsoft.VisualBasic.ApplicationServices.StartupEventArgs e)
        {
            <span class="rem">// First time app is launched</span>
            app = <span class="kwrd">new</span> SingleInstanceApplication();
            app.Run();
            <span class="kwrd">return</span> <span class="kwrd">false</span>;
        }

        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> OnStartupNextInstance(StartupNextInstanceEventArgs eventArgs)
        {
            <span class="rem">// Subsequent launches</span>
            <span class="kwrd">base</span>.OnStartupNextInstance(eventArgs);
            app.Activate();
        }
    }

    <span class="kwrd">public</span> <span class="kwrd">class</span> SingleInstanceApplication : Application
    {
        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> OnStartup(System.Windows.StartupEventArgs e)
        {
            <span class="kwrd">base</span>.OnStartup(e);

            <span class="rem">// Create and show the application's main window</span>
            <span class="rem">//MainWindow window = new MainWindow();</span>
            Window1 window = <span class="kwrd">new</span> Window1();
            window.Show();
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> Activate()
        {
            <span class="rem">// Reactivate application's main window</span>
            <span class="kwrd">this</span>.MainWindow.Show();
            <span class="kwrd">this</span>.MainWindow.Activate();
        }
    }
} 
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>