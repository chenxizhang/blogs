# 一个在ASP.NET中利用服务器控件GridView实现数据增删改查的例子 
> 原文发表于 2013-08-26, 地址: http://www.cnblogs.com/chenxizhang/p/3281833.html 


<p>备注：这是我辅导的一个项目开发组的一个例子，用文章的方式分享出来，给更多的朋友参考。其实我们这几年的项目中，都不怎么使用服务器控件的形式了，而是更多的采用MVC这种开发模式。但是，如果项目的历史背景是用服务器控件的，也不妨继续沿用，以免变动太大，对项目的整体开发不利。</p> <p>很多企业业务程序的页面，其实本质上都是对数据的操作，诸如增加、删除、修改和查询（简称：增删改查），如果有可能在一个页面中完整地实现（不需要几个页面转来转去），对于用户来说可能体验较好。</p> <p>ASP.NET在2.0中开始提供多种数据控件，并且采用了模板的机制，使得我们上面的需求变得可能。今天要讲的就是号称ASP.NET中最复杂的控件：GridView的使用。它可以完整实现增删改查。</p> <p><a href="http://images.cnitblog.com/blog/9072/201308/26084050-72bb0dba032e4da3876d26990c461b8f.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201308/26084050-9e386915f3cb41da870cf1bcb372ea54.png" width="244" height="95"></a><a href="http://images.cnitblog.com/blog/9072/201308/26084050-91d14f336f234ecdaee67d20ce898917.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201308/26084051-a365af972d9d45e59acbc389c2e673de.png" width="244" height="95"></a><a href="http://images.cnitblog.com/blog/9072/201308/26084051-80808d57567b407fa2f3cfca5abcd6b8.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201308/26084052-91bce288f6974368a6c05efddd18dd9d.png" width="244" height="95"></a><a href="http://images.cnitblog.com/blog/9072/201308/26084052-c4d61eff75b3487fa5b1cc6bde9bce98.png"><img title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/9072/201308/26084052-7ac937e8fe06457db76ff4301f550e01.png" width="244" height="109"></a></p> <p>&nbsp;</p> <p>页面：</p><pre class="csharpcode"><span class="asp">&lt;%@ Page Language="C#" AutoEventWireup="true" CodeBehind="Default.aspx.cs" Inherits="WebApplicationSample.Default" %&gt;</span>

<span class="kwrd">&lt;!</span><span class="html">DOCTYPE</span> <span class="attr">html</span><span class="kwrd">&gt;</span>

<span class="kwrd">&lt;</span><span class="html">html</span> <span class="attr">xmlns</span><span class="kwrd">="http://www.w3.org/1999/xhtml"</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">head</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">title</span><span class="kwrd">&gt;&lt;/</span><span class="html">title</span><span class="kwrd">&gt;</span>

<span class="kwrd">&lt;/</span><span class="html">head</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">body</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">form</span> <span class="attr">id</span><span class="kwrd">="form1"</span> <span class="attr">runat</span><span class="kwrd">="server"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">div</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">asp:GridView</span> <span class="attr">ID</span><span class="kwrd">="gvData"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">OnRowDeleting</span><span class="kwrd">="gvData_RowDeleting"</span> <span class="attr">OnRowUpdating</span><span class="kwrd">="gvData_RowUpdating"</span> <span class="attr">OnRowCancelingEdit</span><span class="kwrd">="gvData_RowCancelingEdit"</span> <span class="attr">OnRowEditing</span><span class="kwrd">="gvData_RowEditing"</span> <span class="attr">AutoGenerateColumns</span><span class="kwrd">="true"</span> <span class="attr">AutoGenerateDeleteButton</span><span class="kwrd">="true"</span> <span class="attr">AutoGenerateEditButton</span><span class="kwrd">="true"</span><span class="kwrd">&gt;</span>

               <span class="asp">&lt;%</span>--&lt;Columns&gt;
                    &lt;asp:CommandField HeaderText=<span class="str">"操作"</span> UpdateText=<span class="str">"保存"</span> CancelText=<span class="str">"取消"</span> DeleteText=<span class="str">"删除"</span> ShowDeleteButton=<span class="str">"true"</span> ShowEditButton=<span class="str">"true"</span> EditText=<span class="str">"编辑"</span> /&gt;
                &lt;/Columns&gt;--<span class="asp">%&gt;</span>
            <span class="kwrd">&lt;/</span><span class="html">asp:GridView</span><span class="kwrd">&gt;</span>

            <span class="kwrd">&lt;</span><span class="html">asp:Button</span> <span class="attr">ID</span><span class="kwrd">="btAddNew"</span> <span class="attr">runat</span><span class="kwrd">="server"</span> <span class="attr">Text</span><span class="kwrd">="添加新记录"</span> <span class="attr">OnClick</span><span class="kwrd">="btAddNew_Click"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">div</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">form</span><span class="kwrd">&gt;</span>

    

    <span class="kwrd">&lt;</span><span class="html">script</span><span class="kwrd">&gt;</span>
        <span class="rem">//这里为所有删除按钮都处理一个事件，请用户确认</span>
        <span class="kwrd">var</span> links = document.links;<span class="rem">//获取所有的链接</span>
        <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> links) {<span class="rem">//循环他们</span>
            <span class="kwrd">var</span> a = links[i];<span class="rem">//取得当前这个链接</span>
            <span class="kwrd">if</span> (a.text == <span class="str">"Delete"</span> || a.text==<span class="str">"删除"</span>) {<span class="rem">//如果是删除按钮的话</span>
                <span class="kwrd">var</span> o = a.href;<span class="rem">//获取这个链接的地址（默认会生成一个执行javascript的地址的）</span>

                a.href = <span class="str">"#"</span>;<span class="rem">//将这个地址删除掉，就是不要让他执行默认的行为</span>
                a.addEventListener(<span class="str">"click"</span>, <span class="kwrd">function</span> () {<span class="rem">//添加一个新的事件注册</span>
                    <span class="kwrd">var</span> result = window.confirm(<span class="str">"你是否真的要删除?"</span>);<span class="rem">//向用户确认是否要删除</span>
                    <span class="kwrd">if</span> (result == <span class="kwrd">true</span>)<span class="rem">//如果用户确定</span>
                        eval(o);<span class="rem">//执行原先默认的那个方法（去服务器删除数据）</span>
                    <span class="kwrd">return</span> <span class="kwrd">false</span>;
                });
            }
        }
    <span class="kwrd">&lt;/</span><span class="html">script</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">body</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">html</span><span class="kwrd">&gt;</span>
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>代码：</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Web.UI.WebControls;

<span class="kwrd">namespace</span> WebApplicationSample
{


    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 这个实例主要演示了如何使用GridView进行数据的增、删、改、查。</span>
    <span class="rem">/// 更多有关于该控件的知识，可以参考 http://msdn.microsoft.com/zh-cn/library/vstudio/system.web.ui.webcontrols.gridview.aspx （请仔细阅读）</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Default : System.Web.UI.Page
    {
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 这是我们定义的一个业务实体类，用来保存界面上的列表数据，为了保存，必须支持序列化</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        [Serializable]
        <span class="kwrd">public</span> <span class="kwrd">class</span> Employee
        {
            <span class="kwrd">public</span> <span class="kwrd">string</span> FirstName { get; set; }
            <span class="kwrd">public</span> <span class="kwrd">string</span> LastName { get; set; }
        }


        <span class="kwrd">private</span> List&lt;Employee&gt; data = <span class="kwrd">new</span> List&lt;Employee&gt;();<span class="rem">//这是用来保存那个列表数据的字段</span>
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 重写这个方法来保存视图状态。因为每次页面刷新的时候，默认情况下，data都会被清空，如果希望在多次回发的过程中保存数据，则重写该方法</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">object</span> SaveViewState()
        {
            var obj = <span class="kwrd">new</span> <span class="kwrd">object</span>[] { <span class="kwrd">base</span>.SaveViewState(), data };
            <span class="kwrd">return</span> obj;
        }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 重写该方法，是与上面这个方法配套，在回发回来之后加载并还原</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="savedState"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> LoadViewState(<span class="kwrd">object</span> savedState)
        {
            var obj = savedState <span class="kwrd">as</span> <span class="kwrd">object</span>[];

            <span class="kwrd">base</span>.LoadViewState(obj[0]);
            data = obj[1] <span class="kwrd">as</span> List&lt;Employee&gt;;
        }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 页面初始化的时候执行该代码</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="sender"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;param name="e"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">void</span> Page_Load(<span class="kwrd">object</span> sender, EventArgs e)
        {
            <span class="kwrd">if</span> (!IsPostBack)
            {<span class="rem">//这里只是一个示例，默认给页面添加一个初始的员工，实际在做的时候，可以不加</span>
                data = <span class="kwrd">new</span> List&lt;Employee&gt;(){
                    <span class="kwrd">new</span> Employee(){FirstName =<span class="str">"ares"</span>,LastName =<span class="str">"chen"</span>}
                };

                gvData.DataSource = data;
                gvData.DataBind();
            }
        }


        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 添加新的员工时执行该代码</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="sender"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;param name="e"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">void</span> btAddNew_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            data.Add(<span class="kwrd">new</span> Employee());<span class="rem">//创建一个空的对象</span>
            gvData.DataSource = data;<span class="rem">//设置数据源</span>
            gvData.EditIndex = data.Count - 1;<span class="rem">//设置当前这个对象为编辑状态</span>
            gvData.DataBind();<span class="rem">//绑定数据</span>

        }

        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 当用户决定要删除某一行数据时执行该代码</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="sender"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;param name="e"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">void</span> gvData_RowDeleting(<span class="kwrd">object</span> sender, GridViewDeleteEventArgs e)
        {
            <span class="rem">//删除某一行</span>
            data.RemoveAt(e.RowIndex);
            gvData.DataSource = data;
            gvData.EditIndex = -1;
            gvData.DataBind();
        }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 当用户要保存修改时执行该代码</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="sender"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;param name="e"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">void</span> gvData_RowUpdating(<span class="kwrd">object</span> sender, GridViewUpdateEventArgs e)
        {
            var index = e.RowIndex;<span class="rem">//获取当前编辑行当索引号</span>
            var row = gvData.Rows[index];<span class="rem">//获取当前用户编辑的这一行</span>

            var firstName = (row.Cells[1].Controls[0] <span class="kwrd">as</span> TextBox).Text;<span class="rem">//获取用户输入的数据</span>
            var lastName = (row.Cells[2].Controls[0] <span class="kwrd">as</span> TextBox).Text;<span class="rem">//获取用户输入的数据</span>


            var emp = data[index];<span class="rem">//找到这个对象</span>
            emp.FirstName = firstName;
            emp.LastName = lastName;

            gvData.DataSource = data;
            gvData.EditIndex = -1;<span class="rem">//退出编辑状态</span>
            gvData.DataBind();
        }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 当用户要取消编辑的时候</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="sender"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;param name="e"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">void</span> gvData_RowCancelingEdit(<span class="kwrd">object</span> sender, GridViewCancelEditEventArgs e)
        {
            gvData.DataSource = data;
            gvData.EditIndex = -1;
            gvData.DataBind();
        }
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 当用户要进行编辑的时候</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="rem">/// &lt;param name="sender"&gt;&lt;/param&gt;</span>
        <span class="rem">/// &lt;param name="e"&gt;&lt;/param&gt;</span>
        <span class="kwrd">protected</span> <span class="kwrd">void</span> gvData_RowEditing(<span class="kwrd">object</span> sender, GridViewEditEventArgs e)
        {
            gvData.DataSource = data;
            gvData.EditIndex = e.NewEditIndex;
            gvData.DataBind();
        }
    }
}</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>