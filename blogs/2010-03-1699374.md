# 一个自定义的文本框验证器(WindowsForms) 
> 原文发表于 2010-03-29, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/03/29/1699374.html 


<p>这也是前两天在课堂上的一个案例，我们实现了自定义的文本框验证器。这是一个实现了IExtenderProvider 的组件。该范例部分代码改编自MSDN</p> <p>这个验证组件，可以为窗体上任意多个文本框提供验证，大致有如下几种方式</p> <p>1. 必填项检查</p> <p>2.范围检查（例如最小值为5，最大值为100）</p> <p>3. 类型检查</p> <p>4. 正则表达式检查</p> <p>&nbsp;</p> <p>大致的用法是：</p> <p>1. 将该组件拖拽到窗体上，同时还要拖拽一个ErrorProvider</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_thumb.png" width="364" height="94"></a> </p> <p>2. 设置该组件的一个属性，将其与ErrorProvider绑定</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_4.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_thumb_1.png" width="304" height="167"></a> </p> <p>3. 设置哪些文本框需要进行什么样的验证</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_6.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_thumb_2.png" width="420" height="280"></a> </p> <p>4. 在窗体代码中，例如提交按钮代码中，使用下面的方式来做验证</p><pre class="csharpcode">            <span class="rem">//使用自定义验证器</span>
            <span class="kwrd">if</span> (!textBoxValidator1.IsValid(<span class="kwrd">out</span> errorMessage))
                MessageBox.Show(String.Format(<span class="str">"当前数据没有通过:{0}"</span>, errorMessage));
            <span class="kwrd">else</span>
            {
                employeesBindingSource.EndEdit();
                tableAdapterManager.UpdateAll(employeesDataSet);
                <span class="kwrd">this</span>.Text = firstNameTextBox.Text + <span class="str">","</span> + lastNameTextBox.Text;

                SetControlStatus(<span class="kwrd">false</span>);
            }</pre>
<p>5. 运行效果大致如下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_8.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_thumb_3.png" width="270" height="173"></a> </p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_10.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/WindowsForms_A0FA/image_thumb_4.png" width="862" height="483"></a> 
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>&nbsp;</p>
<p>该组件的完整代码如下</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;

<span class="kwrd">using</span> System.ComponentModel;
<span class="kwrd">using</span> System.Windows.Forms;

<span class="kwrd">using</span> System.Collections;
<span class="kwrd">using</span> System.Text.RegularExpressions;

<span class="kwrd">namespace</span> NorthwindApplication
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 这个类型是专门用来做文本框验证的</span>
    <span class="rem">/// 作者：陈希章</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="rem">/// </span>

    [ProvideProperty(<span class="str">"DataType"</span>, <span class="kwrd">typeof</span>(Control))]
    [ProvideProperty(<span class="str">"DisplayName"</span>, <span class="kwrd">typeof</span>(Control))]
    [ProvideProperty(<span class="str">"MinValue"</span>, <span class="kwrd">typeof</span>(Control))]
    [ProvideProperty(<span class="str">"MaxValue"</span>, <span class="kwrd">typeof</span>(Control))]
    [ProvideProperty(<span class="str">"Required"</span>, <span class="kwrd">typeof</span>(Control))]
    [ProvideProperty(<span class="str">"RegularExpression"</span>, <span class="kwrd">typeof</span>(Control))]
    <span class="rem">//这是定义的几个属性</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> TextBoxValidator : Component, IExtenderProvider
    {
        [Description(<span class="str">"设置一个关联的ErrorProvider"</span>)]
        <span class="kwrd">public</span> ErrorProvider ErrorProvider { get; set; }

        <span class="preproc">#region</span> IExtenderProvider 成员

        <span class="kwrd">public</span> <span class="kwrd">bool</span> CanExtend(<span class="kwrd">object</span> extendee)
        {
            <span class="kwrd">return</span> extendee.GetType() == <span class="kwrd">typeof</span>(TextBox);
        }

        <span class="preproc">#endregion</span>


        <span class="rem">///用一个hashTable来保存控件的设置</span>

        Hashtable tb = <span class="kwrd">new</span> Hashtable();

        <span class="kwrd">private</span> TextBoxValidatorProvidedProperties GetAddControl(Control ctrl)
        {
            <span class="kwrd">if</span> (!tb.ContainsKey(ctrl))
            {
                TextBoxValidatorProvidedProperties prop = <span class="kwrd">new</span> TextBoxValidatorProvidedProperties();
                tb.Add(ctrl, prop);
                ctrl.Validated += <span class="kwrd">new</span> EventHandler(ctrl_Validated);
            }

            <span class="kwrd">return</span> tb[ctrl] <span class="kwrd">as</span> TextBoxValidatorProvidedProperties;

        }

        <span class="kwrd">void</span> ctrl_Validated(<span class="kwrd">object</span> sender, EventArgs e)
        {
            ProcessError((Control)sender);
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> ProcessError(Control ctrl)
        {
            TextBoxValidatorProvidedProperties prop = (TextBoxValidatorProvidedProperties)tb[ctrl];
            <span class="kwrd">string</span> message = GetErrorMessage(ctrl);
            <span class="kwrd">if</span> (!<span class="kwrd">string</span>.IsNullOrEmpty(message) &amp;&amp; ErrorProvider != <span class="kwrd">null</span>)
                ErrorProvider.SetError(ctrl, message);
            <span class="kwrd">else</span>
                ErrorProvider.SetError(ctrl, <span class="str">""</span>);
        }

        <span class="kwrd">private</span> <span class="kwrd">string</span> GetErrorMessage(Control ctrl)
        {
            Type[] types = <span class="kwrd">new</span>[]{
                <span class="kwrd">typeof</span>(<span class="kwrd">string</span>),
                <span class="kwrd">typeof</span>(<span class="kwrd">byte</span>),
                <span class="kwrd">typeof</span>(Int16),
                <span class="kwrd">typeof</span>(Int32),
                <span class="kwrd">typeof</span>(Int64),
                <span class="kwrd">typeof</span>(Single),
                <span class="kwrd">typeof</span>(<span class="kwrd">double</span>),
                <span class="kwrd">typeof</span>(<span class="kwrd">decimal</span>),
                <span class="kwrd">typeof</span>(DateTime)
            };

            TextBoxValidatorProvidedProperties props = (TextBoxValidatorProvidedProperties)tb[ctrl];
            <span class="kwrd">string</span> displayName;
            <span class="kwrd">if</span> (<span class="kwrd">string</span>.IsNullOrEmpty(props.DisplayName))
                displayName = ctrl.Name;
            <span class="kwrd">else</span>
                displayName = props.DisplayName;

            <span class="kwrd">string</span> <span class="kwrd">value</span> = ctrl.Text;<span class="rem">//检查是不是必填项</span>
            <span class="kwrd">if</span> (<span class="kwrd">value</span>.Length == 0)
            {
                <span class="kwrd">if</span> (props.Required)
                    <span class="kwrd">return</span> displayName + <span class="str">" 是必填的!"</span>;
                <span class="kwrd">else</span>
                    <span class="kwrd">return</span> <span class="kwrd">string</span>.Empty;
            }

            Type dataType = types[(<span class="kwrd">int</span>)props.DataType];
            <span class="kwrd">try</span>
            {
                <span class="kwrd">object</span> o = Convert.ChangeType(<span class="kwrd">value</span>, dataType);<span class="rem">//尝试强制转换到某个类型</span>
                <span class="kwrd">switch</span> (props.DataType)
                {
                    <span class="kwrd">case</span> DataTypeConstants.ByteType:
                    <span class="kwrd">case</span> DataTypeConstants.Int16Type:
                    <span class="kwrd">case</span> DataTypeConstants.Int32Type:
                    <span class="kwrd">case</span> DataTypeConstants.Int64Type:
                        <span class="kwrd">if</span> (Convert.ToDecimal(<span class="kwrd">value</span>) != Convert.ToInt64(<span class="kwrd">value</span>))
                            <span class="kwrd">return</span> <span class="str">"在文本框"</span> + displayName + <span class="str">"中不允许有小数点"</span>;

                        <span class="kwrd">break</span>;
                    <span class="kwrd">default</span>:
                        <span class="kwrd">break</span>;
                }
            }
            <span class="kwrd">catch</span> (Exception)
            {

                <span class="kwrd">return</span> <span class="kwrd">string</span>.Format(<span class="str">"文本框{0}中的值{1}无法转换为{2}类型"</span>,
                    displayName,
                    <span class="kwrd">value</span>,
                    dataType);

            }


            <span class="rem">//验证正则表达式</span>
            <span class="kwrd">if</span> (props.RegularExpression.Length &gt; 0)
            {
                <span class="kwrd">if</span> (!Regex.IsMatch(<span class="kwrd">value</span>, props.RegularExpression))
                {
                    <span class="kwrd">return</span> <span class="kwrd">string</span>.Format(<span class="str">"文本框{0}中的值{1}不满足正则表达式{2}的验证规则"</span>,
                        displayName,
                        <span class="kwrd">value</span>,
                        props.RegularExpression);
                }
            }

            <span class="kwrd">if</span> (props.MinValue.Length &gt; 0)
            {
                <span class="kwrd">if</span> (Convert.ChangeType(<span class="kwrd">value</span>, dataType).GetHashCode() &lt; 
                    Convert.ChangeType(props.MinValue, dataType).GetHashCode())
                    <span class="kwrd">return</span> <span class="kwrd">string</span>.Format(<span class="str">"文本框{0}中的值{1}太小了，应该至少是{2}"</span>,
                        displayName,
                        <span class="kwrd">value</span>,
                        props.MinValue);
            }

            <span class="kwrd">if</span> (props.MaxValue.Length &gt; 0)
            {
                <span class="kwrd">if</span> (Convert.ChangeType(<span class="kwrd">value</span>, dataType).GetHashCode() &gt;
                    Convert.ChangeType(props.MaxValue, dataType).GetHashCode())
                    <span class="kwrd">return</span> <span class="kwrd">string</span>.Format(<span class="str">"文本框{0}中的值{1}太大了，应该最大是{2}"</span>,
                        displayName,
                        <span class="kwrd">value</span>,
                        props.MaxValue);
            }


            <span class="kwrd">return</span> <span class="kwrd">string</span>.Empty;
        }


        <span class="preproc">#region</span> 属性
        <span class="rem">///定义一系列的Get和Set方法来完成属性</span>
        <span class="rem">///</span>

        <span class="kwrd">public</span> DataTypeConstants GetDataType(Control ctrl)
        {
            <span class="kwrd">if</span> (tb.ContainsKey(ctrl))
                <span class="kwrd">return</span> ((TextBoxValidatorProvidedProperties)tb[ctrl]).DataType;
            <span class="kwrd">else</span>
                <span class="kwrd">return</span> DataTypeConstants.StringType;

        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> SetDataType(Control ctrl, DataTypeConstants dataType)
        {
            GetAddControl(ctrl).DataType = dataType;
        }


        <span class="kwrd">public</span> <span class="kwrd">string</span> GetMinValue(Control ctrl)
        {
            <span class="kwrd">if</span> (tb.ContainsKey(ctrl))
                <span class="kwrd">return</span> ((TextBoxValidatorProvidedProperties)tb[ctrl]).MinValue;
            <span class="kwrd">else</span>
                <span class="kwrd">return</span> <span class="kwrd">string</span>.Empty;
        }
        <span class="kwrd">public</span> <span class="kwrd">void</span> SetMinValue(Control ctrl, <span class="kwrd">string</span> <span class="kwrd">value</span>)
        {
            <span class="kwrd">if</span> (<span class="kwrd">value</span> == <span class="kwrd">null</span>) <span class="kwrd">value</span> = <span class="kwrd">string</span>.Empty;

            GetAddControl(ctrl).MinValue = <span class="kwrd">value</span>;
        }


        <span class="kwrd">public</span> <span class="kwrd">string</span> GetMaxValue(Control ctrl)
        {
            <span class="kwrd">if</span> (tb.ContainsKey(ctrl))
                <span class="kwrd">return</span> ((TextBoxValidatorProvidedProperties)tb[ctrl]).MaxValue;
            <span class="kwrd">else</span>
                <span class="kwrd">return</span> <span class="kwrd">string</span>.Empty;
        }
        <span class="kwrd">public</span> <span class="kwrd">void</span> SetMaxValue(Control ctrl, <span class="kwrd">string</span> <span class="kwrd">value</span>)
        {
            <span class="kwrd">if</span> (<span class="kwrd">value</span> == <span class="kwrd">null</span>) <span class="kwrd">value</span> = <span class="kwrd">string</span>.Empty;

            GetAddControl(ctrl).MaxValue = <span class="kwrd">value</span>;
        }

        <span class="kwrd">public</span> <span class="kwrd">string</span> GetDisplayName(Control ctrl)
        {
            <span class="kwrd">if</span> (tb.ContainsKey(ctrl))
                <span class="kwrd">return</span> ((TextBoxValidatorProvidedProperties)tb[ctrl]).DisplayName;
            <span class="kwrd">else</span>
                <span class="kwrd">return</span> <span class="kwrd">string</span>.Empty;
        }
        <span class="kwrd">public</span> <span class="kwrd">void</span> SetDisplayName(Control ctrl, <span class="kwrd">string</span> <span class="kwrd">value</span>)
        {
            GetAddControl(ctrl).DisplayName = <span class="kwrd">value</span>;
        }


        <span class="kwrd">public</span> <span class="kwrd">string</span> GetRegularExpression(Control ctrl)
        {
            <span class="kwrd">if</span> (tb.ContainsKey(ctrl))
                <span class="kwrd">return</span> ((TextBoxValidatorProvidedProperties)tb[ctrl]).RegularExpression;
            <span class="kwrd">else</span>
                <span class="kwrd">return</span> <span class="kwrd">string</span>.Empty;
        }
        <span class="kwrd">public</span> <span class="kwrd">void</span> SetRegularExpression(Control ctrl, <span class="kwrd">string</span> <span class="kwrd">value</span>)
        {
            GetAddControl(ctrl).RegularExpression = <span class="kwrd">value</span>;
        }

        <span class="kwrd">public</span> <span class="kwrd">bool</span> GetRequired(Control ctrl)
        {
            <span class="kwrd">if</span> (tb.ContainsKey(ctrl))
                <span class="kwrd">return</span> ((TextBoxValidatorProvidedProperties)tb[ctrl]).Required;
            <span class="kwrd">else</span>
                <span class="kwrd">return</span> <span class="kwrd">false</span>;
        }
        <span class="kwrd">public</span> <span class="kwrd">void</span> SetRequired(Control ctrl, <span class="kwrd">bool</span> <span class="kwrd">value</span>)
        {
            GetAddControl(ctrl).Required = <span class="kwrd">value</span>;
        }
        <span class="preproc">#endregion</span>



        <span class="preproc">#region</span> 验证逻辑

        <span class="kwrd">public</span> <span class="kwrd">bool</span> IsValid(<span class="kwrd">out</span> <span class="kwrd">string</span> summary)
        {
            summary = <span class="kwrd">this</span>.ValidationSummary;
            <span class="kwrd">return</span> summary.Length == 0;

        }

        <span class="kwrd">private</span> <span class="kwrd">string</span> ValidationSummary
        {
            get
            {

                var messages = <span class="kwrd">this</span>.InvalidMessages;
                StringBuilder sb = <span class="kwrd">new</span> StringBuilder();
                <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> messages)
                {
                    sb.AppendFormat(<span class="str">"{0}\n"</span>, item.ToString());
                }

                <span class="kwrd">return</span> sb.ToString();
            }
        }

        <span class="kwrd">private</span> ArrayList InvalidMessages
        {
            get
            {
                SortedList olInvalidMessages = <span class="kwrd">new</span> SortedList();
                <span class="kwrd">string</span> message;
                <span class="kwrd">foreach</span> (Control ctrl <span class="kwrd">in</span> tb.Keys)
                {
                    message = GetErrorMessage(ctrl);
                    <span class="kwrd">if</span> (!<span class="kwrd">string</span>.IsNullOrEmpty(message))
                        olInvalidMessages.Add(ctrl.TabIndex, message);

                }


                ArrayList colErrorsByIndex = <span class="kwrd">new</span> ArrayList();
                <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> olInvalidMessages.Values)
                {
                    colErrorsByIndex.Add(item.ToString());
                }

                <span class="kwrd">return</span> colErrorsByIndex;

            }
        }

        <span class="preproc">#endregion</span>
    }

    <span class="kwrd">public</span> <span class="kwrd">class</span> TextBoxValidatorProvidedProperties
    {
        <span class="kwrd">public</span> DataTypeConstants DataType;
        <span class="kwrd">public</span> <span class="kwrd">string</span> MinValue;
        <span class="kwrd">public</span> <span class="kwrd">string</span> MaxValue;
        <span class="kwrd">public</span> <span class="kwrd">string</span> DisplayName = <span class="kwrd">string</span>.Empty;
        <span class="kwrd">public</span> <span class="kwrd">bool</span> Required = <span class="kwrd">false</span>;
        <span class="kwrd">public</span> <span class="kwrd">string</span> RegularExpression = <span class="kwrd">string</span>.Empty;
    }

    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 定义一个枚举，用来让用户可以选择数据类型</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">public</span> <span class="kwrd">enum</span> DataTypeConstants
    {
        StringType,
        ByteType,
        Int16Type,
        Int32Type,
        Int64Type,
        SingleType,
        DoubleType,
        DecimalType,
        DateTimeType
    }
 }
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>