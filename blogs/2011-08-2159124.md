# 在Silverlight中对多个异步任务的调用 
> 原文发表于 2011-08-30, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/08/30/2159124.html 


<p>这是一个常见的问题，由于Silverlight只支持异步调用后台的服务，而如果有多个任务的话，可能就很麻烦，往往就是要在一个异步任务结束事件中去调用另外一个任务，以此类推。典型的问题就是，代码很复杂，而且几乎很难维护。看看下面的代码吧</p><pre class="csharpcode">            <span class="rem">//传统的多个异步任务的调用方法，必须是一层一层嵌套的方式</span>
            
            var proxy = <span class="kwrd">new</span> ServiceReference1.WebService1SoapClient();
            proxy.Endpoint.Address = <span class="kwrd">new</span> System.ServiceModel.EndpointAddress(
                <span class="kwrd">new</span> Uri(App.Current.Host.Source, <span class="str">"../WebService1.asmx"</span>));

            proxy.HelloWorldCompleted += (o, a) =&gt;
            {
                
                proxy.GetEmployeeCompleted += (o1, a1) =&gt;
                {
                    proxy.GetCustomersCompleted += (o2, a1) =&gt;
                    {

                    };
                    proxy.GetCustomersAsync();
                };

                proxy.GetEmployeeAsync();
            };
            proxy.HelloWorldAsync();</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>为了解决这个问题，我自己也想过一些办法，同时参考了<a href="http://www.cnblogs.com/beginor/">张志敏</a>的如下文章</p>
<p><a href="http://www.cnblogs.com/beginor/archive/2010/12/24/1915910.html">http://www.cnblogs.com/beginor/archive/2010/12/24/1915910.html</a></p>
<p>&nbsp;</p>
<p>这篇文章提供了一个不错的思路。这篇文章的评论中，有朋友也提到了Reactive Framework，我看了看，还没有找到很好的应用方法。这个Framework是一个很强大的东西，但在本文讨论的场景中具体该如何应用，如果有这方面研究的朋友，请不吝赐教</p>
<p>&nbsp;</p>
<p>在这篇文章提供的简单模型基础上，我做了一些修改，并且也增加了一些更加实用的特性。共享出来给大家参考</p>
<p>&nbsp;</p>
<h1>添加和改进的功能主要是：</h1>
<p>1.使用更加便捷（原先是用IEnumerator去构造Runner，现在提供了更多的支持，可以是一个Array,也可以是一个List等等，因为我们很多时候任务是动态构造出来的）</p>
<p>2.提供了任务结果反馈（ActionResult)的功能</p>
<p>3.提供了任务之间约束的功能,在每个任务里面都可以得到前置任务的信息</p>
<p>&nbsp;</p>
<h1>如何使用？</h1>
<p>第一步：添加Nuget Package，关于什么是Nuget，请参考 <a href="http://www.cnblogs.com/dudu/archive/2011/07/15/nuget.html">http://www.cnblogs.com/dudu/archive/2011/07/15/nuget.html</a></p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/20110830092641200.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/201108300926422185.png" width="804" height="609" /></a></p>
<p>第二步，参考如下的范例代码</p>
<p>&nbsp;</p>
<h1>运行效果</h1>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/20110830092642582.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201108/20110830092642615.png" width="1001" height="367" /></a></p>
<p>&nbsp;</p>
<h1>完整源代码</h1>
<p>如果你不想下载包，可以直接复制这个代码进行使用或者修改</p>
<p>&nbsp;</p><pre class="csharpcode"><font class="Apple-style-span" color="#0000ff"><div class="cnblogs_code"><div><span>using</span><span>&nbsp;System;<br /></span><span>using</span><span>&nbsp;System.Collections.Generic;<br /></span><span>using</span><span>&nbsp;System.Linq;<br /></span><span>/*</span><span><br />&nbsp;*&nbsp;这个设计针对在Silverlight中经常需要对多个远程服务进行调用，而且我们可能需要让这些任务之间有固定的顺序，同时还希望能够在任务之间传递任务状态,还支持进度汇报的功能<br />&nbsp;*&nbsp;作者：陈希章<br />&nbsp;*&nbsp;时间：2011年8月30日<br />&nbsp;*&nbsp;反馈：ares@xizhang.com<br />&nbsp;</span><span>*/</span><span><br /><br /></span><span>#region</span><span>&nbsp;Sample&nbsp;Code</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>/第一个任务</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>var&nbsp;task&nbsp;=&nbsp;new&nbsp;AsyncAction("Task&nbsp;1");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>task.SetAction(()&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;proxy&nbsp;=&nbsp;new&nbsp;ServiceReference1.WebService1SoapClient();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;proxy.Endpoint.Address&nbsp;=&nbsp;new&nbsp;System.ServiceModel.EndpointAddress(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;Uri(App.Current.Host.Source,&nbsp;"../WebService1.asmx"));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;proxy.HelloWorldCompleted&nbsp;+=&nbsp;(o,&nbsp;a)&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task.ActionResult.Message&nbsp;=&nbsp;"Test&nbsp;test";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task.ActionResult.Result&nbsp;=&nbsp;a.Result;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task.ActionResult.Status&nbsp;=&nbsp;ActionStatus.Success;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task.OnCompleted();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;};<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;proxy.HelloWorldAsync();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>},&nbsp;true);</span><span><br /></span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>/第二个任务</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>var&nbsp;task2&nbsp;=&nbsp;new&nbsp;AsyncAction("Task&nbsp;2");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>task2.SetAction(()&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;proxy&nbsp;=&nbsp;new&nbsp;ServiceReference1.WebService1SoapClient();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;proxy.Endpoint.Address&nbsp;=&nbsp;new&nbsp;System.ServiceModel.EndpointAddress(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;Uri(App.Current.Host.Source,&nbsp;"../WebService1.asmx"));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;proxy.HelloWorldCompleted&nbsp;+=&nbsp;(o,&nbsp;a)&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task2.ActionResult.Message&nbsp;=&nbsp;"Test&nbsp;test";<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task2.ActionResult.Result&nbsp;=&nbsp;a.Result;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task2.ActionResult.Status&nbsp;=&nbsp;ActionStatus.Success;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task2.OnCompleted();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;proxy.HelloWorldAsync();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>},&nbsp;true);</span><span><br /></span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>/构造Runner</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>var&nbsp;runner&nbsp;=&nbsp;new&nbsp;AsyncActionRunner(new[]&nbsp;{&nbsp;task,&nbsp;task2&nbsp;});</span><span><br /></span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>/注册完成事件</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>runner.Completed&nbsp;+=&nbsp;(o,&nbsp;a)&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>将界面设置为空闲<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;busyIndicator.IsBusy&nbsp;=&nbsp;false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>显示所有任务的执行结果<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;dgResult.ItemsSource&nbsp;=&nbsp;runner.TaskResults;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>};<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>runner.ProgressChanged&nbsp;+=&nbsp;(o,&nbsp;a)&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;busyIndicator.BusyContent&nbsp;=&nbsp;string.Format("Current&nbsp;Step&nbsp;:{0},&nbsp;Percent:{1:p},&nbsp;Name:{2},Status:{3}",&nbsp;a.Current,&nbsp;a.Percent,&nbsp;a.ActionResult.TaskName,&nbsp;a.ActionResult.Status);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>};</span><span><br /></span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>/将界面设置为忙碌</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>busyIndicator.IsBusy&nbsp;=&nbsp;true;</span><span><br /></span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>/执行</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>runner.Execute();</span><span><br /></span><span>#endregion</span><span><br /><br /><br /></span><span>namespace</span><span>&nbsp;System<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;这个枚举记录了任务的状态，默认为Ready<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>enum</span><span>&nbsp;ActionStatus<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ready,</span><span>//</span><span>准备好，如果最后检查仍然为这个状态，则通常表示该任务被跳过了</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Success,</span><span>//</span><span>成功</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Failure,</span><span>//</span><span>失败</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Completed</span><span>//</span><span>完成</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;这个记录了任务的结果<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;ActionResult<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;ActionResult()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status&nbsp;</span><span>=</span><span>&nbsp;ActionStatus.Ready;</span><span>//</span><span>默认为ready</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StartTime&nbsp;</span><span>=</span><span>&nbsp;DateTime.Now;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;任务名称<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>string</span><span>&nbsp;TaskName&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;状态<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;ActionStatus&nbsp;Status&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;消息<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>string</span><span>&nbsp;Message&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;任务结果<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>object</span><span>&nbsp;Result&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;开始时间<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;DateTime&nbsp;StartTime&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;结束时间<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;DateTime&nbsp;EndTime&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;异步任务的接口<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>interface</span><span>&nbsp;IAsyncAction<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>void</span><span>&nbsp;Execute();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>event</span><span>&nbsp;EventHandler&nbsp;Completed;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionResult&nbsp;PreActionResult&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionResult&nbsp;ActionResult&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>string</span><span>&nbsp;TaskName&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;异步任务的实现类型<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;AsyncAction&nbsp;:&nbsp;IAsyncAction<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;AsyncAction(</span><span>string</span><span>&nbsp;name):</span><span>this</span><span>()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TaskName&nbsp;</span><span>=</span><span>&nbsp;name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;AsyncAction()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionResult&nbsp;</span><span>=</span><span>&nbsp;</span><span>new</span><span>&nbsp;ActionResult();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;</span><span>bool</span><span>&nbsp;AutoComplete&nbsp;</span><span>=</span><span>&nbsp;</span><span>false</span><span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;Action&nbsp;Action&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;设置要执行的操作<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;param&nbsp;name="action"&gt;</span><span>操作</span><span>&lt;/param&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;param&nbsp;name="autoComplete"&gt;</span><span>是否自动完成</span><span>&lt;/param&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>void</span><span>&nbsp;SetAction(Action&nbsp;action,&nbsp;</span><span>bool</span><span>&nbsp;autoComplete)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Action&nbsp;</span><span>=</span><span>&nbsp;action;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AutoComplete&nbsp;</span><span>=</span><span>&nbsp;autoComplete;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>virtual</span><span>&nbsp;</span><span>void</span><span>&nbsp;Execute()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(Action&nbsp;</span><span>!=</span><span>&nbsp;</span><span>null</span><span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionResult.StartTime&nbsp;</span><span>=</span><span>&nbsp;DateTime.Now;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Action();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>!</span><span>AutoComplete)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnCompleted();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>event</span><span>&nbsp;EventHandler&nbsp;Completed;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>void</span><span>&nbsp;OnCompleted()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;completed&nbsp;</span><span>=</span><span>&nbsp;</span><span>this</span><span>.Completed;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(completed&nbsp;</span><span>!=</span><span>&nbsp;</span><span>null</span><span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;completed(</span><span>this</span><span>,&nbsp;EventArgs.Empty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;前置任务的结果，添加这个功能目的是，可能多个任务之间互相有所依赖，例如某个任务要根据前面任务的情况决定是否执行<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;ActionResult&nbsp;PreActionResult&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;当前任务的结果<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;ActionResult&nbsp;ActionResult&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;任务名称<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;</span><span>string</span><span>&nbsp;taskName&nbsp;</span><span>=</span><span>&nbsp;</span><span>string</span><span>.Empty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>string</span><span>&nbsp;TaskName<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span>&nbsp;taskName;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>set</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;taskName&nbsp;</span><span>=</span><span>&nbsp;value;&nbsp;ActionResult.TaskName&nbsp;</span><span>=</span><span>&nbsp;value;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;任务运行器<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;AsyncActionRunner<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;AsyncActionRunner()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TaskResults&nbsp;</span><span>=</span><span>&nbsp;</span><span>new</span><span>&nbsp;List</span><span>&lt;</span><span>ActionResult</span><span>&gt;</span><span>();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;</span><span>readonly</span><span>&nbsp;IEnumerator</span><span>&lt;</span><span>IAsyncAction</span><span>&gt;</span><span>&nbsp;_enumerator;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;</span><span>int</span><span>&nbsp;taskCount&nbsp;</span><span>=</span><span>&nbsp;</span><span>0</span><span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>public&nbsp;AsyncActionRunner(IEnumerator&lt;IAsyncAction&gt;&nbsp;enumerator)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;this()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>&nbsp;&nbsp;&nbsp;&nbsp;this._enumerator&nbsp;=&nbsp;enumerator;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//</span><span>}</span><span><br /></span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;AsyncActionRunner(IList</span><span>&lt;</span><span>IAsyncAction</span><span>&gt;</span><span>&nbsp;tasks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;</span><span>this</span><span>()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;taskCount&nbsp;</span><span>=</span><span>&nbsp;tasks.Count();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_enumerator&nbsp;</span><span>=</span><span>&nbsp;tasks.GetEnumerator();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;完成事件及处理方法<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>event</span><span>&nbsp;EventHandler&nbsp;Completed;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;进度发生更改时发生<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>event</span><span>&nbsp;EventHandler</span><span>&lt;</span><span>ProgressEventArgs</span><span>&gt;</span><span>&nbsp;ProgressChanged;<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;保存所有任务的执行结果<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;List</span><span>&lt;</span><span>ActionResult</span><span>&gt;</span><span>&nbsp;TaskResults&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>private</span><span>&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;临时保存的当前任务的执行结果<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;ActionResult&nbsp;tmp&nbsp;</span><span>=</span><span>&nbsp;</span><span>null</span><span>;<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>private</span><span>&nbsp;</span><span>int</span><span>&nbsp;index&nbsp;</span><span>=</span><span>&nbsp;</span><span>1</span><span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;执行所有任务<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>void</span><span>&nbsp;Execute()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(</span><span>this</span><span>._enumerator.MoveNext())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;current&nbsp;</span><span>=</span><span>&nbsp;</span><span>this</span><span>._enumerator.Current;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;</span><span>=</span><span>&nbsp;current.ActionResult;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;ci&nbsp;</span><span>=</span><span>&nbsp;index</span><span>++</span><span>;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current.Completed&nbsp;</span><span>+=</span><span>&nbsp;(sender,&nbsp;args)&nbsp;</span><span>=&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;</span><span>=</span><span>&nbsp;((IAsyncAction)sender).ActionResult;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp.EndTime&nbsp;</span><span>=</span><span>&nbsp;DateTime.Now;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TaskResults.Add(tmp);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(ProgressChanged&nbsp;</span><span>!=</span><span>&nbsp;</span><span>null</span><span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProgressChanged(</span><span>this</span><span>,&nbsp;</span><span>new</span><span>&nbsp;ProgressEventArgs(ci,&nbsp;(</span><span>double</span><span>)ci&nbsp;</span><span>/</span><span>&nbsp;taskCount,&nbsp;tmp));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.Execute();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current.PreActionResult&nbsp;</span><span>=</span><span>&nbsp;tmp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current.Execute();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProgressChanged(</span><span>this</span><span>,&nbsp;</span><span>new</span><span>&nbsp;ProgressEventArgs(ci,&nbsp;(</span><span>double</span><span>)ci&nbsp;</span><span>/</span><span>&nbsp;taskCount,&nbsp;tmp));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span>=</span><span>&nbsp;</span><span>1</span><span>;</span><span>//</span><span>将进度复位</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;completed&nbsp;</span><span>=</span><span>&nbsp;</span><span>this</span><span>.Completed;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>(completed&nbsp;</span><span>!=</span><span>&nbsp;</span><span>null</span><span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;completed(</span><span>this</span><span>,&nbsp;EventArgs.Empty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;summary&gt;</span><span><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;进度事件的参数<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span>///</span><span>&nbsp;</span><span>&lt;/summary&gt;</span><span><br /></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>class</span><span>&nbsp;ProgressEventArgs&nbsp;:&nbsp;EventArgs<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>int</span><span>&nbsp;Current&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;ActionResult&nbsp;ActionResult&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;ProgressEventArgs(</span><span>int</span><span>&nbsp;current,&nbsp;</span><span>double</span><span>&nbsp;percent,&nbsp;ActionResult&nbsp;result)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.Current&nbsp;</span><span>=</span><span>&nbsp;current;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionResult&nbsp;</span><span>=</span><span>&nbsp;result;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Percent&nbsp;</span><span>=</span><span>&nbsp;percent;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>public</span><span>&nbsp;</span><span>double</span><span>&nbsp;Percent&nbsp;{&nbsp;</span><span>get</span><span>;&nbsp;</span><span>set</span><span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></div></div></font></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>