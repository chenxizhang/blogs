# 如何理解IIS 7的两种应用程序池的管道模式（Managed Pipeline Mode) 
> 原文发表于 2011-06-19, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/06/19/2084579.html 


<p>之前我写过一篇<a href="http://www.cnblogs.com/chenxizhang/archive/2010/06/02/1750236.html">博客文章</a>，讲的是.NET 4.0的应用程序部署问题。有网友问到一个相关问题就是：如何理解IIS 7中的应用程序池的管道模式，尤其是如何理解“托管模型（integrated mode)”，今天特意再写一篇文章来介绍这个问题。</p> <p>&nbsp;</p> <p>IIS 7是微软最新版本的IIS版本，从Vista开始提供，目前在Vista，Windows 7，Windows Server 2008中提供。这个全新的版本中，一个突出的亮点就是，它提供了两种管道模式，来支持不同的应用程序场景。</p> <p>&nbsp;</p> <p>这里提到的管道模式，指的是应用程序池（Application Pool）的一个属性</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191116522902.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191116556546.png" width="897" height="346"></a><br></p> <p>上图中可以看到，这两种管道模式分别为Integrated(集成）和 Classic(经典）</p> <p>那么，到底如何理解这两种模式呢？</p> <p><strong><font color="#ff0000">Classic模式：</font></strong>指的是与IIS 6或者之前版本保持兼容的一种模式，一个典型问题就是，在处理ASP.NET这种动态网站的时候，它是通过一个所谓的ISAPI程序，作为插件的方式来工作的。针对不同的动态应用程序（例如ASP,PHP等），会需要不同的ISAPI。</p> <p>例如，下面就是一个注册号的ISAPI映射</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191116575905.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191116594467.png" width="475" height="388"></a></p> <p>从上图可以看出，不同的Request,指定了不同的ISAPI程序。下图是对于这种Pipeline的一个图形化说明</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/20110619111701205.jpg"><img title="iis 6 pipelines" border="0" alt="iis 6 pipelines" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117055618.jpg" width="836" height="649"></a></p> <p>&nbsp;</p> <p><strong><font color="#ff0000">Integrated模式</font></strong>：这种全新的模式，允许我们将ASP.NET更好地与IIS集成，甚至允许我们在ASP.NET中编写一些功能（例如Module）来改变IIS的行为（扩展）。集成的好处是，不再通过ISAPI的方式，提高了速度和稳定性。至于扩展，则可以使得我们对于IIS，以及其他类型的请求有更多的控制。（例如，我们希望静态网页也具备一些特殊的行为）</p> <p>下图解释了这一点。</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117076405.jpg"><img title="iis 7 integrated mode" border="0" alt="iis 7 integrated mode" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117097476.jpg" width="836" height="649"></a></p> <p>以上两个图片来自与下面这个文章，并且该文章有更详细的一些理论介绍。</p> <p><a href="http://learn.iis.net/page.aspx/243/aspnet-integration-with-iis-7/">http://learn.iis.net/page.aspx/243/aspnet-integration-with-iis-7/</a></p> <p>&nbsp;</p> <p>下面，我就通过一个例子，来帮助大家更好地了解集成模型。</p> <p>这个例子里面，我有一个特殊的需求就是，我希望对网站里面所有请求做一个日志监控，不管是动态网页，还是静态网页。</p> <p>&nbsp;</p> <h2>1. 创建一个Web Application</h2> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117134873.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117179447.png" width="919" height="727"></a></p> <p>&nbsp;</p> <h2>2. 添加一个HttpModule</h2> <p>为了对用户请求进行监控，我们一般会编写一个HttpModule</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117203157.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117273818.png" width="959" height="664"></a></p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117312885.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117345723.png" width="919" height="727"></a></p> <p>我为该模块实现简单的功能（将用户的请求地址打印出来在页面上）</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Web;

<span class="kwrd">namespace</span> WebApplication2
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> MyModule1 : IHttpModule
    {
        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// You will need to configure this module in the web.config file of your</span>
        <span class="rem">/// web and register it with IIS before being able to use it. For more information</span>
        <span class="rem">/// see the following link: http://go.microsoft.com/?linkid=8101007</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="preproc">#region</span> IHttpModule Members

        <span class="kwrd">public</span> <span class="kwrd">void</span> Dispose()
        {
            <span class="rem">//clean-up code here.</span>
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> Init(HttpApplication context)
        {
            <span class="rem">// Below is an example of how you can handle LogRequest event and provide </span>
            <span class="rem">// custom logging implementation for it</span>
            context.LogRequest += <span class="kwrd">new</span> EventHandler(OnLogRequest);
        }

        <span class="preproc">#endregion</span>

        <span class="kwrd">public</span> <span class="kwrd">void</span> OnLogRequest(Object source, EventArgs e)
        {
            <span class="rem">//custom logging logic can go here</span>
            var app = (HttpApplication)source;
            app.Response.Write(app.Request.Url.ToString());
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<h2>3.注册该模块</h2>
<p>模块是需要注册才能够使用的。我们一般会想到以前的做法</p><pre class="csharpcode">  <span class="kwrd">&lt;</span><span class="html">system.web</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">compilation</span> <span class="attr">debug</span><span class="kwrd">="true"</span> <span class="attr">targetFramework</span><span class="kwrd">="4.0"</span> <span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">httpModules</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="test"</span> <span class="attr">type</span><span class="kwrd">="WebApplication2.MyModule1,WebApplication2"</span><span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">httpModules</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">system.web</span><span class="kwrd">&gt;</span>
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>但这样注册，会遇到一个错误</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117351395.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117372923.png" width="456" height="260"></a></p>
<p>这个错误的意思是，LogRequest这个操作，是必须运行在集成模式下的。</p>
<p>那么，到底如何注册成集成模式的模块呢？</p>
<p>我们需要将配置文件修改成下面这样</p><pre class="csharpcode"><span class="kwrd">&lt;?</span><span class="html">xml</span> <span class="attr">version</span><span class="kwrd">="1.0"</span>?<span class="kwrd">&gt;</span>

<span class="rem">&lt;!--</span>
<span class="rem">  For more information on how to configure your ASP.NET application, please visit</span>
<span class="rem">  http://go.microsoft.com/fwlink/?LinkId=169433</span>
<span class="rem">  --&gt;</span>

<span class="kwrd">&lt;</span><span class="html">configuration</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">system.web</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">compilation</span> <span class="attr">debug</span><span class="kwrd">="true"</span> <span class="attr">targetFramework</span><span class="kwrd">="4.0"</span> <span class="kwrd">/&gt;</span>
    <span class="rem">&lt;!--&lt;httpModules&gt;</span>
<span class="rem">      &lt;add name="test" type="WebApplication2.MyModule1,WebApplication2"/&gt;</span>
<span class="rem">    &lt;/httpModules&gt;--&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">system.web</span><span class="kwrd">&gt;</span>

  <span class="kwrd">&lt;</span><span class="html">system.webServer</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">modules</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="test"</span> <span class="attr">type</span><span class="kwrd">="WebApplication2.MyModule1,WebApplication2"</span><span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">modules</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">system.webServer</span><span class="kwrd">&gt;</span>

<span class="kwrd">&lt;/</span><span class="html">configuration</span><span class="kwrd">&gt;</span>
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>请注意，现在多了一个system.webServer的节，里面有一个modules的节，可以配置需要注册的一些HttpModule</p>
<p>因为是注册为system.webServer的Module，所以，在visual studio中调试是没有效果的</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117386709.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117405238.png" width="738" height="196"></a></p>
<p>我们需要将该应用程序发布到IIS，并且设置为integrated mode。</p>
<p>&nbsp;</p>
<h2>4.发布到IIS</h2>
<p>有很多办法进行发布，我所推荐的是用deploy package的方式。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117426582.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117442287.png" width="344" height="365"></a></p>
<p>请注意，我们使用的Application Pool是integrated mode的</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117485540.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117518935.png" width="891" height="365"></a></p>
<p>&nbsp;</p>
<p>发布之后，我们在浏览器中浏览首页，我们会发现在底部会有一个特殊的输出，就是我们当前请求的地址信息。这说明，我们那个Module已经在工作了。</p>
<p>&nbsp;</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117534673.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117551000.png" width="612" height="199"></a></p>
<p>&nbsp;</p>
<h2>5.测试该模块对于静态页面的支持</h2>











<p>如果仅仅是上面这样，我们似乎看不出这种模式到底有何优势。我们以前不也是可以实现这样的效果吗？</p>
<p>请你主要的是，以前的HttpModule只能影响到动态网页，例如我们的ASPX网页，而对于静态网页（例如html)，或者其他类型的动态网页（例如php等）是无能为力的。</p>
<p>那么，现在这种模式下情况是怎样的呢？</p>
<p>我们可以添加一个简单的html页面，放在网站根目录下</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/2011061911175619.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191117585168.png" width="876" height="111"></a></p>
<p>然后，我们去请求该页面</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191118007351.png"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/201106/201106191118011943.png" width="802" height="189"></a></p>
<p>是不是很神奇呢？虽然是静态网页，但因为我们那个模块是注册在IIS里面的，它改变了IIS的行为，所以仍然会在页面底部插入一段输出。</p>
<p>&nbsp;</p>
<h2>6.总结</h2>
<p>希望上面这样的例子可以帮助大家更好地理解Integrated mode。它是允许我们将代码插入到IIS内核中，而不再通过ISAPI的方式。这将带来更好的性能和扩展性。</p>