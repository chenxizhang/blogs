# 优化网站设计（四）：对资源启用压缩 
> 原文发表于 2013-05-01, 地址: http://www.cnblogs.com/chenxizhang/archive/2013/05/01/3052881.html 


<h1>前言</h1>
<p>网站设计的优化是一个很大的话题,有一些通用的原则,也有针对不同开发平台的一些建议。这方面的研究一直没有停止过，我在不同的场合也分享过这样的话题。</p>
<p>作为通用的原则，雅虎的工程师团队曾经给出过35个最佳实践。这个列表请参考</p>
<h6><span>Best Practices for Speeding Up Your Web Site&nbsp; </span><a href="http://developer.yahoo.com/performance/rules.html"><span>http://developer.yahoo.com/performance/rules.html</span></a></h6>
<p>同时，他们还发布了一个相应的测试工具Yslow <a href="http://developer.yahoo.com/yslow/">http://developer.yahoo.com/yslow/</a></p>
<p>我强烈推荐所有的网站开发人员都应该学习这些最佳实践，并结合自己的实际项目情况进行应用。</p>
<p>接下来的一段时间，我将结合ASP.NET这个开发平台，针对这些原则，通过一个系列文章的形式，做些讲解和演绎，以帮助大家更好地理解这些原则，并且更好地使用他们。</p>
<h1>准备工作</h1>
<p>为了跟随我进行后续的学习，你需要准备如下的开发环境和工具</p>
<ol>
<li>Google Chrome 或者firefox ，并且安装 Yslow这个扩展组件.请注意，这个组件是雅虎提供的，但目前没有针对IE的版本。<ol>
<li><a href="https://chrome.google.com/webstore/detail/yslow/ninejjcohidippngpapiilnmkgllmakh">https://chrome.google.com/webstore/detail/yslow/ninejjcohidippngpapiilnmkgllmakh</a>
<div id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:607f3121-d58f-49db-b70c-bee37cc24144" class="wlWriterEditableSmartContent">Technorati Tags: <a href="http://technorati.com/tags/Performance" rel="tag">Performance</a>,<a href="http://technorati.com/tags/Web+design" rel="tag">Web design</a>,<a href="http://technorati.com/tags/ASP.NET" rel="tag">ASP.NET</a></div>
</li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/yslow/">https://addons.mozilla.org/en-US/firefox/addon/yslow/</a></li>
<li>你应该对这些浏览器的开发人员工具有所了解，你可以通过按下F12键调出这个工具。</li>
</ol></li>
<li>Visaul Studio 2010 SP1 或更高版本，推荐使用Visual Studio 2012<ol>
<li><a href="http://www.microsoft.com/visualstudio/eng/downloads">http://www.microsoft.com/visualstudio/eng/downloads</a></li>
</ol></li>
<li>你需要对ASP.NET的开发基本流程和核心技术有相当的了解，本系列文章很难对基础知识做普及。</li>
</ol>
<h1>本文要讨论的话题</h1>
<p>这一篇，我们要讨论的是对资源启用压缩的话题。我们知道，不光我们如何<a href="http://www.cnblogs.com/chenxizhang/archive/2013/04/29/3050839.html" target="_blank">减少请求数</a>，或者<a href="http://www.cnblogs.com/chenxizhang/archive/2013/04/30/3051686.html" target="_blank">使用CDN</a>，以及<a href="http://www.cnblogs.com/chenxizhang/archive/2013/04/30/3052440.html" target="_blank">使用缓存</a>，有一个事实是我们无法避免的：内容总是需要从服务器传输到客户端，那怕次数是少一些。那么，如果希望这个传输的过程尽量地快，我们应该会很自然地想到，能否将传输的内容体积减小呢？</p>
<p>要回答这样的一个问题，我们通常就会使用到压缩技术。关于这一条原则的理论和概念，请参考 <a href="http://developer.yahoo.com/performance/rules.html#gzip">http://developer.yahoo.com/performance/rules.html#gzip</a></p>
<p>压缩并不那么简单，其实它包含了一对操作：压缩和解压缩。换句话说，在我们今天讨论的网站优化中使用压缩技术，不仅仅需要考虑服务器端对内容进行压缩，还要考虑客户端（浏览器）对内容进行解压缩。反过来也是如此。所以，这里就会有一个问题，我们必须要使用大多数浏览器都能接受的压缩算法。由于浏览器的多样性，通常是由浏览器在发起请求的时候，显式地表明自己接受那些压缩算法，然后服务器检查这些设置，再确认自己是否能利用这些算法进行压缩（或者解压缩），如果不能，则宁愿不进行压缩，直接返回原始的内容。</p>
<p>所以，在<a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html" target="_blank">HTTP 1.1</a>中规定，浏览器在发起请求的时候，可以通过下面这个Request Header来表明自己支持的压缩算法（可以有多个）</p>
<pre>Accept-Encoding: gzip, deflate</pre>
<pre>然后，服务器在发送响应的时候，也可以通过下面这个Response Header来表明此次响应是否使用了某种算法（肯定只有一个）</pre>
<pre>Content-Encoding: gzip</pre>
<pre>作为程序员，我们知道其实还有很多其他的算法，但是确实从通用层面考虑，使用最多的是<a href="http://www.ietf.org/rfc/rfc1952.txt" target="_blank">Gzip</a>。 其他能与其相提并论的还有deflate，但还是Gzip用的最多。</pre>
<h3>&nbsp;</h3>
<h3>哪些资源适合做压缩</h3>
<ol>
<li><span>静态网页（HTML,HTM）</span></li>
<li><span>文本文件（TEXT,XML等）</span></li>
<li><span>脚本文件（JAVASCRIPT)</span></li>
<li><span>样式文件（CSS)</span></li>
</ol>
<p>&nbsp;</p>
<h3>哪些资源不适合做压缩</h3>
<ol>
<li>图片（JPG,GIF,PNG)</li>
<li>特殊组件（FLASH, XAP）</li>
</ol>
<p>&nbsp;</p>
<h3>如何做压缩</h3>
<pre>要实现压缩功能并不难，现代的一些Web 服务器都内置支持这个特性。针对微软的IIS 7.0或者更高版本的话，可以通过参考下面的文章进行配置</pre>
<h3>Configuring HTTP Compression in IIS 7</h3>
<pre><a href="http://technet.microsoft.com/en-us/library/cc771003(v=WS.10).aspx">http://technet.microsoft.com/en-us/library/cc771003(v=WS.10).aspx</a></pre>
<pre>我来对其做一些总结和演示</pre>
<p><span>IIS 7.0内置支持Gzip压缩，这个可以通过在安装IIS的时候进行选择</span></p>
<pre><a href="http://images.cnitblog.com/blog/9072/201305/01112658-2a8fd419888c4b3b8339aa1744305b7a.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112658-8f93ff01fff843dbb1a79a7942b2a089.png" alt="image" width="244" height="214" border="0" /></a></pre>
<pre>正确安装之后，在管理工具中，就可以看到这样一项功能</pre>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01112703-ca9cfd706ca548319b2b52d30a3c793e.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112704-5d9edeacfa2a4cb0aa8a665f39d78234.png" alt="image" width="244" height="155" border="0" /></a></p>
<p>&nbsp;</p>
<p>IIS 7.0 支持两种方式的压缩：静态压缩和动态压缩。所谓静态压缩，就是对相对较大的内容，IIS 7.0会将它们压缩成一个新文件，并且缓存在磁盘上（可以通过下面这个界面配置多大的文件要进行静态压缩，并且放在哪个目录中），而动态压缩就是对于某些提交小的内容，直接在运行时进行动态压缩，不在磁盘上进行缓存（这种做法会带来CPU的一些额外的负担）</p>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01112708-9dc0c0e9ea82476f94e62d897a150331.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112709-7ffe38da9fea4edd8dd0e59ea69e9b1b.png" alt="image" width="244" height="155" border="0" /></a></p>
<p>这个缓存的目录中会自动为每个应用程序池(Application Pool)创建一个子目录，以便保存那些静态压缩的文件</p>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01112709-f4aa15504ac9481a9e2ed2fc7f67287f.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112709-1796c8c48e5b4d3c8c471d811a5f6a3c.png" alt="image" width="244" height="177" border="0" /></a></p>
<p>那么这种压缩到底能有多少收益呢？我们可以看看下面这个截图</p>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01112711-a004ce68657d4fe0a9cbdbbea7f966a1.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112712-4f7a2cf8b2794e18964e2d3129dd22a7.png" alt="image" width="244" height="136" border="0" /></a></p>
<p>上图中看到，在我的一个测试网站中，它对两个JAVASCRIPT文件做了压缩，压缩之后的尺寸分别为33KB和51KB，而这两个文件的原始文件大小其实是92KB和197KB，我们可以由此看出来，压缩比高达65%和74%。这是相当可观的一个收益，而你要做的仅仅是启用压缩即可。</p>
<p><a href="http://images.cnitblog.com/blog/9072/201305/01112712-4556a509e8264034a1002b2b50f5c2e7.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112712-29122bd755bb4106b1575e6ae62b8c53.png" alt="image" width="244" height="69" border="0" /></a></p>
<p>&nbsp;</p>
<pre>实际上这个文件已经被压缩成下面这样了（不再是纯文本的脚本了）</pre>
<pre><a href="http://images.cnitblog.com/blog/9072/201305/01112715-ae2c9210c02c43c69ce57d12de74d223.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112716-4a8970c4c3854832a5d12fb709bb6981.png" alt="image" width="244" height="145" border="0" /></a></pre>
<pre>不可否认的是，压缩和解压缩肯定会对CPU带来一些额外的负担的，但通常情况下，这个代价是很小的，尤其是与收益比较起来的话。</pre>
<pre>等等！我们好像漏了一个很重要的话题:上面的界面中，我们知道如何启用压缩，但却没有看到</pre>
<ol>
<li>如何设置哪些文件应该如何压缩（无论静态还是动态）。</li>
<li>到底是采用什么算法压缩</li>
</ol>
<p>&nbsp;</p>
<p>这个细节被隐藏在下面的配置文件中</p>
<pre>C:\windows\system32\inetsrv\config\applicationHost.config</pre>
<pre><a href="http://images.cnitblog.com/blog/9072/201305/01112718-26949ed0942e4710b72fe3a7bcf8dcf5.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112718-396f2ab531d44cc099ea93aa6d4051e6.png" alt="image" width="244" height="136" border="0" /></a></pre>
<pre>打开这个文件，搜索一下httpCompression，你可以找到如下的配置信息，当然，你可以在这个基础上做一些修改，前提是你先看懂它们。实际上不难，对吧</pre>
<pre><a href="http://images.cnitblog.com/blog/9072/201305/01112724-1807401cec1f49c1ae8c95b99722e2a4.png"><img title="image" src="http://images.cnitblog.com/blog/9072/201305/01112725-8128d4734edd4711bc0a0f95bbd241dc.png" alt="image" width="244" height="141" border="0" /></a></pre>
<div id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:bad989bb-92a7-463c-8e61-8e081168d639" class="wlWriterEditableSmartContent">Technorati Tags: <a href="http://technorati.com/tags/%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96" rel="tag">性能优化</a>,<a href="http://technorati.com/tags/performance" rel="tag">performance</a>,<a href="http://technorati.com/tags/ASP.NET" rel="tag">ASP.NET</a>,<a href="http://technorati.com/tags/web+design" rel="tag">web design</a></div>