# 在.NET开发面向Oracle数据库的应用程序 
> 原文发表于 2016-04-21, 地址: http://www.cnblogs.com/chenxizhang/p/5415442.html 


<p>其实这个不是一个什么新的话题。但是之前在多次项目中，总是遇到大家针对Oracle数据库的访问时，会有各种各样的问题，最基本的就是要在客户端安装各种client，版本不一样的话还有各种问题。</p> <p>静下心来看看，其实也没有那么难。我这里总结一下，如何在.NET应用程序中，简单优雅地使用Oracle数据库。</p> <h1>第一个原则：不要依赖</h1> <p>最好的情况就是，程序自己就可以完成数据访问，不需要额外地安装所谓的Oracle Client，那是一个很麻烦而且痛苦的事情。</p> <p>我们首先看看，如果不装任何东西，是否可以实现Oracle数据库访问？</p> <p>其实，.NET本身是自带了针对Oracle数据库访问的组件的，就是下面这个System.Data.OracleClient</p> <p><a href="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070157116-137859549.png"><img title="image" border="0" alt="image" src="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070157554-168053377.png" width="244" height="170"></a></p> <p>我们的代码如下(这是最原始的ADO.NET代码，只是做演示）</p> <p>using System;<br>using System.Data.OracleClient;</p> <p>namespace ConsoleApplication<br>{<br>&nbsp;&nbsp;&nbsp; class Program<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var connectionString = "user id=system;password=password;data source=192.168.56.101:1521/orcl";</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var connection = new OracleConnection(connectionString))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var cmd = connection.CreateCommand();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "select * from sys.dba_all_tables";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.Open();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var reader = cmd.ExecuteReader();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (reader.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(reader.GetString(0));</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reader.Close();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.Close();</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}<br></p> <p>&nbsp;</p> <p>看起来应该是没有问题的，运行起来却会报错</p> <p>Additional information: System.Data.OracleClient requires Oracle client software version 8.1.7 or greater.</p> <p><a href="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070157820-1380349516.png"><img title="image" border="0" alt="image" src="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070158101-83948817.png" width="244" height="215"></a></p> <p>这里的提示就是说，需要有Oracle Client。</p> <p>这不是我们希望看到的结果。实际上原理上说，我们这么理解吧，可能是这个组件只是一个wrapper，它实际去操作数据库，还需要通过Oracle Client才能实现。</p> <p>&nbsp;</p> <h1>使用Oracle提供的组件</h1> <p>更好的建议就是，使用Oracle 官方提供的托管代码组件。Oracle.ManagedDataAccess.dll</p> <p><a href="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070158601-1716444418.png"><img title="image" border="0" alt="image" src="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070159320-1481710430.png" width="244" height="116"></a></p> <p><a href="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070159632-951092195.png"><img title="image" border="0" alt="image" src="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070159960-127254913.png" width="241" height="244"></a></p> <p>只要添加了这个Nuget Package，代码几乎不需要任何改动，直接就可以复用。</p> <p>using System;<br>using Oracle.ManagedDataAccess.Client;</p> <p>namespace ConsoleApplication<br>{<br>&nbsp;&nbsp;&nbsp; class Program<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var connectionString = "user id=system;password=password;data source=192.168.56.101:1521/orcl";</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var connection = new OracleConnection(connectionString))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var cmd = connection.CreateCommand();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "select * from sys.dba_all_tables";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.Open();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var reader = cmd.ExecuteReader();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (reader.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(reader.GetString(0));</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reader.Close();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.Close();</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}<br></p> <p>&nbsp;</p> <p>当然比较理想的情况是将连接字符串之类的，可以放在配置文件中去。这个很简单，这里就不说明了。</p> <p>&nbsp;</p> <h1>结合Entity Framework使用</h1> <p>Entity Framework 出来已经好多年了，几乎成了所有.NET应用程序中的标配（不管有没有用到）。现在的最新版本应该是 6.1.3 .同时，需要注意的是，以后会有一个所谓的Entity Framework Core ，而且开源了 <a title="https://github.com/aspnet/EntityFramework" href="https://github.com/aspnet/EntityFramework">https://github.com/aspnet/EntityFramework</a></p> <p>回到正题，之前的代码写法其实还是比较原始的，那么如何结合Entity Framework进行Oracle数据库方面的编程呢？</p> <p>首先，安装下面的这个组件：Oracle.ManagedDataAccess.EntityFramework</p> <p><a href="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070200429-1932203417.png"><img title="image" border="0" alt="image" src="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070201070-907365402.png" width="244" height="109"></a></p> <p>然后，可以使用Code first的方式编写如下代码</p> <p>using System.ComponentModel.DataAnnotations;<br>using System.ComponentModel.DataAnnotations.Schema;<br>using System.Data.Entity;</p> <p>namespace ConsoleApplication<br>{<br>&nbsp;&nbsp;&nbsp; public class OracleContext : DbContext<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public OracleContext() : base("OracleDbContext")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public DbSet&lt;Employee&gt; Employees { get; set; }</p> <p>&nbsp;&nbsp;&nbsp; }</p> <p>&nbsp;&nbsp;&nbsp; [Table("EMPLOYEES", Schema = "SYSTEM")]<br>&nbsp;&nbsp;&nbsp; public class Employee<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Key()]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column("EMPLOYEEID")]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int EmployeeID { get; set; }</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column("FIRSTNAME")]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string FirstName { get; set; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column("LASTNAME")]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string LastName { get; set; }<br>&nbsp;&nbsp;&nbsp; }<br>}<br></p> <p>&nbsp;</p> <p>&nbsp;</p> <p>这里的代码没有什么出奇的。配置文件需要有如下的设置（一般在添加Oracle.ManagedDataAccess.EntityFramework 这个组件的时候，会自动修改配置文件）</p> <p>&lt;?xml version="1.0" encoding="utf-8"?&gt;<br>&lt;configuration&gt;<br>&nbsp; &lt;configSections&gt;<br>&nbsp;&nbsp;&nbsp; &lt;section name="oracle.manageddataaccess.client" type="OracleInternal.Common.ODPMSectionHandler, Oracle.ManagedDataAccess, Version=4.121.2.0, Culture=neutral, PublicKeyToken=89b483f429c47342" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;section name="entityFramework" type="System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" requirePermission="false" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;!-- For more information on Entity Framework configuration, visit <a href="http://go.microsoft.com/fwlink/?LinkID=237468">http://go.microsoft.com/fwlink/?LinkID=237468</a> --&gt;<br>&nbsp; &lt;/configSections&gt;<br>&nbsp; &lt;startup&gt;<br>&nbsp;&nbsp;&nbsp; &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.5.2" /&gt;<br>&nbsp; &lt;/startup&gt;<br>&nbsp; &lt;oracle.manageddataaccess.client&gt;<br>&nbsp;&nbsp;&nbsp; &lt;version number="*"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;dataSources&gt;<br><font color="#ff0000"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;dataSource alias="oracle" descriptor="(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=192.168.56.101)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=ORCL))) " /&gt;</strong></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/dataSources&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/version&gt;<br>&nbsp; &lt;/oracle.manageddataaccess.client&gt;<br>&nbsp;<strong><font color="#ff0000"> &lt;connectionStrings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add name="OracleDbContext" connectionString="user id=system;password=password;data source=oracle" providerName="Oracle.ManagedDataAccess.Client" /&gt;<br>&nbsp; &lt;/connectionStrings&gt;<br></font></strong>&nbsp; &lt;system.data&gt;<br>&nbsp;&nbsp;&nbsp; &lt;DbProviderFactories&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;remove invariant="Oracle.ManagedDataAccess.Client" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name="ODP.NET, Managed Driver" invariant="Oracle.ManagedDataAccess.Client" description="Oracle Data Provider for .NET, Managed Driver" type="Oracle.ManagedDataAccess.Client.OracleClientFactory, Oracle.ManagedDataAccess, Version=4.121.2.0, Culture=neutral, PublicKeyToken=89b483f429c47342" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/DbProviderFactories&gt;<br>&nbsp; &lt;/system.data&gt;<br>&nbsp; &lt;runtime&gt;<br>&nbsp;&nbsp;&nbsp; &lt;assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;dependentAssembly&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;publisherPolicy apply="no" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;assemblyIdentity name="Oracle.ManagedDataAccess" publicKeyToken="89b483f429c47342" culture="neutral" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;bindingRedirect oldVersion="4.121.0.0 - 4.65535.65535.65535" newVersion="4.121.2.0" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/dependentAssembly&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/assemblyBinding&gt;<br>&nbsp; &lt;/runtime&gt;<br>&nbsp; &lt;entityFramework&gt;<br>&nbsp;&nbsp;&nbsp; &lt;defaultConnectionFactory type="System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;parameters&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;parameter value="v13.0" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/parameters&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/defaultConnectionFactory&gt;<br>&nbsp;&nbsp;&nbsp; &lt;providers&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;provider invariantName="Oracle.ManagedDataAccess.Client" type="Oracle.ManagedDataAccess.EntityFramework.EFOracleProviderServices, Oracle.ManagedDataAccess.EntityFramework, Version=6.121.2.0, Culture=neutral, PublicKeyToken=89b483f429c47342" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;provider invariantName="System.Data.SqlClient" type="System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/providers&gt;<br>&nbsp; &lt;/entityFramework&gt;<br>&lt;/configuration&gt;</p> <p>后台数据库的表格设计也是很简单。</p> <p><a href="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070201382-620450752.png"><img title="image" border="0" alt="image" src="http://images2015.cnblogs.com/blog/9072/201604/9072-20160421070202398-1259088466.png" width="244" height="185"></a></p> <p>需要注意的是，经过实验，我发现目前这个Entity Framework要求所操作的表必须要有主键，而且主键必须是一个identity column（即自己绑定一个序列，实现自动增长），否则会报错</p> <p>实际上后台会通过一个触发器来实现这个功能</p> <p>create or replace TRIGGER EMPLOYEES_TRG <br>BEFORE INSERT ON EMPLOYEES <br>FOR EACH ROW <br>BEGIN<br>&nbsp; &lt;&lt;COLUMN_SEQUENCES&gt;&gt;<br>&nbsp; BEGIN<br>&nbsp;&nbsp;&nbsp; IF INSERTING AND :NEW.EMPLOYEEID IS NULL THEN<br>&nbsp;&nbsp;&nbsp; <strong>&nbsp; SELECT EMPLOYEES_SEQ.NEXTVAL INTO :NEW.EMPLOYEEID FROM SYS.DUAL;<br></strong>&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp; END COLUMN_SEQUENCES;<br>END;</p> <p>&nbsp;</p> <p>接下来在前端程序中就简单多了，下面是一个代码片段</p> <p>var ctx = new OracleContext();</p> <p>ctx.Employees.Add(new Employee() {FirstName = "ares", LastName = "chen" });<br>ctx.SaveChanges();</p> <p>var query = ctx.Employees.ToArray();<br>foreach (var item in query)<br>{<br>&nbsp;&nbsp;&nbsp; Console.WriteLine(item);<br>}</p> <p>&nbsp;</p> <p>需要注意的是，如果需要使用Entity Frmaework的Database first或Model first的功能，还是需要安装Oracle Client，或者准确地说应该是ODAC组件</p> <p><a title="http://www.oracle.com/technetwork/developer-tools/visual-studio/downloads/index.html" href="http://www.oracle.com/technetwork/developer-tools/visual-studio/downloads/index.html">http://www.oracle.com/technetwork/developer-tools/visual-studio/downloads/index.html</a></p>