# Workflow Foundation 4.0中的事件驱动流程设计和应用（五） 
> 原文发表于 2010-10-11, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/10/11/1848167.html 


<p>之前，我通过4篇文章介绍了在WF4中开发基于事件的工作流的范例。请参考下面的链接。 <p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/10/07/1845104.html">Workflow Foundation 4.0中的事件驱动流程设计和应用（一）</a> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/10/07/1845136.html">Workflow Foundation 4.0中的事件驱动流程设计和应用（二）</a> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/10/07/1845164.html">Workflow Foundation 4.0中的事件驱动流程设计和应用（三）</a> <p><a title="Workflow Foundation 4.0中的事件驱动流程设计和应用（四）" href="http://www.cnblogs.com/chenxizhang/archive/2010/10/10/1847465.html">Workflow Foundation 4.0中的事件驱动流程设计和应用（四）</a> <p>&nbsp;</p> <p>这一篇是这个系列的最后一篇，介绍如何通过配置文件，而不是代码的方式启动宿主。这在现实工作中是相当有用的，请大家参考下面的实例。</p> <p>【注意】有朋友也问到单独用数据库存储业务方面的数据，那是没有错的。一般可以通过自定义的Activity去完成这些操作，都是标准的ADO.NET的数据访问操作。这里就不做展开了。</p> <p>&nbsp;</p> <p>这个案例的最终代码范例，请通过 <a href="http://files.cnblogs.com/chenxizhang/WF4EventDrivenSolution-final.rar" target="_blank">这里</a> 下载</p> <h1>1.修改之前的Host代码</h1><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;
<span class="kwrd">using</span> System.ServiceModel;
<span class="kwrd">using</span> System.Activities;
<span class="kwrd">using</span> System.ServiceModel.Activities;
<span class="kwrd">using</span> System.ServiceModel.Description;

<span class="kwrd">using</span> System.Activities.DurableInstancing;
<span class="kwrd">using</span> System.Runtime.DurableInstancing;
<span class="kwrd">using</span> System.Activities.Persistence;
<span class="kwrd">using</span> System.ServiceModel.Activities.Description;
<span class="kwrd">using</span> System.Xml.Linq;

<span class="kwrd">namespace</span> Host
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var host = <span class="kwrd">new</span> WorkflowServiceHost(
                <span class="kwrd">new</span> DocumentReviewLib.DocumentReviewWorkflow(),
                <span class="kwrd">new</span> Uri(<span class="str">"http://localhost:8080/DRS"</span>));

            host.AddDefaultEndpoints();<span class="rem">//这个方法是添加了一些标准的端点</span>

            host.Description.Behaviors.Add(
                <span class="kwrd">new</span> ServiceMetadataBehavior() { HttpGetEnabled = <span class="kwrd">true</span> });

            var store = <span class="kwrd">new</span> SqlWorkflowInstanceStore(<span class="str">"server=(local)\\sqlexpress;database=WF4;integrated security=true"</span>);

            host.UnknownMessageReceived += (o, e) =&gt;
            {
                Console.WriteLine(<span class="str">"\n"</span> + e.Message + <span class="str">"\n"</span>);
            };


            host.Description.Behaviors.Add(
                <span class="kwrd">new</span> WorkflowIdleBehavior()
                {
                    TimeToPersist = TimeSpan.FromSeconds(0)
                });

            XNamespace xNS = XNamespace.Get(<span class="str">"http://xizhang.com/DocumentReview"</span>);
            store.Promote(<span class="str">"DocumentReview"</span>,
                <span class="kwrd">new</span> List&lt;XName&gt;() { xNS.GetName(<span class="str">"TicketId"</span>) },
                <span class="kwrd">null</span>);


            host.WorkflowExtensions.Add(<span class="kwrd">new</span> Extensions.MyInstanceStoreParticpant());


            host.DurableInstancingOptions.InstanceStore = store;
            host.Open();

            var common = <span class="kwrd">new</span> ServiceHost(
                <span class="kwrd">typeof</span>(CommonService),
                <span class="kwrd">new</span> Uri(<span class="str">"http://localhost:8080/Common"</span>));

            common.AddServiceEndpoint(
                <span class="kwrd">typeof</span>(ICommonService).FullName,
                <span class="kwrd">new</span> BasicHttpBinding(),
                <span class="str">""</span>);

            common.Open();


            Console.WriteLine(<span class="str">"Server is ready."</span>);
            Console.Read();

        }


    }


    [ServiceContract]
    <span class="kwrd">public</span> <span class="kwrd">interface</span> ICommonService
    {
        [OperationContract]
        <span class="kwrd">int</span>[] GetTicketIds();
    }


    <span class="kwrd">public</span> <span class="kwrd">class</span> CommonService : ICommonService
    {

        <span class="kwrd">public</span> <span class="kwrd">int</span>[] GetTicketIds()
        {
            var ctx = <span class="kwrd">new</span> InstanceStoreDataContext();
            <span class="kwrd">return</span> ctx.DocumentReviewTasks.Select(r =&gt; (<span class="kwrd">int</span>)r.TicketId).ToArray();
        }
    }

}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<h1>2. 修改之后的Host代码（请大家比较一下有何区别）</h1><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;
<span class="kwrd">using</span> System.ServiceModel;
<span class="kwrd">using</span> System.Activities;
<span class="kwrd">using</span> System.ServiceModel.Activities;
<span class="kwrd">using</span> System.ServiceModel.Description;

<span class="kwrd">using</span> System.Activities.DurableInstancing;
<span class="kwrd">using</span> System.Runtime.DurableInstancing;
<span class="kwrd">using</span> System.Activities.Persistence;
<span class="kwrd">using</span> System.ServiceModel.Activities.Description;
<span class="kwrd">using</span> System.Xml.Linq;

<span class="kwrd">namespace</span> Host
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            var host = <span class="kwrd">new</span> WorkflowServiceHost(
                <span class="kwrd">new</span> WorkflowService() { 
                    ConfigurationName = <span class="str">"DocumentReviewLib.DocumentReviewWorkflow"</span>,
                    Body = <span class="kwrd">new</span> DocumentReviewLib.DocumentReviewWorkflow()
                });


            <span class="rem">//这里可以通过进一步的Behavior定制来简化。此处略            </span>
            XNamespace xNS = XNamespace.Get(<span class="str">"http://xizhang.com/DocumentReview"</span>);
            var store = (SqlWorkflowInstanceStoreBehavior)host.Description.Behaviors.FirstOrDefault(b =&gt; b.GetType() == <span class="kwrd">typeof</span>(SqlWorkflowInstanceStoreBehavior));

            store.Promote(<span class="str">"DocumentReview"</span>,
                <span class="kwrd">new</span> List&lt;XName&gt;() { xNS.GetName(<span class="str">"TicketId"</span>) },
                <span class="kwrd">null</span>);



            <span class="rem">//这里可以通过进一步的Behavior定制来简化。此处略</span>
            host.WorkflowExtensions.Add(<span class="kwrd">new</span> Extensions.MyInstanceStoreParticpant());

            host.Open();

            var common = <span class="kwrd">new</span> ServiceHost(<span class="kwrd">typeof</span>(CommonService));

            common.Open();


            Console.WriteLine(<span class="str">"Server is ready."</span>);
            Console.Read();

        }


    }


    [ServiceContract]
    <span class="kwrd">public</span> <span class="kwrd">interface</span> ICommonService
    {
        [OperationContract]
        <span class="kwrd">int</span>[] GetTicketIds();
    }


    <span class="kwrd">public</span> <span class="kwrd">class</span> CommonService : ICommonService
    {

        <span class="kwrd">public</span> <span class="kwrd">int</span>[] GetTicketIds()
        {
            var ctx = <span class="kwrd">new</span> InstanceStoreDataContext();
            <span class="kwrd">return</span> ctx.DocumentReviewTasks.Select(r =&gt; (<span class="kwrd">int</span>)r.TicketId).ToArray();
        }
    }

}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<h1>3.添加的app.config文件内容</h1><pre class="csharpcode">&lt;?xml version=<span class="str">"1.0"</span> encoding=<span class="str">"utf-8"</span> ?&gt;
&lt;configuration&gt;
    &lt;configSections&gt;
    &lt;/configSections&gt;
    &lt;connectionStrings&gt;
        &lt;add name=<span class="str">"Host.Properties.Settings.WF4ConnectionString"</span> connectionString=<span class="str">"Data Source=.\sqlexpress;Initial Catalog=WF4;Integrated Security=True"</span>
            providerName=<span class="str">"System.Data.SqlClient"</span> /&gt;
    &lt;/connectionStrings&gt;
  &lt;system.serviceModel&gt;

    
    
    &lt;behaviors&gt;
      &lt;serviceBehaviors&gt;
        &lt;behavior name=<span class="str">"WorkflowService"</span>&gt;
          &lt;sqlWorkflowInstanceStore connectionStringName=<span class="str">"Host.Properties.Settings.WF4ConnectionString"</span>/&gt;
          &lt;workflowIdle timeToPersist=<span class="str">"0"</span> timeToUnload=<span class="str">"0"</span>/&gt;
          &lt;serviceMetadata httpGetEnabled=<span class="str">"true"</span>/&gt;
        &lt;/behavior&gt;
      &lt;/serviceBehaviors&gt;
    &lt;/behaviors&gt;
    
    &lt;services&gt;
      &lt;service name=<span class="str">"DocumentReviewLib.DocumentReviewWorkflow"</span> behaviorConfiguration=<span class="str">"WorkflowService"</span>&gt;
        &lt;host&gt;
          &lt;baseAddresses&gt;
            &lt;add baseAddress=<span class="str">"http://localhost:8080/DRS"</span>/&gt;
          &lt;/baseAddresses&gt;
        &lt;/host&gt;
        &lt;endpoint contract=<span class="str">"IDocumentReview"</span> address=<span class="str">""</span> binding=<span class="str">"basicHttpBinding"</span>&gt;&lt;/endpoint&gt;
      &lt;/service&gt;

      &lt;service name=<span class="str">"Host.CommonService"</span>&gt;
        &lt;host&gt;
          &lt;baseAddresses&gt;
            &lt;add baseAddress=<span class="str">"http://localhost:8080/Common"</span>/&gt;
          &lt;/baseAddresses&gt;
        &lt;/host&gt;

        &lt;endpoint contract=<span class="str">"Host.ICommonService"</span> binding=<span class="str">"basicHttpBinding"</span> address=<span class="str">""</span>&gt;&lt;/endpoint&gt;
      &lt;/service&gt;
    &lt;/services&gt;
    
    
    
  &lt;/system.serviceModel&gt;
  
&lt;/configuration&gt;</pre><pre class="csharpcode">&nbsp;</pre><pre class="csharpcode">这个案例的最终代码范例，请通过 <a href="http://files.cnblogs.com/chenxizhang/WF4EventDrivenSolution-final.rar" target="_blank">这里</a> 下载</pre><pre class="csharpcode">&nbsp;</pre><pre class="csharpcode"><strong><font face="Verdana"></font></strong>&nbsp;</pre>