# 在WPF应用程序中利用IEditableObject接口实现可撤销编辑的对象 
> 原文发表于 2013-08-26, 地址: http://www.cnblogs.com/chenxizhang/p/3281910.html 


<p>这是我辅导的一个项目开发中的例子，他们是用WPF做界面开发，在学习了如何使用MVVM来实现界面与逻辑的分离，并且很好的数据更新之后，有一个疑问就是，这种双向的数据更新确实很不错，但如果我们希望用户可以撤销修改怎么办呢？其实这个功能，很早就有，甚至在原先的Windows Forms里面也可以实现。秘密就是实现IEditableObject这个接口。</p> <p>关于这个接口的官方文档在这里：<a href="http://msdn.microsoft.com/zh-cn/library/vstudio/system.componentmodel.ieditableobject.aspx">http://msdn.microsoft.com/zh-cn/library/vstudio/system.componentmodel.ieditableobject.aspx</a></p> <p>&nbsp;</p> <p>我做了一个小的例子，帮助大家来理解。该例子使用了MVVM这种设计模式，如果你对此不熟悉，请先参考：<a href="http://www.cnblogs.com/chenxizhang/archive/2011/10/01/2197786.html">http://www.cnblogs.com/chenxizhang/archive/2011/10/01/2197786.html</a></p> <p>这个例子，你可以通过 <a title="http://files.cnblogs.com/chenxizhang/WpfApplicationBindingSample.zip" href="http://files.cnblogs.com/chenxizhang/WpfApplicationBindingSample.zip">http://files.cnblogs.com/chenxizhang/WpfApplicationBindingSample.zip</a> 进行下载</p> <h1>Model：Employee</h1><pre class="csharpcode"><span class="kwrd">using</span> System.ComponentModel;

<span class="kwrd">namespace</span> WpfApplicationBindingSample.Models
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 业务实体(Business Entity)</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">class</span> Employee : INotifyPropertyChanged,IEditableObject
    {
        <span class="kwrd">private</span> <span class="kwrd">string</span> _firstName;

        <span class="kwrd">public</span> <span class="kwrd">string</span> FirstName
        {
            get { <span class="kwrd">return</span> _firstName; }
            set
            {
                <span class="kwrd">if</span> (_firstName != <span class="kwrd">value</span>)
                {
                    _firstName = <span class="kwrd">value</span>;
                    <span class="kwrd">if</span> (PropertyChanged != <span class="kwrd">null</span>)
                    {
                        PropertyChanged(<span class="kwrd">this</span>, <span class="kwrd">new</span> PropertyChangedEventArgs(<span class="str">"FirstName"</span>));
                        PropertyChanged(<span class="kwrd">this</span>, <span class="kwrd">new</span> PropertyChangedEventArgs(<span class="str">"FullName"</span>));
                    }
                }
            }
        }

        <span class="kwrd">private</span> <span class="kwrd">string</span> _lastName;
        <span class="kwrd">public</span> <span class="kwrd">string</span> LastName
        {
            get { <span class="kwrd">return</span> _lastName; }
            set
            {
                <span class="kwrd">if</span> (_lastName != <span class="kwrd">value</span>)
                {
                    _lastName = <span class="kwrd">value</span>;
                    <span class="kwrd">if</span> (PropertyChanged != <span class="kwrd">null</span>)
                    {
                        PropertyChanged(<span class="kwrd">this</span>, <span class="kwrd">new</span> PropertyChangedEventArgs(<span class="str">"LastName"</span>));
                        PropertyChanged(<span class="kwrd">this</span>, <span class="kwrd">new</span> PropertyChangedEventArgs(<span class="str">"FullName"</span>));
                    }
                }
            }
        }

        <span class="kwrd">public</span> <span class="kwrd">string</span> FullName
        {
            get
            {
                <span class="kwrd">return</span> FirstName + <span class="str">","</span> + LastName;
            }
        }

        <span class="kwrd">public</span> <span class="kwrd">event</span> PropertyChangedEventHandler PropertyChanged;

        <span class="kwrd">private</span> Employee backup;<span class="rem">//用这个字段来保存一个备份数据</span>
        <span class="kwrd">public</span> <span class="kwrd">void</span> BeginEdit()
        {
            <span class="rem">//开始编辑，此时将当前的状态保存起来，以便后续可以根据情况提交或者撤销更改</span>
            backup = <span class="kwrd">this</span>.MemberwiseClone() <span class="kwrd">as</span> Employee;<span class="rem">//通过克隆的方式直接地复制一份数据</span>
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> CancelEdit()
        {
            <span class="rem">//撤销编辑，此时将对象状态恢复到备份的状态</span>
            <span class="kwrd">this</span>.FirstName = backup.FirstName;
            <span class="kwrd">this</span>.LastName = backup.LastName;
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> EndEdit()
        {
            <span class="rem">//结束编辑，这里可以不做任何事情，也可以添加一些额外的逻辑</span>
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<h1>ViewModel:</h1><pre class="csharpcode">
<span class="kwrd">using</span> GalaSoft.MvvmLight;
<span class="kwrd">using</span> GalaSoft.MvvmLight.Command;
<span class="kwrd">using</span> System.Windows;
<span class="kwrd">using</span> WpfApplicationBindingSample.Models;

<span class="kwrd">namespace</span> WpfApplicationBindingSample.ViewModels
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 视图模型：专门用来为界面（视图）来服务的，这里用来包含一些业务逻辑</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="kwrd">class</span> MainWindowViewModel : ViewModelBase
    {

        <span class="kwrd">public</span> MainWindowViewModel()
        {
            CurrentEmployee = <span class="kwrd">new</span> Employee()
            {
                FirstName = <span class="str">"ares"</span>,
                LastName = <span class="str">"chen"</span>
            };
        }

        <span class="kwrd">public</span> Employee CurrentEmployee { get; set; }
        <span class="kwrd">public</span> RelayCommand EditCommand {
            get {
                <span class="kwrd">return</span> <span class="kwrd">new</span> RelayCommand(() =&gt; {
                    <span class="rem">//将该员工设置为开始编辑</span>
                    CurrentEmployee.BeginEdit();
                });
            }
        }

        <span class="rem">/// &lt;summary&gt;</span>
        <span class="rem">/// 使用命令的机制代替了事件</span>
        <span class="rem">/// &lt;/summary&gt;</span>
        <span class="kwrd">public</span> RelayCommand SubmitCommand
        {
            get
            {<span class="rem">//使用匿名方法</span>
                <span class="kwrd">return</span> <span class="kwrd">new</span> RelayCommand(() =&gt;
                {
                    <span class="rem">//结束编辑，让更改生效</span>
                    CurrentEmployee.EndEdit();

                    MessageBox.Show(CurrentEmployee.FullName);
                });
            }
        }

        <span class="kwrd">public</span> RelayCommand CancelCommand
        {
            get
            {
                <span class="kwrd">return</span> <span class="kwrd">new</span> RelayCommand(() =&gt;
                {
                    CurrentEmployee.CancelEdit();<span class="rem">//取消编辑，此时可以看到FullName那个标签的文本恢复到原来的值</span>
                });
            }
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>View:</p><pre class="csharpcode"><span class="kwrd">&lt;</span><span class="html">Window</span> <span class="attr">x:Class</span><span class="kwrd">="WpfApplicationBindingSample.MainWindow"</span>
        <span class="attr">xmlns</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        <span class="attr">xmlns:x</span><span class="kwrd">="http://schemas.microsoft.com/winfx/2006/xaml"</span>
        <span class="attr">xmlns:vm</span><span class="kwrd">="clr-namespace:WpfApplicationBindingSample.ViewModels"</span>
        <span class="attr">Title</span><span class="kwrd">="MainWindow"</span>
        <span class="attr">Height</span><span class="kwrd">="350"</span>
        <span class="attr">Width</span><span class="kwrd">="525"</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">Window.DataContext</span><span class="kwrd">&gt;</span>
        <span class="rem">&lt;!--绑定数据上下文--&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">vm:MainWindowViewModel</span><span class="kwrd">&gt;&lt;/</span><span class="html">vm:MainWindowViewModel</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">Window.DataContext</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">Window.Resources</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">Style</span> <span class="attr">TargetType</span><span class="kwrd">="TextBlock"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Setter</span> <span class="attr">Property</span><span class="kwrd">="Margin"</span>
                    <span class="attr">Value</span><span class="kwrd">="3"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Setter</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">Style</span><span class="kwrd">&gt;</span>

        <span class="kwrd">&lt;</span><span class="html">Style</span> <span class="attr">TargetType</span><span class="kwrd">="TextBox"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Setter</span> <span class="attr">Property</span><span class="kwrd">="Width"</span>
                    <span class="attr">Value</span><span class="kwrd">="200"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Setter</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Setter</span> <span class="attr">Property</span><span class="kwrd">="HorizontalAlignment"</span>
                    <span class="attr">Value</span><span class="kwrd">="Left"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Setter</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">Style</span><span class="kwrd">&gt;</span>

        <span class="kwrd">&lt;</span><span class="html">Style</span> <span class="attr">TargetType</span><span class="kwrd">="Button"</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Setter</span> <span class="attr">Property</span><span class="kwrd">="Width"</span>
                    <span class="attr">Value</span><span class="kwrd">="100"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Setter</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Setter</span> <span class="attr">Property</span><span class="kwrd">="HorizontalAlignment"</span>
                    <span class="attr">Value</span><span class="kwrd">="Left"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Setter</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">Style</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;/</span><span class="html">Window.Resources</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">StackPanel</span> <span class="attr">Margin</span><span class="kwrd">="10"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">TextBlock</span> <span class="attr">FontSize</span><span class="kwrd">="30"</span>
                   <span class="attr">Text</span><span class="kwrd">="编辑员工"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBlock</span><span class="kwrd">&gt;</span>

        <span class="kwrd">&lt;</span><span class="html">TextBlock</span> <span class="attr">Text</span><span class="kwrd">="姓氏"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBlock</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">TextBox</span> <span class="attr">Text</span><span class="kwrd">="{Binding CurrentEmployee.FirstName,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBox</span><span class="kwrd">&gt;</span>
        <span class="rem">&lt;!--匈牙利命名法--&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">TextBlock</span> <span class="attr">Text</span><span class="kwrd">="名称"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBlock</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">TextBox</span> <span class="attr">Text</span><span class="kwrd">="{Binding CurrentEmployee.LastName,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBox</span><span class="kwrd">&gt;</span>

        <span class="kwrd">&lt;</span><span class="html">TextBlock</span> <span class="attr">Text</span><span class="kwrd">="全称"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBlock</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">TextBlock</span> <span class="attr">Text</span><span class="kwrd">="{Binding CurrentEmployee.FullName}"</span><span class="kwrd">&gt;&lt;/</span><span class="html">TextBlock</span><span class="kwrd">&gt;</span>

        <span class="kwrd">&lt;</span><span class="html">Button</span> <span class="attr">Content</span><span class="kwrd">="编辑"</span>
                <span class="attr">Command</span><span class="kwrd">="{Binding EditCommand}"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Button</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">Button</span> <span class="attr">Content</span><span class="kwrd">="提交"</span>
                <span class="attr">Command</span><span class="kwrd">="{Binding SubmitCommand}"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Button</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">Button</span> <span class="attr">Content</span><span class="kwrd">="取消"</span>
                <span class="attr">Command</span><span class="kwrd">="{Binding CancelCommand}"</span><span class="kwrd">&gt;&lt;/</span><span class="html">Button</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;/</span><span class="html">StackPanel</span><span class="kwrd">&gt;</span>

<span class="kwrd">&lt;/</span><span class="html">Window</span><span class="kwrd">&gt;</span>
</pre>