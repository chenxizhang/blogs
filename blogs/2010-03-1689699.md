# 再谈CLR：无法避免的装箱 
> 原文发表于 2010-03-19, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/03/19/1689699.html 


<p>大家可以思考下面的代码</p><pre class="csharpcode">        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {


            <span class="kwrd">int</span> a = 7;
            Console.WriteLine(a);

            Console.WriteLine(<span class="str">"{0:x}"</span>, a);
            Console.WriteLine(<span class="kwrd">string</span>.Format(<span class="str">"{0:x}"</span>, a));
            StringBuilder sb = <span class="kwrd">new</span> StringBuilder();
            sb.AppendFormat(<span class="str">"{0:x}"</span>, a);
            Console.WriteLine(sb.ToString());
            Console.Read();
        }
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>有几个问题：</p>
<p>1. 这几个方法哪些会发生装箱，哪些不会？</p>
<p>2. 他们有什么区别吗？</p>
<p>&nbsp;</p>
<p>要了解这两点，可以通过下面的图形</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_thumb.png" width="644" height="1014"></a> 
<p>所以，答案就是，只有第一种没有发生装箱操作。其他三种都发生了。
<p>而后面三种，本质上有差别吗？
<p>我们看到最后一种，是有callvirt指令的，也就是说它创建了一个stringbuilder对象，这是引用类型的。
<p>他们真的有差别吗？
<p>其实没有差别，如果我们通过工具查看源代码就会知道，Console.WriteLine方法，其实是调用了TextWriter.WriteLine方法，而这个又调用里的String.Format方法 ，而这个又调用了stringbuilder的AppendFormat方法
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_4.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_thumb_1.png" width="790" height="532"></a> 
<p>那么，为什么需要谈这些？我们的问题是：是否可以完全避免装箱呢？答案是：可以，但代价不见得小
<p>我们为什么会用strnig.Format就是因为要拼接字符串。那么能不能直接拼接呢？<pre class="csharpcode">            Console.WriteLine(<span class="str">""</span> + a.ToString(<span class="str">"x"</span>));
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_6.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_thumb_2.png" width="644" height="1014"></a> 
<p>看起来确实没有了装箱对吧，但其实因为string本身不可变长，此时仍然会产生两个string
<p>&nbsp; <p>那么下面这个方式是否可行呢<pre class="csharpcode">            Console.WriteLine(a.ToString(<span class="str">"当前值是:0"</span>));
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_8.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/CLR_AA7E/image_thumb_3.png" width="644" height="1014"></a> 
<p>&nbsp; <p>&nbsp; <p>&nbsp; <p>如果大家有兴趣，可以看看这个AppendFormat方法<pre class="csharpcode"><span class="kwrd">public</span> StringBuilder AppendFormat(IFormatProvider provider, <span class="kwrd">string</span> format, <span class="kwrd">params</span> <span class="kwrd">object</span>[] args)
{
    <span class="kwrd">int</span> num3;
    <span class="kwrd">if</span> ((format == <span class="kwrd">null</span>) || (args == <span class="kwrd">null</span>))
    {
        <span class="kwrd">throw</span> <span class="kwrd">new</span> ArgumentNullException((format == <span class="kwrd">null</span>) ? <span class="str">"format"</span> : <span class="str">"args"</span>);
    }
    <span class="kwrd">char</span>[] chArray = format.ToCharArray(0, format.Length);
    <span class="kwrd">int</span> index = 0;
    <span class="kwrd">int</span> length = chArray.Length;
    <span class="kwrd">char</span> ch = <span class="str">'\0'</span>;
    ICustomFormatter formatter = <span class="kwrd">null</span>;
    <span class="kwrd">if</span> (provider != <span class="kwrd">null</span>)
    {
        formatter = (ICustomFormatter) provider.GetFormat(<span class="kwrd">typeof</span>(ICustomFormatter));
    }
Label_004E:
    num3 = index;
    <span class="kwrd">int</span> num4 = index;
    <span class="kwrd">while</span> (index &lt; length)
    {
        ch = chArray[index];
        index++;
        <span class="kwrd">if</span> (ch == <span class="str">'}'</span>)
        {
            <span class="kwrd">if</span> ((index &lt; length) &amp;&amp; (chArray[index] == <span class="str">'}'</span>))
            {
                index++;
            }
            <span class="kwrd">else</span>
            {
                FormatError();
            }
        }
        <span class="kwrd">if</span> (ch == <span class="str">'{'</span>)
        {
            <span class="kwrd">if</span> ((index &lt; length) &amp;&amp; (chArray[index] == <span class="str">'{'</span>))
            {
                index++;
            }
            <span class="kwrd">else</span>
            {
                index--;
                <span class="kwrd">break</span>;
            }
        }
        chArray[num4++] = ch;
    }
    <span class="kwrd">if</span> (num4 &gt; num3)
    {
        <span class="kwrd">this</span>.Append(chArray, num3, num4 - num3);
    }
    <span class="kwrd">if</span> (index == length)
    {
        <span class="kwrd">return</span> <span class="kwrd">this</span>;
    }
    index++;
    <span class="kwrd">if</span> (((index == length) || ((ch = chArray[index]) &lt; <span class="str">'0'</span>)) || (ch &gt; <span class="str">'9'</span>))
    {
        FormatError();
    }
    <span class="kwrd">int</span> num5 = 0;
    <span class="kwrd">do</span>
    {
        num5 = ((num5 * 10) + ch) - 0x30;
        index++;
        <span class="kwrd">if</span> (index == length)
        {
            FormatError();
        }
        ch = chArray[index];
    }
    <span class="kwrd">while</span> (((ch &gt;= <span class="str">'0'</span>) &amp;&amp; (ch &lt;= <span class="str">'9'</span>)) &amp;&amp; (num5 &lt; 0xf4240));
    <span class="kwrd">if</span> (num5 &gt;= args.Length)
    {
        <span class="kwrd">throw</span> <span class="kwrd">new</span> FormatException(Environment.GetResourceString(<span class="str">"Format_IndexOutOfRange"</span>));
    }
    <span class="kwrd">while</span> ((index &lt; length) &amp;&amp; ((ch = chArray[index]) == <span class="str">' '</span>))
    {
        index++;
    }
    <span class="kwrd">bool</span> flag = <span class="kwrd">false</span>;
    <span class="kwrd">int</span> num6 = 0;
    <span class="kwrd">if</span> (ch == <span class="str">','</span>)
    {
        index++;
        <span class="kwrd">while</span> ((index &lt; length) &amp;&amp; (chArray[index] == <span class="str">' '</span>))
        {
            index++;
        }
        <span class="kwrd">if</span> (index == length)
        {
            FormatError();
        }
        ch = chArray[index];
        <span class="kwrd">if</span> (ch == <span class="str">'-'</span>)
        {
            flag = <span class="kwrd">true</span>;
            index++;
            <span class="kwrd">if</span> (index == length)
            {
                FormatError();
            }
            ch = chArray[index];
        }
        <span class="kwrd">if</span> ((ch &lt; <span class="str">'0'</span>) || (ch &gt; <span class="str">'9'</span>))
        {
            FormatError();
        }
        <span class="kwrd">do</span>
        {
            num6 = ((num6 * 10) + ch) - 0x30;
            index++;
            <span class="kwrd">if</span> (index == length)
            {
                FormatError();
            }
            ch = chArray[index];
        }
        <span class="kwrd">while</span> (((ch &gt;= <span class="str">'0'</span>) &amp;&amp; (ch &lt;= <span class="str">'9'</span>)) &amp;&amp; (num6 &lt; 0xf4240));
    }
    <span class="kwrd">while</span> ((index &lt; length) &amp;&amp; ((ch = chArray[index]) == <span class="str">' '</span>))
    {
        index++;
    }
    <span class="kwrd">object</span> arg = args[num5];
    <span class="kwrd">string</span> str = <span class="kwrd">null</span>;
    <span class="kwrd">if</span> (ch == <span class="str">':'</span>)
    {
        index++;
        num3 = index;
        num4 = index;
        <span class="kwrd">while</span> (<span class="kwrd">true</span>)
        {
            <span class="kwrd">if</span> (index == length)
            {
                FormatError();
            }
            ch = chArray[index];
            index++;
            <span class="kwrd">switch</span> (ch)
            {
                <span class="kwrd">case</span> <span class="str">'{'</span>:
                    <span class="kwrd">if</span> ((index &lt; length) &amp;&amp; (chArray[index] == <span class="str">'{'</span>))
                    {
                        index++;
                    }
                    <span class="kwrd">else</span>
                    {
                        FormatError();
                    }
                    <span class="kwrd">break</span>;

                <span class="kwrd">case</span> <span class="str">'}'</span>:
                    <span class="kwrd">if</span> ((index &lt; length) &amp;&amp; (chArray[index] == <span class="str">'}'</span>))
                    {
                        index++;
                    }
                    <span class="kwrd">else</span>
                    {
                        index--;
                        <span class="kwrd">if</span> (num4 &gt; num3)
                        {
                            str = <span class="kwrd">new</span> <span class="kwrd">string</span>(chArray, num3, num4 - num3);
                        }
                        <span class="kwrd">goto</span> Label_0253;
                    }
                    <span class="kwrd">break</span>;
            }
            chArray[num4++] = ch;
        }
    }
Label_0253:
    <span class="kwrd">if</span> (ch != <span class="str">'}'</span>)
    {
        FormatError();
    }
    index++;
    <span class="kwrd">string</span> str2 = <span class="kwrd">null</span>;
    <span class="kwrd">if</span> (formatter != <span class="kwrd">null</span>)
    {
        str2 = formatter.Format(str, arg, provider);
    }
    <span class="kwrd">if</span> (str2 == <span class="kwrd">null</span>)
    {
        <span class="kwrd">if</span> (arg <span class="kwrd">is</span> IFormattable)
        {
            str2 = ((IFormattable) arg).ToString(str, provider);
        }
        <span class="kwrd">else</span> <span class="kwrd">if</span> (arg != <span class="kwrd">null</span>)
        {
            str2 = arg.ToString();
        }
    }
    <span class="kwrd">if</span> (str2 == <span class="kwrd">null</span>)
    {
        str2 = <span class="kwrd">string</span>.Empty;
    }
    <span class="kwrd">int</span> repeatCount = num6 - str2.Length;
    <span class="kwrd">if</span> (!flag &amp;&amp; (repeatCount &gt; 0))
    {
        <span class="kwrd">this</span>.Append(<span class="str">' '</span>, repeatCount);
    }
    <span class="kwrd">this</span>.Append(str2);
    <span class="kwrd">if</span> (flag &amp;&amp; (repeatCount &gt; 0))
    {
        <span class="kwrd">this</span>.Append(<span class="str">' '</span>, repeatCount);
    }
    <span class="kwrd">goto</span> Label_004E;
}

 

 
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>