# 使用Expression Tree构建动态LINQ查询 
> 原文发表于 2014-08-16, 地址: http://www.cnblogs.com/chenxizhang/p/3916630.html 


<p>这篇文章介绍一个有意思的话题，也是经常被人问到的：如何构建动态LINQ查询？所谓动态，主要的意思在于查询的条件可以随机组合，动态添加，而不是固定的写法。这个在很多系统开发过程中是非常有用的。
</p><p>我这里给的一个解决方案是采用Expression Tree来构建。
</p><p>其实这个技术很早就有，在.NET Framework 3.5开始引入。之前也有不少同学写过很多不错的理论性文章。我自己当年学习这个，觉得最好的几篇文章是由"装配脑袋"同学写的。【有时间请仔细阅读这些入门指南，做点练习基本就能理解】
</p><p><a href="http://www.cnblogs.com/Ninputer/archive/2009/08/28/expression_tree1.html" target="_blank"><h2><span>Expression<span> Tree上手指南 （一） - <span>装配脑袋<span> - 博客园</span></span></span></span></h2></a><h2><span>
			</span></h2></p><p><a href="http://kb.cnblogs.com/a/1557160/" target="_blank"><h2><span>Expression<span> Tree 上手指南 （二） - <span>装配脑袋<span> - 博客园</span></span></span></span></h2></a><h2><span>
			</span></h2></p><p><a href="http://www.cnblogs.com/Ninputer/archive/2009/09/08/1562425.html" target="_blank"><h2><span>Expression<span> Tree 上手指南 （三） - <span>装配脑袋<span> - 博客园</span></span></span></span></h2></a><h2><span>
			</span></h2></p><p>
 </p><p>我下面给出的这个实例，希望能帮助大家更加深入理解这个技术，并且结合常见的LINQ to SQL来实现动态的查询。
</p><p>下面这个查询，大家应该都很眼熟
</p><p><img src="http://images.cnitblog.com/blog/9072/201408/161736446397432.png" alt=""/>
	</p><p>如果我们的条件是固定的，例如上例中，一共有两个条件，而且条件的逻辑判断也都是确定的，那么上面这样写很容易就能得到我们的结果。
</p><p>但，问题是，如果我们的条件不是固定的呢？如果你需要根据用户的选择，然后动态构造一个查询呢？
</p><p>我看过很多人做的一些通用查询界面，为了应对用户希望自主选择条件的这个需求，他们的做法往往就是用"拼接查询字符串"的做法来实现。这种方法勉强能实现要求，但性能和可维护性方面都相当差。
</p><p>如果你了解了Expression Tree，那么上面这个查询可以修改为下面这样：
</p><p><img src="http://images.cnitblog.com/blog/9072/201408/161736455454576.png" alt=""/>
	</p><p>
 </p><p>由此可见，掌握了这个技术的话，那么以后写动态查询应该会如虎添翼，至少多了一种很好的思路。
</p><p>顺便说一下，这个技术和反射有点类似，属于比较底层的技术，掌握了将对大家的编程能力会有所提升。
</p><p>值得一说的是，就算是我们第一种写法，内部的实现也是使用Expression Tree来实现的，有兴趣的同学可以看看如下的IL代码。
</p><p><span>IL_0001:  <span>ldarg.0    </span>
		</span></p><p><span>IL_0002:  <span>call       </span>
			<span>LINQPad.User.TypedDataContext.get_Employees</span>
		</span></p><p><span>IL_0007:  <span>ldtoken    </span>
			<span>LINQPad.User.Employees</span>
		</span></p><p><span>IL_000C:  <span>call       </span>
			<span>System.Type.GetTypeFromHandle</span>
		</span></p><p><span>IL_0011:  <span>ldstr      </span>
			<span>"x"</span>
		</span></p><p><span>IL_0016:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Parameter</span>
		</span></p><p><span>IL_001B:  <span>stloc.1    </span>
			<span>// CS$0$0000</span>
		</span></p><p><span>IL_001C:  <span>ldloc.1    </span>
			<span>// CS$0$0000</span>
		</span></p><p><span>IL_001D:  <span>ldtoken    </span>
			<span>LINQPad.User.Employees.EmployeeID</span>
		</span></p><p><span>IL_0022:  <span>call       </span>
			<span>System.Reflection.FieldInfo.GetFieldFromHandle</span>
		</span></p><p><span>IL_0027:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Field</span>
		</span></p><p><span>IL_002C:  <span>ldc.i4.5   </span>
		</span></p><p><span>IL_002D:  <span>box        </span>
			<span>System.Int32</span>
		</span></p><p><span>IL_0032:  <span>ldtoken    </span>
			<span>System.Int32</span>
		</span></p><p><span>IL_0037:  <span>call       </span>
			<span>System.Type.GetTypeFromHandle</span>
		</span></p><p><span>IL_003C:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Constant</span>
		</span></p><p><span>IL_0041:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.GreaterThan</span>
		</span></p><p><span>IL_0046:  <span>ldloc.1    </span>
			<span>// CS$0$0000</span>
		</span></p><p><span>IL_0047:  <span>ldtoken    </span>
			<span>LINQPad.User.Employees.Title</span>
		</span></p><p><span>IL_004C:  <span>call       </span>
			<span>System.Reflection.FieldInfo.GetFieldFromHandle</span>
		</span></p><p><span>IL_0051:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Field</span>
		</span></p><p><span>IL_0056:  <span>ldstr      </span>
			<span>"Sales Representative"</span>
		</span></p><p><span>IL_005B:  <span>ldtoken    </span>
			<span>System.String</span>
		</span></p><p><span>IL_0060:  <span>call       </span>
			<span>System.Type.GetTypeFromHandle</span>
		</span></p><p><span>IL_0065:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Constant</span>
		</span></p><p><span>IL_006A:  <span>ldc.i4.0   </span>
		</span></p><p><span>IL_006B:  <span>ldtoken    </span>
			<span>System.String.op_Equality</span>
		</span></p><p><span>IL_0070:  <span>call       </span>
			<span>System.Reflection.MethodBase.GetMethodFromHandle</span>
		</span></p><p><span>IL_0075:  <span>castclass  </span>
			<span>System.Reflection.MethodInfo</span>
		</span></p><p><span>IL_007A:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Equal</span>
		</span></p><p><span>IL_007F:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.AndAlso</span>
		</span></p><p><span>IL_0084:  <span>ldc.i4.1   </span>
		</span></p><p><span>IL_0085:  <span>newarr     </span>
			<span>System.Linq.Expressions.ParameterExpression</span>
		</span></p><p><span>IL_008A:  <span>stloc.2    </span>
			<span>// CS$0$0001</span>
		</span></p><p><span>IL_008B:  <span>ldloc.2    </span>
			<span>// CS$0$0001</span>
		</span></p><p><span>IL_008C:  <span>ldc.i4.0   </span>
		</span></p><p><span>IL_008D:  <span>ldloc.1    </span>
			<span>// CS$0$0000</span>
		</span></p><p><span>IL_008E:  <span>stelem.ref </span>
		</span></p><p><span>IL_008F:  <span>ldloc.2    </span>
			<span>// CS$0$0001</span>
		</span></p><p><span>IL_0090:  <span>call       </span>
			<span>System.Linq.Expressions.Expression.Lambda</span>
		</span></p><p><span>IL_0095:  <span>call       </span>
			<span>System.Linq.Queryable.Where</span>
		</span></p><p><span>IL_009A:  <span>stloc.0    </span>
			<span>// query</span>
		</span></p><p><span>IL_009B:  <span>ldloc.0    </span>
			<span>// query</span>
		</span></p><p><span>IL_009C:  <span>call       </span>
			<span>LINQPad.Extensions.Dump</span>
		</span></p><p>
 </p>