# MTOM效率测试 
> 原文发表于 2010-04-22, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/04/22/1718159.html 


<p>MTOM是一种消息编码方式，它的目的是优化SOAP消息的编码，以减小体积，提高传输速度。如果你对其不清楚，可以参考另外一篇文章</p> <p><a href="http://www.cnblogs.com/chenxizhang/archive/2010/04/09/1708621.html">http://www.cnblogs.com/chenxizhang/archive/2010/04/09/1708621.html</a></p> <p>&nbsp;</p> <p>这一篇，我们主要用实例来看看到底它在性能方面有何表现</p> <p>我们先做一些准备工作，编写了一个接口和服务</p> <p>1. 接口</p><pre class="csharpcode"><span class="kwrd">using</span> System.ServiceModel;

<span class="kwrd">namespace</span> Services
{
    [ServiceContract]
    <span class="kwrd">public</span> <span class="kwrd">interface</span> IHelloService
    {

        [OperationContract]
        <span class="kwrd">byte</span>[] GetData();

        

    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p><pre class="csharpcode">2.服务
<span class="kwrd">namespace</span> Services
{
    <span class="kwrd">public</span> <span class="kwrd">class</span> HelloWorldService:IHelloService
    {
        <span class="preproc">#region</span> IHelloService 成员

        <span class="kwrd">byte</span>[] IHelloService.GetData()
        {
            <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="kwrd">byte</span>[10000];
        }

        <span class="preproc">#endregion</span>
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>注意，我们这里的服务很简单，就是直接返回一个长度为10000的字节数组。</p>
<p>&nbsp;</p>
<p>接下来编写宿主和客户端</p>
<p>3.宿主</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.ServiceModel;
<span class="kwrd">using</span> Services;

<span class="kwrd">namespace</span> Host
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            <span class="kwrd">using</span> (ServiceHost host = <span class="kwrd">new</span> ServiceHost(<span class="kwrd">typeof</span>(HelloWorldService)))
            {
                host.Open();
                Console.WriteLine(<span class="str">"服务器已经准备好"</span>);
                Console.Read();
            }
        }
    }
}
</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>宿主的配置文件</p><pre class="csharpcode"><span class="kwrd">&lt;?</span><span class="html">xml</span> <span class="attr">version</span><span class="kwrd">="1.0"</span> <span class="attr">encoding</span><span class="kwrd">="utf-8"</span> ?<span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">configuration</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">services</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">service</span> <span class="attr">name</span><span class="kwrd">="Services.HelloWorldService"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">host</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">baseAddresses</span><span class="kwrd">&gt;</span>
            <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">baseAddress</span><span class="kwrd">="http://localhost:8080/HelloService"</span><span class="kwrd">/&gt;</span>
          <span class="kwrd">&lt;/</span><span class="html">baseAddresses</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">host</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">=""</span> <span class="attr">contract</span><span class="kwrd">="Services.IHelloService"</span> <span class="attr">binding</span><span class="kwrd">="basicHttpBinding"</span> <span class="attr">bindingConfiguration</span><span class="kwrd">="mtom"</span><span class="kwrd">&gt;&lt;/</span><span class="html">endpoint</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">service</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">services</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">basicHttpBinding</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">binding</span> <span class="attr">name</span><span class="kwrd">="mtom"</span> <span class="attr">messageEncoding</span><span class="kwrd">="Mtom"</span><span class="kwrd">&gt;&lt;/</span><span class="html">binding</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">basicHttpBinding</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">configuration</span><span class="kwrd">&gt;</span></pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>4. 客户端</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.ServiceModel;
<span class="kwrd">using</span> Services;

<span class="kwrd">namespace</span> TestClient
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {
            IHelloService proxy =
                (<span class="kwrd">new</span> ChannelFactory&lt;IHelloService&gt;(<span class="str">"local"</span>)).CreateChannel();

            <span class="kwrd">byte</span>[] buffer=proxy.GetData();
            Console.WriteLine(buffer.Length);

            Console.Read();
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>
<p><a class="thickbox" href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_6.png"></a></p>
<p></p>
<p>&nbsp;</p>
<p>客户端的配置文件</p><pre class="csharpcode"><span class="kwrd">&lt;?</span><span class="html">xml</span> <span class="attr">version</span><span class="kwrd">="1.0"</span> <span class="attr">encoding</span><span class="kwrd">="utf-8"</span> ?<span class="kwrd">&gt;</span>
<span class="kwrd">&lt;</span><span class="html">configuration</span><span class="kwrd">&gt;</span>
  
    <span class="kwrd">&lt;</span><span class="html">system.diagnostics</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">sources</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">source</span> <span class="attr">name</span><span class="kwrd">="System.ServiceModel.MessageLogging"</span>
      <span class="attr">switchValue</span><span class="kwrd">="Verbose"</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">listeners</span><span class="kwrd">&gt;</span>
          <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="xml"</span>
          <span class="attr">type</span><span class="kwrd">="System.Diagnostics.XmlWriterTraceListener"</span>
          <span class="attr">initializeData</span><span class="kwrd">="c:\logs\client.svclog"</span> <span class="kwrd">/&gt;</span>
        <span class="kwrd">&lt;/</span><span class="html">listeners</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">source</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">sources</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">trace</span> <span class="attr">autoflush</span><span class="kwrd">="true"</span> <span class="kwrd">/&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">system.diagnostics</span><span class="kwrd">&gt;</span>


  
  
  <span class="kwrd">&lt;</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>

    <span class="kwrd">&lt;</span><span class="html">diagnostics</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">messageLogging</span> <span class="attr">logEntireMessage</span><span class="kwrd">="true"</span>
      <span class="attr">maxMessagesToLog</span><span class="kwrd">="300"</span>
      <span class="attr">logMessagesAtServiceLevel</span><span class="kwrd">="false"</span>
      <span class="attr">logMalformedMessages</span><span class="kwrd">="true"</span>
      <span class="attr">logMessagesAtTransportLevel</span><span class="kwrd">="true"</span> <span class="kwrd">/&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">diagnostics</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">client</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">endpoint</span> <span class="attr">address</span><span class="kwrd">="http://localhost:8080/HelloService"</span> <span class="attr">binding</span><span class="kwrd">="basicHttpBinding"</span> <span class="attr">contract</span><span class="kwrd">="Services.IHelloService"</span> <span class="attr">name</span><span class="kwrd">="local"</span> <span class="attr">bindingConfiguration</span><span class="kwrd">="mtom"</span><span class="kwrd">&gt;&lt;/</span><span class="html">endpoint</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">client</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;</span><span class="html">basicHttpBinding</span><span class="kwrd">&gt;</span>
        <span class="kwrd">&lt;</span><span class="html">binding</span> <span class="attr">name</span><span class="kwrd">="mtom"</span> <span class="attr">messageEncoding</span><span class="kwrd">="Mtom"</span><span class="kwrd">&gt;&lt;/</span><span class="html">binding</span><span class="kwrd">&gt;</span>
      <span class="kwrd">&lt;/</span><span class="html">basicHttpBinding</span><span class="kwrd">&gt;</span>
    <span class="kwrd">&lt;/</span><span class="html">bindings</span><span class="kwrd">&gt;</span>
  <span class="kwrd">&lt;/</span><span class="html">system.serviceModel</span><span class="kwrd">&gt;</span>
<span class="kwrd">&lt;/</span><span class="html">configuration</span><span class="kwrd">&gt;</span></pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>&nbsp;</p>
<p>说明，上面的配置文件中，已经配置好了messageEncoding为Mtom. 但我们在运行程序时会分两次运行，一次是标准的编码，一次则是Mtom编码</p>
<p>我们通过下面的日志文件可以比较出来MTOM编码的效率优势</p>
<p>下图是标准编码的结果，请注意Content-length为13524</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb.png" width="894" height="879"></a> </p>
<p>下图是Mtom编码的结果，请注意Content-Length为10739</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_4.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb_1.png" width="894" height="879"></a> </p>
<p>&nbsp;</p>
<p>最后有一点要提示的是，MTOM编码主要针对二进制结果有优势。原因在于，标准编码(Text）在对二进制数据编码的时候会采取Base64编码，使得数据平白地多出来了1/3左右。</p>
<p>而针对纯文本的数据，则MTOM编码的长度 总是会大于标准编码的长度。</p>
<p>例如我们有如下的一个方法，返回一些字符</p><pre class="csharpcode">        <span class="kwrd">public</span> <span class="kwrd">string</span> GetString()
        {
            StringBuilder sb = <span class="kwrd">new</span> StringBuilder();
            <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; 1000; i++)
            {
                sb.Append(<span class="str">"Hello"</span>);
            }
            <span class="kwrd">return</span> sb.ToString();
        }
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>首先看标准编码的长度，为5196</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_7.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb_2.png" width="894" height="879"></a> </p>
<p>而MTOM编码的长度则为</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_9.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb_3.png" width="894" height="879"></a> </p>
<p>我们再来测试一下复杂类型的情况。为了演示，我们添加了一个Employee类型在客户端和服务器之间传递。</p><pre class="csharpcode">    [DataContract]
    <span class="kwrd">public</span> <span class="kwrd">class</span> Employee {
        [DataMember]
        <span class="kwrd">public</span> <span class="kwrd">string</span> FirstName { get; set; }
        [DataMember]
        <span class="kwrd">public</span> <span class="kwrd">string</span> LastName { get; set; }

        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">string</span> ToString()
        {
            <span class="kwrd">return</span> <span class="kwrd">string</span>.Format(<span class="str">"{0},{1}"</span>, FirstName, LastName);
        }
    }</pre>
<p>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>
</p>
<p>然后在服务中实现了一个方法</p><pre class="csharpcode">        Employee[] IHelloService.GetEmployees()
        {
            List&lt;Employee&gt; result = <span class="kwrd">new</span> List&lt;Employee&gt;();
            <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; 500; i++)
            {
                result.Add(<span class="kwrd">new</span> Employee()
                {
                    FirstName = <span class="str">"陈"</span>,
                    LastName = <span class="str">"希章"</span>
                });
            }

            <span class="kwrd">return</span> result.ToArray();
        }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>我们看到，发送500个员工的数据，如果按照标准编码的话，长度大致需要43319</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_11.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb_4.png" width="894" height="879"></a> </p>
<p>如果改成mtom呢，长度为43561，还是稍微大一些。这是因为MTOM这种编码本身会有一些额外的开销</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_13.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb_5.png" width="894" height="879"></a> </p>
<p>&nbsp;</p>
<p>好的，这里需要总结一下了</p>
<p>1. MTOM是一个编码方式</p>
<p>2. MTOM是针对较大的二进制数据有优化作用，相比较默认的Text编码，它传输的是接近于数据原本的格式，而Text编码方式则采用了Base64的方式进行编码。</p>
<p>3. 针对标准文本或者对象，MTOM并没有优化作用。</p>
<p>&nbsp;</p>
<p>最后，有没有朋友想到了这样一个问题：既然是二进制的数据，能不能直接就采用二进制的方式传递呢？干嘛要去编码成文本呢？</p>
<p>是的，这是一个很好的问题，我们当然也可以直接采用netTcpBinding，它默认就是直接使用二进制编码</p>
<p>&nbsp;</p>
<p>我们从下图是看不到长度的</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_15.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/MTOM_50F0/image_thumb_6.png" width="894" height="879"></a> </p>
<p></p>
<p></p>
<p></p>
<p></p>
<p>&nbsp;</p>
<p>但如果我们真的有兴趣，可以通过下面的代码计算得到不同的编码方式到底会有多长</p><pre class="csharpcode">        <span class="kwrd">static</span> <span class="kwrd">void</span> CompareMessageSize(<span class="kwrd">int</span> dataSize)
        {
            <span class="rem">// Create and buffer a message with a binary payload</span>
            <span class="kwrd">byte</span>[] binaryData = <span class="kwrd">new</span> <span class="kwrd">byte</span>[dataSize];
            Message message = Message.CreateMessage(MessageVersion.Soap12WSAddressing10, <span class="str">"action"</span>, binaryData);
            MessageBuffer buffer = message.CreateBufferedCopy(<span class="kwrd">int</span>.MaxValue);

            <span class="rem">// Print the size of a text encoded copy</span>
            <span class="kwrd">int</span> size = SizeOfTextMessage(buffer.CreateMessage());
            Console.WriteLine(<span class="str">"Text encoding with a {0} byte payload: {1}"</span>, binaryData.Length, size);

            <span class="rem">// Print the size of an MTOM encoded copy</span>
            size = SizeOfMtomMessage(buffer.CreateMessage());
            Console.WriteLine(<span class="str">"MTOM encoding with a {0} byte payload: {1}"</span>, binaryData.Length, size);

            Console.WriteLine();
            message.Close();
        }

        <span class="kwrd">static</span> <span class="kwrd">int</span> SizeOfTextMessage(Message message)
        {
            <span class="rem">// Create a text encoder</span>
            MessageEncodingBindingElement element = <span class="kwrd">new</span> TextMessageEncodingBindingElement();
            MessageEncoderFactory factory = element.CreateMessageEncoderFactory();
            MessageEncoder encoder = factory.Encoder;

            <span class="rem">// Write the message and return its length</span>
            MemoryStream stream = <span class="kwrd">new</span> MemoryStream();
            encoder.WriteMessage(message, stream);
            <span class="kwrd">int</span> size = (<span class="kwrd">int</span>)stream.Length;
            
            message.Close();
            stream.Close();
            <span class="kwrd">return</span> size;
        }

        <span class="kwrd">static</span> <span class="kwrd">int</span> SizeOfMtomMessage(Message message)
        {
            <span class="rem">// Create an MTOM encoder</span>
            MessageEncodingBindingElement element = <span class="kwrd">new</span> MtomMessageEncodingBindingElement();
            MessageEncoderFactory factory = element.CreateMessageEncoderFactory();
            MessageEncoder encoder = factory.Encoder;

            <span class="rem">// Write the message and return its length</span>
            MemoryStream stream = <span class="kwrd">new</span> MemoryStream();
            encoder.WriteMessage(message, stream);
            <span class="kwrd">int</span> size = (<span class="kwrd">int</span>)stream.Length;
            
            stream.Close();
            message.Close();
            <span class="kwrd">return</span> size;
        }</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>