# 如何在SQL Server中使用正则表达式 
> 原文发表于 2011-05-27, 地址: http://www.cnblogs.com/chenxizhang/archive/2011/05/27/2060319.html 


<p>最近处理客户一个需求，是要在SQL Server中对某个列进行校验，使用正则表达式保证该列必须是一个邮件地址。</p> <p>我们都知道，SQL Server的T-SQL中默认是没有这样的语法的。找了一些资料，下面这个例子还不错，分享给大家参考</p> <p><a href="http://www.codeproject.com/KB/database/xp_pcre.aspx">http://www.codeproject.com/KB/database/xp_pcre.aspx</a></p> <p>大致步骤是</p> <p>1.下载他提供的那个压缩包，里面有源代码和安装脚本</p> <p>2.将DLL复制到SQL Server规定的目录</p> <p>3.运行INSTALL.sql这个脚本</p> <p>&nbsp;</p> <p>大致使用的效果如下</p><pre class="csharpcode"><span class="kwrd">SELECT</span> master.dbo.fn_pcre_match(<span class="str"><a href="mailto:'billg@microsoft.com','^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$'">'billg@microsoft.com'</span>,<span class="str">'^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$'</a></span>)</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>&nbsp;</p>
<p>这句脚本的意思是，根据后面的正则表达式（一个email的规则）匹配前面的字符串.如果返回1的话，表示匹配到了，否则返回0.很显然，</p>
<p><a href="http://www.xizhang.com/blogimages/xp_pcre---Regular-Expressions-in-T-SQL_EA06/image.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/xp_pcre---Regular-Expressions-in-T-SQL_EA06/image_thumb.png" width="930" height="702"></a></p>
<p>&nbsp;</p>
<p>很显然，我们可以根据这个做法设置某个字段的约束。例如下面这样</p>
<p><a href="http://www.xizhang.com/blogimages/xp_pcre---Regular-Expressions-in-T-SQL_EA06/image_3.png"><img title="image" border="0" alt="image" src="http://www.xizhang.com/blogimages/xp_pcre---Regular-Expressions-in-T-SQL_EA06/image_thumb_3.png" width="452" height="250"></a></p>
<p>&nbsp;</p>
<p>上述做法是通过扩展存储过程来实现的功能，需要通过C++来编写。</p>
<p>&nbsp;</p>
<p>当然，如果SQL Server 是2005或者以后的版本，也可以通过托管代码来实现。关于这个话题的基本概念，你可以参考 <a href="http://msdn.microsoft.com/en-us/library/ms254498(v=vs.80).aspx">http://msdn.microsoft.com/en-us/library/ms254498(v=vs.80).aspx</a></p>
<p>&nbsp;</p>
<p>我写好了一个例子，给大家参考</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Data;
<span class="kwrd">using</span> System.Data.SqlClient;
<span class="kwrd">using</span> System.Data.SqlTypes;
<span class="kwrd">using</span> Microsoft.SqlServer.Server;
<span class="kwrd">using</span> System.Collections;
<span class="kwrd">using</span> System.Text.RegularExpressions;

<span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> UserDefinedFunctions
{
    <span class="rem">/// &lt;summary&gt;</span>
    <span class="rem">/// 这是一个进行正则表达式验证的函数.作者：陈希章</span>
    <span class="rem">/// &lt;/summary&gt;</span>
    <span class="rem">/// &lt;param name="ValidOption"&gt;选项，0为用户自定义，1为网址，2为邮件地址，3为邮政编码&lt;/param&gt;</span>
    <span class="rem">/// &lt;param name="ValidString"&gt;要验证的字符串&lt;/param&gt;</span>
    <span class="rem">/// &lt;param name="ValidPatten"&gt;用户自定义的正则表达式规则&lt;/param&gt;</span>
    <span class="rem">/// &lt;returns&gt;&lt;/returns&gt;</span>
    [Microsoft.SqlServer.Server.SqlFunction]
    <span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">bool</span> RegExValidate(<span class="kwrd">int</span> ValidOption, <span class="kwrd">string</span> ValidString, <span class="kwrd">string</span> ValidPatten)
    {
        <span class="kwrd">string</span> strRegExPatten = <span class="kwrd">null</span>;
        <span class="kwrd">switch</span> (ValidOption)
        {
            <span class="kwrd">case</span> 0: { strRegExPatten = ValidPatten; <span class="kwrd">break</span>; }
            <span class="kwrd">case</span> 1: { strRegExPatten = <span class="str">@"^[a-zA-Z0-9\-\.]+\.(com|org|net|mil|edu|COM|ORG|NET|MIL|EDU)$"</span>; <span class="kwrd">break</span>; }
            <span class="kwrd">case</span> 2: { strRegExPatten = <span class="str">@"^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$"</span>; <span class="kwrd">break</span>; }
            <span class="kwrd">case</span> 3: { strRegExPatten = <span class="str">@"^[0-9]{4}\s{0,1}[a-zA-Z]{2}$"</span>; <span class="kwrd">break</span>; }
        }

        <span class="kwrd">if</span> (Regex.IsMatch(ValidString,strRegExPatten))
            <span class="kwrd">return</span> <span class="kwrd">true</span>;
        <span class="kwrd">else</span>
            <span class="kwrd">return</span> <span class="kwrd">false</span>;
    }
};

</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>