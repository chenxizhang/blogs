# 【十五分钟Talkshow】如何理解并优化.NET应用程序对内存的使用 
> 原文发表于 2012-02-27, 地址: http://www.cnblogs.com/chenxizhang/archive/2012/02/27/2370422.html 


<p><font color="#ff0000">前言：十五分钟Talkshow，是我将利用业余时间开展的一个活动（不定期发布），主要是我选择某些与技术或者软件工程方面有关的主题进行讲解，每次一个主题，尽可能在15分钟左右讲完。这些演讲是免费公开的，允许分发。</font></p> <p>&nbsp;</p> <p>备注：这次是第一次录制，本来计划是十五分钟左右，没有把握好时间，后期还会在内容编排上面再做一些改进</p> <p>&nbsp;</p> <h1>摘要提示：</h1> <p>这是一个关于.NET应用程序中对于内存使用和优化的简短演讲，通过此视频，你可以了解</p> <ol> <li>}什么是内存问题  <li>}.NET应用程序是如何分配和释放内存  <li>}深入分析内存使用情况并调优</li></ol> <p>&nbsp;</p> <h1>讲义地址：</h1> <p><a href="http://www.xizhang.com/fmplan/resources/01/如何理解并优化.NET应用程序对内存的使用.pdf">http://www.xizhang.com/fmplan/resources/01/如何理解并优化.NET应用程序对内存的使用.pdf</a></p> <p>&nbsp;</p> <h1>视频地址：</h1> <p><a title="http://www.tudou.com/programs/view/BhY8Q2icnAY/" href="http://www.tudou.com/programs/view/BhY8Q2icnAY/">http://www.tudou.com/programs/view/BhY8Q2icnAY/</a></p> <p>&nbsp;</p><embed src="http://www.tudou.com/v/BhY8Q2icnAY/&amp;rpid=101037296&amp;resourceId=101037296_05_05_99/v.swf" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" wmode="opaque" width="480" height="400"></embed>  <p><font color="#ff0000"></font>&nbsp;</p> <p><font color="#ff0000"></font>&nbsp;</p> <p>&nbsp;</p> <p>范例代码：(代码可以稍作修改，请自行准备有关的Excel文件，和数据库）</p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> System.Text;
<span class="kwrd">using</span> ClosedXML.Excel;
<span class="kwrd">using</span> System.IO;
<span class="kwrd">using</span> System.Diagnostics;


<span class="kwrd">namespace</span> Console
{
    <span class="kwrd">class</span> Program
    {
        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
        {

            UploadData();
            GC.Collect();
            System.Console.Read();
        }

        <span class="kwrd">private</span> <span class="kwrd">static</span> <span class="kwrd">void</span> UploadData()
        {
            <span class="rem">///该软件的功能在于,读取某个文件夹里面一批EXCEL文件里面的数据，并将其插入到数据库中去</span>
            <span class="rem">///测试用的EXCEL文件有470个，每个文件将要读取200个左右的单元格数据，根据名称读取</span>

            var folder = <span class="str">"d:\\temp\\demo"</span>;
            var files = Directory.GetFiles(folder, <span class="str">"*.xlsx"</span>);


            <span class="rem">//数据库连接</span>
            var db = <span class="kwrd">new</span> DataModelDataContext();

            <span class="rem">//准备一个计时器</span>
            var sw = <span class="kwrd">new</span> Stopwatch();
            sw.Start();

            System.Console.WriteLine(<span class="str">"开始工作:"</span> + DateTime.Now.ToString());


            files.ForEach(file =&gt;
            {
                var bk = <span class="kwrd">new</span> XLWorkbook(file);
                var names = bk.NamedRanges;

                var fileName = Path.GetFileNameWithoutExtension(file);
                var code = fileName.Substring(0, 6);
                var year = <span class="kwrd">short</span>.Parse(fileName.Substring(7, 4));
                var month = <span class="kwrd">byte</span>.Parse(fileName.Substring(11, 2));




                names.ForEach(item =&gt;
                {
                    var name = item.Name;
                    var address = item.RefersTo;
                    var sheet = address.Split(<span class="str">'!'</span>)[0].Replace(<span class="str">"'"</span>, <span class="str">""</span>);
                    var cell = address.Split(<span class="str">'!'</span>)[1];
                    var rng = bk.Worksheet(sheet).Range(cell).Cells().FirstOrDefault();
                    var v = !<span class="kwrd">string</span>.IsNullOrEmpty(rng.FormulaA1) ? rng.ValueCached : rng.Value.ToString();
                    <span class="rem">//如果是公式的话，则用ValueCached读取（有可能是空值，即表示当前没有值，有可能是错误，这种情况应该都是以#开头，#DIV/0!，#N/A，#NAME?，#NUM!，#VALUE，#REF!，#NULL!</span>
                    db.ItemValues.InsertOnSubmit(<span class="kwrd">new</span> ItemValue()
                    {
                        Code = code,
                        Year = year,
                        Month = month,
                        ItemName = name,
                        Value = v
                    });

                });

                db.SubmitChanges();


                bk.Dispose();
                GC.Collect();
                System.Console.WriteLine(file);
            });

            sw.Stop();

            System.Console.WriteLine(<span class="str">"结束工作:{0},耗时:{1}秒"</span>, DateTime.Now, sw.Elapsed.TotalSeconds);
        }

    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>