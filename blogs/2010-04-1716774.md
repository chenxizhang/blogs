# 关于工作流（Workflow Foundation）的一些总结归纳 
> 原文发表于 2010-04-21, 地址: http://www.cnblogs.com/chenxizhang/archive/2010/04/21/1716774.html 


<h4>其实，以我的体会，工作流（Workflow Foundation）从它一诞生就褒贬不一。至少它确实目前看起来还是比较难用。在.NET 3.5以及之前的版本中，为了实现工作流，我们还是需要编写相当多的代码。</h4> <p>&nbsp;</p> <p>我觉得，WF给我们带来的主要有几点是值得了解的</p> <h2>1. 通过可视化的界面将流程设计与程序逻辑分离开来。</h2> <p>流程设计的可以只管流程，他们不要知道怎么做。流程设计的人员可能（或者一定）不会用Visual Studio，他们可以使用一些简单的设计器工具。例如下面的这个小例子就是一个独立的程序，上面包装了WF的设计器。结合自定义Activity的设计，可以将业务逻辑隐藏起来。</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_2.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb.png" width="713" height="468"></a> </p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_4.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_1.png" width="848" height="540"></a> </p> <p>&nbsp;</p> <h2>2.业务逻辑的数据还是需要我们自己设计数据库保存以及维护的</h2> <p>这是很多人疑惑的，他们觉得既然有Workflow Foundation，就万事大吉了。因为工作流实例确实也有数据，而且我们可以持久化将其保存起来嘛。</p> <p>停！这不是一个正确的想法。工作流的持久化服务顾名思义，其实主要是为了给我们维护长时间工作的流程信息的（可以在空闲的时候卸载，保存到数据库等）。</p> <p>大家应该这样理解，Workflow Foundation只是管流程的部分，它不管数据。</p> <p>没错，它只管流程。这有什么问题么，它管好这个就够了，而且确实能帮很大的忙，不是吗？</p> <p>这样，我们就可以将注意力放在业务数据的管理，而不是流程状态的管理之类。</p> <p>&nbsp;</p> <h2>3. 一般一套工作流的解决方案需要包含哪些组件</h2> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_6.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_2.png" width="956" height="395"></a> </p> <p>请注意上面选中的项目，我来解释一下</p> <p>3.1 WorkflowLibrary 这个项目包含了工作流设计，它是可视化设计的成果。下图是一个典型的审批流程</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_8.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_3.png" width="963" height="784"></a> </p> <p>3.2 OrderApprovalEventType 这个项目包含了工作流设计时可能会用到的一些接口和事件定义。为什么需要用事件呢？一般我们的流程如果需要等待用户干预，诸如审批之类的情况，就需要这样做，因为它可能不是立即发生的。</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_10.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_4.png" width="963" height="784"></a> </p> <p>注意，接口要标记为ExternalDataExchange，事件参数需要继承ExternalDataEventArgs，而且必须可序列化</p> <p>&nbsp;</p> <p>3.3 Contracts 这个项目是标准的WCF合约定义，因为我们是分了服务器和客户端的，他们之间通过WCF通讯，包括创建流程，以及激发事件等等</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_12.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_5.png" width="963" height="784"></a> </p> <p>3.4 Services，这就是具体实现的WCF服务，在这里可以启动工作流运行时，并且按照客户端指令做相应的事情。这里的代码是相当多的。</p> <p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_14.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_6.png" width="963" height="784"></a> </p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Collections.Generic;
<span class="kwrd">using</span> System.Linq;
<span class="kwrd">using</span> Contracts;

<span class="kwrd">using</span> System.ServiceModel;
<span class="kwrd">using</span> System.Workflow.Runtime;

<span class="kwrd">using</span> OrderApprovalEventType;
<span class="kwrd">using</span> System.Workflow.Activities;

<span class="kwrd">using</span> System.Workflow.Runtime.Hosting;
<span class="kwrd">using</span> System.Workflow.Runtime.Tracking;


<span class="kwrd">namespace</span> Services
{
    [ServiceBehavior(InstanceContextMode=InstanceContextMode.Single)]<span class="rem">//只有一个实例</span>
    <span class="kwrd">public</span> <span class="kwrd">class</span> OrderService:IOrderService
    {
        <span class="rem">//运行时</span>
        <span class="kwrd">private</span> WorkflowRuntime runtime = <span class="kwrd">null</span>;

        <span class="rem">//所有实例</span>
        <span class="kwrd">private</span> List&lt;WorkflowIntanceData&gt; instances = <span class="kwrd">new</span> List&lt;WorkflowIntanceData&gt;();
        <span class="rem">//本地服务</span>
        LocalService local = <span class="kwrd">null</span>;

        <span class="kwrd">public</span> OrderService() {
            runtime = <span class="kwrd">new</span> WorkflowRuntime();

            <span class="rem">//添加数据交换服务，可以激发事件</span>
            ExternalDataExchangeService svr = <span class="kwrd">new</span> ExternalDataExchangeService();
            runtime.AddService(svr);

            local = <span class="kwrd">new</span> LocalService();
            svr.AddService(local);

            <span class="rem">//添加持久化服务，保存实例</span>
            <span class="rem">//F:\Windows\Microsoft.NET\Framework\v3.0\Windows Workflow Foundation\SQL\zh-CHS这里会有脚本</span>
            var db = <span class="str">"server=(local);database=WorkflowFoundation;integrated security=true"</span>;
            SqlWorkflowPersistenceService sqlsvc = <span class="kwrd">new</span> SqlWorkflowPersistenceService(db);
            runtime.AddService(sqlsvc);


            <span class="rem">//添加跟踪服务，可以对服务进行诊断和调试</span>
            SqlTrackingService tracksvc = <span class="kwrd">new</span> SqlTrackingService(db);
            runtime.AddService(tracksvc);
            
            

            <span class="rem">//绑定有关的事件</span>
            runtime.WorkflowStarted += <span class="kwrd">new</span> EventHandler&lt;WorkflowEventArgs&gt;(runtime_WorkflowStarted);
            runtime.WorkflowCompleted += <span class="kwrd">new</span> EventHandler&lt;WorkflowCompletedEventArgs&gt;(runtime_WorkflowCompleted);
            runtime.WorkflowCreated += <span class="kwrd">new</span> EventHandler&lt;WorkflowEventArgs&gt;(runtime_WorkflowCreated);
            runtime.WorkflowAborted += <span class="kwrd">new</span> EventHandler&lt;WorkflowEventArgs&gt;(runtime_WorkflowAborted);
            runtime.WorkflowTerminated += <span class="kwrd">new</span> EventHandler&lt;WorkflowTerminatedEventArgs&gt;(runtime_WorkflowTerminated);
            runtime.WorkflowUnloaded += <span class="kwrd">new</span> EventHandler&lt;WorkflowEventArgs&gt;(runtime_WorkflowUnloaded);

            runtime.StartRuntime();<span class="rem">//启动运行时</span>
            Console.WriteLine(<span class="str">"工作流服务器已经准备就绪"</span>);


            
            <span class="rem">//加载那些保存好的流程实例</span>
            <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> sqlsvc.GetAllWorkflows())
            {
                var instance =(WorkflowLibrary.Workflow1)runtime.GetWorkflow(item.WorkflowInstanceId).GetWorkflowDefinition();

                instances.Add(
                    <span class="kwrd">new</span> WorkflowIntanceData()
                    {
                        Id = item.WorkflowInstanceId,
                        Amount = instance.Amount
                    });


            }
        }

        <span class="kwrd">void</span> runtime_WorkflowUnloaded(<span class="kwrd">object</span> sender, WorkflowEventArgs e)
        {
            Console.WriteLine(<span class="str">"时间:{0},卸载流程:{1}"</span>, DateTime.Now, e.WorkflowInstance.InstanceId);
            
        }

        <span class="kwrd">void</span> runtime_WorkflowTerminated(<span class="kwrd">object</span> sender, WorkflowTerminatedEventArgs e)
        {
            

            Console.WriteLine(<span class="str">"时间:{0},终止流程:{1}"</span>, DateTime.Now, e.WorkflowInstance.InstanceId);
            
        }

        <span class="kwrd">void</span> runtime_WorkflowAborted(<span class="kwrd">object</span> sender, WorkflowEventArgs e)
        {
            Console.WriteLine(<span class="str">"时间:{0},中断流程:{1}"</span>, DateTime.Now, e.WorkflowInstance.InstanceId);
            
            
        }

        <span class="kwrd">void</span> runtime_WorkflowCreated(<span class="kwrd">object</span> sender, WorkflowEventArgs e)
        {
            Console.WriteLine(<span class="str">"时间:{0},创建流程:{1}"</span>, DateTime.Now, e.WorkflowInstance.InstanceId);
            
            
        }

        <span class="kwrd">void</span> runtime_WorkflowCompleted(<span class="kwrd">object</span> sender, WorkflowCompletedEventArgs e)
        {
            var found = instances.FirstOrDefault(d =&gt; d.Id == e.WorkflowInstance.InstanceId);
            <span class="kwrd">if</span> (found != <span class="kwrd">null</span>)
                instances.Remove(found);

            Console.WriteLine(<span class="str">"时间:{0},完成流程:{1}"</span>, DateTime.Now, e.WorkflowInstance.InstanceId);
            
            
        }

        <span class="kwrd">void</span> runtime_WorkflowStarted(<span class="kwrd">object</span> sender, WorkflowEventArgs e)
        {
            Console.WriteLine(<span class="str">"时间:{0},启动流程:{1}"</span>, DateTime.Now, e.WorkflowInstance.InstanceId);
            
        }




        <span class="preproc">#region</span> IOrderService 成员

        <span class="kwrd">public</span> <span class="kwrd">void</span> StartRequest(Guid id, <span class="kwrd">int</span> amount)
        {
            <span class="rem">//准备数据</span>
            var initParam =<span class="kwrd">new</span> Dictionary&lt;<span class="kwrd">string</span>,<span class="kwrd">object</span>&gt;();
            initParam.Add(<span class="str">"Amount"</span>,amount);

            <span class="rem">//创建实例</span>
            var instance = runtime.CreateWorkflow(
                <span class="kwrd">typeof</span>(WorkflowLibrary.Workflow1),
                initParam,
                id);

            <span class="rem">//保存有关数据</span>
            instances.Add(
                <span class="kwrd">new</span> WorkflowIntanceData(){
                    Id = id,
                    Amount = amount,
                    RequestEmployee=<span class="str">"陈希章"</span>
                });

            

            <span class="rem">//启动实例</span>
            instance.Start();


        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> ProcessRequest(Guid id, OrderApprovalEventType.ProcessResult result, <span class="kwrd">string</span> notes)
        {

            var args = <span class="kwrd">new</span> ProcessEventArgs(id);
            args.Result = result;
            args.Notes = notes;



            <span class="rem">//从集合中删除掉有关的实例</span>

            var found = instances.FirstOrDefault(d =&gt; d.Id == id);
            <span class="kwrd">if</span> (found != <span class="kwrd">null</span>)
                instances.Remove(found);


            local.RaiseEvent(args);<span class="rem">//激发事件</span>

             
        }

        <span class="kwrd">public</span> List&lt;WorkflowIntanceData&gt; GetWorkflowInstances()
        {
            <span class="kwrd">return</span> instances.Where(d =&gt; d.Amount &gt;= 2000).ToList();
        }

        <span class="preproc">#endregion</span>

        <span class="preproc">#region</span> IOrderService 成员


        <span class="kwrd">public</span> <span class="kwrd">void</span> UnLoad(Guid id)
        {
            runtime.GetWorkflow(id).Unload();<span class="rem">//要求开启MSDTC服务</span>
        }

        <span class="preproc">#endregion</span>

        ~OrderService() { 
            <span class="rem">//析构的时候将所有未完成的工作流实例保存起来</span>
            <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> runtime.GetLoadedWorkflows())
            {
                item.Unload();
            }
        }

        <span class="kwrd">public</span> <span class="kwrd">void</span> UnloadAllInstances() {
            <span class="kwrd">foreach</span> (var item <span class="kwrd">in</span> runtime.GetLoadedWorkflows())
            {
                item.Unload();
            }
        }

    }

    [Serializable]<span class="rem">//这个必须标记为可序列化</span>
    <span class="kwrd">internal</span> <span class="kwrd">class</span> LocalService : ManagerEvent
    {

        <span class="preproc">#region</span> ManagerEvent 成员

        <span class="kwrd">public</span> <span class="kwrd">event</span> EventHandler&lt;ProcessEventArgs&gt; Process;

        <span class="preproc">#endregion</span>


        <span class="kwrd">internal</span> <span class="kwrd">void</span> RaiseEvent(ProcessEventArgs e) {
            <span class="rem">//这里可能要更新数据库</span>

            <span class="kwrd">if</span> (Process != <span class="kwrd">null</span>)
                Process(<span class="kwrd">this</span>, e);
        }
    }
}
</pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>注意：这里有一个所谓本地服务的概念，是要实现第二步的那个接口，并编写有关触发事件的代码</p>
<p>3.5 HostService 如上都准备好之后，接下来就是通过一定的方式托管这些服务了。我们可以采用Windows Service来托管</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_16.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_7.png" width="963" height="784"></a> </p>
<p>3.6 SimpleClient 最后当然少不了要有客户端界面来实现一些操作。我们这里使用了Windows Forms作为界面。</p>
<p><a href="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_18.png" class="thickbox"><img title="image" border="0" alt="image" src="http://images.cnblogs.com/cnblogs_com/chenxizhang/WindowsLiveWriter/fa2050da86a9_7272/image_thumb_8.png" width="963" height="784"></a> </p><pre class="csharpcode"><span class="kwrd">using</span> System;
<span class="kwrd">using</span> System.Windows.Forms;

<span class="kwrd">using</span> System.ServiceModel;
<span class="kwrd">using</span> Contracts;

<span class="kwrd">namespace</span> SimpleClient
{
    <span class="kwrd">public</span> <span class="kwrd">partial</span> <span class="kwrd">class</span> Form1 : Form
    {

        IOrderService proxy = <span class="kwrd">null</span>;


        <span class="kwrd">public</span> Form1()
        {
            InitializeComponent();
        }

        <span class="kwrd">protected</span> <span class="kwrd">override</span> <span class="kwrd">void</span> OnLoad(EventArgs e)
        {
            <span class="kwrd">base</span>.OnLoad(e);

            ChannelFactory&lt;IOrderService&gt; factory = <span class="kwrd">new</span> ChannelFactory&lt;IOrderService&gt;(<span class="kwrd">new</span> BasicHttpBinding(), <span class="kwrd">new</span> EndpointAddress(<span class="str">"http://localhost:8080/OrderService"</span>));


            proxy = factory.CreateChannel();
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> btRequest_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            <span class="kwrd">int</span> amount = <span class="kwrd">int</span>.Parse(txtAmount.Text);
            proxy.StartRequest(Guid.NewGuid(), amount);
            MessageBox.Show(<span class="str">"已经发起了一个订单"</span>);
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> btGet_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            dgvRequests.DataSource = proxy.GetWorkflowInstances();

        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> dgvRequests_CellEnter(<span class="kwrd">object</span> sender, DataGridViewCellEventArgs e)
        {
            btOK.Enabled = btCancel.Enabled = <span class="kwrd">true</span>;
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> dgvRequests_CellLeave(<span class="kwrd">object</span> sender, DataGridViewCellEventArgs e)
        {
            <span class="rem">//btOK.Enabled = btCancel.Enabled = false;</span>

        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> btOK_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            var row = dgvRequests.Rows[dgvRequests.SelectedCells[0].RowIndex];
            var id = (Guid)row.Cells[0].Value;


            proxy.ProcessRequest(
                id, OrderApprovalEventType.ProcessResult.Approval, txtNotes.Text);


                
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> btCancel_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            var row = dgvRequests.Rows[dgvRequests.SelectedCells[0].RowIndex];
            var id = (Guid)row.Cells[0].Value;


            proxy.ProcessRequest(
                id, OrderApprovalEventType.ProcessResult.Reject, txtNotes.Text);
        }

        <span class="kwrd">private</span> <span class="kwrd">void</span> btUnload_Click(<span class="kwrd">object</span> sender, EventArgs e)
        {
            var row = dgvRequests.Rows[dgvRequests.SelectedCells[0].RowIndex];
            var id = (Guid)row.Cells[0].Value;

            proxy.UnLoad(id);
        }
    }
}
</pre>
<p>这样，一套工作流解决方案就做好了。这个架构可以供很多朋友参考</p>
<p>&nbsp;</p>
<p>另外，下面有几篇有关的文章可以参考学习</p>
<h4>工作流内部工作原理（一）</h4>
<p><a href="http://blogs.msdn.com/cnflow/archive/2010/04/16/9996989.aspx">http://blogs.msdn.com/cnflow/archive/2010/04/16/9996989.aspx</a></p>
<p>工作流内部工作原理（二）</p>
<p><a title="http://blogs.msdn.com/cnflow/archive/2010/04/16/9996992.aspx" href="http://blogs.msdn.com/cnflow/archive/2010/04/16/9996992.aspx">http://blogs.msdn.com/cnflow/archive/2010/04/16/9996992.aspx</a></p>
<p>工作流内部工作原理（三）</p>
<p><a title="http://blogs.msdn.com/cnflow/archive/2010/04/16/9996995.aspx" href="http://blogs.msdn.com/cnflow/archive/2010/04/16/9996995.aspx">http://blogs.msdn.com/cnflow/archive/2010/04/16/9996995.aspx</a></p>